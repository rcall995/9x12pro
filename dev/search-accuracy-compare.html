<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HERE vs Enriched Accuracy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .valid { background-color: #d1fae5; }
    .invalid { background-color: #fee2e2; }
    .warning { background-color: #fef3c7; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">HERE vs Enriched: Accuracy Comparison</h1>
    <p class="text-gray-600 mb-6">Is enrichment making things better or worse?</p>

    <!-- Config -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">ZIP Code</label>
          <input type="text" id="zipCode" value="14150" maxlength="5" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Category</label>
          <select id="category" class="w-full border rounded px-3 py-2">
            <option value="plumber">Plumber</option>
            <option value="auto repair">Auto Repair</option>
            <option value="restaurant" selected>Restaurant</option>
            <option value="hvac">HVAC</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Test Size</label>
          <select id="testSize" class="w-full border rounded px-3 py-2">
            <option value="15">15 businesses</option>
            <option value="25" selected>25 businesses</option>
            <option value="50">All (up to 50)</option>
          </select>
        </div>
      </div>
      <button id="runBtn" onclick="runComparison()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">
        Compare HERE vs Serper Accuracy
      </button>
    </div>

    <!-- Progress -->
    <div id="progress" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
      <div class="flex items-center gap-3">
        <div class="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
        <span id="progressText">Running...</span>
      </div>
    </div>

    <!-- Summary Comparison -->
    <div id="summary" class="grid grid-cols-2 gap-6 mb-6 hidden">
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-green-600 mb-4">HERE Only (Baseline)</h2>
        <div class="text-sm text-gray-500 mb-4">Data from verified business listings</div>
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="hereWebsiteCount">0</div>
            <div class="text-sm text-gray-500">Websites</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="hereWebsiteAccuracy">0%</div>
            <div class="text-sm text-gray-500">Accurate</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600" id="hereEmailCount">0</div>
            <div class="text-sm text-gray-500">Emails</div>
          </div>
        </div>
        <div class="mt-4 text-center text-sm" id="hereVerdict"></div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold text-orange-600 mb-4">Serper Enriched</h2>
        <div class="text-sm text-gray-500 mb-4">HERE + Serper search + Email scraping</div>
        <div class="grid grid-cols-3 gap-4">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600" id="serperWebsiteCount">0</div>
            <div class="text-sm text-gray-500">Websites</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600" id="serperWebsiteAccuracy">0%</div>
            <div class="text-sm text-gray-500">Accurate</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600" id="serperEmailCount">0</div>
            <div class="text-sm text-gray-500">Emails</div>
          </div>
        </div>
        <div class="mt-4 text-center text-sm" id="serperVerdict"></div>
      </div>
    </div>

    <!-- Winner -->
    <div id="winner" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <div id="winnerContent" class="text-center"></div>
    </div>

    <!-- Details Table -->
    <div id="detailsSection" class="bg-white rounded-lg shadow p-6 hidden">
      <h2 class="font-bold text-lg mb-4">Side-by-Side Comparison</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-3 py-2 text-left">Business</th>
              <th class="px-3 py-2 text-center bg-green-50" colspan="2">HERE Website</th>
              <th class="px-3 py-2 text-center bg-orange-50" colspan="2">Serper Website</th>
              <th class="px-3 py-2 text-center">Better?</th>
            </tr>
          </thead>
          <tbody id="detailsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    async function runComparison() {
      const zipCode = document.getElementById('zipCode').value.trim();
      const category = document.getElementById('category').value;
      const testSize = parseInt(document.getElementById('testSize').value);

      document.getElementById('progress').classList.remove('hidden');
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('winner').classList.add('hidden');
      document.getElementById('detailsSection').classList.add('hidden');
      document.getElementById('runBtn').disabled = true;

      try {
        // Get businesses from HERE
        document.getElementById('progressText').textContent = 'Fetching from HERE...';

        const response = await fetch('/api/here-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zipCode, category, limit: 50 })
        });
        const data = await response.json();
        const businesses = (data.businesses || []).slice(0, testSize);

        if (businesses.length === 0) {
          alert('No businesses found');
          return;
        }

        // Store original HERE data
        const hereData = businesses.map(b => ({
          name: b.name,
          website: b.website || null,
          email: b.email || null,
          phone: b.phone || null
        }));

        // Create enriched copy
        const serperData = businesses.map(b => ({
          name: b.name,
          website: b.website || null,
          email: b.email || null,
          phone: b.phone || null,
          city: b.city,
          state: b.state
        }));

        // Enrich with Serper
        for (let i = 0; i < serperData.length; i++) {
          const biz = serperData[i];
          document.getElementById('progressText').textContent = `Enriching ${biz.name} (${i+1}/${serperData.length})...`;

          if (!biz.website) {
            try {
              const query = `${biz.name} ${biz.city || ''} ${biz.state || ''} official website`;
              const resp = await fetch('/api/serper-search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, businessName: biz.name })
              });
              const searchData = await resp.json();
              if (searchData.topUrl) {
                biz.website = searchData.topUrl;
                biz.websiteSource = 'serper';
              }
            } catch (e) {}
          }

          // Email scraping for serper-enriched
          if (biz.website && !biz.email) {
            try {
              const scrapeResp = await fetch('/api/scrape-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ website: biz.website, businessName: biz.name })
              });
              const scrapeData = await scrapeResp.json();
              if (scrapeData.primaryEmail) {
                biz.email = scrapeData.primaryEmail;
              }
            } catch (e) {}
          }

          await new Promise(r => setTimeout(r, 200));
        }

        // Validate both sets
        document.getElementById('progressText').textContent = 'Validating websites...';

        const hereResults = { valid: 0, invalid: 0, total: 0, emails: 0 };
        const serperResults = { valid: 0, invalid: 0, total: 0, emails: 0 };
        const comparisons = [];

        for (let i = 0; i < businesses.length; i++) {
          const here = hereData[i];
          const serper = serperData[i];

          let hereValid = null;
          let serperValid = null;

          // Validate HERE website
          if (here.website) {
            hereResults.total++;
            try {
              const resp = await fetch('/api/validate-website', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ website: here.website, businessName: here.name })
              });
              const data = await resp.json();
              hereValid = data.valid && data.businessNameFound !== false;
              if (hereValid) hereResults.valid++;
              else hereResults.invalid++;
            } catch (e) {
              hereResults.invalid++;
            }
          }

          // Validate Serper website
          if (serper.website) {
            serperResults.total++;
            try {
              const resp = await fetch('/api/validate-website', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ website: serper.website, businessName: serper.name })
              });
              const data = await resp.json();
              serperValid = data.valid && data.businessNameFound !== false;
              if (serperValid) serperResults.valid++;
              else serperResults.invalid++;
            } catch (e) {
              serperResults.invalid++;
            }
          }

          // Count emails
          if (here.email) hereResults.emails++;
          if (serper.email) serperResults.emails++;

          // Determine which is better
          let better = 'same';
          if (hereValid && !serperValid) better = 'here';
          else if (!hereValid && serperValid) better = 'serper';
          else if (!here.website && serper.website && serperValid) better = 'serper';
          else if (here.website && !serper.website) better = 'here';

          comparisons.push({
            name: here.name,
            hereWebsite: here.website,
            hereValid,
            serperWebsite: serper.website,
            serperValid,
            serperSource: serper.websiteSource,
            better
          });

          await new Promise(r => setTimeout(r, 100));
        }

        // Display results
        displayResults(businesses.length, hereResults, serperResults, comparisons);

      } catch (error) {
        console.error('Comparison error:', error);
        alert('Error: ' + error.message);
      } finally {
        document.getElementById('progress').classList.add('hidden');
        document.getElementById('runBtn').disabled = false;
      }
    }

    function displayResults(total, here, serper, comparisons) {
      document.getElementById('summary').classList.remove('hidden');
      document.getElementById('winner').classList.remove('hidden');
      document.getElementById('detailsSection').classList.remove('hidden');

      const hereAccuracy = here.total > 0 ? Math.round((here.valid / here.total) * 100) : 0;
      const serperAccuracy = serper.total > 0 ? Math.round((serper.valid / serper.total) * 100) : 0;

      // HERE stats
      document.getElementById('hereWebsiteCount').textContent = `${here.total}/${total}`;
      document.getElementById('hereWebsiteAccuracy').textContent = `${hereAccuracy}%`;
      document.getElementById('hereEmailCount').textContent = here.emails;
      document.getElementById('hereVerdict').innerHTML =
        `<span class="${hereAccuracy >= 80 ? 'text-green-600' : hereAccuracy >= 60 ? 'text-yellow-600' : 'text-red-600'}">
          ${here.valid} accurate / ${here.total} websites
        </span>`;

      // Serper stats
      document.getElementById('serperWebsiteCount').textContent = `${serper.total}/${total}`;
      document.getElementById('serperWebsiteAccuracy').textContent = `${serperAccuracy}%`;
      document.getElementById('serperEmailCount').textContent = serper.emails;
      document.getElementById('serperVerdict').innerHTML =
        `<span class="${serperAccuracy >= 80 ? 'text-green-600' : serperAccuracy >= 60 ? 'text-yellow-600' : 'text-red-600'}">
          ${serper.valid} accurate / ${serper.total} websites
        </span>`;

      // Winner determination
      const hereWins = comparisons.filter(c => c.better === 'here').length;
      const serperWins = comparisons.filter(c => c.better === 'serper').length;
      const addedBad = comparisons.filter(c => c.serperSource === 'serper' && !c.serperValid).length;
      const addedGood = comparisons.filter(c => c.serperSource === 'serper' && c.serperValid).length;

      let winnerHTML = '';
      if (hereAccuracy > serperAccuracy + 10) {
        winnerHTML = `
          <div class="text-2xl font-bold text-green-600 mb-2">HERE Only is More Accurate!</div>
          <p>HERE: ${hereAccuracy}% accurate vs Serper: ${serperAccuracy}% accurate</p>
          <p class="text-red-600 mt-2">Serper added ${addedBad} BAD websites, only ${addedGood} good ones.</p>
          <p class="mt-4 text-lg font-medium">Recommendation: Skip enrichment, use HERE data only.</p>
        `;
      } else if (serperAccuracy > hereAccuracy + 10 && addedGood > addedBad) {
        winnerHTML = `
          <div class="text-2xl font-bold text-orange-600 mb-2">Serper Enrichment Helps!</div>
          <p>Serper: ${serperAccuracy}% accurate vs HERE: ${hereAccuracy}% accurate</p>
          <p class="text-green-600 mt-2">Serper added ${addedGood} good websites (${addedBad} bad).</p>
          <p class="mt-4 text-lg font-medium">Recommendation: Use Serper enrichment.</p>
        `;
      } else {
        const netBenefit = addedGood - addedBad;
        winnerHTML = `
          <div class="text-2xl font-bold text-yellow-600 mb-2">Mixed Results</div>
          <p>HERE: ${hereAccuracy}% | Serper: ${serperAccuracy}%</p>
          <p class="mt-2">Serper added ${addedGood} good websites but also ${addedBad} bad ones.</p>
          <p class="mt-2">Net benefit: ${netBenefit >= 0 ? '+' : ''}${netBenefit} websites</p>
          <p class="mt-4 text-lg font-medium">
            ${netBenefit > 2 ? 'Lean toward enrichment' : netBenefit < -2 ? 'Lean toward HERE only' : 'Consider case-by-case'}
          </p>
        `;
      }
      document.getElementById('winnerContent').innerHTML = winnerHTML;

      // Details table
      let tableHTML = '';
      for (const c of comparisons) {
        const hereClass = c.hereValid ? 'valid' : (c.hereWebsite ? 'invalid' : '');
        const serperClass = c.serperValid ? 'valid' : (c.serperWebsite ? 'invalid' : '');
        const betterIcon = c.better === 'here' ? '‚¨ÖÔ∏è HERE' : c.better === 'serper' ? 'Serper ‚û°Ô∏è' : '‚Äî';

        tableHTML += `
          <tr class="border-t">
            <td class="px-3 py-2 font-medium">${c.name}</td>
            <td class="px-3 py-2 text-xs max-w-32 truncate bg-green-50" title="${c.hereWebsite || ''}">${c.hereWebsite ? c.hereWebsite.replace(/^https?:\/\//, '').substring(0, 25) : '‚Äî'}</td>
            <td class="px-3 py-2 text-center ${hereClass}">${c.hereWebsite ? (c.hereValid ? '‚úÖ' : '‚ùå') : '‚Äî'}</td>
            <td class="px-3 py-2 text-xs max-w-32 truncate bg-orange-50" title="${c.serperWebsite || ''}">${c.serperWebsite ? c.serperWebsite.replace(/^https?:\/\//, '').substring(0, 25) : '‚Äî'}</td>
            <td class="px-3 py-2 text-center ${serperClass}">${c.serperWebsite ? (c.serperValid ? '‚úÖ' : '‚ùå') : '‚Äî'}${c.serperSource === 'serper' ? ' üÜï' : ''}</td>
            <td class="px-3 py-2 text-center text-xs">${betterIcon}</td>
          </tr>
        `;
      }
      document.getElementById('detailsTable').innerHTML = tableHTML;
    }
  </script>
</body>
</html>
