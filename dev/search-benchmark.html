<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Benchmark Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .good { background-color: #d1fae5; }
    .medium { background-color: #fef3c7; }
    .poor { background-color: #fee2e2; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Search Benchmark Tool</h1>
    <p class="text-gray-600 mb-6">Test multiple ZIP codes and categories to find the best data sources</p>

    <!-- Configuration -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="font-bold text-lg mb-4">Test Configuration</h2>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium mb-2">ZIP Codes (one per line)</label>
          <textarea id="zipCodes" rows="4" class="w-full border rounded px-3 py-2 font-mono text-sm"
>14150
14072
14201
14226</textarea>
          <p class="text-xs text-gray-500 mt-1">Tonawanda, Grand Island, Buffalo Downtown, Amherst</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Categories (one per line)</label>
          <textarea id="categories" rows="4" class="w-full border rounded px-3 py-2 font-mono text-sm"
>hvac
plumber
auto repair
restaurant
salon</textarea>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-4">
        <label class="flex items-center gap-2">
          <input type="checkbox" id="usePlaces" checked class="rounded">
          <span class="text-sm">Use Google Places API ($)</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" id="useEmailScrape" checked class="rounded">
          <span class="text-sm">Use Email Scraping</span>
        </label>
      </div>

      <button id="runBtn" onclick="runBenchmark()"
        class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">
        Run Benchmark
      </button>
      <button onclick="exportResults()" class="mt-4 ml-2 bg-gray-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-700">
        Export CSV
      </button>
    </div>

    <!-- Progress -->
    <div id="progress" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
      <div class="flex items-center gap-3">
        <div class="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
        <span id="progressText">Running...</span>
      </div>
      <div class="mt-2 bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
      </div>
    </div>

    <!-- Summary -->
    <div id="summary" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <h2 class="font-bold text-lg mb-4">Summary</h2>
      <div id="summaryContent" class="grid grid-cols-4 gap-4"></div>
    </div>

    <!-- Results Table -->
    <div id="resultsSection" class="bg-white rounded-lg shadow p-6 hidden">
      <h2 class="font-bold text-lg mb-4">Detailed Results</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-3 py-2 text-left">ZIP</th>
              <th class="px-3 py-2 text-left">Category</th>
              <th class="px-3 py-2 text-right">Total</th>
              <th class="px-3 py-2 text-right">Websites</th>
              <th class="px-3 py-2 text-right">Phones</th>
              <th class="px-3 py-2 text-right">Emails</th>
              <th class="px-3 py-2 text-right">Web %</th>
              <th class="px-3 py-2 text-right">Email %</th>
              <th class="px-3 py-2 text-right">Score</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Category Summary -->
    <div id="categorySection" class="bg-white rounded-lg shadow p-6 mt-6 hidden">
      <h2 class="font-bold text-lg mb-4">Best Categories (by data quality)</h2>
      <div id="categoryRanking"></div>
    </div>
  </div>

  <script>
    let allResults = [];
    let googleMapsLoaded = false;

    function loadGoogleMaps() {
      return new Promise((resolve, reject) => {
        if (googleMapsLoaded) { resolve(); return; }
        window.initGoogleMaps = () => { googleMapsLoaded = true; resolve(); };
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyB9E1j1s3I-7RkL1AmKWJpMdA6gDoRW6nQ&libraries=places&loading=async&callback=initGoogleMaps`;
        script.async = true;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function enrichWithPlaces(biz) {
      await loadGoogleMaps();
      try {
        const query = `${biz.name} ${biz.city || ''} ${biz.state || ''}`;
        const { Place } = await google.maps.importLibrary("places");
        const request = {
          textQuery: query,
          fields: ['displayName', 'formattedAddress', 'websiteURI', 'nationalPhoneNumber', 'googleMapsURI', 'rating', 'userRatingCount'],
          maxResultCount: 1
        };
        const { places } = await Place.searchByText(request);
        if (places && places.length > 0) {
          const place = places[0];
          return {
            website: place.websiteURI || null,
            phone: place.nationalPhoneNumber || null,
            googleMapsUrl: place.googleMapsURI || null,
            rating: place.rating || null,
            reviewCount: place.userRatingCount || null
          };
        }
        return null;
      } catch (error) {
        console.error(`Places API error for ${biz.name}:`, error);
        return null;
      }
    }

    async function runBenchmark() {
      const zipCodes = document.getElementById('zipCodes').value.trim().split('\n').filter(z => z.trim());
      const categories = document.getElementById('categories').value.trim().split('\n').filter(c => c.trim());
      const usePlaces = document.getElementById('usePlaces').checked;
      const useEmailScrape = document.getElementById('useEmailScrape').checked;

      if (zipCodes.length === 0 || categories.length === 0) {
        alert('Enter at least one ZIP code and one category');
        return;
      }

      const totalTests = zipCodes.length * categories.length;
      let completed = 0;
      allResults = [];

      document.getElementById('progress').classList.remove('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('resultsTable').innerHTML = '';
      document.getElementById('runBtn').disabled = true;

      for (const zip of zipCodes) {
        for (const category of categories) {
          completed++;
          const pct = Math.round((completed / totalTests) * 100);
          document.getElementById('progressText').textContent = `Testing ${zip} - ${category} (${completed}/${totalTests})`;
          document.getElementById('progressBar').style.width = `${pct}%`;

          try {
            const result = await runSingleSearch(zip.trim(), category.trim(), usePlaces, useEmailScrape);
            allResults.push(result);
            addResultRow(result);
          } catch (e) {
            console.error(`Error testing ${zip} - ${category}:`, e);
            allResults.push({
              zip: zip.trim(),
              category: category.trim(),
              total: 0,
              websites: 0,
              phones: 0,
              emails: 0,
              error: e.message
            });
          }

          // Small delay between searches
          await new Promise(r => setTimeout(r, 500));
        }
      }

      document.getElementById('progress').classList.add('hidden');
      document.getElementById('runBtn').disabled = false;

      showSummary();
      showCategoryRanking();
    }

    async function runSingleSearch(zipCode, category, usePlaces, useEmailScrape) {
      // Step 1: HERE API
      const response = await fetch('/api/here-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zipCode, category, limit: 50 })
      });
      const data = await response.json();
      let businesses = data.businesses || [];

      let hereWebsites = businesses.filter(b => b.website).length;
      let herePhones = businesses.filter(b => b.phone).length;
      let hereEmails = businesses.filter(b => b.email).length;
      let placesWebsites = 0;
      let scrapedEmails = 0;

      // Step 2: Places enrichment
      if (usePlaces && businesses.length > 0) {
        const needsEnrichment = businesses.filter(b => !b.website);
        for (const biz of needsEnrichment) {
          try {
            const placesData = await enrichWithPlaces(biz);
            if (placesData?.website) {
              biz.website = placesData.website;
              placesWebsites++;
            }
          } catch (e) {}
          await new Promise(r => setTimeout(r, 150));
        }
      }

      // Step 3: Email scraping
      if (useEmailScrape && businesses.length > 0) {
        const needsEmail = businesses.filter(b => b.website && !b.email);
        for (const biz of needsEmail) {
          try {
            const scrapeResp = await fetch('/api/scrape-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ website: biz.website, businessName: biz.name })
            });
            const scrapeData = await scrapeResp.json();
            if (scrapeData.primaryEmail) {
              biz.email = scrapeData.primaryEmail;
              scrapedEmails++;
            }
          } catch (e) {}
          await new Promise(r => setTimeout(r, 200));
        }
      }

      const totalWebsites = businesses.filter(b => b.website).length;
      const totalPhones = businesses.filter(b => b.phone).length;
      const totalEmails = businesses.filter(b => b.email).length;

      return {
        zip: zipCode,
        category,
        total: businesses.length,
        websites: totalWebsites,
        phones: totalPhones,
        emails: totalEmails,
        hereWebsites,
        hereEmails,
        placesWebsites,
        scrapedEmails,
        webPct: businesses.length > 0 ? Math.round((totalWebsites / businesses.length) * 100) : 0,
        emailPct: businesses.length > 0 ? Math.round((totalEmails / businesses.length) * 100) : 0,
        // Score: weighted combination of data completeness
        score: businesses.length > 0 ? Math.round(
          (totalWebsites / businesses.length * 40) +
          (totalPhones / businesses.length * 30) +
          (totalEmails / businesses.length * 30)
        ) : 0
      };
    }

    function addResultRow(r) {
      const scoreClass = r.score >= 70 ? 'good' : r.score >= 40 ? 'medium' : 'poor';
      const row = `
        <tr class="border-t">
          <td class="px-3 py-2">${r.zip}</td>
          <td class="px-3 py-2">${r.category}</td>
          <td class="px-3 py-2 text-right">${r.total}</td>
          <td class="px-3 py-2 text-right">${r.websites}</td>
          <td class="px-3 py-2 text-right">${r.phones}</td>
          <td class="px-3 py-2 text-right">${r.emails}</td>
          <td class="px-3 py-2 text-right">${r.webPct}%</td>
          <td class="px-3 py-2 text-right">${r.emailPct}%</td>
          <td class="px-3 py-2 text-right ${scoreClass} font-bold">${r.score}</td>
        </tr>
      `;
      document.getElementById('resultsTable').innerHTML += row;
    }

    function showSummary() {
      const totalBusinesses = allResults.reduce((sum, r) => sum + r.total, 0);
      const totalWebsites = allResults.reduce((sum, r) => sum + r.websites, 0);
      const totalPhones = allResults.reduce((sum, r) => sum + r.phones, 0);
      const totalEmails = allResults.reduce((sum, r) => sum + r.emails, 0);
      const avgScore = Math.round(allResults.reduce((sum, r) => sum + r.score, 0) / allResults.length);

      document.getElementById('summary').classList.remove('hidden');
      document.getElementById('summaryContent').innerHTML = `
        <div class="bg-blue-50 rounded p-4 text-center">
          <div class="text-3xl font-bold text-blue-600">${totalBusinesses}</div>
          <div class="text-sm text-gray-600">Total Businesses</div>
        </div>
        <div class="bg-green-50 rounded p-4 text-center">
          <div class="text-3xl font-bold text-green-600">${totalWebsites} <span class="text-lg">(${Math.round(totalWebsites/totalBusinesses*100)}%)</span></div>
          <div class="text-sm text-gray-600">Have Websites</div>
        </div>
        <div class="bg-yellow-50 rounded p-4 text-center">
          <div class="text-3xl font-bold text-yellow-600">${totalPhones} <span class="text-lg">(${Math.round(totalPhones/totalBusinesses*100)}%)</span></div>
          <div class="text-sm text-gray-600">Have Phones</div>
        </div>
        <div class="bg-purple-50 rounded p-4 text-center">
          <div class="text-3xl font-bold text-purple-600">${totalEmails} <span class="text-lg">(${Math.round(totalEmails/totalBusinesses*100)}%)</span></div>
          <div class="text-sm text-gray-600">Have Emails</div>
        </div>
      `;
    }

    function showCategoryRanking() {
      // Group by category and calculate averages
      const categoryStats = {};
      for (const r of allResults) {
        if (!categoryStats[r.category]) {
          categoryStats[r.category] = { total: 0, websites: 0, phones: 0, emails: 0, scores: [] };
        }
        categoryStats[r.category].total += r.total;
        categoryStats[r.category].websites += r.websites;
        categoryStats[r.category].phones += r.phones;
        categoryStats[r.category].emails += r.emails;
        categoryStats[r.category].scores.push(r.score);
      }

      const ranking = Object.entries(categoryStats).map(([cat, stats]) => ({
        category: cat,
        avgScore: Math.round(stats.scores.reduce((a, b) => a + b, 0) / stats.scores.length),
        total: stats.total,
        webPct: Math.round(stats.websites / stats.total * 100),
        emailPct: Math.round(stats.emails / stats.total * 100)
      })).sort((a, b) => b.avgScore - a.avgScore);

      document.getElementById('categorySection').classList.remove('hidden');
      document.getElementById('categoryRanking').innerHTML = ranking.map((r, i) => `
        <div class="flex items-center gap-4 py-2 ${i > 0 ? 'border-t' : ''}">
          <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-green-500' : i === 1 ? 'bg-blue-500' : 'bg-gray-400'} text-white flex items-center justify-center font-bold">${i + 1}</div>
          <div class="flex-1">
            <div class="font-bold capitalize">${r.category}</div>
            <div class="text-sm text-gray-500">${r.total} businesses | ${r.webPct}% websites | ${r.emailPct}% emails</div>
          </div>
          <div class="text-2xl font-bold ${r.avgScore >= 70 ? 'text-green-600' : r.avgScore >= 40 ? 'text-yellow-600' : 'text-red-600'}">${r.avgScore}</div>
        </div>
      `).join('');
    }

    function exportResults() {
      if (allResults.length === 0) {
        alert('Run a benchmark first');
        return;
      }

      const headers = ['ZIP', 'Category', 'Total', 'Websites', 'Phones', 'Emails', 'HERE Web', 'HERE Email', 'Places Web', 'Scraped Email', 'Web %', 'Email %', 'Score'];
      const rows = allResults.map(r => [
        r.zip, r.category, r.total, r.websites, r.phones, r.emails,
        r.hereWebsites, r.hereEmails, r.placesWebsites, r.scrapedEmails,
        r.webPct, r.emailPct, r.score
      ]);

      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `search-benchmark-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }
  </script>
</body>
</html>
