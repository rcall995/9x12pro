<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search Method Comparison</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Search Method Comparison</h1>
    <p class="text-gray-600 mb-6">Compare FREE enrichment methods vs paid Google Places</p>

    <!-- Configuration -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">ZIP Code</label>
          <input type="text" id="zipCode" value="14150" maxlength="5"
            class="w-full border rounded px-3 py-2 text-lg">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Category</label>
          <select id="category" class="w-full border rounded px-3 py-2 text-lg">
            <option value="plumber" selected>Plumber (best data)</option>
            <option value="auto repair">Auto Repair</option>
            <option value="restaurant">Restaurant</option>
            <option value="hvac">HVAC</option>
            <option value="electrician">Electrician</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Test Size</label>
          <select id="testSize" class="w-full border rounded px-3 py-2 text-lg">
            <option value="10">First 10 businesses</option>
            <option value="20" selected>First 20 businesses</option>
            <option value="50">All (up to 50)</option>
          </select>
        </div>
      </div>

      <button id="runBtn" onclick="runComparison()"
        class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700">
        Compare Methods
      </button>
    </div>

    <!-- Progress -->
    <div id="progress" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
      <div class="flex items-center gap-3">
        <div class="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
        <span id="progressText">Running...</span>
      </div>
    </div>

    <!-- Method Summary -->
    <div id="methodSummary" class="grid grid-cols-5 gap-3 mb-6 hidden">
      <div id="hereCard" class="bg-white rounded-lg shadow p-3">
        <h3 class="font-bold text-green-600 mb-1 text-sm">HERE Only</h3>
        <div class="text-xs text-gray-500 mb-2">FREE (baseline)</div>
        <div id="hereStats"></div>
      </div>
      <div id="googleCard" class="bg-white rounded-lg shadow p-3">
        <h3 class="font-bold text-yellow-600 mb-1 text-sm">+ Google Search</h3>
        <div class="text-xs text-gray-500 mb-2">FREE (100/day)</div>
        <div id="googleStats"></div>
      </div>
      <div id="serperCard" class="bg-white rounded-lg shadow p-3">
        <h3 class="font-bold text-orange-600 mb-1 text-sm">+ Serper API</h3>
        <div class="text-xs text-gray-500 mb-2">FREE (2500/mo)</div>
        <div id="serperStats"></div>
      </div>
      <div id="braveCard" class="bg-white rounded-lg shadow p-3">
        <h3 class="font-bold text-red-600 mb-1 text-sm">+ Brave Search</h3>
        <div class="text-xs text-gray-500 mb-2">FREE (2000/mo)</div>
        <div id="braveStats"></div>
      </div>
      <div id="placesCard" class="bg-white rounded-lg shadow p-3">
        <h3 class="font-bold text-blue-600 mb-1 text-sm">+ Google Places</h3>
        <div class="text-xs text-gray-500 mb-2">$17/1000 calls</div>
        <div id="placesStats"></div>
      </div>
    </div>

    <!-- Winner -->
    <div id="winner" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
      <h2 class="font-bold text-lg mb-2">Recommendation</h2>
      <div id="winnerContent"></div>
    </div>

    <!-- Detailed Results -->
    <div id="detailsSection" class="bg-white rounded-lg shadow p-6 hidden">
      <h2 class="font-bold text-lg mb-4">Business-by-Business Comparison</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-2 py-2 text-left">Business</th>
              <th class="px-2 py-2 text-center bg-green-50">HERE</th>
              <th class="px-2 py-2 text-center bg-yellow-50">Google</th>
              <th class="px-2 py-2 text-center bg-orange-50">Serper</th>
              <th class="px-2 py-2 text-center bg-red-50">Brave</th>
              <th class="px-2 py-2 text-center bg-blue-50">Places</th>
            </tr>
          </thead>
          <tbody id="detailsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let googleMapsLoaded = false;

    function loadGoogleMaps() {
      return new Promise((resolve, reject) => {
        if (googleMapsLoaded) { resolve(); return; }
        window.initGoogleMaps = () => { googleMapsLoaded = true; resolve(); };
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyB9E1j1s3I-7RkL1AmKWJpMdA6gDoRW6nQ&libraries=places&loading=async&callback=initGoogleMaps`;
        script.async = true;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function runComparison() {
      const zipCode = document.getElementById('zipCode').value.trim();
      const category = document.getElementById('category').value;
      const testSize = parseInt(document.getElementById('testSize').value);

      document.getElementById('progress').classList.remove('hidden');
      document.getElementById('runBtn').disabled = true;
      document.getElementById('methodSummary').classList.add('hidden');

      try {
        // Step 1: Get businesses from HERE
        document.getElementById('progressText').textContent = 'Fetching businesses from HERE...';

        const response = await fetch('/api/here-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ zipCode, category, limit: 50 })
        });
        const data = await response.json();
        let businesses = (data.businesses || []).slice(0, testSize);

        if (businesses.length === 0) {
          alert('No businesses found');
          return;
        }

        // Find businesses that need website enrichment
        const needsWebsite = businesses.filter(b => !b.website);

        // Track results for each method
        const results = {
          here: { websites: businesses.filter(b => b.website).length, found: {} },
          google: { websites: businesses.filter(b => b.website).length, found: {} },
          serper: { websites: businesses.filter(b => b.website).length, found: {} },
          brave: { websites: businesses.filter(b => b.website).length, found: {} },
          places: { websites: businesses.filter(b => b.website).length, found: {} }
        };

        // Test each enrichment method on businesses without websites
        for (let i = 0; i < needsWebsite.length; i++) {
          const biz = needsWebsite[i];
          document.getElementById('progressText').textContent =
            `Testing "${biz.name}" (${i + 1}/${needsWebsite.length})...`;

          // Test Google Custom Search
          try {
            const query = `${biz.name} ${biz.city || ''} ${biz.state || ''} official website`;
            const resp = await fetch('/api/google-search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query, businessName: biz.name })
            });
            const searchData = await resp.json();
            const googleWebsite = searchData.website;
            if (googleWebsite && !googleWebsite.includes('facebook.com') && !googleWebsite.includes('yelp.com')) {
              results.google.websites++;
              results.google.found[biz.name] = googleWebsite;
              console.log(`✅ Google found: ${googleWebsite}`);
            }
          } catch (e) { console.warn('Google search error:', e); }

          await new Promise(r => setTimeout(r, 300));

          // Test Serper API
          try {
            const query = `${biz.name} ${biz.city || ''} ${biz.state || ''} official website`;
            const resp = await fetch('/api/serper-search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query, businessName: biz.name })
            });
            const searchData = await resp.json();
            const serperWebsite = searchData.topUrl; // Serper uses topUrl, not website
            if (serperWebsite && !serperWebsite.includes('facebook.com') && !serperWebsite.includes('yelp.com')) {
              results.serper.websites++;
              results.serper.found[biz.name] = serperWebsite;
              console.log(`✅ Serper found: ${serperWebsite}`);
            }
          } catch (e) { console.warn('Serper error:', e); }

          await new Promise(r => setTimeout(r, 200));

          // Test Brave Search API
          try {
            const query = `${biz.name} ${biz.city || ''} ${biz.state || ''} official website`;
            const resp = await fetch('/api/brave-search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query, businessName: biz.name })
            });
            const searchData = await resp.json();
            const braveWebsite = searchData.website;
            if (braveWebsite && !braveWebsite.includes('facebook.com') && !braveWebsite.includes('yelp.com')) {
              results.brave.websites++;
              results.brave.found[biz.name] = braveWebsite;
              console.log(`✅ Brave found: ${braveWebsite}`);
            }
          } catch (e) { console.warn('Brave search error:', e); }

          await new Promise(r => setTimeout(r, 200));

          // Test Google Places API
          try {
            await loadGoogleMaps();
            const query = `${biz.name} ${biz.city || ''} ${biz.state || ''}`;
            const { Place } = await google.maps.importLibrary("places");
            const request = {
              textQuery: query,
              fields: ['displayName', 'websiteURI'],
              maxResultCount: 1
            };
            const { places } = await Place.searchByText(request);
            if (places && places.length > 0 && places[0].websiteURI) {
              const website = places[0].websiteURI;
              if (!website.includes('facebook.com') && !website.includes('yelp.com')) {
                results.places.websites++;
                results.places.found[biz.name] = website;
              }
            }
          } catch (e) { console.warn('Places error:', e); }

          await new Promise(r => setTimeout(r, 200));
        }

        // Display results
        displayResults(businesses, needsWebsite, results);

      } catch (error) {
        console.error('Comparison error:', error);
        alert('Error: ' + error.message);
      } finally {
        document.getElementById('progress').classList.add('hidden');
        document.getElementById('runBtn').disabled = false;
      }
    }

    function displayResults(businesses, needsWebsite, results) {
      const total = businesses.length;
      const hereWebsites = results.here.websites;

      document.getElementById('methodSummary').classList.remove('hidden');
      document.getElementById('detailsSection').classList.remove('hidden');
      document.getElementById('winner').classList.remove('hidden');

      // Calculate percentages
      const herePct = Math.round(hereWebsites / total * 100);
      const googlePct = Math.round(results.google.websites / total * 100);
      const serperPct = Math.round(results.serper.websites / total * 100);
      const bravePct = Math.round(results.brave.websites / total * 100);
      const placesPct = Math.round(results.places.websites / total * 100);

      const googleAdded = results.google.websites - hereWebsites;
      const serperAdded = results.serper.websites - hereWebsites;
      const braveAdded = results.brave.websites - hereWebsites;
      const placesAdded = results.places.websites - hereWebsites;

      // Update cards
      document.getElementById('hereStats').innerHTML = `
        <div class="text-2xl font-bold">${hereWebsites}/${total}</div>
        <div class="text-sm text-gray-500">${herePct}% websites</div>
        <div class="text-xs text-gray-400 mt-1">Baseline</div>
      `;

      document.getElementById('googleStats').innerHTML = `
        <div class="text-2xl font-bold">${results.google.websites}/${total}</div>
        <div class="text-sm text-gray-500">${googlePct}% websites</div>
        <div class="text-xs mt-1 ${googleAdded > 0 ? 'text-green-600' : 'text-gray-400'}">+${googleAdded} added</div>
      `;

      document.getElementById('serperStats').innerHTML = `
        <div class="text-2xl font-bold">${results.serper.websites}/${total}</div>
        <div class="text-sm text-gray-500">${serperPct}% websites</div>
        <div class="text-xs mt-1 ${serperAdded > 0 ? 'text-green-600' : 'text-gray-400'}">+${serperAdded} added</div>
      `;

      document.getElementById('braveStats').innerHTML = `
        <div class="text-2xl font-bold">${results.brave.websites}/${total}</div>
        <div class="text-sm text-gray-500">${bravePct}% websites</div>
        <div class="text-xs mt-1 ${braveAdded > 0 ? 'text-green-600' : 'text-gray-400'}">+${braveAdded} added</div>
      `;

      document.getElementById('placesStats').innerHTML = `
        <div class="text-2xl font-bold">${results.places.websites}/${total}</div>
        <div class="text-sm text-gray-500">${placesPct}% websites</div>
        <div class="text-xs mt-1 ${placesAdded > 0 ? 'text-green-600' : 'text-gray-400'}">+${placesAdded} added</div>
      `;

      // Highlight best
      const methods = [
        { name: 'google', added: googleAdded, cost: 'FREE' },
        { name: 'serper', added: serperAdded, cost: 'FREE' },
        { name: 'brave', added: braveAdded, cost: 'FREE' },
        { name: 'places', added: placesAdded, cost: '$0.017/call' }
      ];
      methods.sort((a, b) => b.added - a.added);

      const best = methods[0];
      const bestFree = methods.filter(m => m.cost === 'FREE').sort((a, b) => b.added - a.added)[0];

      let recommendation = '';
      if (bestFree.added >= best.added * 0.8) {
        recommendation = `
          <div class="text-green-600 font-bold text-xl mb-2">Use ${bestFree.name.toUpperCase()} (FREE)</div>
          <p>The free ${bestFree.name} method found ${bestFree.added} websites - comparable to paid Places API (${placesAdded}).</p>
          <p class="mt-2 text-sm text-gray-600">Save money by using ${bestFree.name} instead of Places API!</p>
        `;
      } else if (placesAdded > bestFree.added + 2) {
        recommendation = `
          <div class="text-blue-600 font-bold text-xl mb-2">Google Places is worth it</div>
          <p>Places found ${placesAdded} more websites vs ${bestFree.added} from best free method (${bestFree.name}).</p>
          <p class="mt-2 text-sm text-gray-600">The extra ${placesAdded - bestFree.added} websites may justify the ~$0.02/call cost.</p>
        `;
      } else {
        recommendation = `
          <div class="text-yellow-600 font-bold text-xl mb-2">Close call - test more data</div>
          <p>Free methods found ${bestFree.added} websites, Places found ${placesAdded}.</p>
          <p class="mt-2 text-sm text-gray-600">Consider running with more businesses to get a clearer signal.</p>
        `;
      }
      document.getElementById('winnerContent').innerHTML = recommendation;

      // Build details table
      let tableHTML = '';
      for (const biz of businesses) {
        const hereWeb = biz.website ? '✅' : '❌';
        const googleWeb = biz.website ? '✅' : (results.google.found[biz.name] ? '✅ Found' : '❌');
        const serperWeb = biz.website ? '✅' : (results.serper.found[biz.name] ? '✅ Found' : '❌');
        const braveWeb = biz.website ? '✅' : (results.brave.found[biz.name] ? '✅ Found' : '❌');
        const placesWeb = biz.website ? '✅' : (results.places.found[biz.name] ? '✅ Found' : '❌');

        tableHTML += `
          <tr class="border-t">
            <td class="px-2 py-1 font-medium">${biz.name}</td>
            <td class="px-2 py-1 text-center bg-green-50">${hereWeb}</td>
            <td class="px-2 py-1 text-center bg-yellow-50">${googleWeb}</td>
            <td class="px-2 py-1 text-center bg-orange-50">${serperWeb}</td>
            <td class="px-2 py-1 text-center bg-red-50">${braveWeb}</td>
            <td class="px-2 py-1 text-center bg-blue-50">${placesWeb}</td>
          </tr>
        `;
      }
      document.getElementById('detailsTable').innerHTML = tableHTML;
    }
  </script>
</body>
</html>
