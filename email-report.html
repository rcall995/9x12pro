<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Category Outreach Queue | 9x12 Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
    .category-section { transition: all 0.3s ease; }
    .category-content { max-height: 2000px; overflow: hidden; transition: max-height 0.3s ease; }
    .category-content.collapsed { max-height: 0; }
    .business-card { transition: all 0.2s ease; }
    .business-card:hover { transform: translateX(4px); }
    .business-card.current-target { border-left: 4px solid #6366f1; background: #eef2ff; }
    .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; font-weight: 600; }
    .spot-fill { transition: width 0.5s ease; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Loading State -->
  <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Loading...</p>
    </div>
  </div>

  <!-- Login Required -->
  <div id="login-required" class="hidden fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center p-8">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Login Required</h1>
      <p class="text-gray-600 mb-6">Please log in to 9x12 Pro to access this report.</p>
      <a href="login.html" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Go to Login
      </a>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white shadow-lg no-print">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="app.html" class="text-white/80 hover:text-white text-sm">&larr; Back to App</a>
          <h1 class="text-xl font-bold">Category Outreach Queue</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="user-name" class="text-sm text-white/90"></span>
          <button onclick="logout()" class="px-4 py-2 text-sm bg-white/20 rounded-lg hover:bg-white/30 transition">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Campaign & Settings Bar -->
    <div class="max-w-7xl mx-auto px-4 py-4 no-print">
      <div class="bg-white rounded-xl shadow-md p-4">
        <div class="flex flex-wrap gap-4 items-center justify-between">
          <!-- Campaign Selector -->
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700">Campaign:</label>
            <select id="campaign-select" onchange="loadCampaignState()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-w-[250px]">
              <option value="">Select a campaign...</option>
            </select>
          </div>

          <!-- Spot Target -->
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700">Target Spots:</label>
            <input type="number" id="spot-target" value="16" min="1" max="50" onchange="updateSpotTracker()"
                   class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          </div>

          <!-- ZIP Filter -->
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700">ZIPs:</label>
            <div id="zip-select" class="flex flex-wrap gap-1 max-w-md">
              <span class="text-gray-400 text-sm">Loading...</span>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="saveState()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm font-medium">
              Save
            </button>
            <button onclick="toggleContactedView()" id="contacted-btn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium">
              View Contacted
            </button>
            <button onclick="exportFullCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium">
              Export All
            </button>
            <button onclick="exportContactSheet()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
              Contact Sheet
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Spot Tracker -->
    <div class="max-w-7xl mx-auto px-4 pb-4 no-print">
      <div class="bg-white rounded-xl shadow-md p-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lg font-bold text-gray-800">
            <span id="spots-filled">0</span>/<span id="spots-target">16</span> Spots Filled
          </span>
          <div class="flex gap-4 text-sm">
            <span class="text-green-600 font-medium"><span id="stat-sold">0</span> Sold</span>
            <span class="text-blue-600 font-medium"><span id="stat-attempting">0</span> In Progress</span>
            <span class="text-gray-600 font-medium"><span id="stat-queue">0</span> In Queue</span>
          </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
          <div id="spot-progress" class="spot-fill bg-gradient-to-r from-green-500 to-emerald-500 h-4 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Category Sections -->
    <div id="categories-container" class="max-w-7xl mx-auto px-4 pb-8">
      <div class="text-center py-12 text-gray-500">
        Select a campaign to view outreach queue...
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div id="notes-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Edit Notes</h3>
      <input type="hidden" id="notes-business-id">
      <textarea id="notes-text" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-none" placeholder="Add notes about this business..."></textarea>
      <div class="flex justify-end gap-2 mt-4">
        <button onclick="closeNotesModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
        <button onclick="saveNotes()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save Notes</button>
      </div>
    </div>
  </div>

  <!-- Edit Email Modal -->
  <div id="edit-email-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-2">Edit Email Address</h3>
      <p class="text-sm text-gray-500 mb-4" id="edit-email-business-name"></p>
      <input type="hidden" id="edit-email-business-id">
      <input type="email" id="edit-email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="email@example.com">
      <div class="flex justify-end gap-2 mt-4">
        <button onclick="closeEditEmailModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
        <button onclick="saveEditedEmail()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Save Email</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

  <script>
    // Supabase config
    const SUPABASE_URL = "https://kurhsdvxsgkgnfimfqdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1cmhzZHZ4c2drZ25maW1mcWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDk3NDYsImV4cCI6MjA3ODM4NTc0Nn0.nB_GsE89WJ3eAQrgmNKb-fbCktHTHf-987D-G6lscZA";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allProspects = [];
    let campaigns = [];
    let currentCampaign = null;
    let showContactedOnly = false;
    let autoSaveInterval = null;
    let hasUnsavedChanges = false;
    let lastSaveTime = null;

    // Outreach state per campaign
    let outreachState = {
      campaignId: null,
      spotTarget: 16,
      selectedZips: [],
      categoryOrder: [],
      businesses: {} // { placeId: { status, attempt1Date, attempt2Date, notes, priority } }
    };

    // Preset category priority (most likely to advertise first)
    const DEFAULT_CATEGORY_PRIORITY = [
      'restaurant', 'restaurants', 'food', 'pizza', 'italian', 'mexican', 'chinese', 'thai', 'indian', 'japanese', 'sushi', 'american', 'bar', 'grill', 'cafe', 'coffee', 'bakery', 'deli',
      'hvac', 'heating', 'cooling', 'air conditioning', 'plumber', 'plumbing', 'electrician', 'electrical', 'roofing', 'roofer', 'contractor', 'handyman', 'landscaping', 'lawn', 'tree service', 'cleaning', 'maid', 'pest control',
      'auto', 'mechanic', 'auto repair', 'car wash', 'tire', 'oil change', 'body shop', 'detailing',
      'salon', 'hair', 'barber', 'spa', 'massage', 'nails', 'beauty', 'chiropractor', 'dentist', 'dental', 'doctor', 'medical', 'physical therapy', 'optometrist', 'veterinarian', 'vet',
      'insurance', 'accountant', 'accounting', 'lawyer', 'attorney', 'real estate', 'realtor', 'financial', 'tax',
      'gym', 'fitness', 'yoga', 'martial arts', 'dance', 'personal trainer',
      'pet', 'grooming', 'dog', 'cat', 'boarding', 'daycare',
      'retail', 'store', 'shop', 'boutique', 'florist', 'jewelry', 'gift'
    ];

    // Status definitions
    const STATUSES = {
      queue: { label: 'In Queue', color: 'gray', bg: 'bg-gray-100 text-gray-700' },
      attempt1: { label: 'Attempt 1', color: 'blue', bg: 'bg-blue-100 text-blue-700' },
      attempt2: { label: 'Attempt 2', color: 'orange', bg: 'bg-orange-100 text-orange-700' },
      sold: { label: 'SOLD', color: 'green', bg: 'bg-green-500 text-white' },
      declined: { label: 'Declined', color: 'red', bg: 'bg-red-100 text-red-700' },
      noResponse: { label: 'No Response', color: 'gray', bg: 'bg-gray-300 text-gray-600' },
      notInterested: { label: 'Not Interested', color: 'red', bg: 'bg-red-200 text-red-800' }
    };

    // Initialize
    async function init() {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error || !session) {
          showLoginRequired();
          return;
        }

        currentUser = session.user;
        document.getElementById('user-name').textContent = currentUser.email;

        await loadProspects();
        await loadCampaigns();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
      } catch (err) {
        console.error('Init error:', err);
        showLoginRequired();
      }
    }

    function showLoginRequired() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('login-required').classList.remove('hidden');
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = 'login.html';
    }

    function showToast(message, isSuccess = true) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${isSuccess ? 'bg-green-600' : 'bg-red-600'} text-white`;
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.transform = 'translateY(20px)';
        toast.style.opacity = '0';
      }, 3000);
    }

    // Load prospects from allProspectsFlat
    async function loadProspects() {
      try {
        const { data: flatData, error } = await supabaseClient
          .from('app_data')
          .select('data_type, data')
          .eq('user_email', currentUser.email)
          .like('data_type', 'allProspectsFlat%');

        if (!error && flatData && flatData.length > 0) {
          const meta = flatData.find(r => r.data_type === 'allProspectsFlat_meta');
          if (meta && meta.data?.chunkCount) {
            const chunks = flatData.filter(r => r.data_type.startsWith('allProspectsFlat_chunk_'));
            let combined = [];
            chunks.forEach(chunk => {
              if (Array.isArray(chunk.data)) combined = combined.concat(chunk.data);
            });
            allProspects = combined;
          } else {
            const flat = flatData.find(r => r.data_type === 'allProspectsFlat');
            if (flat && Array.isArray(flat.data)) allProspects = flat.data;
          }
        }

        // Filter to only those with emails
        allProspects = allProspects.filter(p => p.email && p.email.trim());
        console.log(`Loaded ${allProspects.length} prospects with emails`);
      } catch (err) {
        console.error('Error loading prospects:', err);
      }
    }

    // Load campaigns from campaign-boards
    async function loadCampaigns() {
      try {
        const { data, error } = await supabaseClient
          .from('app_data')
          .select('data')
          .eq('user_email', currentUser.email)
          .eq('data_type', 'campaign-boards')
          .single();

        if (!error && data && data.data) {
          campaigns = Object.entries(data.data).map(([id, board]) => ({
            id,
            name: board.name || id
          }));

          const select = document.getElementById('campaign-select');
          select.innerHTML = '<option value="">Select a campaign...</option>';
          campaigns.forEach(c => {
            select.innerHTML += `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`;
          });
        }
      } catch (err) {
        console.error('Error loading campaigns:', err);
      }
    }

    // Load saved outreach state for campaign
    async function loadCampaignState() {
      const campaignId = document.getElementById('campaign-select').value;
      if (!campaignId) {
        document.getElementById('categories-container').innerHTML = '<div class="text-center py-12 text-gray-500">Select a campaign to view outreach queue...</div>';
        return;
      }

      currentCampaign = campaignId;

      try {
        const { data, error } = await supabaseClient
          .from('app_data')
          .select('data')
          .eq('user_email', currentUser.email)
          .eq('data_type', `outreach-${campaignId}`)
          .single();

        if (!error && data && data.data) {
          outreachState = { ...outreachState, ...data.data, campaignId };
          document.getElementById('spot-target').value = outreachState.spotTarget || 16;
        } else {
          // Initialize new state
          outreachState = {
            campaignId,
            spotTarget: 16,
            selectedZips: [],
            categoryOrder: [],
            businesses: {}
          };
        }

        hasUnsavedChanges = false;
        updateSaveIndicator();
        setupAutoSave();
        populateZipFilter();
        renderCategories();
        updateSpotTracker();
      } catch (err) {
        console.error('Error loading campaign state:', err);
        outreachState = { campaignId, spotTarget: 16, selectedZips: [], categoryOrder: [], businesses: {} };
        hasUnsavedChanges = false;
        setupAutoSave();
        populateZipFilter();
        renderCategories();
      }
    }

    // Save outreach state
    async function saveState() {
      if (!currentCampaign) {
        showToast('Please select a campaign first', false);
        return;
      }

      outreachState.spotTarget = parseInt(document.getElementById('spot-target').value) || 16;

      try {
        const { error } = await supabaseClient
          .from('app_data')
          .upsert({
            user_email: currentUser.email,
            data_type: `outreach-${currentCampaign}`,
            data: outreachState
          }, { onConflict: 'user_email,data_type' });

        if (error) throw error;
        hasUnsavedChanges = false;
        lastSaveTime = new Date();
        updateSaveIndicator();
        showToast('Saved successfully!');
      } catch (err) {
        console.error('Error saving state:', err);
        showToast('Error saving', false);
      }
    }

    // Populate ZIP filter
    function populateZipFilter() {
      const zips = new Set();
      allProspects.forEach(p => {
        const zip = (p.zipCode || p.actualZip || p.zip || '').toString().substring(0, 5);
        if (zip && zip.length === 5) zips.add(zip);
      });

      const container = document.getElementById('zip-select');
      const sortedZips = [...zips].sort();

      container.innerHTML = `
        <label class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-blue-100 border border-blue-300 rounded cursor-pointer hover:bg-blue-200 ${outreachState.selectedZips.length === 0 ? 'ring-2 ring-blue-500' : ''}">
          <input type="checkbox" ${outreachState.selectedZips.length === 0 ? 'checked' : ''} onchange="toggleAllZips(this)" class="w-3 h-3">
          <span class="font-medium">ALL</span>
        </label>
      `;

      sortedZips.forEach(zip => {
        const checked = outreachState.selectedZips.includes(zip);
        container.innerHTML += `
          <label class="inline-flex items-center gap-1 px-2 py-1 text-xs bg-gray-100 border border-gray-300 rounded cursor-pointer hover:bg-gray-200 ${checked ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''}">
            <input type="checkbox" value="${zip}" ${checked ? 'checked' : ''} onchange="toggleZip(this)" class="w-3 h-3">
            <span>${zip}</span>
          </label>
        `;
      });
    }

    function toggleAllZips(checkbox) {
      if (checkbox.checked) {
        outreachState.selectedZips = [];
        markUnsaved();
        populateZipFilter();
        renderCategories();
      }
    }

    function toggleZip(checkbox) {
      const zip = checkbox.value;
      if (checkbox.checked) {
        if (!outreachState.selectedZips.includes(zip)) {
          outreachState.selectedZips.push(zip);
        }
      } else {
        outreachState.selectedZips = outreachState.selectedZips.filter(z => z !== zip);
      }
      markUnsaved();
      populateZipFilter();
      renderCategories();
    }

    // Get filtered prospects
    function getFilteredProspects() {
      return allProspects.filter(p => {
        // Filter by ZIP
        if (outreachState.selectedZips.length > 0) {
          const zip = (p.zipCode || p.actualZip || p.zip || '').toString().substring(0, 5);
          if (!outreachState.selectedZips.includes(zip)) return false;
        }
        // Exclude deleted/hidden businesses
        const state = getBusinessState(getProspectId(p));
        if (state.hidden || state.status === 'deleted') return false;
        return true;
      });
    }

    // Get business state
    function getBusinessState(id) {
      return outreachState.businesses[id] || { status: 'queue', priority: 999 };
    }

    // Update business state
    function updateBusinessState(id, updates) {
      if (!outreachState.businesses[id]) {
        outreachState.businesses[id] = { status: 'queue', priority: 999 };
      }
      Object.assign(outreachState.businesses[id], updates);
      markUnsaved();
      if (showContactedOnly) {
        renderContactedView();
      } else {
        renderCategories();
      }
      updateSpotTracker();
    }

    // Get category priority
    function getCategoryPriority(category) {
      const cat = (category || '').toLowerCase();
      for (let i = 0; i < DEFAULT_CATEGORY_PRIORITY.length; i++) {
        if (cat.includes(DEFAULT_CATEGORY_PRIORITY[i])) return i;
      }
      return 999;
    }

    // Render categories
    function renderCategories() {
      const prospects = getFilteredProspects();
      const container = document.getElementById('categories-container');

      // Group by category
      const categoryMap = {};
      prospects.forEach(p => {
        const category = p.category || 'Other';
        if (!categoryMap[category]) categoryMap[category] = [];
        categoryMap[category].push(p);
      });

      // Sort categories by priority
      const sortedCategories = Object.keys(categoryMap).sort((a, b) => {
        return getCategoryPriority(a) - getCategoryPriority(b);
      });

      if (sortedCategories.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No prospects with emails found for selected filters.</div>';
        return;
      }

      let html = '';
      sortedCategories.forEach((category, catIndex) => {
        const businesses = categoryMap[category];

        // Sort businesses within category by: status priority, then rating, then reviews
        businesses.sort((a, b) => {
          const stateA = getBusinessState(getProspectId(a));
          const stateB = getBusinessState(getProspectId(b));

          // Sold first, then active attempts, then queue
          const statusOrder = { sold: 0, attempt2: 1, attempt1: 2, queue: 3, declined: 4, noResponse: 5, notInterested: 6 };
          const orderA = statusOrder[stateA.status] ?? 3;
          const orderB = statusOrder[stateB.status] ?? 3;
          if (orderA !== orderB) return orderA - orderB;

          // Then by rating
          const ratingA = a.rating || 0;
          const ratingB = b.rating || 0;
          if (ratingB !== ratingA) return ratingB - ratingA;

          // Then by review count
          return (b.userRatingsTotal || 0) - (a.userRatingsTotal || 0);
        });

        // Count statuses
        const soldCount = businesses.filter(b => getBusinessState(getProspectId(b)).status === 'sold').length;
        const attemptingCount = businesses.filter(b => ['attempt1', 'attempt2'].includes(getBusinessState(getProspectId(b)).status)).length;

        // Find current target (first in queue or attempting)
        const currentTarget = businesses.find(b => {
          const status = getBusinessState(getProspectId(b)).status;
          return status === 'queue' || status === 'attempt1' || status === 'attempt2';
        });

        const categoryStatus = soldCount > 0 ? 'SOLD' : attemptingCount > 0 ? 'CONTACTING' : 'IN QUEUE';
        const categoryColor = soldCount > 0 ? 'green' : attemptingCount > 0 ? 'blue' : 'gray';

        html += `
          <div class="category-section bg-white rounded-xl shadow-md mb-4 overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-${categoryColor}-50 to-${categoryColor}-100 border-b cursor-pointer" onclick="toggleCategory(${catIndex})">
              <div class="flex items-center gap-3">
                <span class="text-xl">${getCategoryEmoji(category)}</span>
                <span class="font-bold text-gray-800">${escapeHtml(category)}</span>
                <span class="text-sm text-gray-500">(${businesses.length})</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="status-badge ${soldCount > 0 ? 'bg-green-500 text-white' : attemptingCount > 0 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600'}">
                  ${soldCount > 0 ? soldCount + ' SOLD' : categoryStatus}
                </span>
                <svg class="w-5 h-5 text-gray-400 transform transition-transform category-chevron-${catIndex}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </div>
            <div class="category-content category-content-${catIndex} p-4 space-y-3">
              ${businesses.map((b, bIndex) => renderBusinessCard(b, bIndex, currentTarget)).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Render business card
    function renderBusinessCard(business, index, currentTarget) {
      const id = getProspectId(business);
      const state = getBusinessState(id);
      const isTarget = currentTarget && getProspectId(currentTarget) === id;
      const status = STATUSES[state.status] || STATUSES.queue;

      // Check if ready for follow-up (3+ days since attempt1)
      let readyForFollowup = false;
      if (state.status === 'attempt1' && state.attempt1Date) {
        const daysSince = (Date.now() - new Date(state.attempt1Date).getTime()) / (1000 * 60 * 60 * 24);
        readyForFollowup = daysSince >= 3;
      }

      // Check if should suggest no response (3+ days since attempt2)
      let suggestNoResponse = false;
      if (state.status === 'attempt2' && state.attempt2Date) {
        const daysSince = (Date.now() - new Date(state.attempt2Date).getTime()) / (1000 * 60 * 60 * 24);
        suggestNoResponse = daysSince >= 3;
      }

      const isDone = ['sold', 'declined', 'noResponse', 'notInterested'].includes(state.status);

      return `
        <div class="business-card ${isTarget && !isDone ? 'current-target' : ''} ${isDone ? 'opacity-60' : ''} p-4 border rounded-lg ${isDone ? 'bg-gray-50' : 'bg-white'} hover:shadow-md">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                ${isTarget && !isDone ? '<span class="text-indigo-600 font-bold">‚Üí</span>' : `<span class="text-gray-400 text-sm">${index + 1}.</span>`}
                <span class="font-semibold text-gray-900">${escapeHtml(business.businessName || business.name || '')}</span>
                ${business.rating ? `<span class="text-yellow-500 text-sm">‚≠ê${business.rating}</span>` : ''}
                ${business.userRatingsTotal ? `<span class="text-gray-400 text-xs">(${business.userRatingsTotal})</span>` : ''}
              </div>
              <div class="flex items-center gap-3 text-sm flex-wrap">
                <a href="mailto:${escapeHtml(getDisplayEmail(business, state))}" class="text-blue-600 hover:underline">${escapeHtml(getDisplayEmail(business, state))}</a>
                <button onclick="copyEmail('${escapeHtml(getDisplayEmail(business, state))}')" class="text-gray-400 hover:text-gray-600" title="Copy email">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </button>
                <button onclick="openEditEmailModal('${id}', '${escapeHtml(getDisplayEmail(business, state))}')" class="text-gray-400 hover:text-blue-600" title="Edit email">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
                ${state.editedEmail ? '<span class="text-xs text-green-600">(edited)</span>' : ''}
                ${business.phone ? `<span class="text-gray-500">${escapeHtml(business.phone)}</span>` : ''}
                ${getBusinessZip(business) ? `<span class="text-gray-400 text-xs bg-gray-100 px-2 py-0.5 rounded">üìç ${getBusinessZip(business)}</span>` : ''}
              </div>
              ${business.website ? `<div class="mt-1 text-sm"><a href="${escapeHtml(business.website.startsWith('http') ? business.website : 'https://' + business.website)}" target="_blank" class="text-purple-600 hover:underline text-xs">üåê ${escapeHtml(truncateUrl(business.website))}</a></div>` : ''}
              ${state.notes ? `<div class="mt-2 text-sm text-gray-600 italic">"${escapeHtml(state.notes)}"</div>` : ''}
              ${state.attempt1Date || state.attempt2Date ? `
                <div class="mt-1 text-xs text-gray-400">
                  ${state.attempt1Date ? `Attempt 1: ${formatDate(state.attempt1Date)}` : ''}
                  ${state.attempt2Date ? ` | Attempt 2: ${formatDate(state.attempt2Date)}` : ''}
                </div>
              ` : ''}
              ${readyForFollowup ? '<div class="mt-1 text-xs text-orange-600 font-medium">‚è∞ Ready for follow-up!</div>' : ''}
              ${suggestNoResponse ? '<div class="mt-1 text-xs text-red-600 font-medium">‚ö†Ô∏è Consider marking No Response</div>' : ''}
            </div>
            <div class="flex flex-col items-end gap-2">
              <span class="status-badge ${status.bg}">${status.label}</span>
              <div class="flex flex-wrap gap-1 justify-end">
                ${!isDone ? `
                  ${state.status === 'queue' ? `
                    <button onclick="markAttempt1('${id}')" class="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">Attempt 1</button>
                  ` : ''}
                  ${state.status === 'attempt1' ? `
                    <button onclick="markAttempt2('${id}')" class="px-2 py-1 text-xs bg-orange-600 text-white rounded hover:bg-orange-700">Attempt 2</button>
                  ` : ''}
                  <button onclick="markSold('${id}')" class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">Sold</button>
                  <button onclick="markDeclined('${id}')" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">Declined</button>
                ` : ''}
                ${state.status === 'attempt2' ? `
                  <button onclick="markNoResponse('${id}')" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">No Response</button>
                ` : ''}
                <button onclick="openNotesModal('${id}')" class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Notes</button>
                <button onclick="deleteBusiness('${id}')" class="px-2 py-1 text-xs bg-gray-100 text-gray-500 rounded hover:bg-gray-200" title="Hide from list">üóëÔ∏è</button>
                <button onclick="markNotInterested('${id}')" class="px-2 py-1 text-xs bg-red-50 text-red-600 rounded hover:bg-red-100" title="Never contact">üö´</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Action functions
    function markAttempt1(id) {
      updateBusinessState(id, { status: 'attempt1', attempt1Date: new Date().toISOString() });
      showToast('Marked as Attempt 1');
    }

    function markAttempt2(id) {
      updateBusinessState(id, { status: 'attempt2', attempt2Date: new Date().toISOString() });
      showToast('Marked as Attempt 2');
    }

    function markSold(id) {
      updateBusinessState(id, { status: 'sold', soldDate: new Date().toISOString() });
      showToast('Marked as SOLD! üéâ');
    }

    function markDeclined(id) {
      updateBusinessState(id, { status: 'declined' });
      showToast('Marked as Declined');
    }

    function markNoResponse(id) {
      updateBusinessState(id, { status: 'noResponse' });
      showToast('Marked as No Response');
    }

    function markNotInterested(id) {
      if (confirm('Mark as Not Interested? This will hide the business from ALL future outreach.')) {
        updateBusinessState(id, { status: 'notInterested' });
        showToast('Marked as Not Interested');
        // TODO: Also update main app's notInterested list
      }
    }

    function deleteBusiness(id) {
      if (confirm('Hide this business from the list?')) {
        updateBusinessState(id, { status: 'deleted', hidden: true });
        renderCategories();
        showToast('Business hidden');
      }
    }

    function copyEmail(email) {
      navigator.clipboard.writeText(email);
      showToast('Email copied!');
    }

    // Toggle contacted view
    function toggleContactedView() {
      showContactedOnly = !showContactedOnly;
      const btn = document.getElementById('contacted-btn');
      if (showContactedOnly) {
        btn.textContent = 'View All';
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        renderContactedView();
      } else {
        btn.textContent = 'View Contacted';
        btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        renderCategories();
      }
    }

    // Render contacted view (all businesses that have been contacted)
    function renderContactedView() {
      const container = document.getElementById('categories-container');
      const contactedStatuses = ['attempt1', 'attempt2', 'sold', 'declined', 'noResponse', 'notInterested'];

      // Get all contacted businesses
      const contacted = [];
      allProspects.forEach(p => {
        const id = getProspectId(p);
        const state = getBusinessState(id);
        if (contactedStatuses.includes(state.status)) {
          contacted.push({ prospect: p, state, id });
        }
      });

      if (contacted.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No businesses have been contacted yet.</div>';
        return;
      }

      // Sort by status (sold first, then attempting, then others)
      const statusOrder = { sold: 0, attempt2: 1, attempt1: 2, declined: 3, noResponse: 4, notInterested: 5 };
      contacted.sort((a, b) => {
        const orderA = statusOrder[a.state.status] ?? 99;
        const orderB = statusOrder[b.state.status] ?? 99;
        if (orderA !== orderB) return orderA - orderB;
        // Then by most recent activity
        const dateA = a.state.attempt2Date || a.state.attempt1Date || '';
        const dateB = b.state.attempt2Date || b.state.attempt1Date || '';
        return dateB.localeCompare(dateA);
      });

      // Group by status for display
      const groups = {};
      contacted.forEach(c => {
        const status = c.state.status;
        if (!groups[status]) groups[status] = [];
        groups[status].push(c);
      });

      let html = '<div class="mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200"><h2 class="text-lg font-bold text-purple-800 mb-2">üìã All Contacted Businesses</h2><p class="text-sm text-purple-600">' + contacted.length + ' businesses contacted</p></div>';

      Object.entries(groups).forEach(([status, items]) => {
        const statusInfo = STATUSES[status] || STATUSES.queue;
        html += `
          <div class="bg-white rounded-xl shadow-md mb-4 overflow-hidden">
            <div class="px-4 py-3 bg-gray-50 border-b">
              <span class="font-bold text-gray-800">${statusInfo.label}</span>
              <span class="text-sm text-gray-500 ml-2">(${items.length})</span>
            </div>
            <div class="p-4 space-y-3">
              ${items.map((c, i) => renderBusinessCard(c.prospect, i, null)).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Edit email modal
    function openEditEmailModal(id, currentEmail) {
      const business = allProspects.find(p => getProspectId(p) === id);
      const name = business ? (business.businessName || business.name || 'Business') : 'Business';

      document.getElementById('edit-email-business-id').value = id;
      document.getElementById('edit-email-business-name').textContent = name;
      document.getElementById('edit-email-input').value = currentEmail || '';
      document.getElementById('edit-email-modal').classList.remove('hidden');
      document.getElementById('edit-email-modal').classList.add('flex');
      document.getElementById('edit-email-input').focus();
    }

    function closeEditEmailModal() {
      document.getElementById('edit-email-modal').classList.add('hidden');
      document.getElementById('edit-email-modal').classList.remove('flex');
    }

    function saveEditedEmail() {
      const id = document.getElementById('edit-email-business-id').value;
      const newEmail = document.getElementById('edit-email-input').value.trim();

      // Update the email in allProspects array
      const business = allProspects.find(p => getProspectId(p) === id);
      if (business) {
        business.email = newEmail;
      }

      // Also store in outreach state for persistence
      if (!outreachState.businesses[id]) {
        outreachState.businesses[id] = { status: 'queue', priority: 999 };
      }
      outreachState.businesses[id].editedEmail = newEmail;

      markUnsaved();
      closeEditEmailModal();
      if (showContactedOnly) {
        renderContactedView();
      } else {
        renderCategories();
      }
      showToast('Email updated');
    }

    // Notes modal
    function openNotesModal(id) {
      const state = getBusinessState(id);
      document.getElementById('notes-business-id').value = id;
      document.getElementById('notes-text').value = state.notes || '';
      document.getElementById('notes-modal').classList.remove('hidden');
      document.getElementById('notes-modal').classList.add('flex');
    }

    function closeNotesModal() {
      document.getElementById('notes-modal').classList.add('hidden');
      document.getElementById('notes-modal').classList.remove('flex');
    }

    function saveNotes() {
      const id = document.getElementById('notes-business-id').value;
      const notes = document.getElementById('notes-text').value;
      updateBusinessState(id, { notes });
      closeNotesModal();
      showToast('Notes saved');
    }

    // Toggle category collapse
    function toggleCategory(index) {
      const content = document.querySelector(`.category-content-${index}`);
      const chevron = document.querySelector(`.category-chevron-${index}`);
      content.classList.toggle('collapsed');
      chevron.classList.toggle('rotate-180');
    }

    // Update spot tracker
    function updateSpotTracker() {
      const target = parseInt(document.getElementById('spot-target').value) || 16;
      const soldCount = Object.values(outreachState.businesses).filter(b => b.status === 'sold').length;
      const attemptingCount = Object.values(outreachState.businesses).filter(b => ['attempt1', 'attempt2'].includes(b.status)).length;
      const queueCount = getFilteredProspects().filter(p => {
        const state = getBusinessState(getProspectId(p));
        return state.status === 'queue';
      }).length;

      document.getElementById('spots-filled').textContent = soldCount;
      document.getElementById('spots-target').textContent = target;
      document.getElementById('stat-sold').textContent = soldCount;
      document.getElementById('stat-attempting').textContent = attemptingCount;
      document.getElementById('stat-queue').textContent = queueCount;

      const percent = Math.min((soldCount / target) * 100, 100);
      document.getElementById('spot-progress').style.width = `${percent}%`;
    }

    // Export functions
    function exportFullCSV() {
      const prospects = getFilteredProspects();
      if (prospects.length === 0) {
        showToast('No prospects to export', false);
        return;
      }

      const headers = ['Category', 'Business Name', 'Email', 'Phone', 'Rating', 'Status', 'Attempt 1', 'Attempt 2', 'Notes', 'Address', 'Website'];
      const rows = prospects.map(p => {
        const state = getBusinessState(getProspectId(p));
        return [
          p.category || '',
          p.businessName || p.name || '',
          p.email || '',
          p.phone || '',
          p.rating || '',
          STATUSES[state.status]?.label || 'In Queue',
          state.attempt1Date ? formatDate(state.attempt1Date) : '',
          state.attempt2Date ? formatDate(state.attempt2Date) : '',
          state.notes || '',
          p.address || '',
          p.website || ''
        ];
      });

      downloadCSV(headers, rows, `outreach-full-${currentCampaign || 'export'}`);
    }

    function exportContactSheet() {
      const prospects = getFilteredProspects();

      // Group by category and get current target for each
      const categoryMap = {};
      prospects.forEach(p => {
        const category = p.category || 'Other';
        const state = getBusinessState(getProspectId(p));
        if (!categoryMap[category]) categoryMap[category] = [];
        if (['queue', 'attempt1', 'attempt2'].includes(state.status)) {
          categoryMap[category].push(p);
        }
      });

      // Get first (current target) from each category
      const contactSheet = [];
      Object.keys(categoryMap).sort((a, b) => getCategoryPriority(a) - getCategoryPriority(b)).forEach(category => {
        if (categoryMap[category].length > 0) {
          const target = categoryMap[category][0];
          const state = getBusinessState(getProspectId(target));
          contactSheet.push({
            category,
            business: target,
            state
          });
        }
      });

      if (contactSheet.length === 0) {
        showToast('No active targets to export', false);
        return;
      }

      const headers = ['Category', 'Business Name', 'Email', 'Phone', 'Status', 'Notes'];
      const rows = contactSheet.map(c => [
        c.category,
        c.business.businessName || c.business.name || '',
        c.business.email || '',
        c.business.phone || '',
        STATUSES[c.state.status]?.label || 'In Queue',
        c.state.notes || ''
      ]);

      downloadCSV(headers, rows, `contact-sheet-${currentCampaign || 'export'}`);
    }

    function downloadCSV(headers, rows, filename) {
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      showToast('CSV exported!');
    }

    // Helpers
    function getProspectId(p) {
      return p.placeId || p.id || p.businessName || '';
    }

    function getBusinessZip(p) {
      const zip = (p.zipCode || p.actualZip || p.zip || '').toString();
      return zip.substring(0, 5);
    }

    function truncateUrl(url) {
      if (!url) return '';
      // Remove protocol and www
      let clean = url.replace(/^https?:\/\//, '').replace(/^www\./, '');
      // Remove trailing slash
      clean = clean.replace(/\/$/, '');
      // Truncate if too long
      if (clean.length > 35) {
        clean = clean.substring(0, 35) + '...';
      }
      return clean;
    }

    function getDisplayEmail(business, state) {
      // Use edited email if available, otherwise original
      return state.editedEmail || business.email || '';
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function getCategoryEmoji(category) {
      const cat = (category || '').toLowerCase();
      if (cat.includes('pizza') || cat.includes('italian')) return 'üçï';
      if (cat.includes('mexican') || cat.includes('taco')) return 'üåÆ';
      if (cat.includes('chinese') || cat.includes('asian')) return 'ü•°';
      if (cat.includes('restaurant') || cat.includes('food') || cat.includes('grill')) return 'üçΩÔ∏è';
      if (cat.includes('bar') || cat.includes('pub')) return 'üç∫';
      if (cat.includes('coffee') || cat.includes('cafe')) return '‚òï';
      if (cat.includes('bakery')) return 'ü•ê';
      if (cat.includes('plumb')) return 'üîß';
      if (cat.includes('hvac') || cat.includes('heat') || cat.includes('cool')) return '‚ùÑÔ∏è';
      if (cat.includes('electric')) return '‚ö°';
      if (cat.includes('roof')) return 'üè†';
      if (cat.includes('landscap') || cat.includes('lawn')) return 'üåø';
      if (cat.includes('auto') || cat.includes('mechanic') || cat.includes('car')) return 'üöó';
      if (cat.includes('salon') || cat.includes('hair') || cat.includes('barber')) return 'üíá';
      if (cat.includes('spa') || cat.includes('massage')) return 'üíÜ';
      if (cat.includes('dental') || cat.includes('dentist')) return 'ü¶∑';
      if (cat.includes('chiro')) return 'ü¶¥';
      if (cat.includes('vet') || cat.includes('pet')) return 'üêæ';
      if (cat.includes('gym') || cat.includes('fitness')) return 'üí™';
      if (cat.includes('yoga')) return 'üßò';
      if (cat.includes('insurance')) return 'üõ°Ô∏è';
      if (cat.includes('account') || cat.includes('tax')) return 'üìä';
      if (cat.includes('lawyer') || cat.includes('attorney')) return '‚öñÔ∏è';
      if (cat.includes('real estate')) return 'üè°';
      return 'üè¢';
    }

    // Auto-save setup
    function setupAutoSave() {
      // Clear any existing interval
      if (autoSaveInterval) clearInterval(autoSaveInterval);

      // Auto-save every 30 seconds if there are unsaved changes
      autoSaveInterval = setInterval(() => {
        if (hasUnsavedChanges && currentCampaign) {
          autoSave();
        }
      }, 30000);
    }

    async function autoSave() {
      if (!currentCampaign || !hasUnsavedChanges) return;

      try {
        outreachState.spotTarget = parseInt(document.getElementById('spot-target').value) || 16;

        const { error } = await supabaseClient
          .from('app_data')
          .upsert({
            user_email: currentUser.email,
            data_type: `outreach-${currentCampaign}`,
            data: outreachState
          }, { onConflict: 'user_email,data_type' });

        if (!error) {
          hasUnsavedChanges = false;
          lastSaveTime = new Date();
          updateSaveIndicator();
          showToast('Auto-saved');
        }
      } catch (err) {
        console.error('Auto-save error:', err);
      }
    }

    function updateSaveIndicator() {
      const btn = document.querySelector('button[onclick="saveState()"]');
      if (hasUnsavedChanges) {
        btn.textContent = 'Save *';
        btn.classList.add('ring-2', 'ring-yellow-400');
      } else {
        btn.textContent = 'Save';
        btn.classList.remove('ring-2', 'ring-yellow-400');
      }
    }

    function markUnsaved() {
      hasUnsavedChanges = true;
      updateSaveIndicator();
    }

    // Save before leaving page
    window.addEventListener('beforeunload', (e) => {
      if (hasUnsavedChanges && currentCampaign) {
        // Try to save synchronously using sendBeacon
        const data = JSON.stringify({
          user_email: currentUser?.email,
          data_type: `outreach-${currentCampaign}`,
          data: outreachState
        });

        // Use sendBeacon for reliable save on page unload
        navigator.sendBeacon && navigator.sendBeacon(
          `${SUPABASE_URL}/rest/v1/app_data?on_conflict=user_email,data_type`,
          new Blob([data], { type: 'application/json' })
        );

        // Also show confirmation dialog
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    // Also save on visibility change (when user switches tabs)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden' && hasUnsavedChanges && currentCampaign) {
        autoSave();
      }
    });

    // Start app
    init();
  </script>
</body>
</html>
