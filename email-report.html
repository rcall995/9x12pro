<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Report Generator | 9x12 Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      table { font-size: 10pt; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Loading State -->
  <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Loading...</p>
    </div>
  </div>

  <!-- Login Required -->
  <div id="login-required" class="hidden fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center p-8">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Login Required</h1>
      <p class="text-gray-600 mb-6">Please log in to 9x12 Pro to access this report.</p>
      <a href="login.html" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
        Go to Login
      </a>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg no-print">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="app.html" class="text-white/80 hover:text-white text-sm">&larr; Back to App</a>
          <h1 class="text-xl font-bold">Email Report Generator</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="user-name" class="text-sm text-white/90"></span>
          <button onclick="logout()" class="px-4 py-2 text-sm bg-white/20 rounded-lg hover:bg-white/30 transition">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 py-6 no-print">
      <div class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Filter Prospects</h2>
        <div class="flex flex-wrap gap-4 items-end">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
            <input type="text" id="filter-zip" placeholder="All ZIP codes"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select id="filter-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button onclick="applyFilters()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
              Apply Filters
            </button>
            <button onclick="clearFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats & Actions -->
    <div class="max-w-7xl mx-auto px-4 pb-4 no-print">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <div class="bg-white rounded-lg shadow px-4 py-2">
            <span class="text-gray-500 text-sm">Total Prospects:</span>
            <span id="stat-total" class="font-bold text-gray-800 ml-1">0</span>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-2">
            <span class="text-green-700 text-sm">With Emails:</span>
            <span id="stat-emails" class="font-bold text-green-800 ml-1">0</span>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="exportCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export CSV
          </button>
          <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
            </svg>
            Print
          </button>
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <div class="max-w-7xl mx-auto px-4 pb-8">
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Business Name</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Phone</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Address</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ZIP</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Category</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Website</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Social</th>
              </tr>
            </thead>
            <tbody id="results-body" class="divide-y divide-gray-100">
              <tr>
                <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                  Loading prospects...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase config (same as main app)
    const SUPABASE_URL = "https://kurhsdvxsgkgnfimfqdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1cmhzZHZ4c2drZ25maW1mcWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDk3NDYsImV4cCI6MjA3ODM4NTc0Nn0.nB_GsE89WJ3eAQrgmNKb-fbCktHTHf-987D-G6lscZA";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allProspects = [];
    let filteredProspects = [];

    // Initialize app
    async function init() {
      try {
        // Check auth
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error || !session) {
          showLoginRequired();
          return;
        }

        currentUser = session.user;
        document.getElementById('user-name').textContent = currentUser.email;

        // Load prospects
        await loadProspects();

        // Show app
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');

      } catch (err) {
        console.error('Init error:', err);
        showLoginRequired();
      }
    }

    function showLoginRequired() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('login-required').classList.remove('hidden');
    }

    async function logout() {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    }

    async function loadProspects() {
      try {
        // Load from Supabase app_data table
        const { data, error } = await supabase
          .from('app_data')
          .select('data')
          .eq('user_email', currentUser.email)
          .eq('data_type', 'manualProspects')
          .single();

        if (error && error.code !== 'PGRST116') {
          throw error;
        }

        allProspects = data?.data || [];

        // Populate category filter
        populateCategories();

        // Apply initial filter (only show those with emails)
        applyFilters();

      } catch (err) {
        console.error('Error loading prospects:', err);
        document.getElementById('results-body').innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-red-500">
              Error loading prospects. Please try again.
            </td>
          </tr>
        `;
      }
    }

    function populateCategories() {
      const categories = new Set();
      allProspects.forEach(p => {
        if (p.category) {
          // Handle comma-separated categories
          const cats = p.category.split(',').map(c => c.trim());
          cats.forEach(c => categories.add(c));
        }
      });

      const select = document.getElementById('filter-category');
      const sortedCategories = [...categories].sort();

      sortedCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    function applyFilters() {
      const zipFilter = document.getElementById('filter-zip').value.trim();
      const categoryFilter = document.getElementById('filter-category').value;

      // Filter prospects: must have email
      filteredProspects = allProspects.filter(p => {
        // Must have email
        if (!p.email || !p.email.trim()) return false;

        // ZIP filter
        if (zipFilter) {
          const prospectZip = (p.zipCode || p.actualZip || p.zip || '').toString().substring(0, 5);
          if (!prospectZip.includes(zipFilter)) return false;
        }

        // Category filter
        if (categoryFilter) {
          const categories = (p.category || '').toLowerCase();
          if (!categories.includes(categoryFilter.toLowerCase())) return false;
        }

        return true;
      });

      // Update stats
      const totalWithEmail = allProspects.filter(p => p.email && p.email.trim()).length;
      document.getElementById('stat-total').textContent = allProspects.length;
      document.getElementById('stat-emails').textContent = totalWithEmail;

      // Render table
      renderTable();
    }

    function clearFilters() {
      document.getElementById('filter-zip').value = '';
      document.getElementById('filter-category').value = '';
      applyFilters();
    }

    function renderTable() {
      const tbody = document.getElementById('results-body');

      if (filteredProspects.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              No prospects with email addresses found matching your filters.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredProspects.map(p => {
        const zip = p.zipCode || p.actualZip || p.zip || '';
        const social = [];
        if (p.facebook) social.push(`<a href="${escapeHtml(p.facebook)}" target="_blank" class="text-blue-600 hover:underline">FB</a>`);
        if (p.instagram) social.push(`<a href="${escapeHtml(p.instagram)}" target="_blank" class="text-pink-600 hover:underline">IG</a>`);
        if (p.linkedin) social.push(`<a href="${escapeHtml(p.linkedin)}" target="_blank" class="text-blue-800 hover:underline">LI</a>`);
        if (p.twitter) social.push(`<a href="${escapeHtml(p.twitter)}" target="_blank" class="text-sky-500 hover:underline">X</a>`);

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${escapeHtml(p.businessName || p.name || '')}</td>
            <td class="px-4 py-3 text-sm text-blue-600">
              <a href="mailto:${escapeHtml(p.email)}" class="hover:underline">${escapeHtml(p.email)}</a>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(p.phone || '')}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(p.address || '')}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(zip)}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${escapeHtml(p.category || '')}</td>
            <td class="px-4 py-3 text-sm">
              ${p.website ? `<a href="${escapeHtml(p.website)}" target="_blank" class="text-blue-600 hover:underline truncate block max-w-[150px]">${escapeHtml(getDomain(p.website))}</a>` : ''}
            </td>
            <td class="px-4 py-3 text-sm">${social.join(' ')}</td>
          </tr>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getDomain(url) {
      try {
        const parsed = new URL(url.startsWith('http') ? url : 'https://' + url);
        return parsed.hostname.replace('www.', '');
      } catch {
        return url;
      }
    }

    function exportCSV() {
      if (filteredProspects.length === 0) {
        alert('No prospects to export.');
        return;
      }

      // CSV headers
      const headers = [
        'Business Name',
        'Email',
        'Phone',
        'Address',
        'City',
        'State',
        'ZIP',
        'Category',
        'Website',
        'Facebook',
        'Instagram',
        'LinkedIn',
        'Twitter',
        'Contact Name'
      ];

      // CSV rows
      const rows = filteredProspects.map(p => [
        p.businessName || p.name || '',
        p.email || '',
        p.phone || '',
        p.address || '',
        p.city || '',
        p.state || '',
        p.zipCode || p.actualZip || p.zip || '',
        p.category || '',
        p.website || '',
        p.facebook || '',
        p.instagram || '',
        p.linkedin || '',
        p.twitter || '',
        p.contactName || ''
      ]);

      // Build CSV content
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
      ].join('\n');

      // Download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;

      // Filename with date
      const date = new Date().toISOString().split('T')[0];
      const zipFilter = document.getElementById('filter-zip').value.trim();
      const categoryFilter = document.getElementById('filter-category').value;
      let filename = `email-leads-${date}`;
      if (zipFilter) filename += `-${zipFilter}`;
      if (categoryFilter) filename += `-${categoryFilter.replace(/\s+/g, '-')}`;
      filename += '.csv';

      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // Start app
    init();
  </script>
</body>
</html>
