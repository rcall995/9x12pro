<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>9x12 Pro - Community Card Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Maps API callback must be defined BEFORE script loads -->
  <script>
    window.googleMapsLoaded = false;
    window.initGoogleMaps = function() {
      window.googleMapsLoaded = true;
    };
  </script>
  <!-- Google Maps JavaScript API with Places Library -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNzXL-8UT-JI1Dy9wBN14KtH-UDMbeOlo&libraries=places&callback=initGoogleMaps" async defer></script>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><circle cx=%228%22 cy=%228%22 r=%226%22 fill=%22%23333%22/></svg>">
  <style>
    /* Core card */
    .card{border-width:2px;border-radius:.75rem;padding:.85rem;text-align:center;font-weight:600;position:relative;display:flex;align-items:center;justify-content:center;user-select:none;animation:fadeIn .25s ease-in-out;outline-offset:2px;z-index:1;transition:transform .15s ease,box-shadow .15s ease,outline .15s ease}
    .card:hover{filter:brightness(.98)}
    .spot-label{position:absolute;top:6px;left:8px;font-size:.7rem;font-weight:700;opacity:.65}
    .status-badge{position:absolute;bottom:6px;right:8px;font-size:.7rem;padding:6px 10px;border-radius:9999px;background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.06);color:#0f172a;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .price-badge{position:absolute;top:6px;right:8px;font-size:.7rem;padding:4px 8px;border-radius:9999px;background:rgba(34,197,94,.92);color:white;font-weight:700;box-shadow:0 2px 6px rgba(34,197,94,.3)}
    .selected-pill{position:absolute;top:50%;right:8px;font-size:.65rem;padding:4px 8px;border-radius:9999px;background:rgba(59,130,246,.95);color:white;font-weight:700;box-shadow:0 6px 14px rgba(59,130,246,.12);transform:translateY(-50%)}
    .selected{outline:4px solid rgba(59,130,246,.95);box-shadow:0 18px 40px rgba(2,6,23,.25);transform:scale(1.01)}
    .banner{font-weight:800}
    .grid-front,.grid-back{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      grid-template-rows:40fr 14fr 40fr;
      gap:.5rem;
      width:100%;
      box-sizing:border-box;
      aspect-ratio:12/9;
    }
    .col-span-2{grid-column:span 2 / span 2}
    .col-span-4{grid-column:span 4 / span 4}
    @keyframes fadeIn{from{opacity:0;transform:scale(.985)}to{opacity:1;transform:scale(1)}}
    @media (max-width:900px){.grid-front,.grid-back{grid-template-columns:repeat(2,1fr);aspect-ratio:unset}}
    @media (max-width:600px){
        .grid-front,.grid-back{grid-template-columns:1fr;aspect-ratio:unset}
        .card{min-height:110px;padding:1rem}
        .spot-label{font-size:.8rem;top:8px;left:10px}
        .status-badge{font-size:.75rem;padding:7px 11px;bottom:8px;right:10px}
    }
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem}
    .modal{width:100%;max-width:560px;max-height:90vh;overflow-y:auto;background:#fff;border-radius:.75rem;border:1px solid #e5e7eb;box-shadow:0 20px 40px rgba(0,0,0,.18);padding:1rem}
    .modal.show{display:flex!important}
    @media (max-width:640px){
        .modal{max-height:95vh;border-radius:.5rem;padding:.75rem}
        .modal-backdrop{padding:.5rem}
    }
    
    /* OVERLAY EDIT BUTTON - appears on top of selected card */
    .card-edit-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .card.selected .card-edit-overlay {
      opacity: 1;
      pointer-events: all;
    }
    .card-edit-overlay button {
      padding: 0.5rem 1rem;
      background: rgba(37, 99, 235, 0.95);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 700;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.3);
      cursor: pointer;
      font-size: 0.875rem;
    }
    .card-edit-overlay button:hover {
      background: rgba(29, 78, 216, 0.95);
    }
    
    .toast{position:fixed;bottom:22px;right:22px;z-index:50;padding:.6rem .9rem;border-radius:.6rem;color:#fff;box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .toast-ok{background:#059669}.toast-warn{background:#b45309}
    @media print{#legendArea,.toast{display:none!important}}
    #legendGrid{
      display:flex;
      gap:.6rem;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      padding-top:.25rem;
      max-width:48rem;
    }
    .legend-item{display:flex;align-items:center;gap:.5rem;padding:.2rem .35rem;border-radius:.4rem;background:transparent}
    .legend-dot{width:10px;height:10px;border-radius:9999px;display:inline-block;flex:0 0 auto}
    .postcard {
      background: #000000;
      border: 1px solid #e5e7eb;
      border-radius: 0;
      padding: .75rem;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      transition: background-color .15s ease, border-color .15s ease;
      position: relative;
    }
    .postcard .card { border-radius: .5rem; }
    .placeholder {
        background: #fdfdfd;
        border: 1px dashed #d1d5db;
        color: #9ca3af;
        font-style: normal;
        font-weight: 500;
        opacity: 1;
    }
    .header-controls { display:flex; gap:.5rem; align-items:center; }
    .color-preview { width:18px; height:18px; border-radius:4px; border:1px solid #e5e7eb; display:inline-block; vertical-align:middle }
    .color-label { font-size:0.85rem; color:#374151; margin-right:4px }
    .banner-text {
      display: inline-block;
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: clamp(1.2rem, 1.6vw + 1rem, 2rem);
      line-height: 1;
    }
    .sort-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid #eef2f7}
    .sort-controls button{padding:6px 8px;border-radius:6px;background:#f8fafc;border:1px solid #e6eef4;cursor:pointer}
    .tab-pane { padding-top: 0.5rem; }
    .tab-pane.hidden { display: none; }
    .tab-btn {
        border-color: transparent;
        color: #6b7280;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
        border-radius: 0.375rem 0.375rem 0 0;
        margin-bottom: -2px;
        font-weight: 600;
    }
    .tab-btn:hover:not(.active) {
        color: #374151;
        background-color: #f3f4f6;
    }
    .tab-btn.active {
        border-bottom: 2px solid #4f46e5;
        color: #1f2937;
        background-color: white;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    .dashboard-widget {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .metric-value {
        font-size: 2.25rem;
        font-weight: 700;
    }
    .metric-label {
        color: #6b7280;
        font-weight: 500;
    }
    .kanban-column {
        min-height: 150px;
        background-color: #f3f4f6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-grow: 1;
        min-width: 200px;
        flex-shrink: 0;
    }
    #salesActivityContainer {
        display: flex;
        gap: 1rem;
        padding-bottom: 0.5rem;
        overflow-x: auto;
        scrollbar-width: thin;
        -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 1024px) {
        #salesActivityContainer {
            flex-wrap: wrap;
            overflow-x: visible;
        }
        .kanban-column {
            flex-shrink: 1;
        }
    }
    .control-btn {
        background-color: white;
        color: #1f2937;
        font-weight: 700;
        border: 1px solid #d1d5db;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .control-btn:hover {
        background-color: #f3f4f6;
    }
    #legendContainer {
        display: flex;
        justify-content: flex-start;
        width: 100%;
        margin-bottom: 1rem;
    }
    .task-item {
        cursor: grab;
        padding: 0.5rem;
        border-radius: 0.375rem;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
    }
    .task-item.dragging {
        opacity: 0.5;
        border: 1px dashed #4f46e5;
    }
    .kanban-item {
      cursor: grab;
      transition: opacity 0.2s;
    }
    .kanban-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .card > div:not(.spot-label):not(.status-badge):not(.selected-pill):not(.price-badge):not(.card-edit-overlay) {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 100%;
    }
    .task-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
      cursor: grab;
      transition: opacity 0.2s;
    }
    .task-row.dragging {
      opacity: 0.5;
      border: 1px dashed #4f46e5;
    }
    .task-row.completed {
      opacity: 0.6;
    }
    .task-row.completed .task-text {
      text-decoration: line-through;
      color: #9ca3af;
    }
    .task-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .task-text {
      flex: 1;
      margin-right: 1rem;
    }
    .task-date {
      font-size: 0.875rem;
      color: #6b7280;
      min-width: 120px;
    }
    .overdue { color: #dc2626; font-weight: bold; }
    #taskList {
      min-height: 200px;
    }
    
    /* Client row styles */
    .client-row {
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .client-row:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
  <!-- Inline script to set initial tab state before page renders -->
  <script>
    (function() {
      // Hide all tabs initially to prevent flash
      document.addEventListener('DOMContentLoaded', function() {
        const savedTab = localStorage.getItem('9x12_active_tab') || 'pipeline';

        // Hide all tabs and deactivate all buttons
        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.classList.add('hidden');
          pane.classList.remove('active-pane');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        // Show the saved tab
        const activePane = document.querySelector(`.tab-pane[data-content="${savedTab}"]`);
        const activeBtn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);

        if (activePane) {
          activePane.classList.remove('hidden');
          activePane.classList.add('active-pane');
        }
        if (activeBtn) {
          activeBtn.classList.add('active');
        }
      });
    })();
  </script>
  <iframe name="saveFrame" style="display:none"></iframe>
  <form id="saveForm" target="saveFrame" style="display:none" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="payload" id="payloadField" />
  </form>
  <header class="bg-white shadow px-4 py-3 flex flex-col md:flex-row md:justify-between md:items-center gap-3 sticky top-0 z-30">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <span class="text-indigo-600 font-black">9√ó12</span>
      <span class="font-bold">PRO</span>
    </h1>

    <!-- Current Postcard Selector (Main Control) - Split into Town and Month -->
    <div class="flex-1 flex justify-center">
      <div class="flex flex-col md:flex-row items-center gap-2">
        <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Town:</label>
        <select id="headerTownSelect" onchange="onTownChanged()" class="border-2 border-indigo-300 rounded-lg px-3 py-2 bg-white text-sm font-medium hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" style="min-width: 150px;">
          <option value="">‚Äî Select Town ‚Äî</option>
        </select>
        <label class="text-sm font-semibold text-gray-700 whitespace-nowrap">Month:</label>
        <select id="headerMonthSelect" onchange="updatePostcardFromSelectors()" class="border-2 border-indigo-300 rounded-lg px-3 py-2 bg-white text-sm font-medium hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" style="min-width: 150px;">
          <option value="">‚Äî Select Month ‚Äî</option>
        </select>
      </div>
    </div>

    <div class="flex items-center gap-2 md:gap-3">
      <!-- Auto-Save Status Indicator (Compact) -->
      <div id="autoSaveStatus" class="flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-gray-50 border">
        <span id="autoSaveIcon">‚úì</span>
        <span id="autoSaveText" class="hidden lg:inline">Saved</span>
      </div>
      <button id="btnManualSave" onclick="manualSaveNow()" class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs hover:bg-blue-700 font-medium hidden">
        <span class="hidden sm:inline">‚òÅÔ∏è</span>
      </button>
      <button onclick="openReportsModal()" class="px-2 py-1.5 md:px-3 bg-purple-600 text-white rounded-md text-xs md:text-sm hover:bg-purple-700">
        <span class="hidden sm:inline">üìä Reports</span>
        <span class="sm:hidden">üìä</span>
      </button>
      <button onclick="openEmailModal()" class="px-2 py-1.5 md:px-3 bg-blue-600 text-white rounded-md text-xs md:text-sm hover:bg-blue-700">
        <span class="hidden sm:inline">‚úâÔ∏è Email</span>
        <span class="sm:hidden">‚úâÔ∏è</span>
      </button>
    </div>
  </header>
  <main class="max-w-6xl mx-auto mt-6 px-3 pb-20">
    <div class="flex border-b border-gray-300 mb-6 overflow-x-auto" id="navTabs" style="scrollbar-width: thin;">
        <button data-tab="pipeline" class="tab-btn active px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">Dashboard & Pipeline</span>
            <span class="sm:hidden">Dashboard</span>
        </button>
        <button data-tab="prospects" class="tab-btn px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">üîç Prospect Pool</span>
            <span class="sm:hidden">Prospects</span>
        </button>
        <button data-tab="lead-generation" class="tab-btn px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">üéØ Lead Generation</span>
            <span class="sm:hidden">Leads</span>
        </button>
        <button data-tab="manager" class="tab-btn px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">Postcards & Activation</span>
            <span class="sm:hidden">Postcards</span>
        </button>
        <button data-tab="clients" class="tab-btn px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">Client Database</span>
            <span class="sm:hidden">Clients</span>
        </button>
        <button data-tab="admin" class="tab-btn px-3 md:px-4 py-2 text-xs md:text-sm whitespace-nowrap">
            <span class="hidden sm:inline">Production Admin</span>
            <span class="sm:hidden">Admin</span>
        </button>
        <div class="flex-grow"></div>
        <div id="quickControls" class="flex items-center gap-2"></div>
    </div>
    <div id="tabContent">
       
        <div data-content="pipeline" class="tab-pane active-pane">
            <div class="mb-6">
                <h3 class="text-lg md:text-xl font-bold">Sales & Performance Dashboard</h3>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                
                <div class="dashboard-widget">
                    <div class="metric-label">Slots Sold (Current Card)</div>
                    <div class="flex items-baseline gap-2">
                        <div class="metric-value text-indigo-600" id="slotsSoldMetric">0/18</div>
                        <span class="text-sm text-gray-500" id="slotsSoldPercent"></span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
                        <div id="slotsSoldBar" class="h-2 bg-indigo-500 rounded-full transition-all duration-300" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="dashboard-widget">
                    <div class="metric-label">Revenue Progress</div>
                    <div class="metric-value text-green-600" id="currentRevenue">$0</div>
                    <p class="text-sm text-gray-500 mt-1" id="revenueProgressText">of $9,000 goal</p>
                    <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
                        <div id="revenueProgressBar" class="h-2 bg-green-500 rounded-full transition-all duration-300" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="dashboard-widget">
                    <div class="metric-label">Current Profit/Loss</div>
                    <div id="profitStatus" class="metric-value text-gray-400">$0</div>
                    <p class="text-sm text-gray-500 mt-1" id="spotsToBreakeven">Select a postcard</p>
                </div>
                
                <div class="dashboard-widget cursor-pointer hover:shadow-lg transition-shadow" onclick="openExpenseModal()">
                    <div class="metric-label flex justify-between items-center">
                        <span>Total Expenses</span>
                        <span class="text-xs text-blue-600 font-semibold">‚úé Edit</span>
                    </div>
                    <div class="metric-value text-orange-600" id="totalExpenses">$0</div>
                    <p class="text-sm text-gray-500 mt-1">Click to manage expenses</p>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-6">
               
                <div class="dashboard-widget">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-gray-800">Tasks Due & Renewal Nudges</h4>
                        <button onclick="openTaskModal()" class="px-3 py-1.5 bg-indigo-600 text-white rounded-md text-sm hover:bg-indigo-700">
                            + Add Task
                        </button>
                    </div>
                    <p id="overdueText" class="text-sm text-gray-500 mb-2">Loading...</p>
                    <div id="taskList" class="space-y-2 text-sm text-gray-700">
                        <!-- Tasks dynamically populated -->
                    </div>
                </div>

                <!-- AUTO-POPULATE PROSPECTS SECTION -->
                <div class="dashboard-widget">
                    <h4 class="font-semibold mb-4 text-gray-800">Weekly Sales Activity (Kanban View)</h4>
                   
                    <div id="salesActivityContainer">
                        <!-- Kanban columns dynamically populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PROSPECT POOL TAB -->
        <div data-content="prospects" class="tab-pane hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-bold">Prospect Pool Management</h3>
                    <p class="text-sm text-gray-600 mt-1">Review and manage all businesses found from Google Places searches</p>
                </div>
                <button onclick="clearProspectPool()" class="px-4 py-2 text-sm bg-red-50 text-red-600 border border-red-200 rounded-md hover:bg-red-100 font-medium">
                    Clear All
                </button>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">üí°</span>
                    <div class="flex-1">
                        <h4 class="font-semibold text-blue-900 mb-1">How this works:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>‚Ä¢ All businesses from your searches are stored here and organized by category</li>
                            <li>‚Ä¢ Use the <strong>ZIP Code filter</strong> to view businesses from specific areas</li>
                            <li>‚Ä¢ Select businesses by checking the boxes</li>
                            <li>‚Ä¢ Click "Add Selected to Pipeline" to move them to your Prospecting column</li>
                            <li>‚Ä¢ Results stay cached for 30 days - repeat searches won't use API quota</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Filter by ZIP Codes:</label>
                    <select id="prospectPoolZipFilter" multiple onchange="renderProspectPool()" class="border rounded-md px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 w-full sm:w-64" style="min-height: 38px;">
                        <option value="all">All ZIP Codes</option>
                    </select>
                    <button onclick="document.getElementById('prospectPoolZipFilter').value='all'; renderProspectPool()" class="px-3 py-2 text-xs bg-gray-200 hover:bg-gray-300 rounded-md font-medium whitespace-nowrap">
                        Clear
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Show from:</label>
                    <select id="prospectPoolDateFilter" onchange="filterProspectPoolByDate()" class="border rounded-md px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500">
                        <option value="all">All Time</option>
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
            </div>

            <div id="prospectPoolStats" class="grid grid-cols-4 gap-4 mb-6">
                <!-- Stats populated by JavaScript -->
            </div>

            <div id="prospectPoolContainer">
                <!-- Content populated by JavaScript -->
            </div>

            <div class="sticky bottom-4 mt-6 p-4 bg-white border-2 border-indigo-200 rounded-lg shadow-xl">
                <div class="flex justify-between items-center">
                    <div>
                        <span id="prospectPoolSelectedCount" class="text-2xl font-bold text-indigo-600">0</span>
                        <span class="text-gray-600 ml-2">businesses selected</span>
                    </div>
                    <button id="btnAddFromPool" onclick="addFromProspectPool()" class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Add Selected to Pipeline
                    </button>
                </div>
            </div>
        </div>

        <!-- LEAD GENERATION TAB -->
        <div data-content="lead-generation" class="tab-pane hidden">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Lead Generation</h3>
                <p class="text-gray-600 mt-1">Search for and discover new prospects using Google Places API</p>
            </div>

            <!-- Auto-Populate Section -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-xl p-6 text-white mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-2xl font-black mb-2 flex items-center gap-2">
                            üîç Auto-Populate Prospects
                        </h3>
                        <p class="text-purple-100 text-sm">
                            Search Google Places to automatically find and add businesses to your prospecting pipeline
                        </p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg px-4 py-3 border border-white/20">
                        <div class="text-xs text-purple-100 mb-1">API Usage This Month</div>
                        <div class="font-bold text-lg" id="quickApiUsage">0 / 28,000</div>
                        <div class="text-xs text-purple-200" id="quickApiReset">Resets Dec 1</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: Zip Code & Radius -->
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                            <span class="text-2xl">üìç</span> Location
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium text-purple-100 block mb-1">Zip Code *</label>
                                <input
                                    id="bulkPopZipCode"
                                    type="text"
                                    maxlength="5"
                                    placeholder="14072"
                                    class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-purple-200 focus:outline-none focus:ring-2 focus:ring-white/50"
                                />
                            </div>
                            <div>
                                <label class="text-sm font-medium text-purple-100 block mb-1">Search Radius</label>
                                <select
                                    id="bulkPopRadius"
                                    class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                                >
                                    <option value="3000">~2 miles</option>
                                    <option value="5000" selected>~3 miles</option>
                                    <option value="8000">~5 miles</option>
                                    <option value="16000">~10 miles</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Middle: Business Categories (Multi-Select) -->
                    <div class="lg:col-span-2 bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold flex items-center gap-2">
                                <span class="text-2xl">üè¢</span> Business Categories (Select Multiple)
                            </h4>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/20 px-3 py-1.5 rounded transition font-semibold">
                                <input type="checkbox" id="selectAllCategories" class="rounded text-purple-600 focus:ring-purple-500" onchange="toggleAllCategories()" />
                                <span>Select All</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto pr-2" style="scrollbar-width: thin;">
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="restaurant" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Restaurant</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="cafe" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Cafe</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="bar" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Bar/Pub</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="store" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Retail Store</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="grocery_or_supermarket" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Grocery</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="pharmacy" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Pharmacy</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="gym" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Gym</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="hair_care" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Hair Salon</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="beauty_salon" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Beauty/Spa</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="dentist" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Dentist</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="doctor" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Doctor</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="lawyer" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Law Firm</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="real_estate_agency" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Real Estate</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="car_dealer" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Car Dealer</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="car_repair" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Auto Repair</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="plumber" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Plumber</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="electrician" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Electrician</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="roofing_contractor" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Roofer</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="general_contractor" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Contractor</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="painter" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Painter</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="florist" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Florist</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="pet_store" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Pet Store</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="accounting" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Accountant</span>
                            </label>
                            <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-white/10 p-2 rounded transition">
                                <input type="checkbox" value="insurance_agency" class="category-checkbox rounded text-purple-600 focus:ring-purple-500" />
                                <span>Insurance</span>
                            </label>
                        </div>

                        <!-- Custom Category Input -->
                        <div class="mt-4 pt-4 border-t border-white/20">
                            <label class="flex items-center gap-2 text-sm mb-2">
                                <input type="checkbox" id="enableCustomCategory" class="category-checkbox rounded text-purple-600" onchange="toggleBulkCustomCategory()" />
                                <span class="font-medium">Add custom category</span>
                            </label>
                            <input
                                id="bulkCustomCategory"
                                type="text"
                                placeholder="e.g., bookstore, bakery, snowplowing, etc."
                                disabled
                                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-purple-200 focus:outline-none focus:ring-2 focus:ring-white/50 disabled:opacity-50 disabled:cursor-not-allowed"
                            />
                        </div>
                    </div>
                </div>

                <!-- Search Button & Stats -->
                <div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-2 text-sm text-purple-100">
                        <span class="inline-block w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                        <span>Results cached for 30 days ‚Ä¢ Repeat searches are FREE</span>
                    </div>
                    <button
                        id="btnRunBulkPopulate"
                        onclick="runBulkAutoPopulate()"
                        class="w-full sm:w-auto px-8 py-3 bg-white text-purple-600 font-bold rounded-lg hover:bg-purple-50 transition shadow-lg hover:shadow-xl transform hover:scale-105"
                    >
                        üîç Search & Add Prospects
                    </button>
                </div>
            </div>

            <!-- Help & Tips Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                    <h4 class="font-semibold text-blue-900 mb-3 flex items-center gap-2">
                        <span class="text-2xl">üí°</span> How It Works
                    </h4>
                    <ul class="text-sm text-blue-800 space-y-2">
                        <li>‚Ä¢ Enter a zip code and select your search radius</li>
                        <li>‚Ä¢ Choose business categories or add custom ones</li>
                        <li>‚Ä¢ Results are cached for 30 days - repeat searches are FREE!</li>
                        <li>‚Ä¢ Found businesses go to Prospect Pool for review</li>
                        <li>‚Ä¢ Select and add promising prospects to your pipeline</li>
                    </ul>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h4 class="font-semibold text-green-900 mb-3 flex items-center gap-2">
                        <span class="text-2xl">üéØ</span> Pro Tips
                    </h4>
                    <ul class="text-sm text-green-800 space-y-2">
                        <li>‚Ä¢ Search multiple categories at once for better coverage</li>
                        <li>‚Ä¢ Use custom categories for niche industries (e.g., "snowplowing")</li>
                        <li>‚Ä¢ Results are linked to your current postcard automatically</li>
                        <li>‚Ä¢ Check Prospect Pool tab to review and select businesses</li>
                    </ul>
                </div>
            </div>
        </div>

        <div data-content="manager" class="tab-pane hidden">
            <div class="mb-4">
                <div class="border p-4 rounded-lg bg-white shadow-sm">
                    <h4 class="font-semibold mb-3 text-green-700">Create New Postcard Mailing</h4>
                    <p class="text-sm text-gray-600 mb-4">Start a new postcard campaign for a town and month. You can copy advertisers from previous mailings to speed up the process.</p>
                    <button onclick="openNewPostcardModal()" class="px-6 py-2.5 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">
                        + Create New Postcard
                    </button>
                </div>
            </div>
           
            <div class="flex justify-between items-start mb-4">
                <div id="legendArea" class="bg-white shadow px-3 py-2 rounded-md text-xs">
                    <strong>Status Colors:</strong>
                    <div id="legendGrid" class="mt-1"></div>
                </div>
                <div class="flex flex-col gap-2">
                     <button id="btnAdjustPostcard" class="text-sm px-3 py-1.5 rounded-md control-btn">Adjust Postcard Colors</button>
                     <button id="btnSortOpen" class="text-sm px-3 py-1.5 rounded-md control-btn">Sort Statuses</button>
                     <button onclick="deleteCurrentPostcard()" class="text-sm px-3 py-1.5 rounded-md bg-red-600 text-white hover:bg-red-700 font-medium">üóëÔ∏è Delete This Postcard</button>
                    <button id="btnSaveCommit"
                        class="text-sm px-6 py-3 rounded-md bg-green-600 text-white hover:bg-green-700 opacity-50 cursor-not-allowed font-bold"
                        disabled>
                        ‚úÖ Commit Changes to Database
                    </button>
                </div>
            </div>
            <div class="side-wrap mb-12" id="frontWrap">
                <h2 class="font-semibold mb-2 text-lg text-gray-900">Front Side</h2>
                <div class="postcard" id="frontPostcard">
                    <div id="frontGrid" class="grid-front"></div>
                </div>
            </div>
            <div class="side-wrap mb-16" id="backWrap">
                <h2 class="font-semibold mb-2 text-lg text-gray-900">Back Side</h2>
                <div class="postcard" id="backPostcard">
                    <div id="backGrid" class="grid-back"></div>
                </div>
            </div>
        </div>
        
        <!-- CLIENT DATABASE TAB -->
        <div data-content="clients" class="tab-pane hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Client Database</h3>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('csvFileInput').click()" class="px-3 py-1.5 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700">
                        üì§ Import CSV
                    </button>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="importClientsCSV(event)" style="display: none;" />
                    <button onclick="exportClientsCSV()" class="px-3 py-1.5 bg-green-600 text-white rounded-md text-sm hover:bg-green-700">
                        üì• Export CSV
                    </button>
                    <button onclick="syncClientsToSheets()" class="px-3 py-1.5 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">
                        ‚òÅÔ∏è Sync to Sheets
                    </button>
                    <button onclick="openClientModal()" class="px-4 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        + Add Client
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <input id="clientSearch" type="text" placeholder="Search by business name, category, or contact..." 
                       class="w-full p-2 border rounded-md mb-3" onkeyup="filterClients()" />
                
                <div class="flex gap-2">
                    <select id="categoryFilter" class="border rounded-md p-1.5 text-sm" onchange="filterClients()">
                        <option value="">All Categories</option>
                        <option value="Restaurant">Restaurant</option>
                        <option value="HVAC">HVAC</option>
                        <option value="Plumbing">Plumbing</option>
                        <option value="Legal">Legal</option>
                        <option value="Medical">Medical</option>
                        <option value="Other">Other</option>
                    </select>
                    
                    <select id="statusFilter" class="border rounded-md p-1.5 text-sm" onchange="filterClients()">
                        <option value="">All Clients</option>
                        <option value="active">Active (Paid Card)</option>
                        <option value="pending">Pending Payment</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            
            <div id="clientList" class="space-y-2">
                <p class="text-sm text-gray-500 text-center py-8">No clients yet. Add your first client above!</p>
            </div>
        </div>
        
        <div data-content="admin" class="tab-pane hidden">
            <h3 class="text-xl font-bold mb-4">Production & Renewal Center</h3>
            <div class="grid grid-cols-2 gap-6">
                <div id="contentQueue" class="border p-6 rounded-lg bg-gray-50">
                    <h4 class="font-semibold mb-3">Content / Proofing Queue (Needs Action)</h4>
                    <p>Spots currently waiting for client content submission or final proof approval.</p>
                </div>
                <div id="renewalQueue" class="border p-6 rounded-lg bg-gray-50">
                    <h4 class="font-semibold mb-3">Renewal & ROI Nudges</h4>
                    <div id="renewalList" class="space-y-2 mt-4">
                        <!-- Auto-populated based on 30-day rule -->
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>
  
  <!-- Edit Spot Modal -->
  <div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="editDialog" aria-labelledby="modalTitle">
      <h3 id="modalTitle" class="text-lg font-bold mb-3">Edit Selected Spots</h3>
      <div class="mb-4">
        <label class="text-sm font-medium text-gray-700">Link to Client</label>
        <div class="flex gap-2">
          <select id="editClient" class="border rounded-md flex-1 p-2 bg-white">
            <option value="">‚Äî Select existing client ‚Äî</option>
          </select>
          <button type="button" onclick="quickAddClient()" class="px-3 py-2 bg-gray-100 border rounded-md hover:bg-gray-200 text-sm">
            + New
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">Select a client to auto-fill business name below</p>
      </div>
      <div class="mb-4">
        <label class="text-sm font-medium text-gray-700">Enter Business Name</label>
        <input id="editName" class="border rounded-md w-full p-2 mt-1" placeholder="Example: Adam's Pizza" />
      </div>
      <div class="mb-4">
        <label class="text-sm font-medium text-gray-700">Status</label>
        <select id="editStatus" class="border rounded-md w-full p-2 mt-1 bg-white">
          <option value="AVAIL">Available</option>
          <option value="INVOICE">Invoice Sent</option>
          <option value="DEPOSIT">Deposit Paid</option>
          <option value="PROOF">Proof In Progress</option>
          <option value="APPROVED">Ad Approved</option>
          <option value="PAID">Paid In Full</option>
          <option value="RESERVED">Reserved</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="text-sm font-medium text-gray-700">Spot Price</label>
        <div class="relative mt-1">
          <span class="absolute left-3 top-2 text-gray-500">$</span>
          <input id="editPrice" type="number" step="50" class="border rounded-md w-full p-2 pl-7" placeholder="500" />
        </div>
        <p class="text-xs text-gray-500 mt-1">Price for this specific ad spot</p>
      </div>
      <div class="flex justify-end gap-2">
        <button id="btnCancelEdit" class="px-3 py-1.5 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnApplyEdit" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Postcard Color Modal -->
  <div id="postcardModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="postcardDialog">
      <h3>Adjust Postcard Colors</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div>
          <label style="display:block;font-weight:700;margin-bottom:6px">Postcard Background</label>
          <input id="pickerPostcard" type="color" value="#000000" />
        </div>
        <div>
          <label style="display:block;font-weight:700;margin-bottom:6px">Banner (front) Background</label>
          <input id="pickerBanner" type="color" value="#fed7aa" />
        </div>
      </div>
      <div style="margin-bottom:12px">
        <div style="font-size:.9rem;color:#374151;margin-bottom:6px">Preview</div>
        <div style="display:flex;gap:12px;align-items:center">
          <div id="previewPostcard" style="width:160px;height:100px;border-radius:8px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#000">
            <div id="previewBanner" style="background:#000000;padding:6px 8px;border-radius:6px"><span style="font-weight:800;color:#ffffff">TOWN ‚Äî MONTH</span></div>
          </div>
          <div style="font-size:.9rem;color:#6b7280">Postcard bg controls the simulated postcard container. Banner bg changes the front postcard banner visually and will be saved on Commit.</div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="btnCancelPostcard" class="px-3 py-1.5 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnApplyPostcard" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700">Apply & Close</button>
      </div>
    </div>
  </div>
  
  <!-- Sort Modal -->
  <div id="sortModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="sortDialog">
      <h3>Sort Statuses</h3>
      <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px">
        <div style="flex:1">
          <div id="sortListContainer" style="background:#fafafa;border:1px solid #e6eef4;border-radius:8px;padding:8px;min-height:200px"></div>
        </div>
        <div style="width:240px">
          <div style="font-size:.9rem;color:#374151;margin-bottom:8px">Preview (left ‚Üí right)</div>
          <div id="sortPreview" style="height:48px;border-radius:6px;border:1px solid #e6eef4"></div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="btnCancelSort" class="px-3 py-1.5 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnApplySort" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Order</button>
      </div>
    </div>
  </div>
  
  <!-- Expense Management Modal -->
  <div id="expenseModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="expenseDialog" style="max-width: 640px;">
      <h3 class="text-lg font-bold mb-4">Manage Postcard Expenses</h3>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Printing Cost</label>
            <div class="relative">
              <span class="absolute left-3 top-2 text-gray-500">$</span>
              <input id="expensePrinting" type="number" step="10" class="border rounded-md w-full p-2 pl-7" placeholder="0" />
            </div>
          </div>

          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Postage Cost (EDDM)</label>
            <div class="relative">
              <span class="absolute left-3 top-2 text-gray-500">$</span>
              <input id="expensePostage" type="number" step="10" class="border rounded-md w-full p-2 pl-7" placeholder="0" />
            </div>
            <p class="text-xs text-gray-500 mt-1">~$0.20-0.23 per piece</p>
          </div>

          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Design/Labor Cost</label>
            <div class="relative">
              <span class="absolute left-3 top-2 text-gray-500">$</span>
              <input id="expenseDesign" type="number" step="10" class="border rounded-md w-full p-2 pl-7" placeholder="0" />
            </div>
          </div>

          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Misc/Other Costs</label>
            <div class="relative">
              <span class="absolute left-3 top-2 text-gray-500">$</span>
              <input id="expenseMisc" type="number" step="10" class="border rounded-md w-full p-2 pl-7" placeholder="0" />
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <div class="flex justify-between items-center">
            <span class="font-semibold text-gray-700">Total Expenses:</span>
            <span id="expenseTotal" class="text-2xl font-bold text-orange-600">$0</span>
          </div>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
          <h4 class="font-semibold text-blue-900 mb-2">üí° Quick Calculation Help</h4>
          <div class="text-sm text-blue-800 space-y-1">
            <p><strong>5,000 pieces:</strong> ~$1,000-1,150 postage</p>
            <p><strong>10,000 pieces:</strong> ~$2,000-2,300 postage</p>
            <p><strong>Printing:</strong> $0.10-0.15 per postcard</p>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelExpense" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnSaveExpense" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Expenses</button>
      </div>
    </div>
  </div>
  
  <!-- Client Management Modal -->
  <div id="clientModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <h3 id="clientModalTitle" class="text-lg font-bold mb-4">Add New Client</h3>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="col-span-2">
            <label class="text-sm font-medium text-gray-700 block mb-1">Business Name *</label>
            <input id="clientBusinessName" type="text" class="border rounded-md w-full p-2" placeholder="Adam's Pizza" required />
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Category</label>
            <select id="clientCategory" class="border rounded-md w-full p-2 bg-white" onchange="toggleCustomCategory()">
              <option value="">Select category...</option>
              <option value="Restaurant">Restaurant</option>
              <option value="HVAC">HVAC</option>
              <option value="Plumbing">Plumbing</option>
              <option value="Electrician">Electrician</option>
              <option value="Legal">Legal</option>
              <option value="Medical">Medical</option>
              <option value="Real Estate">Real Estate</option>
              <option value="Home Services">Home Services</option>
              <option value="Automotive">Automotive</option>
              <option value="Other">Other (Specify)</option>
            </select>
            <input id="clientCustomCategory" type="text" class="border rounded-md w-full p-2 mt-2 hidden" placeholder="Enter custom category..." />
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Contact Name</label>
            <input id="clientContactName" type="text" class="border rounded-md w-full p-2" placeholder="Adam Smith" />
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Phone</label>
            <input id="clientPhone" type="tel" class="border rounded-md w-full p-2" placeholder="(555) 123-4567" />
          </div>
          
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Email</label>
            <input id="clientEmail" type="email" class="border rounded-md w-full p-2" placeholder="adam@adamspizza.com" />
          </div>
        </div>
        
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Notes</label>
          <textarea id="clientNotes" rows="3" class="border rounded-md w-full p-2" placeholder="Special requests, preferences, etc."></textarea>
        </div>

        <!-- Contract Section -->
        <div class="border-t pt-4">
          <div class="flex justify-between items-center mb-3">
            <h4 class="font-semibold text-gray-700">Multi-Month Contract (Optional)</h4>
            <label class="flex items-center gap-2">
              <input type="checkbox" id="hasContract" onchange="toggleContractFields()" />
              <span class="text-sm">Enable Contract</span>
            </label>
          </div>

          <div id="contractFields" class="hidden space-y-3">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Contract Start Date</label>
                <input id="contractStartDate" type="date" class="border rounded-md w-full p-2" onchange="calculateContractEnd()" />
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Contract Length</label>
                <select id="contractLength" class="border rounded-md w-full p-2 bg-white" onchange="calculateContractEnd()">
                  <option value="1">1 month</option>
                  <option value="3">3 months</option>
                  <option value="6" selected>6 months</option>
                  <option value="12">12 months</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Monthly Rate</label>
                <div class="relative">
                  <span class="absolute left-3 top-2 text-gray-500">$</span>
                  <input id="contractMonthlyRate" type="number" step="50" class="border rounded-md w-full p-2 pl-7" placeholder="500" onchange="calculateContractTotal()" />
                </div>
              </div>
              <div>
                <label class="text-sm font-medium text-gray-700 block mb-1">Total Contract Value</label>
                <div id="contractTotalValue" class="text-2xl font-bold text-green-600 mt-1">$0</div>
              </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-md">
              <div class="text-sm text-gray-700 mb-1">Contract End Date: <span id="contractEndDate" class="font-semibold">‚Äî</span></div>
              <label class="flex items-center gap-2 mt-2">
                <input type="checkbox" id="contractAutoRenew" />
                <span class="text-sm">Auto-renew contract</span>
              </label>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
              <p class="text-sm text-blue-900 font-medium mb-2">üí° Best Practice for SaaS Model:</p>
              <ul class="text-xs text-blue-800 space-y-1 ml-4 list-disc">
                <li>Offer 3, 6, or 12-month packages with discounts</li>
                <li>Automatically reserve spots for contract holders when creating new postcards</li>
                <li>Set renewal reminders 30 days before contract end</li>
              </ul>
            </div>
          </div>
        </div>

        <div id="clientHistorySection" class="hidden">
          <div class="border-t pt-4">
            <h4 class="font-semibold text-gray-700 mb-2">Purchase History</h4>
            <div id="clientHistory" class="space-y-2">
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-4 mt-4 p-3 bg-gray-50 rounded-lg">
            <div class="text-center">
              <div class="text-xs text-gray-600">Lifetime Spent</div>
              <div id="clientLifetimeSpent" class="text-lg font-bold text-green-600">$0</div>
            </div>
            <div class="text-center">
              <div class="text-xs text-gray-600">Cards Bought</div>
              <div id="clientCardsBought" class="text-lg font-bold text-indigo-600">0</div>
            </div>
            <div class="text-center">
              <div class="text-xs text-gray-600">Avg Price</div>
              <div id="clientAvgPrice" class="text-lg font-bold text-blue-600">$0</div>
            </div>
          </div>
        </div>
      </div>
      
      <input type="hidden" id="clientId" />
      
      <div class="flex justify-between items-center gap-2 mt-6 pt-4 border-t">
        <button id="btnDeleteClient" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 hidden">Delete Client</button>
        <div class="flex gap-2 ml-auto">
          <button id="btnCancelClient" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
          <button id="btnSaveClient" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Client</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Email Modal -->
  <div id="emailModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 600px;">
      <h3 class="text-lg font-bold mb-4">Send Email</h3>
      
      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Template</label>
          <select id="emailTemplate" class="border rounded-md w-full p-2 bg-white" onchange="loadEmailTemplate()">
            <option value="">‚Äî Select Template ‚Äî</option>
            <option value="invoice">Invoice Reminder</option>
            <option value="proof">Proof Ready for Review</option>
            <option value="renewal">Renewal Offer</option>
            <option value="thankyou">Thank You</option>
          </select>
        </div>
        
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">To</label>
          <input id="emailTo" type="email" class="border rounded-md w-full p-2" placeholder="client@example.com" />
        </div>
        
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Subject</label>
          <input id="emailSubject" type="text" class="border rounded-md w-full p-2" placeholder="Subject line" />
        </div>
        
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Message</label>
          <textarea id="emailBody" rows="8" class="border rounded-md w-full p-2" placeholder="Email body..."></textarea>
        </div>
      </div>
      
      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelEmail" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnSendEmail" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Send Email</button>
      </div>
    </div>
  </div>
  
  <!-- Reports Modal -->
  <div id="reportsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 800px;">
      <h3 class="text-lg font-bold mb-4">Financial Reports & Analytics</h3>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <button onclick="generateProfitLossReport()" class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all text-left">
            <div class="font-semibold text-gray-900">üìä Profit & Loss Report</div>
            <div class="text-sm text-gray-600 mt-1">Monthly revenue vs expenses breakdown</div>
          </button>
          
          <button onclick="generateClientValueReport()" class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all text-left">
            <div class="font-semibold text-gray-900">üí∞ Client Value Analysis</div>
            <div class="text-sm text-gray-600 mt-1">Lifetime value & renewal rates</div>
          </button>
          
          <button onclick="generateCampaignReport()" class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all text-left">
            <div class="font-semibold text-gray-900">üìà Campaign Performance</div>
            <div class="text-sm text-gray-600 mt-1">Compare all campaigns side-by-side</div>
          </button>
          
          <button onclick="generateSalesFunnelReport()" class="p-4 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-all text-left">
            <div class="font-semibold text-gray-900">üéØ Sales Funnel</div>
            <div class="text-sm text-gray-600 mt-1">Conversion rates by stage</div>
          </button>
        </div>
        
        <div id="reportOutput" class="border rounded-lg p-4 bg-gray-50 min-h-[200px] hidden">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold">Report Output</h4>
            <button onclick="downloadReport()" class="text-sm px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Download CSV</button>
          </div>
          <div id="reportContent" class="text-sm"></div>
        </div>
      </div>
      
      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCloseReports" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Task Management Modal -->
  <div id="taskModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 500px;">
      <h3 id="taskModalTitle" class="text-lg font-bold mb-4">Add New Task</h3>

      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Task Description *</label>
          <input id="taskText" type="text" class="border rounded-md w-full p-2" placeholder="Follow up with client..." required />
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Due Date *</label>
          <input id="taskDueDate" type="date" class="border rounded-md w-full p-2" required />
        </div>
      </div>

      <input type="hidden" id="taskId" />

      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelTask" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnSaveTask" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Task</button>
      </div>
    </div>
  </div>

  <!-- Lead Management Modal -->
  <div id="leadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 550px;">
      <h3 id="leadModalTitle" class="text-lg font-bold mb-4">Add New Lead</h3>

      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Business Name *</label>
          <input id="leadBusinessName" type="text" class="border rounded-md w-full p-2" placeholder="Joe's Plumbing" required />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Contact Name</label>
            <input id="leadContactName" type="text" class="border rounded-md w-full p-2" placeholder="Joe Smith" />
          </div>

          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Phone</label>
            <input id="leadPhone" type="tel" class="border rounded-md w-full p-2" placeholder="(555) 123-4567" />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Email</label>
          <input id="leadEmail" type="email" class="border rounded-md w-full p-2" placeholder="joe@joesplumbing.com" />
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Website</label>
          <input id="leadWebsite" type="url" class="border rounded-md w-full p-2" placeholder="https://joesplumbing.com" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Facebook</label>
            <input id="leadFacebook" type="url" class="border rounded-md w-full p-2" placeholder="https://facebook.com/..." />
          </div>

          <div>
            <label class="text-sm font-medium text-gray-700 block mb-1">Instagram</label>
            <input id="leadInstagram" type="url" class="border rounded-md w-full p-2" placeholder="https://instagram.com/..." />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Estimated Value</label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-gray-500">$</span>
            <input id="leadValue" type="number" step="50" class="border rounded-md w-full p-2 pl-7" placeholder="500" />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Notes</label>
          <textarea id="leadNotes" rows="2" class="border rounded-md w-full p-2" placeholder="Details about this lead..."></textarea>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">üìÖ Follow-Up Date</label>
          <input id="leadFollowUpDate" type="date" class="border rounded-md w-full p-2" />
          <p class="text-xs text-gray-500 mt-1">Set a reminder to contact this prospect later</p>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-2">Activity Log</label>
          <div id="leadActivityLog" class="border rounded-md p-3 bg-gray-50 max-h-32 overflow-y-auto text-xs space-y-1">
            <div class="text-gray-400 italic">No activity yet</div>
          </div>
          <div class="mt-2 flex gap-2">
            <input id="leadNewActivity" type="text" class="border rounded-md flex-1 p-2 text-sm" placeholder="Add a note (e.g., 'Called, left voicemail')" />
            <button onclick="addActivityNote()" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">Add</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="leadColumn" />
      <input type="hidden" id="leadId" />

      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelLead" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnSaveLead" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Lead</button>
      </div>
    </div>
  </div>

  <!-- Contact Later Modal -->
  <div id="contactLaterModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 400px;">
      <h3 class="text-lg font-bold mb-4">üìÖ Contact Later</h3>

      <p class="text-sm text-gray-600 mb-4">Set a follow-up date and move this prospect to your pool.</p>

      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Business Name</label>
          <div id="contactLaterBusinessName" class="text-sm font-semibold text-gray-900"></div>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Follow-Up Date *</label>
          <input id="contactLaterDate" type="date" class="border rounded-md w-full p-2" required />
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Quick Note (Optional)</label>
          <input id="contactLaterNote" type="text" class="border rounded-md w-full p-2" placeholder="e.g., 'Call back in 2 weeks'" />
        </div>
      </div>

      <input type="hidden" id="contactLaterLeadId" />

      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelContactLater" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnSaveContactLater" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">üìÖ Move to Pool</button>
      </div>
    </div>
  </div>

  <!-- Auto-Populate Prospects Modal -->
  <div id="autoPopulateModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 600px;">
      <h3 class="text-lg font-bold mb-4">üîç Auto-Populate Prospects</h3>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <p class="text-sm text-blue-900">
          Search Google Places API for businesses in your area and automatically add them to your prospecting list.
        </p>
      </div>

      <!-- API Usage Stats -->
      <div id="apiUsageDisplay" class="mb-4 p-3 rounded-lg border">
        <!-- Populated by JavaScript -->
      </div>

      <div class="space-y-4">
        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Zip Code *</label>
          <input id="autoPopZipCode" type="text" class="border rounded-md w-full p-2" placeholder="02101" maxlength="10" required />
          <p class="text-xs text-gray-500 mt-1">5-digit US zip code</p>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Business Category *</label>
          <select id="autoPopCategory" class="border rounded-md w-full p-2 bg-white" required>
            <option value="">Select category...</option>
            <option value="restaurant">Restaurant</option>
            <option value="cafe">Cafe / Coffee Shop</option>
            <option value="bar">Bar / Pub</option>
            <option value="retail">Retail Store</option>
            <option value="grocery_or_supermarket">Grocery Store</option>
            <option value="pharmacy">Pharmacy</option>
            <option value="gym">Gym / Fitness</option>
            <option value="hair_care">Hair Salon / Barber</option>
            <option value="beauty_salon">Beauty Salon / Spa</option>
            <option value="dentist">Dentist</option>
            <option value="doctor">Doctor / Medical</option>
            <option value="lawyer">Law Firm</option>
            <option value="real_estate_agency">Real Estate Agency</option>
            <option value="car_dealer">Car Dealer</option>
            <option value="car_repair">Auto Repair</option>
            <option value="plumber">Plumber</option>
            <option value="electrician">Electrician</option>
            <option value="roofing_contractor">Roofing Contractor</option>
            <option value="general_contractor">General Contractor</option>
            <option value="painter">Painter</option>
            <option value="locksmith">Locksmith</option>
            <option value="florist">Florist</option>
            <option value="pet_store">Pet Store</option>
            <option value="veterinary_care">Veterinarian</option>
            <option value="accounting">Accountant</option>
            <option value="insurance_agency">Insurance Agency</option>
            <option value="bank">Bank</option>
            <option value="hotel">Hotel / Lodging</option>
            <option value="moving_company">Moving Company</option>
            <option value="storage">Storage Facility</option>
            <option value="laundry">Laundromat</option>
            <option value="dry_cleaning">Dry Cleaning</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-medium text-gray-700 block mb-1">Search Radius</label>
          <select id="autoPopRadius" class="border rounded-md w-full p-2 bg-white">
            <option value="3000">~2 miles</option>
            <option value="5000" selected>~3 miles</option>
            <option value="8000">~5 miles</option>
            <option value="16000">~10 miles</option>
          </select>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
          <p class="text-xs text-yellow-900">
            ‚ö° <strong>Note:</strong> Results are cached for 30 days to minimize API costs. Re-running the same search is free!
          </p>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-6">
        <button id="btnCancelAutoPopulate" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnRunAutoPopulate" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">
          üîç Search & Add Prospects
        </button>
      </div>
    </div>
  </div>

  <!-- Prospects Results Preview Modal -->
  <div id="prospectsResultsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-xl font-bold">Search Results</h3>
          <p class="text-sm text-gray-600 mt-1">Select businesses to add to your prospecting pipeline</p>
        </div>
        <button onclick="closeProspectsResultsModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <div class="flex items-start gap-2">
          <span class="text-blue-600 text-lg">üí°</span>
          <div class="text-sm text-blue-900">
            <strong>Select which businesses to add.</strong> Unchecked businesses won't be added. Click "Not Interested" to permanently hide a business from future searches.
          </div>
        </div>
      </div>

      <div id="prospectsResultsStats" class="grid grid-cols-3 gap-4 mb-4">
        <!-- Stats populated by JavaScript -->
      </div>

      <div id="prospectsResultsContainer" class="space-y-2 max-h-96 overflow-y-auto pr-2" style="scrollbar-width: thin;">
        <!-- Results populated by JavaScript -->
      </div>

      <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
        <button onclick="closeProspectsResultsModal()" class="px-6 py-2 border rounded-md bg-gray-100 hover:bg-gray-200 font-medium">
          Cancel
        </button>
        <button id="btnAddSelectedProspects" onclick="addSelectedProspects()" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold">
          Add Selected to Pipeline
        </button>
      </div>
    </div>
  </div>

  <!-- New Postcard Creation Modal -->
  <div id="newPostcardModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <h3 class="text-lg font-bold mb-4">Create New Postcard Mailing</h3>

      <div class="space-y-6">
        <!-- Step 1: Town Selection -->
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-semibold text-blue-900 mb-3">Step 1: Select Town/Territory</h4>
          <div class="space-y-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="townOption" value="existing" checked onchange="toggleTownInput()" />
              <span class="text-sm font-medium">Use existing town</span>
            </label>
            <select id="newPostcardTownSelect" class="border rounded-md p-2 w-full bg-white ml-6">
              <option value="">‚Äî Select existing town ‚Äî</option>
            </select>

            <label class="flex items-center gap-2 mt-3">
              <input type="radio" name="townOption" value="new" onchange="toggleTownInput()" />
              <span class="text-sm font-medium">Add new town</span>
            </label>
            <input id="newPostcardTownInput" type="text" class="border rounded-md p-2 w-full ml-6" placeholder="Enter new town name (e.g., Buffalo, West Seneca)" disabled />
          </div>
        </div>

        <!-- Step 2: Mail Date -->
        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
          <h4 class="font-semibold text-green-900 mb-3">Step 2: Select Mail Date</h4>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium block mb-1">Month</label>
              <select id="newPostcardMonth" class="border rounded-md p-2 w-full bg-white">
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium block mb-1">Year</label>
              <select id="newPostcardYear" class="border rounded-md p-2 w-full bg-white">
              </select>
            </div>
          </div>
          <div class="mt-3">
            <label class="text-sm font-medium block mb-1">In-Homes Date</label>
            <input id="newPostcardInHomesDate" type="date" class="border rounded-md p-2 w-full" />
          </div>
        </div>

        <!-- Step 3: Copy from Previous -->
        <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
          <h4 class="font-semibold text-purple-900 mb-3">Step 3: Copy from Previous Postcard (Optional)</h4>
          <label class="flex items-center gap-2 mb-3">
            <input type="checkbox" id="copyFromPrevious" onchange="toggleCopyOptions()" />
            <span class="text-sm font-medium">Copy advertisers from a previous postcard</span>
          </label>

          <div id="copyOptions" class="hidden space-y-3">
            <div>
              <label class="text-sm font-medium block mb-1">Select postcard to copy from:</label>
              <select id="copySourcePostcard" class="border rounded-md p-2 w-full bg-white" onchange="loadAdvertisersForCopy()">
                <option value="">‚Äî Select postcard ‚Äî</option>
              </select>
            </div>

            <div id="advertiserChecklistContainer" class="hidden">
              <p class="text-sm font-medium mb-2">Select advertisers to carry forward:</p>
              <div id="advertiserChecklist" class="max-h-60 overflow-y-auto border rounded-md p-3 bg-white space-y-2">
                <!-- Populated dynamically -->
              </div>
              <p class="text-xs text-gray-600 mt-2">üí° Selected advertisers will have their spots auto-reserved in the new postcard with "Reserved" status.</p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end gap-2 mt-6 pt-4 border-t">
        <button id="btnCancelNewPostcard" class="px-4 py-2 border rounded-md bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="btnCreatePostcard" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-semibold">
          Create Postcard
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ========= CONFIG ========= */
    // Supabase Configuration
    const SUPABASE_URL = "https://kurhsdvxsgkgnfimfqdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1cmhzZHZ4c2drZ25maW1mcWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDk3NDYsImV4cCI6MjA3ODM4NTc0Nn0.nB_GsE89WJ3eAQrgmNKb-fbCktHTHf-987D-G6lscZA";
    const ACTIVE_USER = "lastcall.me@hotmail.com";

    // Initialize Supabase client
    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Cloud Sync State - Tracks what's syncing and when
    const cloudSyncState = {
      syncing: false,
      lastSync: null,
      pendingSaves: new Set(), // Track which data types need saving (temporary failures)
      permanentlyFailedSaves: new Set(), // Track data types that are too large (permanent failures)
      syncErrors: {},
      userNotified: new Set(), // Track which errors we've already notified user about
      inProgressSaves: new Map(), // Track saves currently in progress (dataType -> Promise)
      debouncedSaves: new Map() // Track debounced save timers (dataType -> timeoutId)
    };

    // ‚ö†Ô∏è SECURITY WARNING: Never commit real API keys to version control!
    //
    // Google Places API Key - Replace with your actual key
    // Get your key at: https://console.cloud.google.com/google/maps-apis/
    // IMPORTANT: Restrict this key by HTTP referrer in Google Cloud Console to prevent abuse
    const GOOGLE_PLACES_API_KEY = "YOUR_GOOGLE_PLACES_API_KEY_HERE";

    // Outscraper API Key - For enriched contact data (phone, email, social media)
    // This key is ONLY used to pass to backend - never called directly from frontend
    // The backend (GoogleAppsScript_FIXED.js) proxies all Outscraper requests
    // Get your key at: https://app.outscraper.com/profile
    const OUTSCRAPER_API_KEY = "YOUR_OUTSCRAPER_API_KEY_HERE";
    const OUTSCRAPER_COST_PER_BUSINESS = 0.01; // $0.01 per business enriched

    // Application Configuration Constants
    const TOTAL_SPOTS_PER_POSTCARD = 18;
    const DEFAULT_DESIGN_COST = 150;
    const CLOUD_SYNC_URL_LENGTH_LIMIT = 6000; // Browser URL length limit for GET requests
    const CLOUD_SYNC_RETRY_INTERVAL = 60000; // 1 minute in milliseconds
    const DEBOUNCE_RENDER_DELAY = 150; // Milliseconds to debounce kanban rendering

    /* ========= LOCALSTORAGE UTILITY ========= */

    // Safe localStorage wrapper with quota exceeded handling
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (err) {
        // Check if this is a quota exceeded error
        const isQuotaExceeded = err.name === 'QuotaExceededError' ||
                                err.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||
                                err.code === 22 || // Chrome
                                err.code === 1014; // Firefox

        if (isQuotaExceeded) {
          console.error('localStorage quota exceeded:', {
            key,
            valueSize: value.length,
            error: err.message
          });

          // Show user-friendly warning (only once per session)
          if (!window._localStorageQuotaWarningShown) {
            toast('‚ö†Ô∏è Local storage is full. Some data may not be saved offline. Consider clearing old cached data.', false);
            window._localStorageQuotaWarningShown = true;
          }

          // Try to free up space by clearing old cache data
          try {
            // Clear places cache (largest non-critical data)
            localStorage.removeItem('mailslot-places-cache');

            // Retry the save after clearing cache
            localStorage.setItem(key, value);
            toast('‚úì Freed up space and saved successfully', true);
            return true;
          } catch (retryErr) {
            console.error('Failed to save even after clearing cache:', retryErr);
            return false;
          }
        } else {
          // Other localStorage error
          console.error('localStorage error:', err);
          return false;
        }
      }
    }

    function safeGetItem(key) {
      try {
        return localStorage.getItem(key);
      } catch (err) {
        console.error('localStorage getItem error:', err);
        return null;
      }
    }

    function safeRemoveItem(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (err) {
        console.error('localStorage removeItem error:', err);
        return false;
      }
    }

    /* ========= CLOUD SYNC SYSTEM ========= */

    // Unified function to load data from Google Sheets
    async function loadFromCloud(dataType) {
      try {
        // Query Supabase app_data table for this data type
        const { data, error } = await supabaseClient
          .from('app_data')
          .select('data')
          .eq('user_email', ACTIVE_USER)
          .eq('data_type', dataType)
          .single();

        if (error) {
          // If no data found (404), return null (not an error)
          if (error.code === 'PGRST116') {
            return null;
          }
          throw error;
        }

        const appData = data?.data || null;

        // Cache to localStorage
        if (appData !== null && appData !== undefined) {
          safeSetItem(`mailslot-${dataType}`, JSON.stringify(appData));
        }

        return appData;
      } catch (err) {
        console.warn(`‚ö†Ô∏è Failed to load ${dataType} from cloud, using localStorage:`, err);
        cloudSyncState.syncErrors[dataType] = err.message;

        // Fallback to localStorage
        const cached = safeGetItem(`mailslot-${dataType}`);
        return cached ? JSON.parse(cached) : null;
      }
    }

    // Unified function to save data to Supabase
    async function saveToCloud(dataType, data, options = {}) {
      try {
        // Use upsert to insert or update
        const { error } = await supabaseClient
          .from('app_data')
          .upsert({
            user_email: ACTIVE_USER,
            data_type: dataType,
            data: data
          }, {
            onConflict: 'user_email,data_type'
          });

        if (error) throw error;

        // Update cache
        safeSetItem(`mailslot-${dataType}`, JSON.stringify(data));
        cloudSyncState.lastSync = Date.now();
        delete cloudSyncState.syncErrors[dataType];

        return { success: true };

      } catch (err) {
        console.error(`‚ùå Failed to save ${dataType} to cloud:`, err);
        cloudSyncState.syncErrors[dataType] = err.message;

        // Still save to localStorage as backup
        safeSetItem(`mailslot-${dataType}`, JSON.stringify(data));

        // Check if this is a permanent failure (data too large)
        if (err.message && err.message.includes('Data too large')) {
          // Mark as permanently failed (don't retry)
          cloudSyncState.permanentlyFailedSaves.add(dataType);

          // Show user notification once
          if (!cloudSyncState.userNotified.has(dataType)) {
            toast(`‚ö†Ô∏è ${dataType} data is too large for cloud sync. Saved locally only.`, false);
            cloudSyncState.userNotified.add(dataType);
          }

          console.warn(`üì¶ ${dataType} marked as localStorage-only (too large for cloud sync)`);
        } else {
          // Temporary failure - add to retry queue
          cloudSyncState.pendingSaves.add(dataType);
        }

        throw err;
      }
    }

    // Optimized cloud sync wrapper - prevents duplicate simultaneous saves
    // Optional debouncing for non-critical saves (set debounceMs > 0)
    async function saveToCloudOptimized(dataType, data, debounceMs = 0) {
      // If this dataType is already being saved, wait for that save to complete
      // then trigger a new save with the latest data
      if (cloudSyncState.inProgressSaves.has(dataType)) {
        try {
          await cloudSyncState.inProgressSaves.get(dataType);
        } catch (err) {
          // Ignore errors from previous save, we'll try again
        }
      }

      // Clear any pending debounced save for this dataType (update to latest data)
      if (cloudSyncState.debouncedSaves.has(dataType)) {
        clearTimeout(cloudSyncState.debouncedSaves.get(dataType));
        cloudSyncState.debouncedSaves.delete(dataType);
      }

      // For non-critical saves with debouncing, delay the save
      if (debounceMs > 0) {
        return new Promise((resolve, reject) => {
          const timeoutId = setTimeout(async () => {
            cloudSyncState.debouncedSaves.delete(dataType);

            const savePromise = saveToCloud(dataType, data)
              .finally(() => {
                cloudSyncState.inProgressSaves.delete(dataType);
              });

            cloudSyncState.inProgressSaves.set(dataType, savePromise);

            try {
              const result = await savePromise;
              resolve(result);
            } catch (err) {
              reject(err);
            }
          }, debounceMs);

          cloudSyncState.debouncedSaves.set(dataType, timeoutId);
        });
      }

      // For immediate/critical saves, execute right away
      const savePromise = saveToCloud(dataType, data)
        .finally(() => {
          cloudSyncState.inProgressSaves.delete(dataType);
        });

      cloudSyncState.inProgressSaves.set(dataType, savePromise);
      return savePromise;
    }

    // Auto-retry failed syncs (but not permanently failed ones)
    setInterval(() => {
      // Remove any permanently failed saves from the retry queue
      cloudSyncState.permanentlyFailedSaves.forEach(dataType => {
        cloudSyncState.pendingSaves.delete(dataType);
      });

      if (cloudSyncState.pendingSaves.size > 0 && !cloudSyncState.syncing) {
        // Will be handled by individual save functions
      }
    }, CLOUD_SYNC_RETRY_INTERVAL); // Retry every minute

    const CANONICAL_STATUSES = [
      "Available",
      "Reserved",
      "Invoice Sent",
      "Deposit Paid",
      "Proof In Progress",
      "Ad Approved",
      "Paid in Full"
    ];
    
    let sortOrder = [...CANONICAL_STATUSES];
    let visibleStatuses = [...CANONICAL_STATUSES];
    const GRADIENT_HEX = ["#fef3c7", "#fff7ed", "#fed7aa", "#fdba74", "#dbeafe", "#2563eb", "#16a34a"];
    const GRADIENT_PILL = ["#fcd34d", "#fb923c", "#f97316", "#ea580c", "#3b82f6", "#1d4ed8", "#15803d"];
    let STATUS_HEX = {};
    let STATUS_PILL = {};
    
    function updateColorMappings() {
      const visibleSorted = sortOrder.filter(s => visibleStatuses.includes(s));
      const numVisible = visibleSorted.length;
      const usedHex = GRADIENT_HEX.slice(0, numVisible - 1);
      usedHex.push(GRADIENT_HEX[GRADIENT_HEX.length - 1]);
      const usedPill = GRADIENT_PILL.slice(0, numVisible - 1);
      usedPill.push(GRADIENT_PILL[GRADIENT_PILL.length - 1]);
      visibleSorted.forEach((s, i) => {
        STATUS_HEX[s] = usedHex[i];
        STATUS_PILL[s] = usedPill[i];
      });
      const hiddenDefault = STATUS_HEX["Available"] || GRADIENT_HEX[0];
      CANONICAL_STATUSES.filter(s => !visibleStatuses.includes(s)).forEach(s => {
        STATUS_HEX[s] = hiddenDefault;
        STATUS_PILL[s] = GRADIENT_PILL[0];
      });
    }
    
    const PAIRS = [[1,2],[3,4],[5,6],[7,8],[9,10],[11,12],[13,14],[15,16],[17,18]];
    const keyPair = (a,b)=>[Math.min(a,b),Math.max(a,b)].join("-");
    const isValidPair=(a,b)=>PAIRS.some(([x,y])=>x===Math.min(a,b)&&y===Math.max(a,b));
    const mateOf = n => { for (const [a,b] of PAIRS) { if (a===n) return b; if (b===n) return a; } return null; };
    
    const state = {
      mailers: [],
      current: null,
      availability: {},
      initial: {},
      merged: new Set(),
      selected: new Set(),
      dirty: false,
      lastSide: "front"
    };
    
    const stagedColors = {
      Postcard_BG: "",
      Banner_BG: "#000000"  // Black - ensures white text by default
    };

    // AUTO-SAVE STATE
    const autoSaveState = {
      timer: null,
      lastSaveTime: null,
      saving: false,
      updateInterval: null
    };

    // FINANCIAL STATE
    const financialState = {
      expenses: {},
      spotPricing: {}
    };
    
    const DEFAULT_SPOT_PRICE = 500;
    const DEFAULT_EXPENSES = {
      printing: 0,
      postage: 0,
      design: 0,
      misc: 0
    };
    
    // CRM STATE
    const crmState = {
      clients: {},
      nextClientId: 1
    };
    
    // KANBAN STATE
    const kanbanState = {
      columns: {
        'new-lead': [],
        'proposal-sent': [],
        'negotiation': [],
        'closed-won': []
      }
    };

    // CLOUD SYNC SELECTION STATE
    const cloudSyncSelection = {
      selectedIds: new Set(),
      showSyncUI: false
    };

    // TASKS STATE
    const tasksState = {
      tasks: []
    };

    // API QUOTA TRACKING STATE
    const apiQuotaState = {
      monthlyLimit: 28000,  // Google Places API free tier
      currentMonth: new Date().toISOString().slice(0, 7), // "2025-11"
      callsThisMonth: 0,
      userQuotas: {},  // Per-user quotas when restrictions activate
      restrictionsActive: false,
      warningThreshold: 0.8,  // 80% = 22,400 calls
      criticalThreshold: 0.95  // 95% = 26,600 calls
    };

    // PLACES CACHE STATE (30-day cache + permanent Place IDs)
    const placesCache = {
      searches: {}  // Format: { "zipCode-category": { placeIds: [], cachedData: [], cachedUntil: "date" } }
    };

    // NOT INTERESTED LIST STATE (permanent exclusion list)
    const notInterestedState = {
      placeIds: new Set(),  // Set of Place IDs marked as "not interested"
      businesses: {}  // Map of Place ID => business info for reference
    };

    // PROSPECTS RESULTS STATE (temporary storage for search results)
    let prospectsResultsState = {
      businesses: [],
      selectedIds: new Set()
    };

    let lastFocusedElementBeforeModal = null;
    let draggedItem = null;
    let draggedTask = null;
    
    /* ========= UTILITIES ========= */
    const $ = sel => document.querySelector(sel);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const show = (el, on=true) => el.classList.toggle("hidden", !on);
    const toast = (msg, ok=true, durationMs=null) => {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = `toast ${ok ? "toast-ok" : "toast-warn"}`;
      t.classList.remove("hidden");
      t.removeAttribute("aria-hidden");

      // Calculate duration based on message length if not specified
      // Base: 2000ms, +50ms per character over 20 chars, max 6000ms
      const duration = durationMs || Math.min(2000 + Math.max(0, msg.length - 20) * 50, 6000);

      setTimeout(()=>{ t.classList.add("hidden"); t.setAttribute("aria-hidden","true"); }, duration);
    };
    
    function formatDate(dateStr) {
      return new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' }).format(new Date(dateStr));
    }
    
    function isOverdue(dateStr) {
      const due = new Date(dateStr);
      const today = new Date();
      return due < today;
    }
    
    function updateTaskDate(input) {
      const row = input.closest('.task-row');
      const taskId = row.dataset.taskId;
      const newDate = input.value;
      if (newDate) {
        row.dataset.dueDate = newDate;
        const task = tasksState.tasks.find(t => t.id == taskId);
        if (task) {
          task.dueDate = newDate;
          saveTasks();
        }
        updateTasksDisplay();
        toast('Task date updated');
      }
    }
    
    function toggleTaskComplete(checkbox) {
      const row = checkbox.closest('.task-row');
      const taskId = row.dataset.taskId;
      const task = tasksState.tasks.find(t => t.id == taskId);
      if (task) {
        task.completed = checkbox.checked;
        saveTasks();
        if (checkbox.checked) {
          row.classList.add('completed');
        } else {
          row.classList.remove('completed');
        }
        updateTasksDisplay();
      }
    }
    
    /* ========= FINANCIAL CALCULATIONS ========= */
    function calculateFinancials(mailerId) {
      if (!mailerId) return null;
      
      const expenses = financialState.expenses[mailerId] || { ...DEFAULT_EXPENSES };
      const totalExpenses = Object.values(expenses).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
      
      let paidRevenue = 0;
      let depositRevenue = 0;
      let projectedRevenue = 0;
      let spotsSold = 0;
      let spotsPaid = 0;

      for (let i = 1; i <= TOTAL_SPOTS_PER_POSTCARD; i++) {
        const spot = state.availability[`Spot_${i}`];
        const priceKey = `${mailerId}-Spot_${i}`;
        const price = financialState.spotPricing[priceKey] || DEFAULT_SPOT_PRICE;

        // Check if this spot is the SECOND spot in a merged pair
        const mate = mateOf(i);
        const isMergedSecond = mate && mate < i && state.merged.has(keyPair(i, mate));

        // Skip if this is the second spot in a merged pair (already counted with first spot)
        if (isMergedSecond) {
          continue;
        }

        // Only count revenue if spot has a business name entered
        if (spot && spot.status !== "Available" && spot.name && spot.name.trim() !== "") {
          spotsSold++;
          projectedRevenue += price;

          // Count toward current revenue for ANY spot with a business name
          if (spot.status === "Paid in Full") {
            paidRevenue += price;
            spotsPaid++;
          } else if (spot.status === "Deposit Paid") {
            const depositAmount = price * 0.5;
            depositRevenue += depositAmount;
          } else {
            // For any other status (Reserved, Invoice Sent, etc.), count full price as current revenue
            paidRevenue += price;
          }
        }
      }
      
      const currentRevenue = paidRevenue + depositRevenue;
      const currentProfit = currentRevenue - totalExpenses;
      const projectedProfit = projectedRevenue - totalExpenses;
      const breakeven = currentRevenue >= totalExpenses;
      
      const avgSpotPrice = spotsSold > 0 ? projectedRevenue / spotsSold : DEFAULT_SPOT_PRICE;
      const remainingToBreakeven = Math.max(0, totalExpenses - currentRevenue);
      const spotsNeeded = Math.ceil(remainingToBreakeven / avgSpotPrice);

      // Calculate effective total spots (18 minus number of merged pairs)
      // Each merged pair reduces total by 1 (4 singles become 2 doubles = -2 spots)
      const mergedPairsCount = state.merged.size;
      const effectiveTotalSpots = TOTAL_SPOTS_PER_POSTCARD - mergedPairsCount;

      return {
        revenue: {
          paid: paidRevenue,
          deposit: depositRevenue,
          current: currentRevenue,
          projected: projectedRevenue,
          target: TOTAL_SPOTS_PER_POSTCARD * DEFAULT_SPOT_PRICE
        },
        expenses: {
          ...expenses,
          total: totalExpenses
        },
        profit: {
          current: currentProfit,
          projected: projectedProfit,
          margin: projectedRevenue > 0 ? (projectedProfit / projectedRevenue * 100) : 0
        },
        metrics: {
          spotsSold,
          spotsPaid,
          spotsAvailable: effectiveTotalSpots - spotsSold,
          avgSpotPrice,
          breakeven,
          spotsNeeded,
          progressPercent: effectiveTotalSpots > 0 ? (spotsSold / effectiveTotalSpots * 100) : 0,
          effectiveTotalSpots // Add this for display purposes
        }
      };
    }
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { 
        style: 'currency', 
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount || 0);
    }
    
    function updateFinancialDashboard() {
      if (!state.current) return;
      
      const financials = calculateFinancials(state.current.Mailer_ID);
      if (!financials) return;
      
      const profitEl = document.getElementById('profitStatus');
      const revenueEl = document.getElementById('currentRevenue');
      const expensesEl = document.getElementById('totalExpenses');
      const spotsToBreakevenEl = document.getElementById('spotsToBreakeven');
      const progressBarEl = document.getElementById('revenueProgressBar');
      const progressTextEl = document.getElementById('revenueProgressText');
      
      if (profitEl) {
        profitEl.textContent = formatCurrency(financials.profit.current);
        profitEl.className = `metric-value ${financials.metrics.breakeven ? 'text-green-600' : 'text-red-500'}`;
      }
      
      if (revenueEl) revenueEl.textContent = formatCurrency(financials.revenue.current);
      if (expensesEl) expensesEl.textContent = formatCurrency(financials.expenses.total);
      
      if (spotsToBreakevenEl) {
        if (financials.metrics.breakeven) {
          spotsToBreakevenEl.innerHTML = '‚úì <span class="text-green-600 font-bold">Profitable!</span>';
        } else {
          spotsToBreakevenEl.innerHTML = `Need <span class="font-bold text-indigo-600">${financials.metrics.spotsNeeded} more spot${financials.metrics.spotsNeeded === 1 ? '' : 's'}</span> to break even`;
        }
      }
      
      if (progressBarEl) {
        const percent = (financials.revenue.current / financials.revenue.target * 100);
        progressBarEl.style.width = `${Math.min(percent, 100)}%`;
      }
      
      if (progressTextEl) {
        const revenuePercent = Math.round((financials.revenue.current / financials.revenue.target) * 100);
        progressTextEl.textContent = `${formatCurrency(financials.revenue.current)} of ${formatCurrency(financials.revenue.target)} goal (${revenuePercent}%)`;
      }
      
      const slotsSoldEl = document.getElementById('slotsSoldMetric');
      const slotsSoldPercentEl = document.getElementById('slotsSoldPercent');
      if (slotsSoldEl) {
        slotsSoldEl.textContent = `${financials.metrics.spotsSold}/${financials.metrics.effectiveTotalSpots}`;
      }
      if (slotsSoldPercentEl) {
        const percent = Math.round(financials.metrics.progressPercent);
        slotsSoldPercentEl.textContent = `(${percent}%)`;
      }

      const slotsSoldBarEl = document.getElementById('slotsSoldBar');
      if (slotsSoldBarEl) {
        slotsSoldBarEl.style.width = `${financials.metrics.progressPercent}%`;
      }
    }
    
    /* ========= EXPENSE MODAL ========= */
    function openExpenseModal() {
      if (!state.current) {
        toast("Please select a postcard first", false);
        return;
      }
      
      const modal = document.getElementById("expenseModal");
      const mailerId = state.current.Mailer_ID;
      const expenses = financialState.expenses[mailerId] || { ...DEFAULT_EXPENSES };
      
      document.getElementById("expensePrinting").value = expenses.printing || DEFAULT_EXPENSES.printing;
      document.getElementById("expensePostage").value = expenses.postage || DEFAULT_EXPENSES.postage;
      document.getElementById("expenseDesign").value = expenses.design || DEFAULT_EXPENSES.design;
      document.getElementById("expenseMisc").value = expenses.misc || DEFAULT_EXPENSES.misc;
      
      updateExpenseTotal();
      
      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = "flex";
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
      document.getElementById("expensePrinting").focus();
    }
    
    function closeExpenseModal() {
      const modal = document.getElementById("expenseModal");
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) lastFocusedElementBeforeModal.focus();
    }
    
    function updateExpenseTotal() {
      const printing = parseFloat(document.getElementById("expensePrinting").value) || 0;
      const postage = parseFloat(document.getElementById("expensePostage").value) || 0;
      const design = parseFloat(document.getElementById("expenseDesign").value) || 0;
      const misc = parseFloat(document.getElementById("expenseMisc").value) || 0;
      
      const total = printing + postage + design + misc;
      document.getElementById("expenseTotal").textContent = formatCurrency(total);
    }
    
    async function loadExpenses() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('expenses');

        if (cloudData) {
          financialState.expenses = cloudData;
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('mailslot-expenses');
          if (saved) {
            financialState.expenses = JSON.parse(saved);
            // Sync to cloud
            saveToCloud('expenses', financialState.expenses).catch(e => console.warn('Failed to sync expenses to cloud:', e));
          }
        }
      } catch(e) {
        console.error('Error loading expenses:', e);
      }
    }

    async function saveExpenses() {
      try {
        // Save to cloud and localStorage
        await saveToCloud('expenses', financialState.expenses);
      } catch(e) {
        console.warn('Expenses saved to localStorage only (cloud sync failed):', e);
      }
    }

    function saveExpenseModal() {
      if (!state.current) return;

      const mailerId = state.current.Mailer_ID;
      financialState.expenses[mailerId] = {
        printing: parseFloat(document.getElementById("expensePrinting").value) || 0,
        postage: parseFloat(document.getElementById("expensePostage").value) || 0,
        design: parseFloat(document.getElementById("expenseDesign").value) || 0,
        misc: parseFloat(document.getElementById("expenseMisc").value) || 0
      };

      saveExpenses();

      updateFinancialDashboard();
      toast("Expenses saved");
      closeExpenseModal();
      state.dirty = true;
      updateToolbar();
      scheduleAutoSave(); // Trigger auto-save
    }
    
    /* ========= CRM FUNCTIONS ========= */

    function buildClientObject(data) {
      return {
        id: data.id || `CLT-${String(crmState.nextClientId++).padStart(4, '0')}`,
        businessName: data.businessName || "",
        category: data.category || "",
        contact: {
          name: data.contactName || "",
          phone: data.phone || "",
          email: data.email || "",
          address: data.address || ""
        },
        history: data.history || [],
        lifetime: {
          totalSpent: 0,
          cardsBought: 0,
          renewalRate: 0,
          avgPrice: 0
        },
        notes: data.notes || "",
        tags: data.tags || [],
        createdDate: data.createdDate || new Date().toISOString(),
        lastContact: data.lastContact || null,
        nextRenewal: data.nextRenewal || null,
        contract: data.contract || {
          enabled: false,
          startDate: null,
          length: 6,
          monthlyRate: 0,
          totalValue: 0,
          endDate: null,
          autoRenew: false
        }
      };
    }
    
    async function loadClients() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('clients');

        if (cloudData) {
          console.log('üì¶ Loaded clients from cloud:', cloudData);
          crmState.clients = cloudData.clients || {};
          crmState.nextClientId = cloudData.nextClientId || 1;

          // Normalize client data to ensure all have required structure
          Object.keys(crmState.clients).forEach(clientId => {
            const client = crmState.clients[clientId];

            // If client is missing expected properties, normalize it
            if (!client.history || !client.lifetime || !client.contact || typeof client.contact === 'string') {
              crmState.clients[clientId] = buildClientObject({
                id: client.id || clientId,
                businessName: client.businessName || client.business_name || "",
                category: client.category || "",
                contactName: client.contactName || client.contact_name || client.contact || "",
                phone: client.phone || "",
                email: client.email || "",
                address: client.address || "",
                notes: client.notes || "",
                history: client.history || [],
                tags: client.tags || [],
                createdDate: client.createdDate || client.created_at || new Date().toISOString(),
                lastContact: client.lastContact || null,
                nextRenewal: client.nextRenewal || null,
                contract: client.contract || undefined
              });
            }
          });
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('mailslot-clients');
          if (saved) {
            const data = JSON.parse(saved);
            crmState.clients = data.clients || {};
            crmState.nextClientId = data.nextClientId || 1;
            // Sync to cloud
            saveToCloud('clients', { clients: crmState.clients, nextClientId: crmState.nextClientId }).catch(e => console.warn('Failed to sync clients to cloud:', e));
          }
        }

        // Render client list (inside try-catch to prevent promise rejection)
        renderClientList();
      } catch(e) {
        console.error('Error loading clients:', e);
        // Still try to render with empty state
        crmState.clients = {};
        crmState.nextClientId = 1;
        renderClientList();
      }
    }

    async function saveClients() {
      try {
        const data = {
          clients: crmState.clients,
          nextClientId: crmState.nextClientId
        };
        // Save to cloud and localStorage
        await saveToCloud('clients', data);
      } catch(e) {
        console.warn('Clients saved to localStorage only (cloud sync failed):', e);
      }
    }
    
    function renderClientList() {
      const container = document.getElementById('clientList');
      const clients = Object.values(crmState.clients);
      
      if (clients.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No clients yet. Add your first client above!</p>';
        return;
      }
      
      clients.sort((a, b) => a.businessName.localeCompare(b.businessName));
      
      container.innerHTML = clients.map(client => {
        const lastPurchase = client.history.length > 0 
          ? client.history[client.history.length - 1] 
          : null;
        
        return `
          <div class="client-row" 
               onclick="openClientModal('${client.id}')" 
               data-client-id="${client.id}"
               data-category="${client.category}"
               data-business="${client.businessName.toLowerCase()}">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="font-semibold text-gray-900">${esc(client.businessName)}</div>
                <div class="text-sm text-gray-600">${esc(client.category || 'Uncategorized')}</div>
                ${client.contact.name ? `<div class="text-sm text-gray-500">${esc(client.contact.name)} ‚Ä¢ ${esc(client.contact.phone)}</div>` : ''}
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold text-green-600">${formatCurrency(client.lifetime.totalSpent)}</div>
                <div class="text-xs text-gray-500">${client.lifetime.cardsBought} card${client.lifetime.cardsBought === 1 ? '' : 's'}</div>
              </div>
            </div>
            ${lastPurchase ? `
              <div class="mt-2 pt-2 border-t text-xs text-gray-500">
                Last: ${lastPurchase.campaign} (${lastPurchase.status})
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function filterClients() {
      const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      const clientEls = document.querySelectorAll('#clientList .client-row');
      
      clientEls.forEach(el => {
        const business = el.dataset.business || '';
        const category = el.dataset.category || '';
        const clientId = el.dataset.clientId;
        const client = crmState.clients[clientId];
        
        let visible = true;
        
        if (searchTerm && !business.includes(searchTerm) && !category.toLowerCase().includes(searchTerm)) {
          visible = false;
        }
        
        if (categoryFilter && category !== categoryFilter) {
          visible = false;
        }
        
        if (statusFilter && client) {
          const hasActivePurchase = client.history.some(h => h.status === 'Paid in Full');
          const hasPendingPurchase = client.history.some(h => h.status !== 'Paid in Full' && h.status !== 'Available');
          
          if (statusFilter === 'active' && !hasActivePurchase) visible = false;
          if (statusFilter === 'pending' && !hasPendingPurchase) visible = false;
          if (statusFilter === 'inactive' && (hasActivePurchase || hasPendingPurchase)) visible = false;
        }
        
        el.style.display = visible ? 'block' : 'none';
      });
    }
    
    /* ========= CONTRACT MANAGEMENT ========= */
    function toggleContractFields() {
      const enabled = document.getElementById('hasContract').checked;
      document.getElementById('contractFields').classList.toggle('hidden', !enabled);
      if (enabled) {
        // Set default start date to today if empty
        if (!document.getElementById('contractStartDate').value) {
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('contractStartDate').value = today;
          calculateContractEnd();
        }
      }
    }

    function calculateContractEnd() {
      const startDate = document.getElementById('contractStartDate').value;
      const length = parseInt(document.getElementById('contractLength').value);

      if (!startDate) {
        document.getElementById('contractEndDate').textContent = '‚Äî';
        return;
      }

      const start = new Date(startDate);
      const end = new Date(start);
      end.setMonth(end.getMonth() + length);

      // Format as readable date
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('contractEndDate').textContent = end.toLocaleDateString('en-US', options);

      calculateContractTotal();
    }

    function calculateContractTotal() {
      const monthlyRate = parseFloat(document.getElementById('contractMonthlyRate').value) || 0;
      const length = parseInt(document.getElementById('contractLength').value);
      const total = monthlyRate * length;

      document.getElementById('contractTotalValue').textContent = formatCurrency(total);
    }

    function openClientModal(clientId = null) {
      const modal = document.getElementById('clientModal');
      const title = document.getElementById('clientModalTitle');
      const deleteBtn = document.getElementById('btnDeleteClient');
      const historySection = document.getElementById('clientHistorySection');
      
      lastFocusedElementBeforeModal = document.activeElement;
      
      if (clientId && crmState.clients[clientId]) {
        const client = crmState.clients[clientId];
        title.textContent = 'Edit Client';
        deleteBtn.classList.remove('hidden');
        historySection.classList.remove('hidden');
        
        document.getElementById('clientId').value = client.id;
        document.getElementById('clientBusinessName').value = client.businessName;
        document.getElementById('clientCategory').value = client.category;
        document.getElementById('clientContactName').value = client.contact.name;
        document.getElementById('clientPhone').value = client.contact.phone;
        document.getElementById('clientEmail').value = client.contact.email;
        document.getElementById('clientNotes').value = client.notes;
        
        renderClientHistory(client);
        
        document.getElementById('clientLifetimeSpent').textContent = formatCurrency(client.lifetime.totalSpent);
        document.getElementById('clientCardsBought').textContent = client.lifetime.cardsBought;
        document.getElementById('clientAvgPrice').textContent = formatCurrency(client.lifetime.avgPrice);

        // Load contract data
        if (client.contract && client.contract.enabled) {
          document.getElementById('hasContract').checked = true;
          document.getElementById('contractFields').classList.remove('hidden');
          document.getElementById('contractStartDate').value = client.contract.startDate || '';
          document.getElementById('contractLength').value = client.contract.length || 6;
          document.getElementById('contractMonthlyRate').value = client.contract.monthlyRate || '';
          document.getElementById('contractAutoRenew').checked = client.contract.autoRenew || false;
          calculateContractEnd();
        } else {
          document.getElementById('hasContract').checked = false;
          document.getElementById('contractFields').classList.add('hidden');
        }
      } else {
        title.textContent = 'Add New Client';
        deleteBtn.classList.add('hidden');
        historySection.classList.add('hidden');

        document.getElementById('clientId').value = '';
        document.getElementById('clientBusinessName').value = '';
        document.getElementById('clientCategory').value = '';
        document.getElementById('clientCustomCategory').value = '';
        document.getElementById('clientCustomCategory').classList.add('hidden');
        document.getElementById('clientContactName').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('clientNotes').value = '';

        // Reset contract fields
        document.getElementById('hasContract').checked = false;
        document.getElementById('contractFields').classList.add('hidden');
        document.getElementById('contractStartDate').value = '';
        document.getElementById('contractLength').value = '6';
        document.getElementById('contractMonthlyRate').value = '';
        document.getElementById('contractAutoRenew').checked = false;
        document.getElementById('contractEndDate').textContent = '‚Äî';
        document.getElementById('contractTotalValue').textContent = '$0';
      }
      
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
      document.getElementById('clientBusinessName').focus();
    }
    
    function renderClientHistory(client) {
      const container = document.getElementById('clientHistory');
      
      if (client.history.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No purchase history yet</p>';
        return;
      }
      
      container.innerHTML = client.history.map(purchase => `
        <div class="flex justify-between items-center p-2 bg-white border rounded">
          <div>
            <div class="font-medium text-sm">${esc(purchase.campaign)}</div>
            <div class="text-xs text-gray-500">Spot ${purchase.spot} ‚Ä¢ ${purchase.status}</div>
          </div>
          <div class="text-right">
            <div class="font-semibold text-green-600">${formatCurrency(purchase.price)}</div>
            <div class="text-xs text-gray-500">${purchase.date || 'N/A'}</div>
          </div>
        </div>
      `).join('');
    }
    
    function toggleCustomCategory() {
      const categorySelect = document.getElementById('clientCategory');
      const customInput = document.getElementById('clientCustomCategory');

      if (categorySelect.value === 'Other') {
        customInput.classList.remove('hidden');
        customInput.focus();
      } else {
        customInput.classList.add('hidden');
        customInput.value = '';
      }
    }

    function closeClientModal() {
      const modal = document.getElementById('clientModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) lastFocusedElementBeforeModal.focus();
    }

    function saveClientModal() {
      const businessName = document.getElementById('clientBusinessName').value.trim();

      if (!businessName) {
        toast('Business name is required', false);
        document.getElementById('clientBusinessName').focus();
        return;
      }

      // Handle custom category
      let category = document.getElementById('clientCategory').value;
      if (category === 'Other') {
        const customCategory = document.getElementById('clientCustomCategory').value.trim();
        if (!customCategory) {
          toast('Please enter a custom category or select a different option', false);
          document.getElementById('clientCustomCategory').focus();
          return;
        }
        category = customCategory;

        // Add custom category to dropdown for future use
        const categorySelect = document.getElementById('clientCategory');
        const existingOption = Array.from(categorySelect.options).find(opt => opt.value === customCategory);
        if (!existingOption) {
          const newOption = document.createElement('option');
          newOption.value = customCategory;
          newOption.textContent = customCategory;
          // Insert before "Other" option
          const otherOption = categorySelect.querySelector('option[value="Other"]');
          categorySelect.insertBefore(newOption, otherOption);
        }
      }

      const clientId = document.getElementById('clientId').value;
      const isNew = !clientId;

      const clientData = {
        id: clientId || undefined,
        businessName,
        category: category,
        contactName: document.getElementById('clientContactName').value,
        phone: document.getElementById('clientPhone').value,
        email: document.getElementById('clientEmail').value,
        notes: document.getElementById('clientNotes').value
      };
      
      let client;
      if (isNew) {
        client = buildClientObject(clientData);
        crmState.clients[client.id] = client;
      } else {
        client = crmState.clients[clientId];
        client.businessName = clientData.businessName;
        client.category = clientData.category;
        client.contact.name = clientData.contactName;
        client.contact.phone = clientData.phone;
        client.contact.email = clientData.email;
        client.notes = clientData.notes;
      }

      // Save contract data
      const hasContract = document.getElementById('hasContract').checked;
      if (hasContract) {
        const startDate = document.getElementById('contractStartDate').value;
        const length = parseInt(document.getElementById('contractLength').value);
        const monthlyRate = parseFloat(document.getElementById('contractMonthlyRate').value) || 0;
        const autoRenew = document.getElementById('contractAutoRenew').checked;

        // Calculate end date
        let endDate = null;
        if (startDate) {
          const start = new Date(startDate);
          const end = new Date(start);
          end.setMonth(end.getMonth() + length);
          endDate = end.toISOString().split('T')[0];
        }

        client.contract = {
          enabled: true,
          startDate: startDate,
          length: length,
          monthlyRate: monthlyRate,
          totalValue: monthlyRate * length,
          endDate: endDate,
          autoRenew: autoRenew
        };
      } else {
        client.contract = {
          enabled: false,
          startDate: null,
          length: 6,
          monthlyRate: 0,
          totalValue: 0,
          endDate: null,
          autoRenew: false
        };
      }

      saveClients();
      renderClientList();
      closeClientModal();
      toast(isNew ? 'Client added' : 'Client updated');
    }
    
    function deleteClientModal() {
      const clientId = document.getElementById('clientId').value;
      if (!clientId) return;

      const client = crmState.clients[clientId];
      if (!client) return;

      const historyCount = client.history?.length || 0;
      const confirmMsg = `Are you sure you want to delete "${client.businessName}"?\n\n` +
        `This client has ${historyCount} purchase ${historyCount === 1 ? 'record' : 'records'}.\n\n` +
        `This action cannot be undone.`;

      if (confirm(confirmMsg)) {
        delete crmState.clients[clientId];
        saveClients();
        renderClientList();
        closeClientModal();
        toast('Client deleted');
      }
    }
    
    function linkClientToSpot(clientId, spotNum, campaign, price, status) {
      const client = crmState.clients[clientId];
      if (!client) return;
      
      const purchase = {
        campaign: campaign,
        spot: spotNum,
        price: price,
        status: status,
        date: new Date().toISOString().split('T')[0]
      };
      
      client.history.push(purchase);
      
      client.lifetime.cardsBought = client.history.length;
      client.lifetime.totalSpent = client.history.reduce((sum, p) => sum + (p.price || 0), 0);
      client.lifetime.avgPrice = client.lifetime.totalSpent / client.lifetime.cardsBought;
      
      saveClients();
    }
    
    function populateClientDropdown() {
      const select = document.getElementById('editClient');
      if (!select) return;

      const clients = Object.values(crmState.clients).sort((a, b) =>
        a.businessName.localeCompare(b.businessName)
      );

      select.innerHTML = '<option value="">‚Äî Select existing client ‚Äî</option>' +
        clients.map(c => `<option value="${c.id}">${esc(c.businessName)} (${esc(c.category)})</option>`).join('');

      // Auto-fill business name when client is selected
      select.onchange = function() {
        const clientId = this.value;
        if (clientId && crmState.clients[clientId]) {
          document.getElementById('editName').value = crmState.clients[clientId].businessName;
        }
      };
    }
    
    function quickAddClient() {
      const businessName = document.getElementById('editName').value.trim();
      openClientModal();
      if (businessName) {
        document.getElementById('clientBusinessName').value = businessName;
      }
    }
    
    /* ========= EXPORT/IMPORT FUNCTIONS ========= */
    
    function exportClientsCSV() {
      const clients = Object.values(crmState.clients);
      if (clients.length === 0) {
        toast('No clients to export', false);
        return;
      }
      
      const headers = ['Business Name', 'Category', 'Contact Name', 'Phone', 'Email', 'Lifetime Spent', 'Cards Bought', 'Notes'];
      const rows = clients.map(c => [
        c.businessName,
        c.category,
        c.contact.name,
        c.contact.phone,
        c.contact.email,
        c.lifetime.totalSpent,
        c.lifetime.cardsBought,
        c.notes
      ]);
      
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `clients-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      toast('Clients exported to CSV');
    }

    function importClientsCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(line => line.trim());

          if (lines.length < 2) {
            toast('CSV file is empty or invalid', false);
            return;
          }

          // Parse CSV
          const parseCsvLine = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                  current += '"';
                  i++;
                } else {
                  inQuotes = !inQuotes;
                }
              } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
              } else {
                current += char;
              }
            }
            result.push(current);
            return result;
          };

          // Parse header
          const headers = parseCsvLine(lines[0]).map(h => h.trim().toLowerCase());

          // Validate headers
          const requiredHeaders = ['business name', 'category', 'contact name', 'phone', 'email'];
          const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
          if (missingHeaders.length > 0) {
            toast(`CSV missing required columns: ${missingHeaders.join(', ')}`, false);
            return;
          }

          // Parse data rows
          const imported = [];
          const errors = [];

          for (let i = 1; i < lines.length; i++) {
            const values = parseCsvLine(lines[i]);
            if (values.length !== headers.length) continue;

            const row = {};
            headers.forEach((header, idx) => {
              row[header] = values[idx];
            });

            // Validate required fields
            if (!row['business name'] || !row['business name'].trim()) {
              errors.push(`Row ${i + 1}: Missing business name`);
              continue;
            }

            // Create or update client object
            const businessName = row['business name'].trim();

            // Check if client already exists (by business name)
            let existingClient = Object.values(crmState.clients).find(
              c => c.businessName.toLowerCase() === businessName.toLowerCase()
            );

            const clientId = existingClient ? existingClient.id : Date.now() + i;

            const client = {
              id: clientId,
              businessName: businessName,
              category: row['category'] || '',
              contact: {
                name: row['contact name'] || '',
                phone: row['phone'] || '',
                email: row['email'] || ''
              },
              lifetime: {
                totalSpent: parseFloat(row['lifetime spent']) || 0,
                cardsBought: parseInt(row['cards bought']) || 0
              },
              notes: row['notes'] || '',
              contracts: existingClient ? existingClient.contracts : []
            };

            crmState.clients[clientId] = client;
            imported.push(businessName);
          }

          // Save and re-render
          saveClients();
          renderClientList();

          // Reset file input
          event.target.value = '';

          // Show results
          if (imported.length > 0) {
            toast(`Successfully imported ${imported.length} client${imported.length === 1 ? '' : 's'}`, true);
          }
          if (errors.length > 0) {
            console.warn('Import errors:', errors);
            toast(`Imported with ${errors.length} error${errors.length === 1 ? '' : 's'} (check console)`, false);
          }

        } catch (err) {
          console.error('CSV import error:', err);
          toast('Failed to import CSV. Please check the file format.', false);
        }
      };

      reader.onerror = () => {
        toast('Failed to read CSV file', false);
      };

      reader.readAsText(file);
    }

    function syncClientsToSheets() {
      // Google Sheets sync deprecated - now using Supabase cloud storage
      toast('Clients are now automatically synced to Supabase', true);
      return;
    }

    function syncClientsToSheets_DEPRECATED() {
      const clients = Object.values(crmState.clients);

      if (clients.length === 0) {
        toast('No clients to sync', false);
        return;
      }

      toast('Syncing clients to Google Sheets...', true);

      const payload = {
        action: 'syncClients',
        user: ACTIVE_USER,
        clients: clients
      };

      fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors',  // Google Apps Script requires no-cors
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      })
      .then(() => {
        // no-cors mode doesn't allow reading response, so we assume success
        toast(`‚úì Client sync request sent (${clients.length} clients)`, true);
      })
      .catch(err => {
        console.error('Sync error:', err);
        toast('‚ö†Ô∏è Sync failed. Your Google Apps Script may need to handle "syncClients" action. Clients are saved locally.', false);
      });

      // Note: To make this fully functional, add this to your Google Apps Script doPost():
      // if (data.action === 'syncClients') {
      //   // Handle client sync logic here
      //   return ContentService.createTextOutput(JSON.stringify({success: true}))
      //     .setMimeType(ContentService.MimeType.JSON);
      // }
    }
    
    /* ========= EMAIL FUNCTIONS ========= */
    
    const emailTemplates = {
      invoice: {
        subject: 'Invoice Reminder - {businessName}',
        body: 'Hi {contactName},\n\nThis is a friendly reminder that your invoice for {campaign} is still pending.\n\nAmount Due: {amount}\n\nPlease let me know if you have any questions.\n\nBest regards'
      },
      proof: {
        subject: 'Your Ad Proof is Ready - {businessName}',
        body: 'Hi {contactName},\n\nGreat news! Your ad proof for {campaign} is ready for review.\n\nPlease review and let me know if you\'d like any changes.\n\nBest regards'
      },
      renewal: {
        subject: 'Time to Renew - {businessName}',
        body: 'Hi {contactName},\n\nI hope your campaign with us has been successful!\n\nWe\'re preparing our next mailing and would love to have you on board again.\n\nWould you like to renew your spot?\n\nBest regards'
      },
      thankyou: {
        subject: 'Thank You - {businessName}',
        body: 'Hi {contactName},\n\nThank you for advertising with us on {campaign}!\n\nWe appreciate your business and look forward to working with you again.\n\nBest regards'
      }
    };
    
    function openEmailModal() {
      const modal = document.getElementById('emailModal');
      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
    }
    
    function closeEmailModal() {
      const modal = document.getElementById('emailModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) lastFocusedElementBeforeModal.focus();
    }
    
    function loadEmailTemplate() {
      const templateKey = document.getElementById('emailTemplate').value;
      if (!templateKey) return;
      
      const template = emailTemplates[templateKey];
      document.getElementById('emailSubject').value = template.subject;
      document.getElementById('emailBody').value = template.body;
    }
    
    function sendEmail() {
      const to = document.getElementById('emailTo').value;
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;
      
      if (!to || !subject || !body) {
        toast('Please fill in all fields', false);
        return;
      }
      
      // In production, this would call your email API
      const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = mailtoLink;
      
      toast('Email client opened');
      closeEmailModal();
    }
    
    /* ========= REPORTS FUNCTIONS ========= */
    
    function openReportsModal() {
      const modal = document.getElementById('reportsModal');
      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
    }
    
    function closeReportsModal() {
      const modal = document.getElementById('reportsModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) lastFocusedElementBeforeModal.focus();
    }
    
    function generateProfitLossReport() {
      const output = document.getElementById('reportOutput');
      const content = document.getElementById('reportContent');
      
      let report = '<div class="space-y-4">';
      report += '<h3 class="font-bold text-lg">Profit & Loss Report</h3>';
      
      state.mailers.forEach(campaign => {
        const financials = calculateFinancials(campaign.Mailer_ID);
        if (!financials) return;
        
        report += `
          <div class="border-b pb-3">
            <div class="font-semibold">${esc(campaign.Town)} ‚Äî ${esc(campaign.Mail_Date)}</div>
            <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
              <div>Revenue: ${formatCurrency(financials.revenue.current)}</div>
              <div>Expenses: ${formatCurrency(financials.expenses.total)}</div>
              <div class="${financials.profit.current >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
                Profit: ${formatCurrency(financials.profit.current)}
              </div>
              <div>Margin: ${financials.profit.margin.toFixed(1)}%</div>
            </div>
          </div>
        `;
      });
      
      report += '</div>';
      content.innerHTML = report;
      output.classList.remove('hidden');
    }
    
    function generateClientValueReport() {
      const output = document.getElementById('reportOutput');
      const content = document.getElementById('reportContent');
      
      const clients = Object.values(crmState.clients).sort((a, b) => b.lifetime.totalSpent - a.lifetime.totalSpent);
      
      let report = '<div class="space-y-2">';
      report += '<h3 class="font-bold text-lg mb-3">Client Value Analysis</h3>';
      report += '<div class="grid grid-cols-3 gap-2 font-semibold text-sm border-b pb-2">';
      report += '<div>Client</div><div>Lifetime Value</div><div>Cards Purchased</div>';
      report += '</div>';
      
      clients.forEach(client => {
        report += `
          <div class="grid grid-cols-3 gap-2 text-sm py-1">
            <div>${esc(client.businessName)}</div>
            <div class="text-green-600 font-semibold">${formatCurrency(client.lifetime.totalSpent)}</div>
            <div>${client.lifetime.cardsBought}</div>
          </div>
        `;
      });
      
      report += '</div>';
      content.innerHTML = report;
      output.classList.remove('hidden');
    }
    
    function generateCampaignReport() {
      toast('Campaign comparison report generated');
      // Implementation similar to P&L
    }
    
    function generateSalesFunnelReport() {
      toast('Sales funnel report generated');
      // Implementation with kanban metrics
    }
    
    function downloadReport() {
      toast('Report download started');
    }

    /* ========= API QUOTA & PLACES CACHE FUNCTIONS ========= */

    function loadApiQuota() {
      try {
        const saved = safeGetItem('mailslot-api-quota');
        if (saved) {
          const data = JSON.parse(saved);
          const currentMonth = new Date().toISOString().slice(0, 7);

          // Reset if new month
          if (data.currentMonth !== currentMonth) {
            apiQuotaState.currentMonth = currentMonth;
            apiQuotaState.callsThisMonth = 0;
            apiQuotaState.userQuotas = {};
            apiQuotaState.restrictionsActive = false;
            saveApiQuota();
          } else {
            Object.assign(apiQuotaState, data);
          }
        }
      } catch(e) {
        console.error('Error loading API quota:', e);
      }
    }

    function saveApiQuota() {
      safeSetItem('mailslot-api-quota', JSON.stringify(apiQuotaState));
    }

    function getApiQuota() {
      return {
        used: apiQuotaState.callsThisMonth,
        total: apiQuotaState.monthlyLimit,
        remaining: apiQuotaState.monthlyLimit - apiQuotaState.callsThisMonth,
        percentUsed: (apiQuotaState.callsThisMonth / apiQuotaState.monthlyLimit) * 100,
        restrictionsActive: apiQuotaState.restrictionsActive
      };
    }

    async function loadNotInterestedList() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('notInterested');

        if (cloudData) {
          notInterestedState.placeIds = new Set(cloudData.placeIds || []);
          notInterestedState.businesses = cloudData.businesses || {};
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('mailslot-not-interested');
          if (saved) {
            const data = JSON.parse(saved);
            notInterestedState.placeIds = new Set(data.placeIds || []);
            notInterestedState.businesses = data.businesses || {};
            // Sync to cloud
            const cloudData = {
              placeIds: Array.from(notInterestedState.placeIds),
              businesses: notInterestedState.businesses
            };
            saveToCloud('notInterested', cloudData).catch(e => console.warn('Failed to sync not interested list to cloud:', e));
          }
        }
      } catch(e) {
        console.error('Error loading not interested list:', e);
      }
    }

    async function saveNotInterestedList() {
      try {
        const data = {
          placeIds: Array.from(notInterestedState.placeIds),
          businesses: notInterestedState.businesses
        };
        await saveToCloud('notInterested', data);
      } catch(e) {
        console.warn('Not interested list saved to localStorage only (cloud sync failed):', e);
      }
    }

    function loadPlacesCache() {
      try {
        // Prospect pool stays local-only (too large for cloud sync)
        const saved = safeGetItem('mailslot-places-cache');
        if (saved) {
          placesCache.searches = JSON.parse(saved);
        }
      } catch(e) {
        console.error('Error loading places cache:', e);
      }
    }

    function savePlacesCache() {
      // Prospect pool stays local-only (too large for cloud sync)
      safeSetItem('mailslot-places-cache', JSON.stringify(placesCache.searches));
    }

    function trackApiCall(count = 1) {
      apiQuotaState.callsThisMonth += count;

      const percentUsed = apiQuotaState.callsThisMonth / apiQuotaState.monthlyLimit;

      // Activate restrictions at warning threshold
      if (percentUsed >= apiQuotaState.warningThreshold && !apiQuotaState.restrictionsActive) {
        apiQuotaState.restrictionsActive = true;
        // Set per-user quota: remaining calls divided by estimated active users (default 10)
        const remainingCalls = apiQuotaState.monthlyLimit - apiQuotaState.callsThisMonth;
        const perUserQuota = Math.floor(remainingCalls / 10); // Conservative estimate

        toast(`‚ö†Ô∏è API quota at ${Math.round(percentUsed * 100)}% - Per-user limits now active (${perUserQuota} searches/user)`, false);
      }

      // Critical warning
      if (percentUsed >= apiQuotaState.criticalThreshold) {
        toast(`üö® API quota at ${Math.round(percentUsed * 100)}% - Very limited searches remaining`, false);
      }

      saveApiQuota();
    }

    function canUserSearch(userId = ACTIVE_USER) {
      const percentUsed = apiQuotaState.callsThisMonth / apiQuotaState.monthlyLimit;

      // If under warning threshold, everyone can search
      if (percentUsed < apiQuotaState.warningThreshold) {
        return { allowed: true, reason: null };
      }

      // If restrictions active, check user quota
      if (apiQuotaState.restrictionsActive) {
        const userCalls = apiQuotaState.userQuotas[userId] || 0;
        const remainingCalls = apiQuotaState.monthlyLimit - apiQuotaState.callsThisMonth;
        const perUserLimit = Math.floor(remainingCalls / 10);

        if (userCalls >= perUserLimit) {
          return {
            allowed: false,
            reason: `Monthly search limit reached (${perUserLimit} searches). Resets ${getNextMonthDate()}.`
          };
        }
      }

      // Check absolute limit
      if (apiQuotaState.callsThisMonth >= apiQuotaState.monthlyLimit) {
        return {
          allowed: false,
          reason: `System-wide monthly limit reached. Resets ${getNextMonthDate()}.`
        };
      }

      return { allowed: true, reason: null };
    }

    function recordUserSearch(userId = ACTIVE_USER) {
      if (!apiQuotaState.userQuotas[userId]) {
        apiQuotaState.userQuotas[userId] = 0;
      }
      apiQuotaState.userQuotas[userId]++;
      saveApiQuota();
    }

    function getNextMonthDate() {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      return nextMonth.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function getApiUsageStats() {
      const percentUsed = (apiQuotaState.callsThisMonth / apiQuotaState.monthlyLimit * 100).toFixed(1);
      const remaining = apiQuotaState.monthlyLimit - apiQuotaState.callsThisMonth;

      return {
        used: apiQuotaState.callsThisMonth,
        limit: apiQuotaState.monthlyLimit,
        remaining: remaining,
        percentUsed: percentUsed,
        restrictionsActive: apiQuotaState.restrictionsActive,
        resetsOn: getNextMonthDate()
      };
    }

    /* ========= GOOGLE PLACES AUTO-POPULATE FUNCTIONS ========= */

    function openAutoPopulateModal() {
      if (!GOOGLE_PLACES_API_KEY) {
        toast('Google Places API key not configured. Please add your API key to the GOOGLE_PLACES_API_KEY constant.', false);
        return;
      }

      const modal = document.getElementById('autoPopulateModal');
      modal.classList.add('show');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');

      // Update API usage display
      updateApiUsageDisplay();

      // Focus first input
      document.getElementById('autoPopZipCode').focus();
    }

    function closeAutoPopulateModal() {
      const modal = document.getElementById('autoPopulateModal');
      modal.classList.remove('show');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');

      // Reset form
      document.getElementById('autoPopZipCode').value = '';
      document.getElementById('autoPopCategory').value = '';
      document.getElementById('autoPopRadius').value = '5000';
    }

    function updateApiUsageDisplay() {
      const stats = getApiUsageStats();
      const display = document.getElementById('apiUsageDisplay');

      let bgColor = 'bg-green-50 border-green-300';
      let textColor = 'text-green-900';
      let icon = '‚úÖ';

      if (stats.percentUsed >= 95) {
        bgColor = 'bg-red-50 border-red-300';
        textColor = 'text-red-900';
        icon = 'üö®';
      } else if (stats.percentUsed >= 80) {
        bgColor = 'bg-orange-50 border-orange-300';
        textColor = 'text-orange-900';
        icon = '‚ö†Ô∏è';
      } else if (stats.percentUsed >= 50) {
        bgColor = 'bg-yellow-50 border-yellow-300';
        textColor = 'text-yellow-900';
        icon = 'üí°';
      }

      display.className = `mb-4 p-3 rounded-lg border ${bgColor}`;
      display.innerHTML = `
        <div class="${textColor}">
          <div class="font-semibold text-sm mb-1">${icon} API Usage This Month</div>
          <div class="text-xs">
            <strong>${stats.used}</strong> of ${stats.limit} searches used (${stats.percentUsed}%)
            <br>
            ${stats.remaining} searches remaining ‚Ä¢ Resets ${stats.resetsOn}
          </div>
          ${stats.restrictionsActive ? '<div class="text-xs mt-1 font-semibold">‚ö†Ô∏è Per-user quotas active</div>' : ''}
        </div>
      `;
    }

    // Initialize Google Maps API - script loads from <head> tag with callback
    function loadGoogleMapsAPI() {
      return new Promise((resolve, reject) => {
        // Check if already loaded
        if (typeof google !== 'undefined' && google.maps && googleMapsLoaded) {
          resolve();
          return;
        }

        // Wait for callback (script is loading from <head>)
        const checkInterval = setInterval(() => {
          if (googleMapsLoaded && typeof google !== 'undefined' && google.maps) {
            clearInterval(checkInterval);
            resolve();
          }
        }, 100);

        // Timeout after 10 seconds
        setTimeout(() => {
          clearInterval(checkInterval);
          if (!googleMapsLoaded) {
            reject(new Error('Google Maps API failed to load within 10 seconds'));
          }
        }, 10000);
      });
    }

    async function convertZipToLatLng(zipCode) {
      try {
        // Ensure Google Maps API is loaded
        await loadGoogleMapsAPI();

        // Use Google Maps Geocoder (client-side, no CORS issues)
        const geocoder = new google.maps.Geocoder();

        return new Promise((resolve, reject) => {
          geocoder.geocode(
            {
              address: zipCode,
              componentRestrictions: { country: 'US' }
            },
            (results, status) => {
              if (status === 'OK' && results.length > 0) {
                const location = results[0].geometry.location;
                resolve({ lat: location.lat(), lng: location.lng() });
              } else {
                reject(new Error(`Geocoding failed: ${status}`));
              }
            }
          );
        });
      } catch(err) {
        console.error('Geocoding error:', err);
        return null;
      }
    }

    async function searchGooglePlaces(zipCode, category, radiusMeters) {
      // Check quota first
      const quotaCheck = canUserSearch();
      if (!quotaCheck.allowed) {
        toast(quotaCheck.reason, false);
        return [];
      }

      const cacheKey = `${zipCode}-${category}`;

      // Check cache first
      if (placesCache.searches[cacheKey]) {
        const cached = placesCache.searches[cacheKey];
        const cacheDate = new Date(cached.cachedUntil);

        if (new Date() < cacheDate) {
          toast('‚úÖ Using cached results (FREE!)', true);
          return cached.cachedData || [];
        }
      }

      try {
        // Ensure Google Maps API is loaded
        await loadGoogleMapsAPI();

        // Convert zip code to lat/lng
        toast('üìç Finding location...', true);
        const location = await convertZipToLatLng(zipCode);

        if (!location) {
          toast('Invalid zip code or geocoding failed', false);
          return [];
        }

        // Track API call for geocoding
        trackApiCall(1);
        recordUserSearch();

        // Search nearby places using Places Service (client-side, no CORS issues)
        toast('üîç Searching for businesses...', true);

        // Create a temporary div for PlacesService (required by Google Maps API)
        const mapDiv = document.createElement('div');
        const map = new google.maps.Map(mapDiv);
        const service = new google.maps.places.PlacesService(map);

        // List of Google's predefined place types
        const predefinedTypes = [
          'accounting', 'airport', 'amusement_park', 'aquarium', 'art_gallery', 'atm', 'bakery', 'bank', 'bar',
          'beauty_salon', 'bicycle_store', 'book_store', 'bowling_alley', 'bus_station', 'cafe', 'campground',
          'car_dealer', 'car_rental', 'car_repair', 'car_wash', 'casino', 'cemetery', 'church', 'city_hall',
          'clothing_store', 'convenience_store', 'courthouse', 'dentist', 'department_store', 'doctor', 'drugstore',
          'electrician', 'electronics_store', 'embassy', 'fire_station', 'florist', 'funeral_home', 'furniture_store',
          'gas_station', 'gym', 'hair_care', 'hardware_store', 'hindu_temple', 'home_goods_store', 'hospital',
          'insurance_agency', 'jewelry_store', 'laundry', 'lawyer', 'library', 'light_rail_station', 'liquor_store',
          'local_government_office', 'locksmith', 'lodging', 'meal_delivery', 'meal_takeaway', 'mosque', 'movie_rental',
          'movie_theater', 'moving_company', 'museum', 'night_club', 'painter', 'park', 'parking', 'pet_store',
          'pharmacy', 'physiotherapist', 'plumber', 'police', 'post_office', 'primary_school', 'real_estate_agency',
          'restaurant', 'roofing_contractor', 'rv_park', 'school', 'secondary_school', 'shoe_store', 'shopping_mall',
          'spa', 'stadium', 'storage', 'store', 'subway_station', 'supermarket', 'synagogue', 'taxi_stand',
          'tourist_attraction', 'train_station', 'transit_station', 'travel_agency', 'university', 'veterinary_care',
          'zoo', 'administrative_area_level_1', 'administrative_area_level_2', 'administrative_area_level_3',
          'administrative_area_level_4', 'administrative_area_level_5', 'archipelago', 'colloquial_area', 'continent',
          'country', 'establishment', 'finance', 'floor', 'food', 'general_contractor', 'geocode', 'health',
          'intersection', 'locality', 'natural_feature', 'neighborhood', 'place_of_worship', 'plus_code', 'point_of_interest',
          'political', 'post_box', 'postal_code', 'postal_code_prefix', 'postal_code_suffix', 'postal_town', 'premise',
          'room', 'route', 'street_address', 'street_number', 'sublocality', 'sublocality_level_1', 'sublocality_level_2',
          'sublocality_level_3', 'sublocality_level_4', 'sublocality_level_5', 'subpremise', 'town_square', 'grocery_or_supermarket'
        ];

        const isCustomCategory = !predefinedTypes.includes(category.toLowerCase());

        return new Promise((resolve, reject) => {
          let request;

          if (isCustomCategory) {
            // Use textSearch for custom categories (more accurate for niche industries)
            request = {
              query: `${category} in ${zipCode}`,
              location: new google.maps.LatLng(location.lat, location.lng),
              radius: radiusMeters
            };

            service.textSearch(request, (results, status) => {
              // Track API call for places search
              trackApiCall(1);

              if (status === google.maps.places.PlacesServiceStatus.OK ||
                  status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {

                const businesses = (results || [])
                  .filter(place => place.business_status === 'OPERATIONAL') // Only active businesses
                  .map(place => ({
                    placeId: place.place_id,
                    name: place.name,
                    address: place.vicinity || place.formatted_address || '',
                    rating: place.rating || 0,
                    userRatingsTotal: place.user_ratings_total || 0,
                    types: place.types || [],
                    category: category, // Track which category this came from
                    zipCode: zipCode // Track which ZIP code was used for the search
                  }));

                // Cache results for 30 days
                const cacheExpiry = new Date();
                cacheExpiry.setDate(cacheExpiry.getDate() + 30);

                placesCache.searches[cacheKey] = {
                  placeIds: businesses.map(b => b.placeId),
                  cachedData: businesses,
                  cachedUntil: cacheExpiry.toISOString(),
                  lastFetched: new Date().toISOString(),
                  town: state.current?.Town || null // Tag with current town
                };

                savePlacesCache();

                resolve(businesses);
              } else {
                reject(new Error(`Places API error: ${status}`));
              }
            });
          } else {
            // Use nearbySearch for predefined types (faster and more accurate)
            request = {
              location: new google.maps.LatLng(location.lat, location.lng),
              radius: radiusMeters,
              type: category
            };

            service.nearbySearch(request, (results, status) => {
              // Track API call for places search
              trackApiCall(1);

              if (status === google.maps.places.PlacesServiceStatus.OK ||
                  status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {

                const businesses = (results || [])
                  .filter(place => place.business_status === 'OPERATIONAL') // Only active businesses
                  .map(place => ({
                    placeId: place.place_id,
                    name: place.name,
                    address: place.vicinity || place.formatted_address || '',
                    rating: place.rating || 0,
                    userRatingsTotal: place.user_ratings_total || 0,
                    types: place.types || [],
                    category: category, // Track which category this came from
                    zipCode: zipCode // Track which ZIP code was used for the search
                  }));

                // Cache results for 30 days
                const cacheExpiry = new Date();
                cacheExpiry.setDate(cacheExpiry.getDate() + 30);

                placesCache.searches[cacheKey] = {
                  placeIds: businesses.map(b => b.placeId),
                  cachedData: businesses,
                  cachedUntil: cacheExpiry.toISOString(),
                  lastFetched: new Date().toISOString(),
                  town: state.current?.Town || null // Tag with current town
                };

                savePlacesCache();

                resolve(businesses);
              } else {
                reject(new Error(`Places API error: ${status}`));
              }
            });
          }
        });
      } catch(err) {
        console.error('Google Places search error:', err);
        toast(`Search failed: ${err.message}`, false);
        return [];
      }
    }

    // Fetch additional details for a place (phone, website, etc.)
    async function fetchPlaceDetails(placeId) {
      try {
        await loadGoogleMapsAPI();

        return new Promise((resolve, reject) => {
          const service = new google.maps.places.PlacesService(document.createElement('div'));

          service.getDetails(
            {
              placeId: placeId,
              fields: ['formatted_phone_number', 'international_phone_number', 'website', 'opening_hours', 'url']
            },
            (place, status) => {
              if (status === google.maps.places.PlacesServiceStatus.OK) {
                const hasData = !!(place.formatted_phone_number || place.international_phone_number || place.website);
                resolve({
                  phone: place.formatted_phone_number || place.international_phone_number || '',
                  website: place.website || '',
                  email: '', // Google Places doesn't provide emails
                  facebook: '', // Google Places doesn't provide social media
                  instagram: '',
                  googleMapsUrl: place.url || '',
                  openingHours: place.opening_hours?.weekday_text || [],
                  enriched: hasData, // Mark as enriched if we got phone or website
                  cost: 0 // Google Places is free
                });
              } else {
                // Don't reject - just return empty data
                resolve({ phone: '', website: '', email: '', facebook: '', instagram: '', googleMapsUrl: '', openingHours: [], enriched: false, cost: 0 });
              }
            }
          );
        });
      } catch(err) {
        console.error('Error fetching place details:', err);
        return { phone: '', website: '', email: '', facebook: '', instagram: '', googleMapsUrl: '', openingHours: [], enriched: false, cost: 0 };
      }
    }

    // Fetch enriched business details from Outscraper (phone, email, social media)
    // Uses Vercel serverless function as proxy to avoid CORS issues
    async function fetchOutscraperDetails(businessName, address, placeId) {
      try {
        // Call Vercel serverless function proxy
        const response = await fetch('/api/enrich', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            businessName,
            address,
            placeId
          })
        });

        if (!response.ok) {
          console.warn('‚ö†Ô∏è Outscraper proxy returned error:', response.status);
          return {
            phone: '',
            website: '',
            email: '',
            facebook: '',
            instagram: '',
            enriched: false,
            source: 'google-places'
          };
        }

        const data = await response.json();

        if (!data.enriched) {
          console.log('‚ÑπÔ∏è No enrichment data found for:', businessName);
          return {
            ...data,
            source: 'google-places'
          };
        }

        console.log('‚úÖ Enriched from Outscraper:', businessName, {
          hasPhone: !!data.phone,
          hasEmail: !!data.email,
          hasFacebook: !!data.facebook,
          hasInstagram: !!data.instagram
        });

        return {
          ...data,
          source: 'outscraper'
        };

      } catch (error) {
        console.error('üí• Error calling Outscraper proxy:', error);
        return {
          phone: '',
          website: '',
          email: '',
          facebook: '',
          instagram: '',
          enriched: false,
          source: 'google-places',
          error: error.message
        };
      }
    }

    async function runAutoPopulate() {
      const zipCode = document.getElementById('autoPopZipCode').value.trim();
      const category = document.getElementById('autoPopCategory').value;
      const radius = parseInt(document.getElementById('autoPopRadius').value);

      // Validation
      if (!zipCode || !/^\d{5}$/.test(zipCode)) {
        toast('Please enter a valid 5-digit zip code', false);
        return;
      }

      if (!category) {
        toast('Please select a business category', false);
        return;
      }

      // Disable button during search
      const btn = document.getElementById('btnRunAutoPopulate');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Searching...';

      try {
        const businesses = await searchGooglePlaces(zipCode, category, radius);

        if (businesses.length === 0) {
          toast('No businesses found in this area', false);
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        // Just cache results - searchGooglePlaces already handled caching
        closeAutoPopulateModal();

        toast(`‚úÖ Found ${businesses.length} businesses! Go to Prospect Pool tab to review and add them.`, true);

        // Switch to Prospect Pool
        setTimeout(() => {
          switchTab('prospects');
        }, 1500);

      } catch(err) {
        console.error('Auto-populate error:', err);
        toast('Search failed. Please try again.', false);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    // Toggle custom category input
    function toggleBulkCustomCategory() {
      const checkbox = document.getElementById('enableCustomCategory');
      const input = document.getElementById('bulkCustomCategory');
      input.disabled = !checkbox.checked;
      if (checkbox.checked) {
        input.focus();
      } else {
        input.value = '';
      }
    }

    // Update quick API usage display in prospecting section
    function updateQuickApiUsage() {
      const stats = getApiQuota();
      const usageEl = document.getElementById('quickApiUsage');
      const resetEl = document.getElementById('quickApiReset');

      if (usageEl) {
        usageEl.textContent = `${stats.used.toLocaleString()} / ${stats.total.toLocaleString()}`;
      }

      if (resetEl) {
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        nextMonth.setDate(1);
        const monthName = nextMonth.toLocaleString('en-US', { month: 'short' });
        resetEl.textContent = `Resets ${monthName} 1`;
      }
    }

    // Toggle all category checkboxes
    function toggleAllCategories() {
      const selectAllCheckbox = document.getElementById('selectAllCategories');
      const categoryCheckboxes = document.querySelectorAll('.category-checkbox');

      categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
    }

    // Run bulk auto-populate with multiple categories - shows results in modal
    async function runBulkAutoPopulate() {
      const zipCode = document.getElementById('bulkPopZipCode').value.trim();
      const radius = parseInt(document.getElementById('bulkPopRadius').value);

      // Validation
      if (!zipCode || !/^\d{5}$/.test(zipCode)) {
        toast('Please enter a valid 5-digit zip code', false);
        return;
      }

      // Get selected categories
      const categoryCheckboxes = document.querySelectorAll('.category-checkbox:checked');
      const selectedCategories = [];

      categoryCheckboxes.forEach(checkbox => {
        if (checkbox.id === 'enableCustomCategory') {
          // Handle custom category
          const customInput = document.getElementById('bulkCustomCategory');
          if (customInput.value.trim()) {
            selectedCategories.push(customInput.value.trim());
          }
        } else {
          selectedCategories.push(checkbox.value);
        }
      });

      if (selectedCategories.length === 0) {
        toast('Please select at least one business category', false);
        return;
      }

      // Disable button during search
      const btn = document.getElementById('btnRunBulkPopulate');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Searching...';

      try {
        // Track all businesses found across all categories
        const allBusinesses = [];
        const seenPlaceIds = new Set();
        let successfulSearches = 0;
        let failedSearches = 0;

        // Search each category
        for (const category of selectedCategories) {
          try {
            btn.innerHTML = `‚è≥ Searching ${category}... (${successfulSearches + failedSearches + 1}/${selectedCategories.length})`;

            const businesses = await searchGooglePlaces(zipCode, category, radius);

            // Deduplicate by place ID and filter out "not interested"
            businesses.forEach(business => {
              if (!seenPlaceIds.has(business.placeId) && !notInterestedState.placeIds.has(business.placeId)) {
                seenPlaceIds.add(business.placeId);
                allBusinesses.push(business);
              }
            });

            successfulSearches++;

            // Small delay between requests to be polite to the API
            if (selectedCategories.length > 1) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          } catch (err) {
            console.error(`Failed to search category ${category}:`, err);
            failedSearches++;
          }
        }

        if (allBusinesses.length === 0) {
          toast(`Searched ${selectedCategories.length} categories. No businesses found in this area.`, false);
          btn.disabled = false;
          btn.innerHTML = originalText;
          updateQuickApiUsage();
          return;
        }

        // Check which businesses already exist
        const existingLeads = new Set();
        Object.values(kanbanState.columns).forEach(column => {
          if (Array.isArray(column)) {
            column.forEach(lead => {
              if (lead && lead.placeId) {
                existingLeads.add(lead.placeId);
              }
            });
          }
        });

        Object.values(crmState.clients).forEach(client => {
          if (client.placeId) {
            existingLeads.add(client.placeId);
          }
        });

        // Mark businesses with status
        allBusinesses.forEach(business => {
          business.alreadyExists = existingLeads.has(business.placeId);
        });

        // Just cache results - don't auto-add to prospecting
        toast(`‚úÖ Found ${allBusinesses.length} businesses! Go to Prospect Pool tab to review and add them.`, true);

        // Update API usage display
        updateQuickApiUsage();

        // Automatically switch to Prospect Pool tab to review
        setTimeout(() => {
          switchTab('prospects');
        }, 1500);

      } catch(err) {
        console.error('Bulk auto-populate error:', err);
        toast('Search failed. Please try again.', false);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    /* ========= PROSPECTS RESULTS MODAL FUNCTIONS ========= */

    function openProspectsResultsModal() {
      const modal = document.getElementById('prospectsResultsModal');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
    }

    function closeProspectsResultsModal() {
      const modal = document.getElementById('prospectsResultsModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
    }

    function renderProspectsResults() {
      const { businesses, selectedIds } = prospectsResultsState;
      const container = document.getElementById('prospectsResultsContainer');
      const statsContainer = document.getElementById('prospectsResultsStats');

      // Calculate stats
      const newBusinesses = businesses.filter(b => !b.alreadyExists).length;
      const existingBusinesses = businesses.filter(b => b.alreadyExists).length;
      const selectedCount = selectedIds.size;

      // Render stats
      statsContainer.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
          <div class="text-2xl font-bold text-green-600">${newBusinesses}</div>
          <div class="text-xs text-green-800">New Businesses</div>
        </div>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
          <div class="text-2xl font-bold text-gray-600">${existingBusinesses}</div>
          <div class="text-xs text-gray-800">Already in System</div>
        </div>
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 text-center">
          <div class="text-2xl font-bold text-indigo-600">${selectedCount}</div>
          <div class="text-xs text-indigo-800">Selected to Add</div>
        </div>
      `;

      // Render business list
      container.innerHTML = businesses.map(business => {
        const isSelected = selectedIds.has(business.placeId);
        const isDisabled = business.alreadyExists;

        return `
          <div class="border rounded-lg p-3 ${isDisabled ? 'bg-gray-50 opacity-60' : 'bg-white hover:shadow-md'} transition">
            <div class="flex items-start gap-3">
              <input
                type="checkbox"
                ${isSelected ? 'checked' : ''}
                ${isDisabled ? 'disabled' : ''}
                onchange="toggleProspectSelection('${business.placeId}')"
                class="mt-1 w-5 h-5 text-indigo-600 rounded cursor-pointer"
              />
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1 min-w-0">
                    <h4 class="font-semibold text-gray-900 truncate">${esc(business.name)}</h4>
                    <p class="text-sm text-gray-600 mt-0.5">${esc(business.address)}</p>
                    <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                      ${business.rating ? `<span>‚≠ê ${business.rating} (${business.userRatingsTotal || 0} reviews)</span>` : ''}
                    </div>
                  </div>
                  ${isDisabled
                    ? '<span class="text-xs font-medium px-2 py-1 bg-gray-200 text-gray-600 rounded whitespace-nowrap">Already in System</span>'
                    : `<button onclick="markNotInterested('${business.placeId}')" class="text-xs font-medium px-2 py-1 bg-red-50 text-red-600 rounded hover:bg-red-100 whitespace-nowrap">Not Interested</button>`
                  }
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Update button text
      const addButton = document.getElementById('btnAddSelectedProspects');
      addButton.textContent = `Add ${selectedCount} to Pipeline`;
      addButton.disabled = selectedCount === 0;
      addButton.classList.toggle('opacity-50', selectedCount === 0);
      addButton.classList.toggle('cursor-not-allowed', selectedCount === 0);
    }

    function toggleProspectSelection(placeId) {
      if (prospectsResultsState.selectedIds.has(placeId)) {
        prospectsResultsState.selectedIds.delete(placeId);
      } else {
        prospectsResultsState.selectedIds.add(placeId);
      }
      renderProspectsResults();
    }

    function markNotInterested(placeId) {
      // Find the business
      const business = prospectsResultsState.businesses.find(b => b.placeId === placeId);
      if (!business) return;

      // Confirmation dialog
      if (!confirm(`Mark "${business.name}" as "Not Interested"?\n\nThis business will be permanently hidden from all future searches.\n\nYou can undo this later from the Not Interested list.`)) {
        return;
      }

      // Add to not interested list
      notInterestedState.placeIds.add(placeId);
      notInterestedState.businesses[placeId] = {
        name: business.name,
        address: business.address,
        addedDate: new Date().toISOString()
      };
      saveNotInterestedList();

      // Remove from results
      prospectsResultsState.businesses = prospectsResultsState.businesses.filter(b => b.placeId !== placeId);
      prospectsResultsState.selectedIds.delete(placeId);

      toast(`"${business.name}" marked as not interested and will be hidden from future searches`, true);
      renderProspectsResults();
    }

    async function addSelectedProspects() {
      const { businesses, selectedIds } = prospectsResultsState;

      if (selectedIds.size === 0) {
        toast('No businesses selected', false);
        return;
      }

      // Disable button while fetching details
      const btn = document.getElementById('btnAddSelectedProspects');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Fetching details...';

      const prospectingColumn = 'new-lead';
      let addedCount = 0;
      const selectedBusinesses = businesses.filter(b => selectedIds.has(b.placeId) && !b.alreadyExists);

      try {
        // Track total enrichment cost
        let totalCost = 0;
        let enrichedCount = 0;

        // Fetch details for all selected businesses
        for (let i = 0; i < selectedBusinesses.length; i++) {
          const business = selectedBusinesses[i];

          btn.textContent = `‚è≥ Fetching contact details... (${i + 1}/${selectedBusinesses.length})`;

          // Try Outscraper first (if available), fall back to Google Places Details
          let details = await fetchOutscraperDetails(business.name, business.address);

          // If Outscraper failed (CORS or error), fall back to Google Places Details API
          if (!details.enriched && business.placeId) {
            details = await fetchPlaceDetails(business.placeId);
            details.source = 'google-places';
          } else {
            details.source = 'outscraper';
          }

          if (details.enriched) {
            enrichedCount++;
            totalCost += details.cost || OUTSCRAPER_COST_PER_BUSINESS;
          }

          const newLead = {
            id: Date.now() + Math.random(),
            businessName: business.name,
            contactName: '',
            phone: details.phone || '',
            email: details.email || '',
            estimatedValue: 500,
            notes: `Found via Google Places${details.source === 'outscraper' ? ' + Outscraper' : ''}\nAddress: ${business.address}\nRating: ${business.rating} (${business.userRatingsTotal} reviews)\n${details.phone ? `Phone: ${details.phone}\n` : ''}${details.website ? `Website: ${details.website}\n` : ''}${details.email ? `Email: ${details.email}\n` : ''}${details.facebook ? `Facebook: ${details.facebook}\n` : ''}${details.instagram ? `Instagram: ${details.instagram}\n` : ''}Place ID: ${business.placeId}${details.enriched ? (details.cost ? `\n\nüí∞ Enrichment cost: $${details.cost.toFixed(2)}` : '') : ''}`,
            source: details.source || 'google-places',
            placeId: business.placeId,
            website: details.website || '',
            facebook: details.facebook || '',
            instagram: details.instagram || '',
            category: business.category || 'other',
            zipCode: business.zipCode || null, // Tag with ZIP code from search
            mailerId: state.current?.Mailer_ID || null, // Tag with current postcard
            town: state.current?.Town || null, // Tag with current town
            addedDate: new Date().toISOString()
          };

          kanbanState.columns[prospectingColumn].push(newLead);
          addedCount++;

          // Small delay to avoid rate limiting
          if (i < selectedBusinesses.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        }

        saveKanban();
        renderKanban();
        closeProspectsResultsModal();

        // Show success message with enrichment stats
        const costMessage = totalCost > 0 ? ` üí∞ Cost: $${totalCost.toFixed(2)}` : '';
        const enrichmentMessage = enrichedCount > 0 ? ` (${enrichedCount} enriched)` : '';
        toast(`‚úÖ Added ${addedCount} new prospect${addedCount === 1 ? '' : 's'} with contact details!${enrichmentMessage}${costMessage}`, true);

        // Scroll to kanban section
        setTimeout(() => {
          const kanbanSection = document.querySelector('[data-content="pipeline"]');
          if (kanbanSection) {
            kanbanSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      } catch(err) {
        console.error('Error adding prospects:', err);
        toast('Failed to fetch all details. Some prospects may be incomplete.', false);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    /* ========= PROSPECT POOL FUNCTIONS ========= */

    // State for prospect pool selections and manual moves
    let prospectPoolState = {
      selectedIds: new Set(),
      manualProspects: [] // Prospects manually moved from Prospecting to Pool
    };

    // State for tracking selected prospects in Prospecting column
    let prospectingSelectionState = {
      selectedIds: new Set()
    };

    // Load manual prospects from localStorage
    async function loadManualProspects() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('manualProspects');

        if (cloudData && Array.isArray(cloudData)) {
          prospectPoolState.manualProspects = cloudData;
          console.log('üì¶ Loaded', cloudData.length, 'manual prospects from cloud');
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('9x12_manual_prospects');
          if (saved) {
            prospectPoolState.manualProspects = JSON.parse(saved);
            console.log('üì¶ Loaded', prospectPoolState.manualProspects.length, 'manual prospects from localStorage (syncing to cloud...)');
            // Sync to cloud
            saveToCloud('manualProspects', prospectPoolState.manualProspects).catch(e => console.warn('Failed to sync manual prospects to cloud:', e));
          }
        }
      } catch(err) {
        console.error('Error loading manual prospects:', err);
      }
    }

    // Save manual prospects to cloud and localStorage
    async function saveManualProspects() {
      try {
        console.log('üíæ Saving manual prospects to cloud:', prospectPoolState.manualProspects.length, 'prospects');
        await saveToCloud('manualProspects', prospectPoolState.manualProspects);
        console.log('‚úÖ Manual prospects saved to cloud successfully');
      } catch(err) {
        console.warn('‚ö†Ô∏è Manual prospects saved to localStorage only (cloud sync failed):', err);
      }
    }

    // Toggle selection of a prospect in Prospecting column
    function toggleProspectingSelection(leadId) {
      if (prospectingSelectionState.selectedIds.has(leadId)) {
        prospectingSelectionState.selectedIds.delete(leadId);
      } else {
        prospectingSelectionState.selectedIds.add(leadId);
      }
      updateMoveToPoolButton();
    }

    // Update visibility of "Move Selected to Pool" button
    function updateMoveToPoolButton() {
      const btn = document.getElementById('btnMoveSelectedToPool');
      if (btn) {
        if (prospectingSelectionState.selectedIds.size > 0) {
          btn.classList.remove('hidden');
          btn.textContent = `‚¨Ö Move ${prospectingSelectionState.selectedIds.size} to Pool`;
        } else {
          btn.classList.add('hidden');
        }
      }
    }

    // Move all selected prospects to Prospect Pool (bulk operation)
    function moveSelectedToPool() {
      const selectedCount = prospectingSelectionState.selectedIds.size;

      if (selectedCount === 0) {
        toast('No prospects selected', false);
        return;
      }

      // Single confirmation for all
      if (!confirm(`Move ${selectedCount} prospect${selectedCount === 1 ? '' : 's'} to Prospect Pool?`)) {
        return;
      }

      const prospectingColumn = 'new-lead';
      const items = kanbanState.columns[prospectingColumn] || [];
      const movedProspects = [];

      // Collect all selected prospects
      prospectingSelectionState.selectedIds.forEach(leadId => {
        const leadIndex = items.findIndex(item => typeof item === 'object' && item.id === leadId);
        if (leadIndex !== -1) {
          movedProspects.push({
            lead: items[leadIndex],
            index: leadIndex
          });
        }
      });

      // Sort by index descending to safely remove from array
      movedProspects.sort((a, b) => b.index - a.index);

      // Move each prospect
      movedProspects.forEach(({ lead, index }) => {
        // Add to manual prospects pool with current postcard association
        prospectPoolState.manualProspects.push({
          ...lead,
          movedToPoolDate: new Date().toISOString(),
          mailerId: state.current?.Mailer_ID || null, // Tag with current postcard
          town: state.current?.Town || null // Tag with current town
        });

        // Remove from prospecting
        kanbanState.columns[prospectingColumn].splice(index, 1);
      });

      // Clear selections
      prospectingSelectionState.selectedIds.clear();

      saveManualProspects();
      saveKanban();
      renderKanban();

      toast(`‚úÖ Moved ${selectedCount} prospect${selectedCount === 1 ? '' : 's'} to Prospect Pool for ${state.current?.Town || 'current campaign'}`, true);
    }

    // Legacy function - kept for backwards compatibility but now uses bulk selection
    function moveProspectToPool(leadId, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }

      const prospectingColumn = 'new-lead';
      const items = kanbanState.columns[prospectingColumn] || [];
      const leadIndex = items.findIndex(item => typeof item === 'object' && item.id === leadId);

      if (leadIndex === -1) {
        toast('Prospect not found', false);
        return;
      }

      const lead = items[leadIndex];

      // Add to manual prospects pool with current postcard association
      prospectPoolState.manualProspects.push({
        ...lead,
        movedToPoolDate: new Date().toISOString(),
        mailerId: state.current?.Mailer_ID || null, // Tag with current postcard
        town: state.current?.Town || null // Tag with current town
      });

      // Remove from prospecting
      kanbanState.columns[prospectingColumn].splice(leadIndex, 1);

      // Clear this prospect from selection if it was selected
      prospectingSelectionState.selectedIds.delete(leadId);

      saveManualProspects();
      saveKanban();
      renderKanban();

      toast(`"${lead.businessName}" moved to Prospect Pool for ${state.current?.Town || 'current campaign'}`, true);

      // Ask if user wants to view the pool
      setTimeout(() => {
        if (confirm('Go to Prospect Pool to view this prospect?')) {
          switchTab('prospects');
        }
      }, 500);
    }

    // Move prospect from Pool back to Prospecting
    function moveProspectFromPool(prospectId) {
      const prospectIndex = prospectPoolState.manualProspects.findIndex(p => p.id === prospectId);

      if (prospectIndex === -1) {
        toast('Prospect not found in pool', false);
        return;
      }

      const prospect = prospectPoolState.manualProspects[prospectIndex];

      // Check for duplicate by placeId if exists
      const prospectingColumn = 'new-lead';
      const existingLeads = kanbanState.columns[prospectingColumn] || [];

      if (prospect.placeId) {
        const currentMailerId = state.current?.Mailer_ID;
        const duplicate = existingLeads.find(lead =>
          lead.placeId === prospect.placeId &&
          lead.mailerId === currentMailerId
        );

        if (duplicate) {
          toast(`"${prospect.businessName}" already exists in Prospecting for this card`, false);
          return;
        }
      }

      // Remove from pool
      prospectPoolState.manualProspects.splice(prospectIndex, 1);

      // Add back to prospecting with mailerId
      kanbanState.columns[prospectingColumn].push({
        ...prospect,
        mailerId: prospect.mailerId || state.current?.Mailer_ID, // Preserve or set mailerId
        movedBackDate: new Date().toISOString()
      });

      saveManualProspects();
      saveKanban();
      renderProspectPool();
      renderKanban();

      toast(`"${prospect.businessName}" moved back to Prospecting`, true);
    }

    // Expose functions globally
    window.toggleProspectingSelection = toggleProspectingSelection;
    window.moveSelectedToPool = moveSelectedToPool;
    window.moveProspectToPool = moveProspectToPool;
    window.moveProspectFromPool = moveProspectFromPool;
    window.filterProspectPoolByDate = filterProspectPoolByDate;

    function filterProspectPoolByDate() {
      renderProspectPool();
    }

    function renderProspectPool() {
      const container = document.getElementById('prospectPoolContainer');
      const statsContainer = document.getElementById('prospectPoolStats');
      const zipFilterSelect = document.getElementById('prospectPoolZipFilter');

      if (!container || !statsContainer) return;

      // Get selected ZIP codes for filtering
      const selectedZips = zipFilterSelect ? Array.from(zipFilterSelect.selectedOptions).map(opt => opt.value) : ['all'];
      const filterByZip = !selectedZips.includes('all') && selectedZips.length > 0;

      // Get date filter selection
      const filterDays = document.getElementById('prospectPoolDateFilter')?.value || 'all';
      const now = new Date();
      const cutoffDate = filterDays === 'all' ? null : new Date(now.getTime() - (parseInt(filterDays) * 24 * 60 * 60 * 1000));

      // Get all cached searches and organize by category
      const categorizedProspects = {};
      let totalProspects = 0;
      let alreadyInSystem = 0;

      // Check what's already in the system
      const existingPlaceIds = new Set();
      Object.values(kanbanState.columns).forEach(column => {
        if (Array.isArray(column)) {
          column.forEach(lead => {
            if (lead && lead.placeId) {
              existingPlaceIds.add(lead.placeId);
            }
          });
        }
      });

      Object.values(crmState.clients).forEach(client => {
        if (client.placeId) {
          existingPlaceIds.add(client.placeId);
        }
      });

      // Collect all available ZIP codes for the filter dropdown
      const availableZips = new Set();

      // Process cached searches (with deduplication)
      const seenPlaceIds = new Set(); // Track placeIds to prevent duplicates
      Object.keys(placesCache.searches).forEach(cacheKey => {
        const [zipCode, category] = cacheKey.split('-');
        const cached = placesCache.searches[cacheKey];

        if (!cached.cachedData || cached.cachedData.length === 0) return;

        // Track available ZIP codes
        availableZips.add(zipCode);

        // Filter by selected ZIP codes
        if (filterByZip && !selectedZips.includes(zipCode)) {
          return; // Skip searches from unselected ZIP codes
        }

        // Check if cache is still valid
        const cacheDate = new Date(cached.cachedUntil);
        if (new Date() > cacheDate) return; // Skip expired cache

        // Apply date filter
        if (cutoffDate && cached.lastFetched) {
          const fetchedDate = new Date(cached.lastFetched);
          if (fetchedDate < cutoffDate) return; // Skip if outside date range
        }

        if (!categorizedProspects[category]) {
          categorizedProspects[category] = [];
        }

        cached.cachedData.forEach(business => {
          // Skip if already seen (prevents duplicates across searches)
          if (seenPlaceIds.has(business.placeId)) return;

          if (!notInterestedState.placeIds.has(business.placeId)) {
            const isInSystem = existingPlaceIds.has(business.placeId);
            categorizedProspects[category].push({
              ...business,
              zipCode,
              inSystem: isInSystem
            });
            seenPlaceIds.add(business.placeId); // Mark as seen
            totalProspects++;
            if (isInSystem) alreadyInSystem++;
          }
        });
      });

      // Render stats
      const categories = Object.keys(categorizedProspects).length;
      const selectedCount = prospectPoolState.selectedIds.size;
      const available = totalProspects - alreadyInSystem;
      const manualCount = prospectPoolState.manualProspects.length;

      statsContainer.innerHTML = `
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-3xl font-bold text-purple-600">${manualCount}</div>
          <div class="text-xs text-gray-600 mt-1">My Prospect List</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-3xl font-bold text-gray-900">${categories}</div>
          <div class="text-xs text-gray-600 mt-1">Categories</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-3xl font-bold text-indigo-600">${totalProspects}</div>
          <div class="text-xs text-gray-600 mt-1">Total Businesses</div>
        </div>
        <div class="bg-white border rounded-lg p-4 text-center">
          <div class="text-3xl font-bold text-green-600">${available}</div>
          <div class="text-xs text-gray-600 mt-1">Available to Add</div>
        </div>
      `;

      // ========= UNIFIED POOL: Merge manual prospects + search results by category =========

      // Check if we have any prospects at all
      if (Object.keys(categorizedProspects).length === 0 && prospectPoolState.manualProspects.length === 0) {
        container.innerHTML = `
          <div class="text-center py-16 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">No prospects in your pool yet</h3>
            <p class="text-gray-600 mb-6">Run a search from Lead Generation to populate your prospect pool</p>
            <button onclick="switchTab('lead-generation')" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
              Go to Lead Generation
            </button>
          </div>
        `;
        return;
      }

      // Merge both manual prospects and search results into unified categories
      const unifiedByCategory = {};

      // 1. Add manual prospects (enriched) to unified pool - filter by ZIP and date
      prospectPoolState.manualProspects
        .filter(prospect => {
          // Filter by selected ZIP codes
          if (filterByZip && prospect.zipCode && !selectedZips.includes(prospect.zipCode)) {
            return false; // Skip if ZIP doesn't match filter
          }
          // Track available ZIP code
          if (prospect.zipCode) availableZips.add(prospect.zipCode);
          return true;
        })
        .filter(prospect => {
          // Apply date filter
          if (!cutoffDate) return true; // Show all if no date filter
          if (!prospect.movedToPoolDate) return true; // Show if no date (legacy)
          const movedDate = new Date(prospect.movedToPoolDate);
          return movedDate >= cutoffDate;
        })
        .forEach(prospect => {
          const category = prospect.category || 'other';
          if (!unifiedByCategory[category]) {
            unifiedByCategory[category] = [];
          }
          unifiedByCategory[category].push({
            ...prospect,
            isEnriched: true, // From manual list = has contact info
            type: 'manual'
          });
        });

      // 2. Add search results (raw) to unified pool
      Object.keys(categorizedProspects).forEach(category => {
        if (!unifiedByCategory[category]) {
          unifiedByCategory[category] = [];
        }
        categorizedProspects[category].forEach(prospect => {
          unifiedByCategory[category].push({
            ...prospect,
            isEnriched: false, // From search = no contact info yet
            type: 'search'
          });
        });
      });

      // Render unified pool header
      container.innerHTML = `
        <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 mb-6 flex justify-between items-center">
          <div>
            <h3 class="text-lg font-bold text-indigo-900">üéØ Prospect Pool</h3>
            <p class="text-sm text-indigo-700 mt-1">All prospects organized by category - click to add to your pipeline</p>
          </div>
          <button onclick="clearAllProspects()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
            Clear All
          </button>
        </div>

        ${Object.keys(unifiedByCategory).sort().map(category => {
        const prospects = unifiedByCategory[category];
        const categoryName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const enrichedCount = prospects.filter(p => p.isEnriched).length;
        const rawCount = prospects.filter(p => !p.isEnriched).length;

        return `
          <div class="mb-8">
            <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-gray-200">
              <div>
                <h4 class="text-lg font-bold text-gray-900">${categoryName}</h4>
                <p class="text-sm text-gray-600">${prospects.length} total ‚Ä¢ <span class="text-green-600">${enrichedCount} enriched</span> ‚Ä¢ <span class="text-blue-600">${rawCount} raw</span></p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              ${prospects.map(prospect => {
                // For enriched prospects (from manual list) - show with green border and contact icons
                if (prospect.isEnriched) {
                  const hasContact = prospect.phone || prospect.website || prospect.email;
                  const contactIcons = [];
                  if (prospect.phone) contactIcons.push('üìû');
                  if (prospect.website) contactIcons.push('üåê');
                  if (prospect.email) contactIcons.push('‚úâÔ∏è');
                  if (prospect.facebook) contactIcons.push('üìò');
                  if (prospect.instagram) contactIcons.push('üì∑');

                  return `
                    <div class="bg-white border-2 ${hasContact ? 'border-green-400' : 'border-gray-200'} rounded-lg p-3 hover:shadow-md transition">
                      <h5 class="font-semibold text-sm text-gray-900 mb-2">${esc(prospect.businessName)}</h5>
                      ${contactIcons.length > 0 ? `<div class="flex gap-2 text-lg mb-2">${contactIcons.join(' ')}</div>` : ''}
                      ${prospect.followUpDate ? `<div class="text-xs text-purple-600 font-medium mb-2">üìÖ ${prospect.followUpDate}</div>` : ''}
                      <button onclick="moveProspectFromPool(${prospect.id})" class="w-full px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-semibold text-xs">
                        Add to Prospecting ‚Üí
                      </button>
                    </div>
                  `;
                }

                // For raw prospects (from search results) - show with checkbox
                const isSelected = prospectPoolState.selectedIds.has(prospect.placeId);
                const isDisabled = prospect.inSystem;

                return `
                  <div class="border rounded-lg p-3 ${isDisabled ? 'bg-gray-50 opacity-60' : 'bg-white hover:shadow-md'} transition">
                    <div class="flex items-start gap-2">
                      <input
                        type="checkbox"
                        ${isSelected ? 'checked' : ''}
                        ${isDisabled ? 'disabled' : ''}
                        onchange="togglePoolProspect('${prospect.placeId}')"
                        class="mt-1 w-4 h-4 text-indigo-600 rounded cursor-pointer flex-shrink-0"
                      />
                      <div class="flex-1 min-w-0">
                        <h5 class="font-semibold text-sm text-gray-900 truncate">${esc(prospect.name)}</h5>
                        <p class="text-xs text-gray-600 mt-0.5 truncate">${esc(prospect.address)}</p>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                          ${prospect.rating ? `<span>‚≠ê ${prospect.rating}</span>` : ''}
                          ${isDisabled ? '<span class="text-xs px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded">In System</span>' : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('')}
      `;

      // Populate ZIP code filter dropdown with available ZIP codes
      if (zipFilterSelect) {
        const currentlySelected = Array.from(zipFilterSelect.selectedOptions).map(opt => opt.value);
        const sortedZips = Array.from(availableZips).sort();

        zipFilterSelect.innerHTML = '<option value="all">All ZIP Codes</option>' +
          sortedZips.map(zip => `<option value="${esc(zip)}" ${currentlySelected.includes(zip) ? 'selected' : ''}>${esc(zip)}</option>`).join('');
      }

      // Update selected count
      updatePoolSelectedCount();
    }

    function togglePoolProspect(placeId) {
      if (prospectPoolState.selectedIds.has(placeId)) {
        prospectPoolState.selectedIds.delete(placeId);
      } else {
        prospectPoolState.selectedIds.add(placeId);
      }
      updatePoolSelectedCount();
      // Just update the checkbox state, don't re-render everything
    }

    function areCategoryProspectsSelected(category) {
      const cached = placesCache.searches;
      let allSelected = true;
      let hasAny = false;

      Object.keys(cached).forEach(cacheKey => {
        if (!cacheKey.endsWith(`-${category}`)) return;

        cached[cacheKey].cachedData?.forEach(business => {
          if (notInterestedState.placeIds.has(business.placeId)) return;

          // Check if in system
          const existingPlaceIds = new Set();
          Object.values(kanbanState.columns).forEach(column => {
            column.forEach(lead => {
              if (lead && lead.placeId) existingPlaceIds.add(lead.placeId);
            });
          });

          if (existingPlaceIds.has(business.placeId)) return;

          hasAny = true;
          if (!prospectPoolState.selectedIds.has(business.placeId)) {
            allSelected = false;
          }
        });
      });

      return hasAny && allSelected;
    }

    function selectCategoryProspects(category, select) {
      const cached = placesCache.searches;

      // Get existing place IDs
      const existingPlaceIds = new Set();
      Object.values(kanbanState.columns).forEach(column => {
        column.forEach(lead => {
          if (lead && lead.placeId) existingPlaceIds.add(lead.placeId);
        });
      });

      Object.keys(cached).forEach(cacheKey => {
        if (!cacheKey.endsWith(`-${category}`)) return;

        cached[cacheKey].cachedData?.forEach(business => {
          if (notInterestedState.placeIds.has(business.placeId)) return;
          if (existingPlaceIds.has(business.placeId)) return;

          if (select) {
            prospectPoolState.selectedIds.add(business.placeId);
          } else {
            prospectPoolState.selectedIds.delete(business.placeId);
          }
        });
      });

      renderProspectPool();
    }

    function updatePoolSelectedCount() {
      const countEl = document.getElementById('prospectPoolSelectedCount');
      const btnEl = document.getElementById('btnAddFromPool');

      if (countEl) {
        countEl.textContent = prospectPoolState.selectedIds.size;
      }

      if (btnEl) {
        btnEl.disabled = prospectPoolState.selectedIds.size === 0;
      }
    }

    async function addFromProspectPool() {
      if (prospectPoolState.selectedIds.size === 0) {
        toast('No prospects selected', false);
        return;
      }

      // Get current mailer ID
      const currentMailerId = state.current?.Mailer_ID;
      if (!currentMailerId) {
        toast('Please select a postcard first', false);
        return;
      }

      const btn = document.getElementById('btnAddFromPool');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥ Adding...';

      try {
        // Collect all selected businesses
        const selectedBusinesses = [];
        Object.values(placesCache.searches).forEach(cached => {
          cached.cachedData?.forEach(business => {
            if (prospectPoolState.selectedIds.has(business.placeId)) {
              selectedBusinesses.push(business);
            }
          });
        });

        // Fetch details and add to kanban
        const prospectingColumn = 'new-lead';
        const existingLeads = kanbanState.columns[prospectingColumn] || [];

        // Get existing placeIds for current mailer to prevent duplicates
        const existingPlaceIds = new Set(
          existingLeads
            .filter(lead => lead.mailerId === currentMailerId && lead.placeId)
            .map(lead => lead.placeId)
        );

        let addedCount = 0;
        let skippedCount = 0;
        let enrichedCount = 0;
        let totalCost = 0;

        for (let i = 0; i < selectedBusinesses.length; i++) {
          const business = selectedBusinesses[i];

          // Skip if already exists for this mailer
          if (existingPlaceIds.has(business.placeId)) {
            skippedCount++;
            continue;
          }

          btn.textContent = `‚è≥ Fetching contact details... (${i + 1}/${selectedBusinesses.length})`;

          // Try Outscraper first (if available), fall back to Google Places Details
          let details = await fetchOutscraperDetails(business.name, business.address);

          // If Outscraper failed (CORS or error), fall back to Google Places Details API
          if (!details.enriched && business.placeId) {
            details = await fetchPlaceDetails(business.placeId);
            details.source = 'google-places';
          } else {
            details.source = 'outscraper';
          }

          if (details.enriched) {
            enrichedCount++;
            totalCost += details.cost || OUTSCRAPER_COST_PER_BUSINESS;
          }

          const newLead = {
            id: Date.now() + Math.random(),
            businessName: business.name,
            contactName: '',
            phone: details.phone || '',
            email: details.email || '',
            estimatedValue: 500,
            notes: `Found via Google Places${details.source === 'outscraper' ? ' + Outscraper' : ''}\nAddress: ${business.address}\nRating: ${business.rating} (${business.userRatingsTotal} reviews)\n${details.phone ? `Phone: ${details.phone}\n` : ''}${details.website ? `Website: ${details.website}\n` : ''}${details.email ? `Email: ${details.email}\n` : ''}${details.facebook ? `Facebook: ${details.facebook}\n` : ''}${details.instagram ? `Instagram: ${details.instagram}\n` : ''}Place ID: ${business.placeId}${details.enriched ? (details.cost ? `\n\nüí∞ Enrichment cost: $${details.cost.toFixed(2)}` : '') : ''}`,
            source: details.source || 'google-places',
            placeId: business.placeId,
            website: details.website || '',
            facebook: details.facebook || '',
            instagram: details.instagram || '',
            category: business.category || 'other',
            zipCode: business.zipCode || null, // Tag with ZIP code from search
            mailerId: currentMailerId, // Link to current card
            town: state.current?.Town, // Tag with town for organization
            addedDate: new Date().toISOString()
          };

          kanbanState.columns[prospectingColumn].push(newLead);
          addedCount++;

          // Small delay to avoid rate limiting
          if (i < selectedBusinesses.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        }

        saveKanban();
        renderKanban();

        // Clear selections and re-render pool
        prospectPoolState.selectedIds.clear();
        renderProspectPool();

        // Show success message with enrichment stats
        const costMessage = totalCost > 0 ? ` üí∞ Cost: $${totalCost.toFixed(2)}` : '';
        const enrichmentMessage = enrichedCount > 0 ? ` (${enrichedCount} enriched)` : '';
        let message = `‚úÖ Added ${addedCount} prospect${addedCount === 1 ? '' : 's'} to Pipeline with contact details!${enrichmentMessage}${costMessage}`;
        if (skippedCount > 0) {
          message += ` ${skippedCount} duplicate${skippedCount === 1 ? '' : 's'} skipped.`;
        }
        toast(message, true);

        // Switch to pipeline tab
        switchTab('pipeline');
      } catch(err) {
        console.error('Error adding from pool:', err);
        toast('Failed to add prospects. Please try again.', false);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function clearProspectPool() {
      if (!confirm('Are you sure you want to clear the entire prospect pool? This will remove all cached searches.')) {
        return;
      }

      placesCache.searches = {};
      savePlacesCache();
      prospectPoolState.selectedIds.clear();
      renderProspectPool();
      toast('Prospect pool cleared', true);
    }

    // Clear prospects for CURRENT CARD only
    function clearAllProspects() {
      const currentMailerId = state.current?.Mailer_ID;
      if (!currentMailerId) {
        toast('Please select a postcard first', false);
        return;
      }

      const cardName = `${state.current.Town} ‚Äî ${state.current.Mail_Date}`;

      if (!confirm(`‚ö†Ô∏è This will clear all prospects for:\n"${cardName}"\n\n‚Ä¢ All search results in the prospect pool\n‚Ä¢ All prospects in the pipeline (all stages)\n\nAre you sure?`)) {
        return;
      }

      // Clear ALL cached search results (entire prospect pool)
      placesCache.searches = {};
      savePlacesCache();

      // Clear manual prospects for this card only
      prospectPoolState.manualProspects = prospectPoolState.manualProspects.filter(
        p => p.mailerId && p.mailerId !== currentMailerId
      );

      // Clear prospecting column for this card only
      const prospectingColumn = 'new-lead';
      kanbanState.columns[prospectingColumn] = (kanbanState.columns[prospectingColumn] || []).filter(
        lead => !lead.mailerId || lead.mailerId !== currentMailerId
      );

      // Clear all other kanban columns for this card
      ['proposal-sent', 'negotiation', 'closed-won'].forEach(column => {
        kanbanState.columns[column] = (kanbanState.columns[column] || []).filter(
          lead => !lead.mailerId || lead.mailerId !== currentMailerId
        );
      });

      prospectPoolState.selectedIds.clear();

      saveManualProspects();
      saveKanban();

      renderProspectPool();
      renderKanban();

      toast(`‚úÖ All prospects cleared for ${cardName}!`, true);
    }

    // Expose globally
    window.clearAllProspects = clearAllProspects;

    /* ========= KANBAN FUNCTIONS ========= */

    async function loadKanban() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('kanban');

        if (cloudData && typeof cloudData === 'object' && Object.keys(cloudData).length > 0) {
          kanbanState.columns = cloudData;
        } else {
          // Fallback to localStorage
          const saved = localStorage.getItem('mailslot-kanban');
          if (saved) {
            kanbanState.columns = JSON.parse(saved);
          }
          // Sync default/localStorage data to cloud if cloud was empty
          saveToCloud('kanban', kanbanState.columns).catch(e => console.warn('Failed to sync kanban to cloud:', e));
        }

        // Ensure all required columns exist
        const requiredColumns = ['new-lead', 'proposal-sent', 'negotiation', 'closed-won'];
        requiredColumns.forEach(col => {
          if (!kanbanState.columns[col]) {
            kanbanState.columns[col] = [];
          }
        });

        // Clean up any null/undefined items from all columns
        Object.keys(kanbanState.columns).forEach(key => {
          if (Array.isArray(kanbanState.columns[key])) {
            kanbanState.columns[key] = kanbanState.columns[key].filter(item => item != null);
          }
        });

      } catch(e) {
        console.error('Error loading kanban:', e);
      }
      renderKanban();
    }

    async function saveKanban() {
      try {
        // Save to cloud and localStorage
        await saveToCloud('kanban', kanbanState.columns);
      } catch(e) {
        console.warn('Kanban saved to localStorage only (cloud sync failed):', e);
      }
    }

    // CLOUD PROSPECTS SYNC FUNCTIONS
    async function saveSelectedProspectsToCloud() {
      if (cloudSyncSelection.selectedIds.size === 0) {
        toast('No prospects selected', false);
        return;
      }

      try {
        const prospectsToSync = [];

        // Collect selected prospects from all columns
        Object.keys(kanbanState.columns).forEach(columnKey => {
          const items = kanbanState.columns[columnKey];

          // Safety check - ensure column is an array
          if (!Array.isArray(items)) {
            console.warn(`Column ${columnKey} is not an array:`, items);
            return;
          }

          items.forEach(item => {
            if (typeof item === 'object' && item && cloudSyncSelection.selectedIds.has(item.id)) {
              prospectsToSync.push({
                ...item,
                column: columnKey // Store which column it's in
              });
            }
          });
        });

        if (prospectsToSync.length === 0) {
          toast('Selected prospects not found', false);
          return;
        }

        // Use POST request to avoid URL length limits
        const response = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'saveCloudProspects',
            user: ACTIVE_USER,
            prospects: prospectsToSync
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
          toast(`‚úÖ Synced ${result.count} prospect(s) to cloud!`, true);
          cloudSyncSelection.selectedIds.clear();
          renderKanban();
        } else {
          throw new Error(result.error || 'Unknown error');
        }

      } catch (err) {
        console.error('Failed to sync prospects to cloud:', err);
        toast('Failed to sync prospects to cloud', false);
      }
    }

    async function loadCloudProspects() {
      try {
        const url = `${GAS_URL}?action=loadCloudProspects&user=${encodeURIComponent(ACTIVE_USER)}`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.success && result.prospects) {
          return result.prospects;
        }

        return [];

      } catch (err) {
        console.error('Failed to load cloud prospects:', err);
        return [];
      }
    }

    async function deleteCloudProspect(prospectId) {
      try {
        const url = `${GAS_URL}?action=deleteCloudProspect&user=${encodeURIComponent(ACTIVE_USER)}&prospectId=${encodeURIComponent(prospectId)}`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        return result.success;

      } catch (err) {
        console.error('Failed to delete cloud prospect:', err);
        return false;
      }
    }

    function toggleCloudSyncUI() {
      cloudSyncSelection.showSyncUI = !cloudSyncSelection.showSyncUI;
      if (!cloudSyncSelection.showSyncUI) {
        cloudSyncSelection.selectedIds.clear();
      }
      renderKanban();
    }

    function toggleProspectForSync(prospectId) {
      if (cloudSyncSelection.selectedIds.has(prospectId)) {
        cloudSyncSelection.selectedIds.delete(prospectId);
      } else {
        cloudSyncSelection.selectedIds.add(prospectId);
      }
      debouncedRenderKanban(); // Use debounced version for checkbox toggles
    }

    // Debounce utility to prevent excessive re-renders
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Debounced version of renderKanban for non-critical updates
    const debouncedRenderKanban = debounce(() => renderKanban(), DEBOUNCE_RENDER_DELAY);

    function renderKanban() {
      const container = document.getElementById('salesActivityContainer');
      const currentMailerId = state.current?.Mailer_ID;

      const columnDefs = [
        { key: 'new-lead', title: '1. Prospecting', color: 'blue' },
        { key: 'proposal-sent', title: '2. Initial Contact', color: 'purple' },
        { key: 'negotiation', title: '3. Follow-Up (Active)', color: 'green' },
        { key: 'closed-won', title: '4. Committed / Sold', color: 'yellow' }
      ];

      // Cloud Sync UI at top (HIDDEN temporarily - needs more testing)
      const cloudSyncBar = cloudSyncSelection.showSyncUI
        ? `
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-blue-900">‚òÅÔ∏è Cloud Sync Mode</span>
              <span class="text-sm text-blue-700">${cloudSyncSelection.selectedIds.size} selected</span>
            </div>
            <div class="flex gap-2">
              <button onclick="saveSelectedProspectsToCloud()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium" ${cloudSyncSelection.selectedIds.size === 0 ? 'disabled' : ''}>
                ‚òÅÔ∏è Sync to Cloud
              </button>
              <button onclick="toggleCloudSyncUI()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500 text-sm">
                Cancel
              </button>
            </div>
          </div>
        `
        : ''; // Hidden for now

      const columnsHTML = columnDefs.map(col => {
        let items = (kanbanState.columns[col.key] || [])
          .filter(item => item != null) // Filter out null/undefined
          .filter(item => {
            // Filter by current mailer - show items that either:
            // 1. Have mailerId matching current card, OR
            // 2. Have no mailerId (legacy items, show in all cards)
            if (!currentMailerId) return true; // Show all if no card selected
            if (typeof item === 'string') return true; // Legacy string format
            return !item.mailerId || item.mailerId === currentMailerId;
          });

        // Deduplicate by placeId (keep first occurrence)
        const seenPlaceIds = new Set();
        items = items.filter(item => {
          if (typeof item !== 'object' || !item.placeId) return true; // Keep items without placeId
          if (seenPlaceIds.has(item.placeId)) return false; // Skip duplicates
          seenPlaceIds.add(item.placeId);
          return true;
        });

        // Sort Prospecting column: items with phone/website/email first
        if (col.key === 'new-lead') {
          items = items.sort((a, b) => {
            const aHasContact = (a.phone || a.website || a.email) ? 1 : 0;
            const bHasContact = (b.phone || b.website || b.email) ? 1 : 0;
            return bHasContact - aHasContact; // Sort descending (with contact first)
          });
        }

        // Add buttons for Prospecting column
        const buttons = col.key === 'new-lead'
          ? `
            <div class="flex gap-1">
              <button id="btnMoveSelectedToPool" onclick="moveSelectedToPool()" class="text-xs px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 hidden" title="Move selected to pool">
                ‚¨Ö Move to Pool
              </button>
              <button onclick="openLeadModal('${col.key}')" class="text-xs px-2 py-1 bg-${col.color}-600 text-white rounded hover:bg-${col.color}-700" title="Add lead manually">
                +
              </button>
            </div>
          `
          : `
            <button onclick="openLeadModal('${col.key}')" class="text-xs px-2 py-1 bg-${col.color}-600 text-white rounded hover:bg-${col.color}-700" title="Add lead">
              +
            </button>
          `;

        return `
          <div class="kanban-column" data-column="${col.key}">
            <div class="flex justify-between items-center mb-2">
              <div class="font-semibold text-sm text-${col.color}-600">${col.title} (${items.length})</div>
              ${buttons}
            </div>
            ${items.map((item, idx) => {
              // Support both string (legacy) and object format
              // Add safety check for null/undefined items
              if (!item) return '';

              const leadName = typeof item === 'string' ? item : (item.businessName || 'Unnamed Lead');
              const leadId = typeof item === 'string' ? idx : (item.id || idx);

              // Enhanced display for Prospecting column
              if (col.key === 'new-lead' && typeof item === 'object') {
                const hasContact = item.phone || item.website || item.email;
                const isProspectingSelected = prospectingSelectionState.selectedIds.has(leadId);
                const isCloudSyncSelected = cloudSyncSelection.selectedIds.has(leadId);

                // Build compact icon display
                const contactIcons = [];
                if (item.phone) contactIcons.push(`<a href="tel:${esc(item.phone)}" class="text-lg hover:text-blue-600" title="üìû ${esc(item.phone)}">üìû</a>`);
                if (item.website) contactIcons.push(`<a href="${esc(item.website)}" target="_blank" class="text-lg hover:text-blue-600" title="üåê ${esc(item.website)}">üåê</a>`);
                if (item.email) contactIcons.push(`<a href="mailto:${esc(item.email)}" class="text-lg hover:text-blue-600" title="‚úâÔ∏è ${esc(item.email)}">‚úâÔ∏è</a>`);
                if (item.facebook) contactIcons.push(`<a href="${esc(item.facebook)}" target="_blank" class="text-lg hover:text-blue-600" title="Facebook">üìò</a>`);
                if (item.instagram) contactIcons.push(`<a href="${esc(item.instagram)}" target="_blank" class="text-lg hover:text-blue-600" title="Instagram">üì∑</a>`);

                return `
                  <div class="kanban-item text-xs p-2 bg-white border rounded ${hasContact ? 'border-l-4 border-l-green-500' : 'border-l-4 border-l-gray-300'} cursor-move" data-item-id="${leadId}" data-column="${col.key}">
                    <div class="flex justify-between items-start gap-2 mb-2">
                      ${cloudSyncSelection.showSyncUI ? `
                        <input
                          type="checkbox"
                          ${isCloudSyncSelected ? 'checked' : ''}
                          onchange="toggleProspectForSync(${leadId})"
                          onclick="event.stopPropagation()"
                          class="mt-1 w-4 h-4 text-blue-600 rounded cursor-pointer flex-shrink-0"
                        />
                      ` : `
                        <input
                          type="checkbox"
                          ${isProspectingSelected ? 'checked' : ''}
                          onchange="toggleProspectingSelection(${leadId})"
                          onclick="event.stopPropagation()"
                          class="mt-1 w-4 h-4 text-purple-600 rounded cursor-pointer flex-shrink-0"
                        />
                      `}
                      <div class="flex-1">
                        <div class="font-medium text-xs break-words">${esc(leadName)}</div>
                        ${item.zipCode ? `<div class="text-xs text-gray-500 font-medium mt-0.5">üìç ${esc(item.zipCode)}</div>` : ''}
                      </div>
                      <div class="flex gap-1 flex-shrink-0">
                        <button onclick="openContactLaterModal(${leadId}, event)" class="text-purple-600 hover:text-purple-800 text-sm cursor-pointer" title="Contact Later">üìÖ</button>
                        <button onclick="editLead('${col.key}', ${leadId}, event)" class="text-blue-600 hover:text-blue-800 text-sm cursor-pointer" title="Edit">‚úé</button>
                        <button onclick="deleteLead('${col.key}', ${leadId}, event)" class="text-red-600 hover:text-red-800 text-sm cursor-pointer" title="Delete">üóë</button>
                      </div>
                    </div>
                    ${contactIcons.length > 0 ? `
                      <div class="flex gap-2 items-center justify-center py-1">
                        ${contactIcons.join('')}
                      </div>
                    ` : '<div class="text-gray-400 italic text-center py-1">No contact info</div>'}
                  </div>
                `;
              }

              // Standard display for other columns
              const isCloudSyncSelected = cloudSyncSelection.selectedIds.has(leadId);

              return `
                <div class="kanban-item text-xs p-2 bg-white border rounded cursor-move" data-item-id="${leadId}" data-column="${col.key}">
                  <div class="flex justify-between items-start gap-2">
                    ${cloudSyncSelection.showSyncUI && typeof item === 'object' ? `
                      <input
                        type="checkbox"
                        ${isCloudSyncSelected ? 'checked' : ''}
                        onchange="toggleProspectForSync(${leadId})"
                        onclick="event.stopPropagation()"
                        class="mt-0.5 w-4 h-4 text-blue-600 rounded cursor-pointer flex-shrink-0"
                      />
                    ` : ''}
                    <div class="flex-1">
                      <div class="font-medium">${esc(leadName)}</div>
                      ${typeof item === 'object' && item.zipCode ? `<div class="text-xs text-gray-500 font-medium mt-0.5">üìç ${esc(item.zipCode)}</div>` : ''}
                    </div>
                    <div class="flex gap-1">
                      <button onclick="editLead('${col.key}', ${leadId}, event)" class="text-blue-600 hover:text-blue-800 cursor-pointer" title="Edit">‚úé</button>
                      <button onclick="deleteLead('${col.key}', ${leadId}, event)" class="text-red-600 hover:text-red-800 cursor-pointer" title="Delete">üóë</button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');

      // Set container HTML with cloud sync bar + columns
      container.innerHTML = cloudSyncBar + columnsHTML;

      setupKanbanDrag();
      updateMoveToPoolButton();
    }
    
    function setupKanbanDrag() {
      // Set draggable attribute and attach listeners to each item
      const items = document.querySelectorAll('.kanban-item');

      items.forEach(item => {
        item.setAttribute('draggable', 'true');

        item.ondragstart = function(e) {
          // Prevent drag if click started on or near interactive elements
          let element = e.target;
          while (element && element !== this) {
            if (element.tagName === 'INPUT' ||
                element.tagName === 'BUTTON' ||
                element.tagName === 'A' ||
                element.tagName === 'SELECT' ||
                element.tagName === 'TEXTAREA') {
              e.preventDefault();
              e.stopPropagation();
              return false;
            }
            element = element.parentElement;
          }

          draggedItem = this;
          this.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', this.dataset.itemId);
        };

        item.ondragend = function(e) {
          this.classList.remove('dragging');
          draggedItem = null;
        };
      });

      // Set up drop zones on columns
      const columns = document.querySelectorAll('.kanban-column');

      columns.forEach(col => {
        col.ondragover = function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        };

        col.ondrop = function(e) {
          e.preventDefault();

          if (!draggedItem) {
            return;
          }

          const fromColumn = draggedItem.closest('.kanban-column').dataset.column;
          const toColumn = this.dataset.column;
          const itemId = parseFloat(draggedItem.dataset.itemId); // Use parseFloat to preserve decimals

          // Find and remove from old column
          const fromItems = kanbanState.columns[fromColumn] || [];
          const fromIdx = fromItems.findIndex(item => {
            if (typeof item === 'string') return false;
            return item.id === itemId;
          });

          if (fromIdx > -1) {
            const itemToMove = fromItems[fromIdx];
            fromItems.splice(fromIdx, 1);

            // Add to new column
            if (!kanbanState.columns[toColumn]) {
              kanbanState.columns[toColumn] = [];
            }

            // Check if item already exists in destination
            const alreadyExists = kanbanState.columns[toColumn].some(item => {
              if (typeof item === 'string') return false;
              return item.id === itemId;
            });

            if (!alreadyExists) {
              kanbanState.columns[toColumn].push(itemToMove);
            }

            saveKanban();
            renderKanban();

            // Map column key to display title
            const columnTitles = {
              'new-lead': '1. Prospecting',
              'proposal-sent': '2. Initial Contact',
              'negotiation': '3. Follow-Up (Active)',
              'closed-won': '4. Committed / Sold'
            };
            toast(`Moved to ${columnTitles[toColumn] || toColumn}`);
          }
        };
      });
    }
    
    /* ========= TASKS FUNCTIONS ========= */
    
    async function loadTasks() {
      try {
        // Try loading from cloud first
        const cloudData = await loadFromCloud('tasks');

        if (cloudData && Array.isArray(cloudData)) {
          tasksState.tasks = cloudData;
        } else {
          // Check localStorage as fallback
          const saved = localStorage.getItem('mailslot-tasks');
          if (saved) {
            tasksState.tasks = JSON.parse(saved);
            // Sync to cloud if we loaded from localStorage
            saveToCloud('tasks', tasksState.tasks).catch(e => console.warn('Failed to sync tasks to cloud:', e));
          } else {
            // Initialize with default tasks
            tasksState.tasks = [
              { id: 1, text: 'Call Royco Partners about Renewal', dueDate: '2025-11-20', completed: false },
              { id: 2, text: 'Follow up Capital Systems Group', dueDate: '2025-11-22', completed: false },
              { id: 3, text: 'Check Print Status: Boston Card', dueDate: '2025-11-25', completed: false },
              { id: 4, text: 'SMS Client: Stone Solutions Maine', dueDate: '2025-11-25', completed: false },
              { id: 5, text: 'Prep Renewal Pitch: Adam\'s Pizza', dueDate: '2025-11-28', completed: false },
              { id: 6, text: 'Design Ad Proof for Royco', dueDate: '2025-11-30', completed: false }
            ];
            saveTasks();
          }
        }
      } catch(e) {
        console.error('Error loading tasks:', e);
      }
      updateTasksDisplay();
    }

    async function saveTasks() {
      try {
        // Save to cloud and localStorage
        await saveToCloud('tasks', tasksState.tasks);
      } catch(e) {
        console.error('‚ùå Tasks save failed:', e);
        console.warn('Tasks saved to localStorage only (cloud sync failed):', e);
        // Show user-visible error
        toast('‚ö†Ô∏è Cloud sync failed - saved locally only', false);
      }
    }
    
    function updateTasksDisplay() {
      const container = document.getElementById('taskList');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Filter: hide completed tasks that are overdue
      const visibleTasks = tasksState.tasks.filter(task => {
        if (task.completed) {
          const dueDate = new Date(task.dueDate);
          dueDate.setHours(0, 0, 0, 0);
          return dueDate >= today; // Only show completed if not overdue
        }
        return true;
      });
      
      if (visibleTasks.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">All tasks complete!</p>';
        document.getElementById('overdueText').textContent = 'All tasks complete';
        document.getElementById('overdueText').className = 'text-sm text-green-600 mb-2';
        return;
      }
      
      container.innerHTML = visibleTasks.map(task => {
        const dueDate = new Date(task.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        const overdueClass = dueDate < today && !task.completed ? 'overdue' : '';
        const completedClass = task.completed ? 'completed' : '';

        return `
          <div class="task-row ${completedClass}" draggable="true" data-task-id="${task.id}" data-due-date="${task.dueDate}">
            <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskComplete(this)" />
            <span class="task-text">${esc(task.text)}</span>
            <input type="date" class="task-date ${overdueClass}" value="${task.dueDate}" onchange="updateTaskDate(this)" />
            <div style="display: flex; gap: 0.5rem; margin-left: auto;">
              <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-800 text-xs" title="Edit task">
                ‚úé
              </button>
              <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-800 text-xs" title="Delete task">
                üóë
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // Update overdue count
      const incompleteTasks = visibleTasks.filter(t => !t.completed);
      const overdueCount = incompleteTasks.filter(t => {
        const dueDate = new Date(t.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate < today;
      }).length;
      
      const overdueText = document.getElementById('overdueText');
      if (overdueCount > 0) {
        overdueText.textContent = `${overdueCount} Task${overdueCount > 1 ? 's' : ''} Overdue`;
        overdueText.className = 'text-sm text-red-500 mb-2 font-bold';
      } else if (incompleteTasks.length > 0) {
        overdueText.textContent = `${incompleteTasks.length} Task${incompleteTasks.length > 1 ? 's' : ''} Pending`;
        overdueText.className = 'text-sm text-blue-600 mb-2';
      } else {
        overdueText.textContent = 'All tasks complete';
        overdueText.className = 'text-sm text-green-600 mb-2';
      }
      
      setupTaskDrag();
    }
    
    function setupTaskDrag() {
      const taskList = document.getElementById('taskList');
      
      taskList.querySelectorAll('.task-row').forEach(row => {
        row.addEventListener('dragstart', e => {
          draggedTask = row;
          row.classList.add('dragging');
        });
        
        row.addEventListener('dragend', e => {
          row.classList.remove('dragging');
          draggedTask = null;
        });
      });
      
      taskList.addEventListener('dragover', e => {
        e.preventDefault();
      });
      
      taskList.addEventListener('drop', e => {
        e.preventDefault();
        if (draggedTask) {
          const afterElement = getDragAfterElement(taskList, e.clientY);
          if (afterElement == null) {
            taskList.appendChild(draggedTask);
          } else {
            taskList.insertBefore(draggedTask, afterElement);
          }

          // Persist the new order
          const newOrder = Array.from(taskList.querySelectorAll('.task-row')).map(row => {
            const taskId = parseInt(row.dataset.taskId);
            return tasksState.tasks.find(t => t.id === taskId);
          }).filter(t => t != null);

          tasksState.tasks = newOrder;
          saveTasks();
          toast('Task order saved', true);
        }
      });
      
      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.task-row:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }
    }

    /* ========= TASK MANAGEMENT CRUD ========= */
    function openTaskModal(taskId = null) {
      const modal = document.getElementById("taskModal");
      const title = document.getElementById("taskModalTitle");
      const textInput = document.getElementById("taskText");
      const dateInput = document.getElementById("taskDueDate");
      const idInput = document.getElementById("taskId");

      if (taskId) {
        // Edit existing task
        const task = tasksState.tasks.find(t => t.id === taskId);
        if (task) {
          title.textContent = "Edit Task";
          textInput.value = task.text;
          dateInput.value = task.dueDate;
          idInput.value = task.id;
        }
      } else {
        // New task
        title.textContent = "Add New Task";
        textInput.value = "";
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        idInput.value = "";
      }

      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = "flex";
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
      textInput.focus();
    }

    function closeTaskModal() {
      const modal = document.getElementById("taskModal");
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) {
        lastFocusedElementBeforeModal.focus();
        lastFocusedElementBeforeModal = null;
      }
    }

    function saveTaskModal() {
      const textInput = document.getElementById("taskText");
      const dateInput = document.getElementById("taskDueDate");
      const idInput = document.getElementById("taskId");

      const text = textInput.value.trim();
      const dueDate = dateInput.value;

      if (!text) {
        toast("Please enter a task description", false);
        return;
      }

      if (!dueDate) {
        toast("Please select a due date", false);
        return;
      }

      // Warn if date is in the past (but still allow it)
      const today = new Date().toISOString().split('T')[0];
      if (dueDate < today) {
        if (!confirm(`‚ö†Ô∏è Warning: This date is in the past (${dueDate}).\n\nDo you want to continue?`)) {
          return;
        }
      }

      const taskId = idInput.value;

      if (taskId) {
        // Edit existing task
        const task = tasksState.tasks.find(t => t.id == taskId);
        if (task) {
          task.text = text;
          task.dueDate = dueDate;
          toast("Task updated successfully");
        }
      } else {
        // Create new task
        const newTask = {
          id: Date.now(),
          text: text,
          dueDate: dueDate,
          completed: false
        };
        tasksState.tasks.push(newTask);
        toast("Task added successfully");
      }

      saveTasks();
      updateTasksDisplay();
      closeTaskModal();
    }

    function editTask(taskId) {
      openTaskModal(taskId);
    }

    function deleteTask(taskId) {
      const index = tasksState.tasks.findIndex(t => t.id === taskId);

      if (index === -1) {
        toast("Task not found", false);
        return;
      }

      const task = tasksState.tasks[index];
      const taskText = task.text || 'Unnamed task';

      if (!confirm(`Are you sure you want to delete this task?\n\n"${taskText}"\n\nThis action cannot be undone.`)) {
        return;
      }

      tasksState.tasks.splice(index, 1);
      saveTasks();
      updateTasksDisplay();
      toast("Task deleted successfully");
    }

    /* ========= LEAD/PROSPECT MANAGEMENT CRUD ========= */
    // Render activity log
    function renderActivityLog(activityLog = []) {
      const container = document.getElementById('leadActivityLog');
      if (!activityLog || activityLog.length === 0) {
        container.innerHTML = '<div class="text-gray-400 italic">No activity yet</div>';
        return;
      }

      container.innerHTML = activityLog.map(activity => {
        const date = new Date(activity.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        return `
          <div class="text-gray-700">
            <span class="text-gray-500">${dateStr}:</span> ${esc(activity.note)}
          </div>
        `;
      }).join('');
    }

    // Add activity note to current lead
    function addActivityNote() {
      const noteInput = document.getElementById('leadNewActivity');
      const note = noteInput.value.trim();

      if (!note) {
        toast('Please enter a note', false);
        return;
      }

      const leadId = document.getElementById("leadId").value;
      const column = document.getElementById("leadColumn").value;

      if (!leadId) {
        toast('Please save the lead first before adding notes', false);
        return;
      }

      // Find the lead
      const items = kanbanState.columns[column] || [];
      const lead = items.find(item => typeof item === 'object' && item.id === parseFloat(leadId));

      if (!lead) {
        toast('Lead not found', false);
        return;
      }

      // Add note to activity log
      if (!lead.activityLog) {
        lead.activityLog = [];
      }

      lead.activityLog.push({
        timestamp: new Date().toISOString(),
        note: note
      });

      // Re-render activity log
      renderActivityLog(lead.activityLog);

      // Clear input
      noteInput.value = '';

      // Save changes
      saveKanban();

      toast('Note added', true);
    }

    // Expose functions globally
    window.addActivityNote = addActivityNote;

    /* ========= CONTACT LATER MODAL ========= */
    function openContactLaterModal(leadId, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }

      const prospectingColumn = 'new-lead';
      const items = kanbanState.columns[prospectingColumn] || [];

      // Convert leadId to number for comparison
      const numericLeadId = typeof leadId === 'string' ? parseFloat(leadId) : leadId;

      const lead = items.find(item => {
        if (typeof item !== 'object' || !item) return false;
        const itemId = typeof item.id === 'string' ? parseFloat(item.id) : item.id;
        return itemId === numericLeadId;
      });

      if (!lead) {
        console.error('Lead not found. Looking for ID:', numericLeadId, 'in items:', items);
        toast('Prospect not found', false);
        return;
      }

      // Set modal data
      document.getElementById('contactLaterBusinessName').textContent = lead.businessName;
      document.getElementById('contactLaterLeadId').value = numericLeadId;

      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('contactLaterDate').value = tomorrow.toISOString().split('T')[0];

      document.getElementById('contactLaterNote').value = '';

      // Show modal
      const modal = document.getElementById('contactLaterModal');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('contactLaterDate').focus();
    }

    function closeContactLaterModal() {
      const modal = document.getElementById('contactLaterModal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    function saveContactLater() {
      const leadId = parseFloat(document.getElementById('contactLaterLeadId').value);
      const followUpDate = document.getElementById('contactLaterDate').value;
      const note = document.getElementById('contactLaterNote').value.trim();

      if (!followUpDate) {
        toast('Please select a follow-up date', false);
        return;
      }

      const prospectingColumn = 'new-lead';
      const items = kanbanState.columns[prospectingColumn] || [];
      const leadIndex = items.findIndex(item => typeof item === 'object' && item.id === leadId);

      if (leadIndex === -1) {
        toast('Prospect not found', false);
        return;
      }

      const lead = items[leadIndex];

      // Set follow-up date
      lead.followUpDate = followUpDate;

      // Add activity note if provided
      if (note) {
        if (!lead.activityLog) {
          lead.activityLog = [];
        }
        lead.activityLog.push({
          timestamp: new Date().toISOString(),
          note: `üìÖ Set follow-up for ${followUpDate}: ${note}`
        });
      } else {
        if (!lead.activityLog) {
          lead.activityLog = [];
        }
        lead.activityLog.push({
          timestamp: new Date().toISOString(),
          note: `üìÖ Set follow-up for ${followUpDate}`
        });
      }

      // Move to pool
      prospectPoolState.manualProspects.push({
        ...lead,
        movedToPoolDate: new Date().toISOString()
      });

      // Remove from prospecting
      kanbanState.columns[prospectingColumn].splice(leadIndex, 1);

      saveManualProspects();
      saveKanban();
      renderKanban();
      closeContactLaterModal();

      toast(`üìÖ "${lead.businessName}" moved to pool. Follow up on ${followUpDate}`, true);
    }

    // Expose functions globally
    window.openContactLaterModal = openContactLaterModal;
    window.closeContactLaterModal = closeContactLaterModal;
    window.saveContactLater = saveContactLater;

    function openLeadModal(column = null, leadId = null) {
      const modal = document.getElementById("leadModal");
      const title = document.getElementById("leadModalTitle");
      const columnInput = document.getElementById("leadColumn");
      const idInput = document.getElementById("leadId");

      if (leadId !== null && column) {
        // Edit existing lead
        const items = kanbanState.columns[column] || [];
        const numericLeadId = typeof leadId === 'string' ? parseFloat(leadId) : leadId;
        const lead = items.find(item => {
          if (typeof item !== 'object') return false;
          const itemId = typeof item.id === 'string' ? parseFloat(item.id) : item.id;
          return itemId === numericLeadId;
        });

        if (lead) {
          title.textContent = "Edit Lead";
          document.getElementById("leadBusinessName").value = lead.businessName || '';
          document.getElementById("leadContactName").value = lead.contactName || '';
          document.getElementById("leadPhone").value = lead.phone || '';
          document.getElementById("leadEmail").value = lead.email || '';
          document.getElementById("leadWebsite").value = lead.website || '';
          document.getElementById("leadFacebook").value = lead.facebook || '';
          document.getElementById("leadInstagram").value = lead.instagram || '';
          document.getElementById("leadValue").value = lead.value || '';
          document.getElementById("leadNotes").value = lead.notes || '';
          document.getElementById("leadFollowUpDate").value = lead.followUpDate || '';

          // Render activity log
          renderActivityLog(lead.activityLog || []);

          columnInput.value = column;
          idInput.value = leadId;
        }
      } else {
        // New lead
        title.textContent = "Add New Lead";
        document.getElementById("leadBusinessName").value = '';
        document.getElementById("leadContactName").value = '';
        document.getElementById("leadPhone").value = '';
        document.getElementById("leadEmail").value = '';
        document.getElementById("leadWebsite").value = '';
        document.getElementById("leadFacebook").value = '';
        document.getElementById("leadInstagram").value = '';
        document.getElementById("leadValue").value = '';
        document.getElementById("leadNotes").value = '';
        document.getElementById("leadFollowUpDate").value = '';

        // Clear activity log
        renderActivityLog([]);

        columnInput.value = column || 'new-lead';
        idInput.value = '';
      }

      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = "flex";
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
      document.getElementById("leadBusinessName").focus();
    }

    function closeLeadModal() {
      const modal = document.getElementById("leadModal");
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) {
        lastFocusedElementBeforeModal.focus();
        lastFocusedElementBeforeModal = null;
      }
    }

    function saveLeadModal() {
      const businessName = document.getElementById("leadBusinessName").value.trim();
      const contactName = document.getElementById("leadContactName").value.trim();
      const phone = document.getElementById("leadPhone").value.trim();
      const email = document.getElementById("leadEmail").value.trim();
      const website = document.getElementById("leadWebsite").value.trim();
      const facebook = document.getElementById("leadFacebook").value.trim();
      const instagram = document.getElementById("leadInstagram").value.trim();
      const value = document.getElementById("leadValue").value.trim();
      const notes = document.getElementById("leadNotes").value.trim();
      const followUpDate = document.getElementById("leadFollowUpDate").value;
      const column = document.getElementById("leadColumn").value;
      const leadId = document.getElementById("leadId").value;

      if (!businessName) {
        toast("Please enter a business name", false);
        return;
      }

      // Get existing activity log if editing
      let activityLog = [];
      if (leadId) {
        const items = kanbanState.columns[column] || [];
        const existingLead = items.find(item => typeof item === 'object' && item.id === parseFloat(leadId));
        if (existingLead && existingLead.activityLog) {
          activityLog = existingLead.activityLog;
        }
      }

      const leadData = {
        id: leadId ? parseFloat(leadId) : Date.now() + Math.random(),
        businessName: businessName,
        contactName: contactName,
        phone: phone,
        email: email,
        website: website,
        facebook: facebook,
        instagram: instagram,
        value: value ? parseFloat(value) : 0,
        notes: notes,
        followUpDate: followUpDate,
        activityLog: activityLog,
        createdDate: new Date().toISOString()
      };

      if (leadId) {
        // Edit existing lead
        const items = kanbanState.columns[column] || [];
        const index = items.findIndex(item => typeof item === 'object' && item.id === parseFloat(leadId));
        if (index !== -1) {
          items[index] = leadData;
          toast("Lead updated successfully");
        }
      } else {
        // Add new lead
        if (!kanbanState.columns[column]) {
          kanbanState.columns[column] = [];
        }
        kanbanState.columns[column].push(leadData);
        toast("Lead added successfully");
      }

      saveKanban();
      renderKanban();
      closeLeadModal();
    }

    function editLead(column, leadId, event) {
      // Stop event propagation to prevent drag behavior
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      // Normalize ID type (handle both string and number)
      const numericLeadId = typeof leadId === 'string' ? parseFloat(leadId) : leadId;
      openLeadModal(column, numericLeadId);
    }

    function deleteLead(column, leadId, event) {
      // Stop event propagation
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }

      // Normalize ID type (handle both string and number)
      const numericLeadId = typeof leadId === 'string' ? parseFloat(leadId) : leadId;

      const items = kanbanState.columns[column] || [];
      const index = items.findIndex(item => {
        if (typeof item === 'string') return false;
        const itemId = typeof item.id === 'string' ? parseFloat(item.id) : item.id;
        return itemId === numericLeadId;
      });

      if (index === -1) {
        toast("Lead not found", false);
        return;
      }

      const lead = items[index];
      const leadName = typeof lead === 'string' ? lead : (lead.businessName || 'Unnamed Lead');

      if (!confirm(`Are you sure you want to delete "${leadName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      if (index !== -1) {
        items.splice(index, 1);

        // Clear this prospect from selection if it was selected
        prospectingSelectionState.selectedIds.delete(leadId);

        saveKanban();
        renderKanban();
        toast("Lead deleted successfully");
      }
    }

    /* ========= NEW POSTCARD CREATION WORKFLOW ========= */
    function openNewPostcardModal() {
      const modal = document.getElementById("newPostcardModal");

      // Populate town dropdown with unique towns from existing postcards
      const towns = [...new Set(state.mailers.map(m => m.Town))].sort();
      const townSelect = document.getElementById("newPostcardTownSelect");
      townSelect.innerHTML = '<option value="">‚Äî Select existing town ‚Äî</option>' +
        towns.map(town => `<option value="${esc(town)}">${esc(town)}</option>`).join('');

      // Populate year dropdown (current year and next 2 years)
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById("newPostcardYear");
      yearSelect.innerHTML = [currentYear, currentYear + 1, currentYear + 2]
        .map(year => `<option value="${year}">${year}</option>`).join('');

      // Set default month to next month
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      document.getElementById("newPostcardMonth").value = String(nextMonth.getMonth() + 1).padStart(2, '0');

      // Populate copy source dropdown
      const copySelect = document.getElementById("copySourcePostcard");
      copySelect.innerHTML = '<option value="">‚Äî Select postcard ‚Äî</option>' +
        state.mailers.map((m, i) => `<option value="${i}">${esc(m.Town)} ‚Äî ${esc(m.Mail_Date)}</option>`).join('');

      // Reset form
      document.querySelector('input[name="townOption"][value="existing"]').checked = true;
      document.getElementById("newPostcardTownInput").disabled = true;
      document.getElementById("copyFromPrevious").checked = false;
      document.getElementById("copyOptions").classList.add('hidden');
      document.getElementById("advertiserChecklistContainer").classList.add('hidden');

      lastFocusedElementBeforeModal = document.activeElement;
      modal.style.display = "flex";
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
    }

    function closeNewPostcardModal() {
      const modal = document.getElementById("newPostcardModal");
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal) {
        lastFocusedElementBeforeModal.focus();
        lastFocusedElementBeforeModal = null;
      }
    }

    function toggleTownInput() {
      const isNew = document.querySelector('input[name="townOption"][value="new"]').checked;
      document.getElementById("newPostcardTownSelect").disabled = isNew;
      document.getElementById("newPostcardTownInput").disabled = !isNew;
    }

    function toggleCopyOptions() {
      const checked = document.getElementById("copyFromPrevious").checked;
      document.getElementById("copyOptions").classList.toggle('hidden', !checked);
      if (!checked) {
        document.getElementById("advertiserChecklistContainer").classList.add('hidden');
      }
    }

    function loadAdvertisersForCopy() {
      const sourceIndex = document.getElementById("copySourcePostcard").value;
      if (!sourceIndex) {
        document.getElementById("advertiserChecklistContainer").classList.add('hidden');
        return;
      }

      const sourcePostcard = state.mailers[sourceIndex];
      if (!sourcePostcard) return;

      // Extract advertisers from the source postcard
      const advertisers = [];
      for (let i = 1; i <= 18; i++) {
        const spotKey = `Spot_${i}`;
        const raw = (sourcePostcard.availability || {})[spotKey] || "Available";
        if (!/^available$/i.test(raw)) {
          const match = String(raw).match(/^(.+?)\s*:\s*(.*)$/);
          if (match) {
            const status = match[1].trim();
            const name = match[2].trim();
            if (name) {
              // Check if this advertiser is already in the list (merged spots)
              const existing = advertisers.find(a => a.name.toLowerCase() === name.toLowerCase());
              if (existing) {
                existing.spots.push(i);
              } else {
                advertisers.push({ name, status, spots: [i] });
              }
            }
          }
        }
      }

      // Render checklist
      const checklist = document.getElementById("advertiserChecklist");
      if (advertisers.length === 0) {
        checklist.innerHTML = '<p class="text-sm text-gray-500">No advertisers found in this postcard.</p>';
        document.getElementById("advertiserChecklistContainer").classList.remove('hidden');
        return;
      }

      checklist.innerHTML = advertisers.map((adv, idx) => {
        const spotText = adv.spots.length > 1 ? `Spots ${adv.spots.join(', ')}` : `Spot ${adv.spots[0]}`;
        return `
          <label class="flex items-start gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
            <input type="checkbox" value="${idx}" checked class="mt-0.5" />
            <div class="flex-1">
              <div class="font-medium text-sm">${esc(adv.name)}</div>
              <div class="text-xs text-gray-600">${spotText} ‚Ä¢ Status: ${esc(adv.status)}</div>
            </div>
          </label>
        `;
      }).join('');

      document.getElementById("advertiserChecklistContainer").classList.remove('hidden');
    }

    async function createNewPostcard() {
      // Get form values
      const isNewTown = document.querySelector('input[name="townOption"][value="new"]').checked;
      const town = isNewTown ?
        document.getElementById("newPostcardTownInput").value.trim() :
        document.getElementById("newPostcardTownSelect").value;

      const month = document.getElementById("newPostcardMonth").value;
      const year = document.getElementById("newPostcardYear").value;
      const inHomesDate = document.getElementById("newPostcardInHomesDate").value;

      // Validation
      if (!town) {
        toast("Please select or enter a town name", false);
        return;
      }

      if (!inHomesDate) {
        toast("Please select an in-homes date", false);
        return;
      }

      // Show loading state
      const btn = document.getElementById('btnCreatePostcard');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Creating...';

      try {

        // Build mail date - store in ISO format (YYYY-MM-DD) to avoid timezone issues
        const mailDate = `${year}-${month.padStart(2, '0')}-01`;  // e.g., "2025-12-01"

        // Build display name for duplicate check
        const monthNames = ["", "January", "February", "March", "April", "May", "June",
                            "July", "August", "September", "October", "November", "December"];
        const displayDate = `${monthNames[parseInt(month)]} ${year}`;

        // Check for duplicates using town and month/year
        const duplicate = state.mailers.find(m => {
          const mDate = new Date(m.Mail_Date);
          return m.Town.toLowerCase() === town.toLowerCase() &&
                 mDate.getMonth() + 1 === parseInt(month) &&
                 mDate.getFullYear() === parseInt(year);
        });
        if (duplicate) {
          toast("A postcard for this town and date already exists!", false);
          btn.disabled = false;
          btn.innerHTML = originalText;
          return;
        }

        // Create new postcard object
        const newPostcard = {
          Mailer_ID: `${town.replace(/\s+/g, '-')}-${month.padStart(2, '0')}-${year}`,
          Town: town,
          Mail_Date: mailDate,  // Store as "12/1/2025" format
          In_Homes_Date: inHomesDate,
          Payment_Status: "Active",  // Set to Active by default
          availability: {},
          Postcard_BG: "#000000",
          Banner_BG: "#000000"  // Black background (will display white text via useLightTextOn)
        };

        // Initialize all spots as available
        for (let i = 1; i <= 18; i++) {
          newPostcard.availability[`Spot_${i}`] = "Available";
        }

        // Handle copy from previous
        if (document.getElementById("copyFromPrevious").checked) {
          const sourceIndex = document.getElementById("copySourcePostcard").value;
          if (sourceIndex) {
            const sourcePostcard = state.mailers[sourceIndex];
            const checklist = document.getElementById("advertiserChecklist");
            const checkedBoxes = checklist.querySelectorAll('input[type="checkbox"]:checked');

            // Collect selected advertisers
            const advertisers = [];
            for (let i = 1; i <= 18; i++) {
              const spotKey = `Spot_${i}`;
              const raw = (sourcePostcard.availability || {})[spotKey] || "Available";
              if (!/^available$/i.test(raw)) {
                const match = String(raw).match(/^(.+?)\s*:\s*(.*)$/);
                if (match) {
                  const name = match[2].trim();
                  if (name) {
                    const existing = advertisers.find(a => a.name.toLowerCase() === name.toLowerCase());
                    if (existing) {
                      existing.spots.push(i);
                    } else {
                      advertisers.push({ name, spots: [i] });
                    }
                  }
                }
              }
            }

            // Apply selected advertisers to new postcard with "Reserved" status
            checkedBoxes.forEach(checkbox => {
              const idx = parseInt(checkbox.value);
              const adv = advertisers[idx];
              if (adv) {
                adv.spots.forEach(spotNum => {
                  newPostcard.availability[`Spot_${spotNum}`] = `Reserved:${adv.name}`;
                });
              }
            });
          }
        }

        // Add the new postcard to state.mailers
        state.mailers.push(newPostcard);

        // Sort mailers by date (newest first), then by town (alphabetically)
        state.mailers = state.mailers.sort((a, b) => {
          const dateA = a.Mail_Date || '';
          const dateB = b.Mail_Date || '';
          if (dateA !== dateB) {
            return dateB.localeCompare(dateA); // Reverse order for descending
          }
          const townA = (a.Town || '').toLowerCase();
          const townB = (b.Town || '').toLowerCase();
          return townA.localeCompare(townB);
        });

        // Find the index of the newly created postcard after sorting
        const newIndex = state.mailers.findIndex(m => m.Mailer_ID === newPostcard.Mailer_ID);

        // Update the dropdown selectors
        const selManager = document.getElementById("postcardSelect");

        const selectHtml = '<option value="">‚Äî Select ‚Äî</option>' +
          state.mailers.map((m,i)=>{
            // Format date display
            let displayDate = m.Mail_Date || "";
            if (/^\d{4}-\d{2}-\d{2}/.test(displayDate)) {
              const [year, month] = displayDate.split('-');
              const monthNames = ["", "January", "February", "March", "April", "May", "June",
                                  "July", "August", "September", "October", "November", "December"];
              displayDate = `${monthNames[parseInt(month)]} ${year}`;
            }
            return `<option value="${i}">${esc(m.Town)} ‚Äî ${esc(displayDate)}</option>`;
          }).join("");

        if (selManager) {
          selManager.innerHTML = selectHtml;
          selManager.value = newIndex.toString();
        }

        // Repopulate town and month selectors and set to new postcard
        populateTownAndMonthSelectors();
        const townSelect = document.getElementById("headerTownSelect");
        const monthSelect = document.getElementById("headerMonthSelect");
        if (townSelect && newPostcard.Town) {
          townSelect.value = newPostcard.Town;
          onTownChanged(); // Populate month dropdown for this town
          if (monthSelect && newPostcard.Mail_Date) monthSelect.value = newPostcard.Mail_Date;
        }

        // Save to cloud immediately
        btn.innerHTML = '‚òÅÔ∏è Saving to cloud...';

        try {
          // Insert into Supabase with snake_case column names
          const { error } = await supabaseClient
            .from('postcards')
            .insert({
              user_email: ACTIVE_USER,
              mailer_id: newPostcard.Mailer_ID,
              town: newPostcard.Town,
              mail_date: newPostcard.Mail_Date,
              in_homes_date: newPostcard.In_Homes_Date,
              payment_status: newPostcard.Payment_Status,
              postcard_bg: newPostcard.Postcard_BG,
              banner_bg: newPostcard.Banner_BG,
              spot_1: newPostcard.availability.Spot_1 || 'Available',
              spot_2: newPostcard.availability.Spot_2 || 'Available',
              spot_3: newPostcard.availability.Spot_3 || 'Available',
              spot_4: newPostcard.availability.Spot_4 || 'Available',
              spot_5: newPostcard.availability.Spot_5 || 'Available',
              spot_6: newPostcard.availability.Spot_6 || 'Available',
              spot_7: newPostcard.availability.Spot_7 || 'Available',
              spot_8: newPostcard.availability.Spot_8 || 'Available',
              spot_9: newPostcard.availability.Spot_9 || 'Available',
              spot_10: newPostcard.availability.Spot_10 || 'Available',
              spot_11: newPostcard.availability.Spot_11 || 'Available',
              spot_12: newPostcard.availability.Spot_12 || 'Available',
              spot_13: newPostcard.availability.Spot_13 || 'Available',
              spot_14: newPostcard.availability.Spot_14 || 'Available',
              spot_15: newPostcard.availability.Spot_15 || 'Available',
              spot_16: newPostcard.availability.Spot_16 || 'Available',
              spot_17: newPostcard.availability.Spot_17 || 'Available',
              spot_18: newPostcard.availability.Spot_18 || 'Available'
            });

          if (error) throw error;

          toast("‚úÖ Postcard created and saved to cloud!", true);

        } catch (cloudErr) {
          console.error("Failed to save to cloud:", cloudErr);
          toast("‚ö†Ô∏è Postcard created locally. Will sync on next spot edit.", false);
        }

        // Switch to the new postcard
        pickCampaign({ target: { value: newIndex.toString() } });

        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalText;

        closeNewPostcardModal();

      } catch (err) {
        console.error("Failed to create postcard:", err);
        toast("‚ö†Ô∏è Error creating postcard: " + err.message, false);

        // Reset button
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    /* ========= RENEWAL AUTOMATION ========= */

    function checkRenewals() {
      if (!state.current) return;
      
      const mailDate = new Date(state.current.Mail_Date);
      const today = new Date();
      const daysSinceDrop = Math.floor((today - mailDate) / (1000 * 60 * 60 * 24));
      
      const renewalContainer = document.getElementById('renewalList');
      if (!renewalContainer) return;
      
      if (daysSinceDrop >= 30) {
        const clients = Object.values(crmState.clients).filter(c => 
          c.history.some(h => h.campaign.includes(state.current.Town))
        );
        
        renewalContainer.innerHTML = clients.map(c => `
          <div class="p-3 border rounded-lg bg-white">
            <div class="font-semibold">${esc(c.businessName)}</div>
            <div class="text-sm text-gray-600">Ready for renewal outreach</div>
            <button onclick="openEmailRenewal('${c.id}')" class="mt-2 text-sm px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
              Send Renewal Email
            </button>
          </div>
        `).join('');
      } else {
        renewalContainer.innerHTML = `<p class="text-sm text-gray-500">No renewals due yet (${30 - daysSinceDrop} days remaining)</p>`;
      }
    }
    
    function openEmailRenewal(clientId) {
      const client = crmState.clients[clientId];
      if (!client) return;
      
      openEmailModal();
      document.getElementById('emailTemplate').value = 'renewal';
      loadEmailTemplate();
      document.getElementById('emailTo').value = client.contact.email;
      
      // Replace placeholders
      let subject = document.getElementById('emailSubject').value;
      let body = document.getElementById('emailBody').value;
      subject = subject.replace('{businessName}', client.businessName);
      body = body.replace('{contactName}', client.contact.name || 'there');
      body = body.replace('{campaign}', state.current ? `${state.current.Town} ${state.current.Mail_Date}` : 'our campaign');
      
      document.getElementById('emailSubject').value = subject;
      document.getElementById('emailBody').value = body;
    }

    // Delete the current postcard
    async function deleteCurrentPostcard() {
      if (!state.current) {
        toast('No postcard selected', false);
        return;
      }

      const postcard = state.current;
      const confirmMsg = `Are you sure you want to delete the postcard for ${postcard.Town} ‚Äî ${postcard.Mail_Date}?\n\nThis action cannot be undone.`;

      if (!confirm(confirmMsg)) return;

      try {
        // Delete from Supabase
        const { error } = await supabaseClient
          .from('postcards')
          .delete()
          .eq('user_email', ACTIVE_USER)
          .eq('mailer_id', postcard.Mailer_ID);

        if (error) throw error;

        // Remove from state
        const currentIndex = state.mailers.findIndex(m => m.Mailer_ID === postcard.Mailer_ID);
        if (currentIndex !== -1) {
          state.mailers.splice(currentIndex, 1);
        }

        // Clear current selection
        state.current = null;
        state.availability = {};
        state.initial = {};
        state.merged.clear();
        state.selected.clear();
        state.dirty = false;

        // Refresh dropdowns
        populateTownAndMonthSelectors();

        // Select first postcard if available
        if (state.mailers.length > 0) {
          pickCampaign({ target: { value: '0' } });
        } else {
          renderAll();
        }

        toast(`‚úÖ Postcard for ${postcard.Town} deleted successfully`, true);

      } catch (err) {
        console.error('Error deleting postcard:', err);
        toast('Failed to delete postcard', false);
      }
    }

    /* ========= PERSISTED COLORS ========= */
    const POSTCARD_BG_KEY = "mailslot-postcard-bg";
    const BANNER_BG_KEY = "mailslot-banner-bg";
    
    function loadPostcardBg() {
      try {
        const v = localStorage.getItem(POSTCARD_BG_KEY) || "#000000";
        return v;
      } catch (_) { return "#000000"; }
    }
    
    function loadBannerBg() {
      try {
        const v = localStorage.getItem(BANNER_BG_KEY) || "#000000";
        return v;
      } catch (_) { return "#000000"; }
    }
    
    function savePostcardBg(hex) {
      try { localStorage.setItem(POSTCARD_BG_KEY, hex); } catch(_) {}
    }
    
    function saveBannerBg(hex) {
      try { localStorage.setItem(BANNER_BG_KEY, hex); } catch(_) {}
    }
    
    function applyStagedColors() {
      document.querySelectorAll('.postcard').forEach(el => {
        el.style.backgroundColor = stagedColors.Postcard_BG;
        const border = shadeBlend(stagedColors.Postcard_BG, -0.15) || '#e5e7eb';
        el.style.borderColor = border;
      });
      document.querySelectorAll('.banner').forEach(b => {
        b.style.backgroundColor = stagedColors.Banner_BG;
        const border = shadeBlend(stagedColors.Banner_BG, -0.12) || '#e5e7eb';
        b.style.borderColor = border;
        b.style.color = useLightTextOn(stagedColors.Banner_BG) ? '#fff' : '#0f172a';
      });
      const previewPostcard = document.getElementById('previewPostcard');
      const previewBanner = document.getElementById('previewBanner');
      if (previewPostcard) previewPostcard.style.backgroundColor = stagedColors.Postcard_BG;
      if (previewBanner) {
        previewBanner.style.backgroundColor = stagedColors.Banner_BG;
        previewBanner.style.color = useLightTextOn(stagedColors.Banner_BG) ? '#fff' : '#0f172a';
      }
    }
    
    function shadeBlend(hex, percent) {
      try {
        const h = hex.replace('#','');
        const r = parseInt(h.substring(0,2),16), g = parseInt(h.substring(2,4),16), b = parseInt(h.substring(4,6),16);
        const t = percent < 0 ? 0 : 255;
        const p = Math.abs(percent);
        const R = Math.round((t - r) * p) + r;
        const G = Math.round((t - g) * p) + g;
        const B = Math.round((t - b) * p) + b;
        return '#' + [R,G,B].map(x => x.toString(16).padStart(2,'0')).join('');
      } catch (e) { return null; }
    }
    
    function linearize(v){ return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4); }
    function useLightTextOn(hex){ try{ const h = hex.replace('#',''); const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16); const L = 0.2126*linearize(r/255)+0.7152*linearize(g/255)+0.0722*linearize(b/255); return L < 0.45; }catch(e){ return true; } }
    
    /* ========= INIT ========= */
    document.addEventListener("DOMContentLoaded", () => {
      try {
        const saved = JSON.parse(safeGetItem("mailslot-sort") || "{}");
        sortOrder = saved.order || [...CANONICAL_STATUSES];
        visibleStatuses = saved.visible || [...CANONICAL_STATUSES];
      } catch(_) {}
      updateColorMappings();
      renderLegend();
      
      stagedColors.Postcard_BG = loadPostcardBg();
      stagedColors.Banner_BG = loadBannerBg();
      document.getElementById('pickerPostcard').value = stagedColors.Postcard_BG;
      document.getElementById('pickerBanner').value = stagedColors.Banner_BG;
      applyStagedColors();

      // Load all state from cloud (with localStorage fallback)
      Promise.allSettled([
        loadExpenses(),
        loadClients(),
        loadKanban(),
        loadTasks(),
        loadNotInterestedList(),
        loadManualProspects()
      ]).then(results => {
        const succeeded = results.filter(r => r.status === 'fulfilled').length;
        const failed = results.filter(r => r.status === 'rejected').length;

        if (failed > 0) {
          console.warn(`‚ö†Ô∏è ${succeeded} data types loaded, ${failed} failed (using localStorage cache)`);
          const failedTypes = results
            .map((r, i) => r.status === 'rejected' ? ['expenses', 'clients', 'kanban', 'tasks', 'notInterested', 'manualProspects'][i] : null)
            .filter(t => t !== null);
          console.warn('Failed types:', failedTypes.join(', '));

          // Show user notification about partial cloud sync failure
          toast(`‚ö†Ô∏è ${failed} data type(s) loaded from local cache (cloud unavailable)`, false);
        }

        // Load campaigns AFTER expenses are loaded so financial dashboard shows correct data
        loadCampaigns();
      });

      // Load local-only data (too large for cloud)
      loadApiQuota();
      loadPlacesCache();

      // Load pricing (can stay local for now)
      try {
        const savedPricing = safeGetItem('mailslot-pricing');
        if (savedPricing) financialState.spotPricing = JSON.parse(savedPricing);
      } catch(e) {}
      updateAutoSaveStatus(); // Initialize auto-save status indicator
      updateQuickApiUsage(); // Initialize API usage display in prospecting section

      // Restore last active tab, or default to pipeline
      const lastTab = localStorage.getItem('9x12_active_tab') || 'pipeline';
      switchTab(lastTab);

      window.addEventListener('resize', () => renderLegend());
      bindUI();

      // Ensure critical functions are globally accessible
      window.openExpenseModal = openExpenseModal;
      window.openReportsModal = openReportsModal;
      window.openEmailModal = openEmailModal;
      window.manualSaveNow = manualSaveNow;
      window.pickCampaign = pickCampaign;
      window.toggleCustomCategory = toggleCustomCategory;
      window.toggleBulkCustomCategory = toggleBulkCustomCategory;
      window.importClientsCSV = importClientsCSV;
      window.openAutoPopulateModal = openAutoPopulateModal;
      window.runBulkAutoPopulate = runBulkAutoPopulate;
      window.openProspectsResultsModal = openProspectsResultsModal;
      window.closeProspectsResultsModal = closeProspectsResultsModal;
      window.toggleProspectSelection = toggleProspectSelection;
      window.markNotInterested = markNotInterested;
      window.addSelectedProspects = addSelectedProspects;
      window.editLead = editLead;
      window.deleteLead = deleteLead;
      window.openLeadModal = openLeadModal;
      window.saveLeadModal = saveLeadModal;
      window.toggleCloudSyncUI = toggleCloudSyncUI;
      window.toggleProspectForSync = toggleProspectForSync;
      window.saveSelectedProspectsToCloud = saveSelectedProspectsToCloud;
      window.closeLeadModal = closeLeadModal;
      window.togglePoolProspect = togglePoolProspect;
      window.selectCategoryProspects = selectCategoryProspects;
      window.addFromProspectPool = addFromProspectPool;
      window.clearProspectPool = clearProspectPool;
      window.renderProspectPool = renderProspectPool;
      window.switchTab = switchTab;
      window.deleteCurrentPostcard = deleteCurrentPostcard;
    });
    
    function bindUI(){
      document.getElementById("btnCancelEdit").onclick = closeEditModal;
      document.getElementById("btnApplyEdit").onclick = applyEditModal;
      document.getElementById("btnCancelPostcard").onclick = closePostcardModal;
      document.getElementById("btnApplyPostcard").onclick = applyPostcardModal;
      document.getElementById("btnCancelSort").onclick = closeSortModal;
      document.getElementById("btnApplySort").onclick = saveSortOrderFromModal;
      document.getElementById("btnAdjustPostcard").onclick = openPostcardModal;
      document.getElementById("btnSortOpen").onclick = openSortModal;
      
      // Expense modal
      document.getElementById("btnCancelExpense").onclick = closeExpenseModal;
      document.getElementById("btnSaveExpense").onclick = saveExpenseModal;
      ["expensePrinting", "expensePostage", "expenseDesign", "expenseMisc"].forEach(id => {
        document.getElementById(id).addEventListener('input', updateExpenseTotal);
      });
      
      // Client modal
      document.getElementById('btnCancelClient').onclick = closeClientModal;
      document.getElementById('btnSaveClient').onclick = saveClientModal;
      document.getElementById('btnDeleteClient').onclick = deleteClientModal;
      
      // Email modal
      document.getElementById('btnCancelEmail').onclick = closeEmailModal;
      document.getElementById('btnSendEmail').onclick = sendEmail;
      
      // Reports modal
      document.getElementById('btnCloseReports').onclick = closeReportsModal;

      // Task modal
      document.getElementById('btnCancelTask').onclick = closeTaskModal;
      document.getElementById('btnSaveTask').onclick = saveTaskModal;

      // Lead modal
      document.getElementById('btnCancelLead').onclick = closeLeadModal;
      document.getElementById('btnSaveLead').onclick = saveLeadModal;

      // Contact Later modal
      document.getElementById('btnCancelContactLater').onclick = closeContactLaterModal;
      document.getElementById('btnSaveContactLater').onclick = saveContactLater;

      // Auto-populate modal
      document.getElementById('btnCancelAutoPopulate').onclick = closeAutoPopulateModal;
      document.getElementById('btnRunAutoPopulate').onclick = runAutoPopulate;

      // New Postcard modal
      document.getElementById('btnCancelNewPostcard').onclick = closeNewPostcardModal;
      document.getElementById('btnCreatePostcard').onclick = createNewPostcard;
      
      document.getElementById("pickerPostcard").addEventListener('input', (e)=> { stagedColors.Postcard_BG = e.target.value; previewPostcardModal(); });
      document.getElementById("pickerBanner").addEventListener('input', (e)=> { stagedColors.Banner_BG = e.target.value; previewPostcardModal(); });
     
      const commitBtn = document.getElementById("btnSaveCommit");
      if (commitBtn) commitBtn.onclick = saveToSheet;
     
      window.addEventListener('beforeunload', (e) => {
        if (state.dirty) {
          // Attempt to auto-save before leaving
          performAutoSave();

          // Still show warning in case save isn't complete
          e.preventDefault();
          e.returnValue = 'You have unsaved changes. We are attempting to save them now.';
        }
      });
      
      document.addEventListener('click', (e)=> {
        if (e.target.matches('.sort-up') || e.target.matches('.sort-down')) handleSortUpDown(e);
      });
      
      document.getElementById("navTabs").addEventListener('click', (e) => {
          const target = e.target.closest('.tab-btn');
          if (!target) return;
          const tabName = target.dataset.tab;
          switchTab(tabName);
      });

      // Don't call switchTab here - it's already restored at line 6730
    }
    
    function switchTab(tabName) {
        // Auto-save before switching tabs if there are unsaved changes
        if (state.dirty) {
            performAutoSave(); // Immediate save on tab switch
        }

        // Save current tab to remember it on refresh
        localStorage.setItem('9x12_active_tab', tabName);

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.add('hidden');
            pane.classList.remove('active-pane');
        });
        const activePane = document.querySelector(`.tab-pane[data-content="${tabName}"]`);
        if (activePane) {
            activePane.classList.remove('hidden');
            activePane.classList.add('active-pane');
        }

        const legendArea = document.getElementById("legendArea");
        if (legendArea) show(legendArea, tabName === 'manager');
        
        if (tabName === 'manager') {
            renderAll();
        } else if (tabName === 'clients') {
            renderClientList();
        } else if (tabName === 'admin') {
            checkRenewals();
        } else if (tabName === 'prospects') {
            renderProspectPool();
        }
    }
    
    /* ========= LOAD CAMPAIGNS ========= */
    async function loadCampaigns() {
      try {
        const { data, error } = await supabaseClient
          .from('postcards')
          .select('*')
          .eq('user_email', ACTIVE_USER)
          .order('mail_date', { ascending: false });

        if (error) throw error;

        // Transform Supabase column names to match app expectations
        const mailers = (data || []).map(postcard => ({
          Mailer_ID: postcard.mailer_id,
          Town: postcard.town,
          Mail_Date: postcard.mail_date,
          In_Homes_Date: postcard.in_homes_date,
          Payment_Status: postcard.payment_status,
          Postcard_BG: postcard.postcard_bg,
          Banner_BG: postcard.banner_bg,
          Spot_1: postcard.spot_1,
          Spot_2: postcard.spot_2,
          Spot_3: postcard.spot_3,
          Spot_4: postcard.spot_4,
          Spot_5: postcard.spot_5,
          Spot_6: postcard.spot_6,
          Spot_7: postcard.spot_7,
          Spot_8: postcard.spot_8,
          Spot_9: postcard.spot_9,
          Spot_10: postcard.spot_10,
          Spot_11: postcard.spot_11,
          Spot_12: postcard.spot_12,
          Spot_13: postcard.spot_13,
          Spot_14: postcard.spot_14,
          Spot_15: postcard.spot_15,
          Spot_16: postcard.spot_16,
          Spot_17: postcard.spot_17,
          Spot_18: postcard.spot_18
        }));

        onCampaignsLoaded(mailers);
      } catch (err) {
        console.error('Failed to load campaigns from Supabase:', err);
        toast("‚ö†Ô∏è Failed to load campaigns. Please refresh.", false);
      }
    }
    
    function jsonpLoad(url, cb){
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      window[cbName] = (data) => { try{ cb(data); } finally { delete window[cbName]; s.remove(); } };
      const s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cbName;
      s.async = true;
      s.onerror = () => toast("Load failed", false);
      document.head.appendChild(s);
    }
    
    function onCampaignsLoaded(res){
      // Backend returns array directly, not wrapped in {mailers: []}
      let mailers = Array.isArray(res) ? res : (res && res.mailers) ? res.mailers : [];

      // Sort by date (newest first), then by town (alphabetically)
      mailers = mailers.sort((a, b) => {
        // Compare dates in descending order (newest first)
        const dateA = a.Mail_Date || '';
        const dateB = b.Mail_Date || '';
        if (dateA !== dateB) {
          return dateB.localeCompare(dateA); // Reverse order for descending
        }
        // If dates are the same, sort by town alphabetically
        const townA = (a.Town || '').toLowerCase();
        const townB = (b.Town || '').toLowerCase();
        return townA.localeCompare(townB);
      });

      state.mailers = mailers;
      const selectHtml = '<option value="">‚Äî Select ‚Äî</option>' +
        mailers.map((m,i)=>{
          // Format date: handle both formatted strings and date objects
          let displayDate = m.Mail_Date || "";

          // Check if it's already in "Month Year" format (like "December 2025")
          const isMonthYearFormat = displayDate && /^[A-Za-z]+ \d{4}$/.test(displayDate);

          if (!isMonthYearFormat && displayDate) {
            // Parse and format the date (handle ISO format YYYY-MM-DD)
            try {
              // If it's ISO format (YYYY-MM-DD), parse it without timezone issues
              if (/^\d{4}-\d{2}-\d{2}/.test(displayDate)) {
                const [year, month] = displayDate.split('-');
                const monthNames = ["", "January", "February", "March", "April", "May", "June",
                                    "July", "August", "September", "October", "November", "December"];
                displayDate = `${monthNames[parseInt(month)]} ${year}`;
              } else {
                const date = new Date(displayDate);
                if (!isNaN(date.getTime())) {
                  displayDate = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                }
              }
            } catch (e) {
              // Keep original if parsing fails
            }
          }

          return `<option value="${i}">${esc(m.Town)} ‚Äî ${displayDate}</option>`;
        }).join("");
      const selManager = document.getElementById("postcardSelect");

      if (selManager) {
        selManager.innerHTML = selectHtml;
        selManager.onchange = pickCampaign;
      }

      // Populate town and month dropdowns
      populateTownAndMonthSelectors();

      renderAll();

      // Auto-select the most recent postcard (last in array)
      if (mailers.length > 0) {
        const mostRecentIndex = mailers.length - 1;
        if (selManager) selManager.value = mostRecentIndex.toString();

        // Set town and month selectors to match the most recent postcard
        const mostRecent = mailers[mostRecentIndex];
        const townSelect = document.getElementById("headerTownSelect");
        const monthSelect = document.getElementById("headerMonthSelect");
        if (townSelect && mostRecent.Town) {
          townSelect.value = mostRecent.Town;
          populateMonthsForTown(mostRecent.Town); // Populate month dropdown without triggering events
          if (monthSelect && mostRecent.Mail_Date) monthSelect.value = mostRecent.Mail_Date;
        }

        pickCampaign({ target: { value: mostRecentIndex.toString() } });
      }
    }

    // Populate town selector from available mailers
    function populateTownAndMonthSelectors() {
      const townSelect = document.getElementById("headerTownSelect");

      if (!townSelect) return;

      // Get unique towns (sorted alphabetically)
      const towns = [...new Set(state.mailers.map(m => m.Town))].sort();

      // Populate town dropdown
      townSelect.innerHTML = '<option value="">‚Äî Select Town ‚Äî</option>' +
        towns.map(town => `<option value="${esc(town)}">${esc(town)}</option>`).join('');

      // Month dropdown will be populated when town is selected
      const monthSelect = document.getElementById("headerMonthSelect");
      if (monthSelect) {
        monthSelect.innerHTML = '<option value="">‚Äî Select Town First ‚Äî</option>';
        monthSelect.disabled = true;
      }
    }

    // When town changes, populate month dropdown with only months for that town
    function onTownChanged() {
      const townSelect = document.getElementById("headerTownSelect");
      const monthSelect = document.getElementById("headerMonthSelect");

      if (!townSelect || !monthSelect) return;

      const selectedTown = townSelect.value;

      if (!selectedTown) {
        // No town selected, disable month dropdown
        monthSelect.innerHTML = '<option value="">‚Äî Select Town First ‚Äî</option>';
        monthSelect.disabled = true;
        return;
      }

      // Filter mailers for this town only
      const townMailers = state.mailers.filter(m => m.Town === selectedTown);

      if (townMailers.length === 0) {
        monthSelect.innerHTML = '<option value="">‚Äî No cards for this town ‚Äî</option>';
        monthSelect.disabled = true;
        return;
      }

      // Get months for this town (sorted by date descending - newest first)
      const monthDates = townMailers.map(m => m.Mail_Date).sort((a, b) => b.localeCompare(a));

      // Enable and populate month dropdown
      monthSelect.disabled = false;
      monthSelect.innerHTML = '<option value="">‚Äî Select Month ‚Äî</option>' +
        monthDates.map(date => {
          let displayDate = date;
          if (/^\d{4}-\d{2}-\d{2}/.test(date)) {
            const [year, month] = date.split('-');
            const monthNames = ["", "January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            displayDate = `${monthNames[parseInt(month)]} ${year}`;
          }
          return `<option value="${esc(date)}">${esc(displayDate)}</option>`;
        }).join('');

      // If there's only one month for this town, auto-select it
      if (monthDates.length === 1) {
        monthSelect.value = monthDates[0];
        updatePostcardFromSelectors();
      } else {
        // Town changed but no month auto-selected - refresh prospect pool to show prospects for this town
        renderProspectPool();
      }
    }

    // Update selected postcard when town or month selector changes
    function updatePostcardFromSelectors() {
      const townSelect = document.getElementById("headerTownSelect");
      const monthSelect = document.getElementById("headerMonthSelect");

      if (!townSelect || !monthSelect) return;

      const selectedTown = townSelect.value;
      const selectedMonth = monthSelect.value;

      // If either is not selected, don't do anything
      if (!selectedTown || !selectedMonth) {
        return;
      }

      // Find the postcard that matches both town and month
      const matchingIndex = state.mailers.findIndex(m =>
        m.Town === selectedTown && m.Mail_Date === selectedMonth
      );

      if (matchingIndex !== -1) {
        // Update the manager selector if it exists
        const selManager = document.getElementById("postcardSelect");
        if (selManager) selManager.value = matchingIndex.toString();

        // Select this postcard
        pickCampaign({ target: { value: matchingIndex.toString() } });
      } else {
        toast('No postcard found for this town and month combination', false);
      }
    }

    /* ========= LEGEND & SORT ========= */
    function renderLegend(){
      const grid = document.getElementById("legendGrid");
      grid.innerHTML = "";
      const visibleSorted = sortOrder.filter(st => visibleStatuses.includes(st));
      visibleSorted.forEach(st => {
        const item = document.createElement("div");
        item.className = "legend-item";
        const dot = document.createElement("span");
        dot.className = `legend-dot`;
        dot.style.backgroundColor = STATUS_HEX[st] || GRADIENT_HEX[0];
        const txt = document.createElement("span");
        txt.textContent = st;
        item.appendChild(dot);
        item.appendChild(txt);
        grid.appendChild(item);
      });
      requestAnimationFrame(() => {
        const children = Array.from(grid.children);
        let totalW = 0;
        children.forEach((c) => {
          const r = c.getBoundingClientRect();
          totalW += Math.ceil(r.width);
        });
        const gap = 8 * (children.length - 1);
        const needed = totalW + gap;
        const available = grid.clientWidth;
        if (needed <= available) {
          grid.style.flexWrap = 'nowrap';
        } else {
          grid.style.flexWrap = 'wrap';
        }
      });
    }
    
    /* ========= PICK CAMPAIGN ========= */
    function pickCampaign(e){
      const i = e.target.value;
      if (!state.mailers[i]) {
        state.current = null;
        state.availability = {};
        state.initial = {};
        state.merged.clear();
        state.selected.clear();
        state.dirty = false;
        renderAll();
        updateFinancialDashboard();
        return;
      }
      const m = state.mailers[i];
      state.current = m;
      state.availability = {};
      state.initial = {};
      state.merged.clear();
      state.selected.clear();
      state.dirty = false;
      updateToolbar();
      
      for (let s=1; s<=18; s++){
        // Get spot data directly from mailer object (comes from sheet columns Spot_1, Spot_2, etc.)
        const raw = m[`Spot_${s}`] || "Available";
        if (/^available$/i.test(raw)) {
          state.availability[`Spot_${s}`] = { name:"", status:"Available" };
          state.initial[`Spot_${s}`] = "";
        } else {
          const m2 = String(raw).match(/^(.+?)\s*:\s*(.*)$/);
          let long = "Proof In Progress", name = "";
          if (m2) { long = m2[1].trim(); name = (m2[2]||"").trim(); }
          state.availability[`Spot_${s}`] = { name, status:long };
          state.initial[`Spot_${s}`] = `${long}:${name}`;
        }
      }
      
      // Load colors: use postcard data if available, otherwise fall back to localStorage
      if (m.Postcard_BG) {
        stagedColors.Postcard_BG = m.Postcard_BG;
        savePostcardBg(m.Postcard_BG);
      } else {
        // Fall back to localStorage
        stagedColors.Postcard_BG = loadPostcardBg();
        m.Postcard_BG = stagedColors.Postcard_BG; // Update postcard data with loaded color
      }
      document.getElementById('pickerPostcard').value = stagedColors.Postcard_BG;

      if (m.Banner_BG) {
        stagedColors.Banner_BG = m.Banner_BG;
        saveBannerBg(m.Banner_BG);
      } else {
        // Fall back to localStorage
        stagedColors.Banner_BG = loadBannerBg();
        m.Banner_BG = stagedColors.Banner_BG; // Update postcard data with loaded color
      }
      document.getElementById('pickerBanner').value = stagedColors.Banner_BG;

      applyStagedColors();
      
      PAIRS.forEach(([a,b])=>{
        const A = (state.availability[`Spot_${a}`].name||"").toLowerCase().trim().replace(/\s+/g,' ');
        const B = (state.availability[`Spot_${b}`].name||"").toLowerCase().trim().replace(/\s+/g,' ');
        if (A && A===B) state.merged.add(keyPair(a,b));
        else state.merged.delete(keyPair(a,b));
      });
      
      show(document.getElementById("legendArea"), true);
      renderAll();
      updateFinancialDashboard();
      checkRenewals();

      // Sync all dropdowns
      const selManager = document.getElementById("postcardSelect");
      const townSelect = document.getElementById("headerTownSelect");
      const monthSelect = document.getElementById("headerMonthSelect");

      if (selManager) selManager.value = i;

      // Update town and month selectors to match current postcard
      // Use a flag to prevent infinite recursion
      if (townSelect && m.Town) {
        townSelect.value = m.Town;
        // Manually populate month dropdown without triggering events
        populateMonthsForTown(m.Town);
        if (monthSelect && m.Mail_Date) monthSelect.value = m.Mail_Date;
      }
    }

    // Helper function to populate months without triggering onchange events
    function populateMonthsForTown(town) {
      const monthSelect = document.getElementById("headerMonthSelect");
      if (!monthSelect) return;

      const townMailers = state.mailers.filter(m => m.Town === town);

      if (townMailers.length === 0) {
        monthSelect.innerHTML = '<option value="">‚Äî No cards for this town ‚Äî</option>';
        monthSelect.disabled = true;
        return;
      }

      // Get months for this town (sorted by date descending - newest first)
      const monthDates = townMailers.map(m => m.Mail_Date).sort((a, b) => b.localeCompare(a));

      // Enable and populate month dropdown
      monthSelect.disabled = false;
      monthSelect.innerHTML = '<option value="">‚Äî Select Month ‚Äî</option>' +
        monthDates.map(date => {
          let displayDate = date;
          if (/^\d{4}-\d{2}-\d{2}/.test(date)) {
            const [year, month] = date.split('-');
            const monthNames = ["", "January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            displayDate = `${monthNames[parseInt(month)]} ${year}`;
          }
          return `<option value="${esc(date)}">${esc(displayDate)}</option>`;
        }).join('');
    }
    
    /* ========= RENDERING ========= */
    function renderAll(){
      renderFront();
      renderBack();
      updateToolbar();
    }
    
    function renderFront(){
      const grid = document.getElementById("frontGrid");
      grid.innerHTML = "";
      if (!state.current) {
        renderPlaceholderFront(grid);
        return;
      }
      renderRow(grid,1,4);
      const banner = document.createElement("div");
      banner.className = "card col-span-4 banner";
      const town = state.current?.Town || "";
      const md = state.current?.Mail_Date || "";

      // Extract month name from mail date (e.g., "2025-12-01" -> "December")
      // Parse ISO format without timezone issues
      let monthName = "";
      if (md) {
        try {
          if (/^\d{4}-\d{2}-\d{2}/.test(md)) {
            // ISO format: extract month directly from string to avoid timezone issues
            const month = parseInt(md.split('-')[1]);
            const monthNames = ["", "January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];
            monthName = monthNames[month] || "";
          } else {
            const date = new Date(md);
            monthName = date.toLocaleString('en-US', { month: 'long' });
          }
        } catch (e) {
          monthName = "";
        }
      }

      // Show just town and month (e.g., "KENMORE ‚Äî December")
      const fullText = monthName ? `${town.toUpperCase()} ‚Äî ${monthName.toUpperCase()}` : town.toUpperCase();
      const span = document.createElement('span');
      span.className = 'banner-text';
      span.textContent = fullText;
      span.setAttribute('aria-label', fullText);
      span.setAttribute('title', fullText); // Tooltip for overflow text

      // Apply banner colors directly
      banner.style.backgroundColor = stagedColors.Banner_BG || '#000000';
      banner.style.color = useLightTextOn(stagedColors.Banner_BG || '#000000') ? '#ffffff' : '#0f172a';
      const border = shadeBlend(stagedColors.Banner_BG || '#000000', -0.12) || '#e5e7eb';
      banner.style.borderColor = border;

      banner.appendChild(span);
      grid.appendChild(banner);
      renderRow(grid,5,8);
    }
    
    function renderBack(){
      const grid = document.getElementById("backGrid");
      grid.innerHTML = "";
      if (!state.current) {
        renderPlaceholderBack(grid);
        return;
      }
      renderRow(grid,9,12);
      if (state.merged.has(keyPair(13,14))) {
        const A = state.availability["Spot_13"], B = state.availability["Spot_14"];
        const name = A.name || B.name || "Merged Banner";
        const st = A.name ? A.status : (B.name ? B.status : "Available");
        const mergedEl = cardButtonSafe({label:"Spots 13‚Äì14", name, status:st, span4:true, selected:isSel([13,14]), spots:[13,14]});
        mergedEl.addEventListener("click", ()=>toggle([13,14],"back"));
        grid.appendChild(mergedEl);
      } else {
        const sp13 = cardButtonSafe({label:"Spot 13", name:(state.availability["Spot_13"]?.name || "Available"), status: (state.availability["Spot_13"]?.status || "Available"), span2:true, selected: state.selected.has(13), spots:[13]});
        sp13.addEventListener("click", ()=>toggle([13],"back"));
        grid.appendChild(sp13);
        const sp14 = cardButtonSafe({label:"Spot 14", name:(state.availability["Spot_14"]?.name || "Available"), status: (state.availability["Spot_14"]?.status || "Available"), span2:true, selected: state.selected.has(14), spots:[14]});
        sp14.addEventListener("click", ()=>toggle([14],"back"));
        grid.appendChild(sp14);
      }
      renderRow(grid,15,18,"back");
    }
    
    function renderRow(grid, a, b, side="front"){
      for (let i=a; i<=b; i+=2){
        if (state.merged.has(keyPair(i,i+1))){
          const A = state.availability[`Spot_${i}`], B = state.availability[`Spot_${i+1}`];
          const name = A.name || B.name || "Merged Ad";
          const st = A.name ? A.status : (B.name ? B.status : "Available");
          const btn = cardButtonSafe({label:`Spots ${i}-${i+1}`, name, status:st, span2:true, selected:isSel([i,i+1]), spots:[i,i+1]});
          btn.addEventListener("click", ()=>toggle([i,i+1], side));
          grid.appendChild(btn);
        } else {
          grid.appendChild(single(i,false,side));
          grid.appendChild(single(i+1,false,side));
        }
      }
    }
    
    function single(i, span2=false, side="front"){
      const s = state.availability[`Spot_${i}`] || { name:"", status:"Available" };
      const btn = cardButtonSafe({label:`Spot ${i}`, name:(s.name || "Available"), status:s.status, span2, selected:state.selected.has(i), spots:[i]});
      btn.addEventListener("click", ()=>toggle([i], side));
      return btn;
    }
    
    function createTextNodeTag(tagName, text, className) {
      const el = document.createElement(tagName);
      if (className) el.className = className;
      el.textContent = text;
      return el;
    }
    
    function cardButtonSafe({label,name,status,selected=false,span2=false,span4=false,spots=[]}){
      const el = document.createElement("button");
      el.type = "button";
      const span = span4 ? "col-span-4" : (span2 ? "col-span-2" : "");
      const longStatus = normalizeStatusLong(status);
      el.className = `card ${span} ${selected ? "selected" : ""}`;
      el.style.backgroundColor = STATUS_HEX[longStatus] || GRADIENT_HEX[0];
      el.style.borderColor = shadeBlend(STATUS_HEX[longStatus] || GRADIENT_HEX[0], -0.2) || '#f59e0b';
      el.style.color = useLightTextOn(STATUS_HEX[longStatus] || GRADIENT_HEX[0]) ? 'white' : '#0f172a';
      el.setAttribute("aria-pressed", selected ? "true" : "false");
      el.tabIndex = 0;
      const match = label.match(/\d+/);
      if (match) el.dataset.spot = match[0];
      
      const labelEl = createTextNodeTag('div', label, 'spot-label');
      const nameEl = createTextNodeTag('div', name);
      const badge = createTextNodeTag('div', longStatus, 'status-badge');
      badge.style.backgroundColor = shadeBlend(STATUS_HEX[longStatus] || GRADIENT_HEX[0], 0.1) || 'rgba(255,255,255,.96)';
      
      el.appendChild(labelEl);
      el.appendChild(nameEl);
      el.appendChild(badge);
      
      // Add price badge if spot is sold and has a price
      if (state.current && spots.length > 0 && longStatus !== "Available") {
        const spotNum = spots[0];
        const priceKey = `${state.current.Mailer_ID}-Spot_${spotNum}`;
        const price = financialState.spotPricing[priceKey] || DEFAULT_SPOT_PRICE;
        
        const priceBadge = createTextNodeTag('div', formatCurrency(price), 'price-badge');
        el.appendChild(priceBadge);
      }
      
      // Add overlay edit button if selected
      // When multiple spots are selected, only show button on the first (lowest numbered) spot
      if (selected) {
        const showButton = state.selected.size === 1 ||
                          (spots.length > 0 && spots[0] === Math.min(...Array.from(state.selected)));

        if (showButton) {
          const overlay = document.createElement('div');
          overlay.className = 'card-edit-overlay';
          const editBtn = document.createElement('button');
          // Show "EDIT SPOT" (singular) when multiple spots selected, "Edit Spot" otherwise
          editBtn.textContent = state.selected.size > 1 ? '‚úé EDIT SPOT' : '‚úé Edit Spot';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openEditModal();
          };
          overlay.appendChild(editBtn);
          el.appendChild(overlay);
        }
      }
      
      el.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') {
          e.preventDefault();
          el.click();
        }
      });
      return el;
    }
    
    function normalizeStatusLong(s) {
      if (!s) return "Available";
      const up = String(s).trim();
      const map = {
        "RESERVED": "Reserved",
        "INVOICE": "Invoice Sent",
        "DEPOSIT": "Deposit Paid",
        "PROOF": "Proof In Progress",
        "APPROVED": "Ad Approved",
        "PAID": "Paid in Full",
        "AVAIL": "Available"
      };
      if (map[up.toUpperCase()]) return map[up.toUpperCase()];
      for (const k of CANONICAL_STATUSES) {
        if (k.toLowerCase() === up.toLowerCase()) return k;
      }
      return up;
    }
    
    function renderPlaceholderFront(grid){
      for (let i=1;i<=4;i++){
        const el = createPlaceholderCard(`Spot ${i}`);
        grid.appendChild(el);
      }
      const banner = document.createElement("div");
      banner.className = "card col-span-4 banner placeholder";
      banner.innerHTML = '<div class="banner-text" aria-label="TOWN ‚Äî MONTH" title="TOWN ‚Äî MONTH">TOWN ‚Äî MONTH</div>';
      banner.style.backgroundColor = '#000000';
      banner.style.color = '#ffffff';
      banner.style.borderColor = '#000000';
      grid.appendChild(banner);
      for (let i=5;i<=8;i++){
        const el = createPlaceholderCard(`Spot ${i}`);
        grid.appendChild(el);
      }
    }
    
    function renderPlaceholderBack(grid){
      for (let i=9;i<=12;i++){
        const el = createPlaceholderCard(`Spot ${i}`);
        grid.appendChild(el);
      }
      const p13 = createPlaceholderCard('Spot 13');
      p13.classList.add('col-span-2');
      grid.appendChild(p13);
      const p14 = createPlaceholderCard('Spot 14');
      p14.classList.add('col-span-2');
      grid.appendChild(p14);
      for (let i=15;i<=18;i++){
        const el = createPlaceholderCard(`Spot ${i}`);
        grid.appendChild(el);
      }
    }
    
    function createPlaceholderCard(label, hidden=false, isSpan2=false){
      const el = document.createElement("div");
      el.className = "card placeholder";
      if (isSpan2) el.classList.add('col-span-2');
      el.style.justifyContent = "center";
      if (hidden){
        el.style.visibility = 'hidden';
      } else {
        const lbl = document.createElement("div");
        lbl.textContent = label;
        el.appendChild(lbl);
      }
      return el;
    }
    
    /* ========= SELECTION / TOOLBAR ========= */
    function toggle(spots, sideHint="front"){
      spots.forEach(n => { state.selected.has(n) ? state.selected.delete(n) : state.selected.add(n); });
      if (state.selected.size > 2){
        const last = spots[spots.length-1];
        const others = [...state.selected].filter(x => x !== last);
        const mate = others.find(o => isValidPair(o,last));
        state.selected.clear();
        if (mate){ state.selected.add(mate); state.selected.add(last); }
        else { state.selected.add(last); toast("Pick a valid pair", false); }
      }
      if (state.selected.size === 2){
        const [a,b] = [...state.selected].sort((x,y)=>x-y);
        if (!isValidPair(a,b)){
          const last = spots[spots.length-1];
          state.selected.clear();
          state.selected.add(last);
          toast("Pick a valid pair", false);
        }
      }
      renderAll();
    }
    
    function isSel(arr){ return arr.every(n => state.selected.has(n)); }
    
    function updateToolbar(){
      const saveBtn = document.getElementById("btnSaveCommit");
      if (saveBtn) {
        if (state.dirty){
          saveBtn.disabled = false;
          saveBtn.classList.remove("opacity-50","cursor-not-allowed");
        } else {
          saveBtn.disabled = true;
          saveBtn.classList.add("opacity-50","cursor-not-allowed");
        }
      }
    }
    
    /* ========= MODAL & APPLY ========= */
    function openEditModal(){
      if (!state.selected.size) return;
      const modal = document.getElementById("editModal");
      const nameEl = document.getElementById("editName");
      const statusEl = document.getElementById("editStatus");
      const priceEl = document.getElementById("editPrice");
      
      lastFocusedElementBeforeModal = document.activeElement;
      const sel = [...state.selected].sort((a,b)=>a-b);
      if (sel.length === 1){
        const s = state.availability[`Spot_${sel[0]}`] || {name:"", status:"Available"};
        nameEl.value = s.name || "";
        statusEl.value = toShortKey(s.status);
        const priceKey = `${state.current.Mailer_ID}-Spot_${sel[0]}`;
        priceEl.value = financialState.spotPricing[priceKey] || DEFAULT_SPOT_PRICE;
      } else {
        const [a,b] = sel;
        const A = state.availability[`Spot_${a}`] || {name:"", status:"Available"}, B = state.availability[`Spot_${b}`] || {name:"", status:"Available"};
        const nm = (A.name && B.name && A.name.toLowerCase()===B.name.toLowerCase()) ? A.name : (A.name || B.name || "");
        const st = nm ? (A.status!=="Available" ? A.status : (B.status!=="Available"?B.status:"Proof In Progress")) : "Available";
        nameEl.value = nm;
        statusEl.value = toShortKey(st);
        const priceKey = `${state.current.Mailer_ID}-Spot_${a}`;
        priceEl.value = financialState.spotPricing[priceKey] || DEFAULT_SPOT_PRICE;
      }
      
      populateClientDropdown();
      
      modal.style.display = "flex";
      modal.setAttribute('aria-hidden', 'false');
      trapModalFocus(modal);
      nameEl.focus();
    }
    
    function trapModalFocus(modalEl) {
      const dialog = modalEl.querySelector('.modal');
      if (!dialog) return;
      const focusable = dialog.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
      if (focusable.length === 0) return;
      const first = focusable[0], last = focusable[focusable.length - 1];
      function onKey(e) {
        if (e.key === 'Escape') {
          if (modalEl.id === 'editModal') closeEditModal();
          else if (modalEl.id === 'postcardModal') closePostcardModal();
          else if (modalEl.id === 'sortModal') closeSortModal();
          else if (modalEl.id === 'expenseModal') closeExpenseModal();
          else if (modalEl.id === 'clientModal') closeClientModal();
          else if (modalEl.id === 'emailModal') closeEmailModal();
          else if (modalEl.id === 'reportsModal') closeReportsModal();
          return;
        }
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault(); last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault(); first.focus();
          }
        }
      }
      modalEl.__trap = onKey;
      modalEl.addEventListener('keydown', onKey);
    }
    
    function releaseModalFocus(modalEl) {
      if (!modalEl) return;
      if (modalEl.__trap) {
        modalEl.removeEventListener('keydown', modalEl.__trap);
        delete modalEl.__trap;
      }
    }
    
    function closeEditModal(){
      const modal = document.getElementById("editModal");
      modal.style.display = "none";
      modal.setAttribute('aria-hidden', 'true');
      releaseModalFocus(modal);
      if (lastFocusedElementBeforeModal && typeof lastFocusedElementBeforeModal.focus === 'function') {
        lastFocusedElementBeforeModal.focus();
      }
    }
    
    function applyEditModal(){
      const nameRaw = document.getElementById("editName").value;
      const name = String(nameRaw || "").replace(/\s+/g,' ').trim();
      const short = document.getElementById("editStatus").value;
      const long = toLongLabel(short);
      const price = parseFloat(document.getElementById("editPrice").value) || DEFAULT_SPOT_PRICE;
      const selectedClientId = document.getElementById('editClient').value;
      
      const sel = [...state.selected].sort((a,b)=>a-b);
      
      sel.forEach(spotNum => {
        const priceKey = `${state.current.Mailer_ID}-Spot_${spotNum}`;
        financialState.spotPricing[priceKey] = price;
      });

      safeSetItem('mailslot-pricing', JSON.stringify(financialState.spotPricing));
      
      if (sel.length === 2){
        const [a,b] = sel;
        if (name){
          state.merged.add(keyPair(a,b));
          state.availability[`Spot_${a}`] = { name, status: long };
          state.availability[`Spot_${b}`] = { name, status: long };
        } else {
          state.merged.delete(keyPair(a,b));
          state.availability[`Spot_${a}`] = { name:"", status:"Available" };
          state.availability[`Spot_${b}`] = { name:"", status:"Available" };
        }
      } else if (sel.length === 1){
        const a = sel[0];
        const m = mateOf(a);
        if (name){
          state.availability[`Spot_${a}`] = { name, status: long };
          if (m && state.merged.has(keyPair(a,m))){
            state.merged.delete(keyPair(a,m));
            state.availability[`Spot_${m}`] = { name:"", status:"Available" };
          }
        } else {
          state.availability[`Spot_${a}`] = { name:"", status:"Available" };
          if (m && state.merged.has(keyPair(a,m))){
            state.merged.delete(keyPair(a,m));
            state.availability[`Spot_${m}`] = { name:"", status:"Available" };
          }
        }
      }
      
      // Link client if selected and status is Paid in Full
      if (selectedClientId && state.current && name && long === "Paid in Full") {
        const spotNum = sel[0];
        linkClientToSpot(
          selectedClientId,
          spotNum,
          `${state.current.Town} ‚Äî ${state.current.Mail_Date}`,
          price,
          long
        );
        renderClientList();
      }
      
      state.dirty = true;
      toast("Saved locally");

      // Clear selection immediately after save
      state.selected.clear();

      closeEditModal();
      renderAll();
      updateFinancialDashboard();
      scheduleAutoSave(); // Trigger auto-save
    }
    
    function toShortKey(longLabel){
      switch(longLabel){
        case "Reserved": return "RESERVED";
        case "Invoice Sent": return "INVOICE";
        case "Deposit Paid": return "DEPOSIT";
        case "Proof In Progress": return "PROOF";
        case "Ad Approved": return "APPROVED";
        case "Paid in Full": return "PAID";
        case "Available": return "AVAIL";
      }
      return String(longLabel || "").toUpperCase();
    }
    
    function toLongLabel(shortKey){
      switch(shortKey){
        case "RESERVED": return "Reserved";
        case "INVOICE": return "Invoice Sent";
        case "DEPOSIT": return "Deposit Paid";
        case "PROOF": return "Proof In Progress";
        case "APPROVED": return "Ad Approved";
        case "PAID": return "Paid in Full";
        default: return "Available";
      }
    }
    
    /* ========= POSTCARD MODAL ========= */
    function openPostcardModal(){ 
      const modal = document.getElementById("postcardModal");
      modal.style.display='flex'; 
      modal.setAttribute('aria-hidden','false'); 
      trapModalFocus(modal); 
      previewPostcardModal(); 
    }
    
    function closePostcardModal(){ 
      const modal = document.getElementById("postcardModal");
      modal.style.display = 'none'; 
      modal.setAttribute('aria-hidden','true'); 
      releaseModalFocus(modal); 
    }
    
    function previewPostcardModal(){
      const previewPostcard = document.getElementById('previewPostcard');
      const previewBanner = document.getElementById('previewBanner');
      previewPostcard.style.backgroundColor = stagedColors.Postcard_BG || '#000';
      previewBanner.style.backgroundColor = stagedColors.Banner_BG || '#000000';
      previewBanner.style.color = useLightTextOn(stagedColors.Banner_BG || '#000000')? '#fff' : '#0f172a';
    }
    
    function applyPostcardModal(){
      stagedColors.Postcard_BG = document.getElementById('pickerPostcard').value;
      stagedColors.Banner_BG = document.getElementById('pickerBanner').value;
      savePostcardBg(stagedColors.Postcard_BG);
      saveBannerBg(stagedColors.Banner_BG);

      // Also save to current postcard data so colors persist when switching postcards
      if (state.current) {
        // Find the index of current postcard in mailers array
        const currentIndex = state.mailers.findIndex(m => m === state.current || m?.Mailer_ID === state.current?.Mailer_ID);
        if (currentIndex !== -1) {
          state.mailers[currentIndex].Postcard_BG = stagedColors.Postcard_BG;
          state.mailers[currentIndex].Banner_BG = stagedColors.Banner_BG;
        }
        // Also update the current object directly
        state.current.Postcard_BG = stagedColors.Postcard_BG;
        state.current.Banner_BG = stagedColors.Banner_BG;
      }

      applyStagedColors();
      closePostcardModal();
      toast('Postcard colors saved successfully!', true);
      state.dirty = true;
      updateToolbar();
      scheduleAutoSave(); // Trigger auto-save
    }
    
    /* ========= SORT MODAL ========= */
    function openSortModal(){ 
      const modal = document.getElementById("sortModal");
      modal.style.display='flex'; 
      modal.setAttribute('aria-hidden','false'); 
      trapModalFocus(modal); 
      buildSortList(); 
      updateSortPreview();
    }
    
    function closeSortModal(){ 
      const modal = document.getElementById("sortModal");
      modal.style.display = 'none'; 
      modal.setAttribute('aria-hidden','true'); 
      releaseModalFocus(modal); 
      renderLegend(); 
    }
    
    function buildSortList(){
      const container = document.getElementById("sortListContainer"); 
      container.innerHTML = ''; 
      sortOrder.forEach((s, idx)=>{
        const row = document.createElement('div'); 
        row.className='sort-row'; 
        row.dataset.idx = idx;
        const left = document.createElement('div'); 
        left.style.display='flex'; 
        left.style.alignItems='center'; 
        left.style.gap='8px';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = visibleStatuses.includes(s);
        checkbox.dataset.status = s;
        checkbox.style.marginRight = '8px';
        const dot = document.createElement('span'); 
        dot.style.width='14px'; 
        dot.style.height='14px'; 
        dot.style.borderRadius='9999px'; 
        dot.style.background = STATUS_HEX[s] || '#ddd';
        const label = document.createElement('div'); 
        label.textContent = s; 
        label.style.fontWeight='700';
        left.appendChild(checkbox);
        left.appendChild(dot); 
        left.appendChild(label);
        const right = document.createElement('div'); 
        right.style.display='flex'; 
        right.style.gap='6px';
        const up = document.createElement('button'); 
        up.className='sort-up'; 
        up.textContent='‚ñ≤'; 
        up.dataset.idx = idx; 
        up.title='Move up';
        const down = document.createElement('button'); 
        down.className='sort-down'; 
        down.textContent='‚ñº'; 
        down.dataset.idx = idx; 
        down.title='Move down';
        right.appendChild(up); 
        right.appendChild(down);
        row.appendChild(left); 
        row.appendChild(right);
        row.draggable = true;
        row.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', idx); row.style.opacity='0.6'; });
        row.addEventListener('dragend', e => { row.style.opacity=''; });
        row.addEventListener('dragover', e => { e.preventDefault(); row.style.background = '#f3f4f6'; });
        row.addEventListener('dragleave', e => { row.style.background = '#fff'; });
        row.addEventListener('drop', e => {
          e.preventDefault(); 
          row.style.background = '#fff';
          const from = Number(e.dataTransfer.getData('text/plain')); 
          const to = Number(row.dataset.idx);
          if (from === to) return;
          const copy = sortOrder.slice(); 
          const [item] = copy.splice(from,1); 
          copy.splice(to,0,item); 
          sortOrder = copy; 
          buildSortList(); 
          updateSortPreview();
        });
        container.appendChild(row);
      });
    }
    
    function handleSortUpDown(e){
      const el = e.target; 
      const idx = Number(el.dataset.idx);
      if (isNaN(idx)) return;
      if (el.classList.contains('sort-up')){ 
        if (idx>0){ 
          [sortOrder[idx-1], sortOrder[idx]] = [sortOrder[idx], sortOrder[idx-1]]; 
          buildSortList(); 
          updateSortPreview(); 
        } 
      }
      else if (el.classList.contains('sort-down')){ 
        if (idx < sortOrder.length-1){ 
          [sortOrder[idx+1], sortOrder[idx]] = [sortOrder[idx], sortOrder[idx+1]]; 
          buildSortList(); 
          updateSortPreview(); 
        } 
      }
    }
    
    function updateSortPreview(){
      const colors = GRADIENT_HEX;
      const grad = colors.map((c,i)=> `${c} ${i/(colors.length-1)*100}%`).join(',');
      document.getElementById('sortPreview').style.background = `linear-gradient(90deg, ${grad})`;
    }
    
    function saveSortOrderFromModal(){
      const checkboxes = document.querySelectorAll('#sortListContainer input[type="checkbox"]');
      visibleStatuses = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.status);
      safeSetItem('mailslot-sort', JSON.stringify({order: sortOrder, visible: visibleStatuses}));
      updateColorMappings();
      toast('Legend order and visibility saved');
      closeSortModal();
      renderAll();
    }
    
    /* ========= SAVE ========= */
    function computeUpdates(){
      let n=0;
      for (let i=1;i<=18;i++){
        const key=`Spot_${i}`;
        const cur = state.availability[key] || {name:"", status:"Available"};
        const human = cur.name ? `${cur.status}:${cur.name}` : "";
        if ((state.initial[key]||"") !== human) n++;
      }
      return n;
    }
    
    function buildAvailabilityPayload(){
      const out = {};
      for (let i=1;i<=18;i++){
        const key=`Spot_${i}`;
        const cur=state.availability[key] || {name:"", status:"Available"};
        const human = cur.name ? `${cur.status}: ${cur.name}` : "Available";
        const initial = state.initial[key] || "";
        const humanCompare = cur.name ? `${cur.status}:${cur.name}` : "";
        if (initial !== humanCompare) {
          out[key] = cur.name ? `${cur.status}: ${cur.name}` : "Available";
        }
      }
      state.merged.forEach(pair => {
        const parts = pair.split("-").map(n => Number(n));
        if (parts.length !== 2) return;
        const a = parts[0], b = parts[1];
        const A = state.availability[`Spot_${a}`] || {name:"", status:"Available"};
        const B = state.availability[`Spot_${b}`] || {name:"", status:"Available"};
        const preferredName = (A.name || B.name || "").replace(/\s+/g,' ').trim();
        const preferredStatus = (A.name ? A.status : (B.name ? B.status : "Available"));
        const human = preferredName ? `${preferredStatus}: ${preferredName}` : "Available";
        out[`Spot_${a}`] = human;
        out[`Spot_${b}`] = human;
      });
      return out;
    }
    
    /* ========= AUTO-SAVE SYSTEM ========= */

    function updateAutoSaveStatus() {
      try {
        const statusDiv = document.getElementById('autoSaveStatus');
        const iconSpan = document.getElementById('autoSaveIcon');
        const textSpan = document.getElementById('autoSaveText');
        const saveBtn = document.getElementById('btnManualSave');

        if (!statusDiv) return;

      // Clear any hide timeout and show the status
      if (window.autoSaveHideTimeout) {
        clearTimeout(window.autoSaveHideTimeout);
      }
      statusDiv.style.display = 'flex';
      statusDiv.style.opacity = '1';

      // Determine status
      if (autoSaveState.saving) {
        // Currently saving
        statusDiv.className = 'flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-blue-50 border border-blue-300 text-blue-700';
        iconSpan.textContent = '‚òÅÔ∏è';
        textSpan.textContent = 'Saving...';
        saveBtn.classList.add('hidden');
      } else if (state.dirty) {
        // Has unsaved changes
        let changeCount = 0;
        try {
          changeCount = Object.keys(buildAvailabilityPayload()).length;
        } catch(e) {
          changeCount = 1; // Fallback if function doesn't exist yet
        }
        statusDiv.className = 'flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-orange-50 border border-orange-300 text-orange-700';
        iconSpan.textContent = '‚ö†Ô∏è';
        textSpan.textContent = `${changeCount} pending`;
        saveBtn.classList.remove('hidden');
      } else {
        // All saved
        statusDiv.className = 'flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium bg-green-50 border border-green-300 text-green-700';
        iconSpan.textContent = '‚úì';

        if (autoSaveState.lastSaveTime) {
          const relativeTime = getRelativeTime(autoSaveState.lastSaveTime);
          textSpan.textContent = relativeTime;
        } else {
          textSpan.textContent = 'Saved';
        }

        saveBtn.classList.add('hidden');

        // Auto-hide after 10 seconds (increased from 4s for better visibility)
        if (window.autoSaveHideTimeout) {
          clearTimeout(window.autoSaveHideTimeout);
        }
        statusDiv.style.opacity = '1';
        statusDiv.style.transition = 'opacity 0.3s';

        window.autoSaveHideTimeout = setTimeout(() => {
          statusDiv.style.opacity = '0';
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 300);
        }, 10000);
      }
      } catch(e) {
        console.error('Error in updateAutoSaveStatus:', e);
      }
    }

    function getRelativeTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (seconds < 10) return 'just now';
      if (seconds < 60) return `${seconds} sec ago`;
      if (minutes === 1) return '1 min ago';
      if (minutes < 60) return `${minutes} min ago`;
      if (hours === 1) return '1 hour ago';
      if (hours < 24) return `${hours} hours ago`;
      if (days === 1) return '1 day ago';
      return `${days} days ago`;
    }

    function scheduleAutoSave() {
      try {
        // Clear existing timer
        if (autoSaveState.timer) {
          clearTimeout(autoSaveState.timer);
        }

        // Don't schedule if no changes
        if (!state.dirty) {
          updateAutoSaveStatus();
          return;
        }

        // Schedule auto-save for 15 seconds from now
        autoSaveState.timer = setTimeout(() => {
          performAutoSave();
        }, 15000); // 15 seconds

        updateAutoSaveStatus();
      } catch(e) {
        console.error('Error in scheduleAutoSave:', e);
      }
    }

    function performAutoSave() {
      try {
        if (!state.dirty) return;
        if (autoSaveState.saving) {
          // Already saving - reschedule for after current save completes
          return;
        }
        if (!state.current) return;

      const availabilityDiffs = buildAvailabilityPayload();
      if (Object.keys(availabilityDiffs).length === 0) {
        state.dirty = false;
        updateAutoSaveStatus();
        return;
      }

      autoSaveState.saving = true;
      updateAutoSaveStatus();

      const payload = {
        user: ACTIVE_USER,
        Mailer_ID: state.current.Mailer_ID,
        availability: availabilityDiffs,
        Postcard_BG: stagedColors.Postcard_BG || null,
        Banner_BG: stagedColors.Banner_BG || null
      };

      // Use GET request instead of POST to avoid 403 errors
      const payloadJson = encodeURIComponent(JSON.stringify(payload));
      const url = `${GAS_URL}?action=saveSpots&data=${payloadJson}`;

      fetch(url)
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            throw new Error(result.error);
          }

          autoSaveState.saving = false;
          autoSaveState.lastSaveTime = Date.now();
          state.dirty = false;
          updateToolbar();
          updateAutoSaveStatus();

          // Clear spot selection after successful save
          state.selected.clear();
          renderAll();

          // Start interval to update "saved X min ago" text
          if (!autoSaveState.updateInterval) {
            autoSaveState.updateInterval = setInterval(() => {
              if (!state.dirty && autoSaveState.lastSaveTime) {
                updateAutoSaveStatus();
              }
            }, 30000); // Update every 30 seconds
          }

          toast('‚úì Auto-saved to cloud', true);
        })
        .catch(err => {
          console.error('Auto-save failed:', err);
          autoSaveState.saving = false;
          toast('Auto-save failed - saved locally only', false);
        });
      } catch(e) {
        console.error('Error in performAutoSave:', e);
        autoSaveState.saving = false;
        toast('Auto-save failed', false);
      }
    }

    function manualSaveNow() {
      if (!state.dirty) {
        toast('No changes to save', false);
        return;
      }

      // Cancel any pending auto-save
      if (autoSaveState.timer) {
        clearTimeout(autoSaveState.timer);
        autoSaveState.timer = null;
      }

      performAutoSave();
    }

    async function saveToSheet(){
      if (!state.current) return;
      if (!state.dirty) { toast("No changes to save"); return; }
      const availabilityDiffs = buildAvailabilityPayload();
      if (Object.keys(availabilityDiffs).length === 0) {
        toast("No changes to save");
        state.dirty = false;
        updateToolbar();
        return;
      }

      const updates = computeUpdates();
      const payload = {
        User: ACTIVE_USER,  // Use uppercase User to match backend
        Mailer_ID: state.current.Mailer_ID,
        Town: state.current.Town,
        Mail_Date: state.current.Mail_Date,
        In_Homes_Date: state.current.In_Homes_Date,
        availability: availabilityDiffs,
        Postcard_BG: stagedColors.Postcard_BG || state.current.Postcard_BG || '#000000',
        Banner_BG: stagedColors.Banner_BG || state.current.Banner_BG || '#000000'
      };

      try {
        toast(`‚òÅÔ∏è Saving ${updates} change${updates===1?"":"s"}...`, false);

        // Build Supabase update object with snake_case column names
        const updateData = {
          postcard_bg: stagedColors.Postcard_BG || state.current.Postcard_BG || '#000000',
          banner_bg: stagedColors.Banner_BG || state.current.Banner_BG || '#000000'
        };

        // Add spot updates
        Object.keys(availabilityDiffs).forEach(spotKey => {
          const spotNumber = spotKey.replace('Spot_', '');
          updateData[`spot_${spotNumber}`] = availabilityDiffs[spotKey];
        });

        // Update in Supabase
        const { error } = await supabaseClient
          .from('postcards')
          .update(updateData)
          .eq('mailer_id', state.current.Mailer_ID)
          .eq('user_email', ACTIVE_USER);

        if (error) throw error;

        toast(`‚úÖ Saved ${updates} change${updates===1?"":"s"} to cloud!`, true);
        state.dirty = false;
        autoSaveState.lastSaveTime = Date.now();
        updateToolbar();
        updateAutoSaveStatus();

        // Reload campaigns to get fresh data
        setTimeout(() => loadCampaigns(), 500);

      } catch (err) {
        console.error("Failed to save to cloud:", err);
        toast("‚ö†Ô∏è Failed to save to cloud. Please try again.", false);
      }
    }
  </script>
</body>
</html><!-- Force refresh 1762829270 -->
