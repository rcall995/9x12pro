<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Outreach Hub - 9x12 Pro</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        html, body {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }
        .channel-tab {
            transition: all 0.15s ease;
        }
        .channel-tab.active {
            transform: scale(1.05);
        }
        .prospect-item {
            transition: background-color 0.15s ease;
        }
        .prospect-item.selected {
            background-color: #e0f2fe;
            border-left: 4px solid #0ea5e9;
        }
        .prospect-item.contacted {
            opacity: 0.7;
        }
        .template-preview {
            white-space: pre-wrap;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .action-btn {
            min-height: 56px;
            font-size: 18px;
        }
        .nearby-badge {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .toast {
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateY(0);
        }
        /* Safe area for iPad */
        @supports (padding: env(safe-area-inset-bottom)) {
            .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        }
    </style>
</head>
<body class="bg-gray-100 h-full flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-sky-600 to-cyan-500 text-white px-4 py-3 flex items-center justify-between shadow-lg flex-shrink-0">
        <div class="flex items-center gap-3">
            <a href="/app.html" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
            </a>
            <div>
                <h1 class="text-xl font-bold">Outreach Hub</h1>
                <p class="text-xs text-purple-200">Quick Contact + Nearby Walk-ins</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="hubVersionDisplay" class="text-xs text-purple-300/70 font-mono"></span>
            <button onclick="reloadFromCloud()" class="text-xs bg-white/30 hover:bg-white/40 px-2 py-1 rounded-full">üîÑ Reload</button>
            <span id="syncStatus" class="text-xs bg-white/20 px-2 py-1 rounded-full">Loading...</span>
            <span id="userStatus" class="text-xs bg-white/20 px-2 py-1 rounded-full hidden"></span>
        </div>
    </header>

    <!-- Campaign Selector -->
    <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center gap-3 flex-shrink-0">
        <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-gray-600 whitespace-nowrap">Campaign:</label>
            <select id="campaignDropdown" onchange="onCampaignSelect()" class="px-3 py-2 border-2 border-purple-200 rounded-lg text-sm font-medium focus:border-purple-500 focus:outline-none bg-white">
                <option value="">-- Select Campaign --</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-gray-600 whitespace-nowrap">ZIP:</label>
            <select id="zipFilterDropdown" onchange="onZipFilterSelect()" class="px-3 py-2 border-2 border-blue-200 rounded-lg text-sm font-medium focus:border-blue-500 focus:outline-none bg-white">
                <option value="">All ZIPs</option>
            </select>
        </div>
        <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-gray-600 whitespace-nowrap">Category:</label>
            <select id="categoryFilterDropdown" onchange="onCategoryFilterSelect()" class="px-3 py-2 border-2 border-green-200 rounded-lg text-sm font-medium focus:border-green-500 focus:outline-none bg-white">
                <option value="">All Categories</option>
            </select>
        </div>
        <div id="campaignInfo" class="hidden text-sm text-purple-600 bg-purple-50 px-3 py-2 rounded-lg font-medium ml-auto">
            <span id="campaignInfoText"></span>
        </div>
    </div>

    <!-- View Mode Toggle + Channel Tabs -->
    <div class="bg-white border-b border-gray-200 px-2 py-2 flex-shrink-0">
        <!-- View Toggle -->
        <div class="flex items-center justify-between mb-2">
            <div class="flex gap-1">
                <button onclick="switchViewMode('channel')" id="viewMode-channel" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-purple-600 text-white">
                    üìã By Channel
                </button>
                <button onclick="switchViewMode('zipQueue')" id="viewMode-zipQueue" class="px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">
                    üìç ZIP Queue
                </button>
            </div>
            <div id="zipQueueStats" class="hidden text-xs text-gray-500">
                <span id="zipGroupCount">0</span> ZIPs ‚Ä¢ <span id="zipTotalCount">0</span> prospects
            </div>
            <!-- ZIP Queue Channel Selector -->
            <div id="zipQueueChannelSelector" class="hidden flex items-center gap-2 ml-auto">
                <span class="text-xs text-gray-500">Outreach via:</span>
                <select id="zipQueueChannel" onchange="setZipQueueChannel(this.value)"
                        class="text-sm px-2 py-1 rounded-lg border border-gray-300 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="email">üìß Email</option>
                    <option value="sms">üì± SMS</option>
                    <option value="facebook">üìò Facebook</option>
                    <option value="instagram">üì∑ Instagram</option>
                    <option value="linkedin">üíº LinkedIn</option>
                    <option value="call">üìû Call</option>
                </select>
            </div>
        </div>

        <!-- Channel Tabs (shown in channel mode) -->
        <div id="channelTabs" class="flex gap-1 overflow-x-auto">
            <button onclick="switchChannel('sms')" id="tab-sms" class="channel-tab active flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-green-500 text-white">
                <span class="text-lg">üì±</span> SMS
            </button>
            <button onclick="switchChannel('email')" id="tab-email" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üìß</span> Email
            </button>
            <button onclick="switchChannel('facebook')" id="tab-facebook" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üìò</span> Facebook
            </button>
            <button onclick="switchChannel('instagram')" id="tab-instagram" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üì∑</span> Instagram
            </button>
            <button onclick="switchChannel('linkedin')" id="tab-linkedin" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üíº</span> LinkedIn
            </button>
            <button onclick="switchChannel('call')" id="tab-call" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üìû</span> Call
            </button>
            <button onclick="switchChannel('nearby')" id="tab-nearby" class="channel-tab flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">
                <span class="text-lg">üìç</span> Nearby
                <span id="nearbyCount" class="hidden bg-green-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
            </button>
        </div>
    </div>

    <!-- Main Content - Split View -->
    <div class="flex-1 flex overflow-hidden">
        <!-- Left Panel - Prospect List -->
        <div class="w-2/5 border-r border-gray-200 bg-white flex flex-col">
            <div class="p-3 border-b border-gray-100 flex items-center justify-between">
                <span id="listTitle" class="font-semibold text-gray-700">SMS Prospects</span>
                <span id="listCount" class="text-sm text-gray-500">0 available</span>
            </div>
            <div id="prospectList" class="flex-1 overflow-y-auto">
                <!-- Prospects will be rendered here -->
                <div class="p-8 text-center text-gray-400">
                    <div class="text-4xl mb-2">üìã</div>
                    <p>Loading prospects...</p>
                </div>
            </div>
        </div>

        <!-- Right Panel - Selected Prospect Details -->
        <div class="w-3/5 bg-gray-50 flex flex-col">
            <div id="detailsPanel" class="flex-1 overflow-y-auto p-6">
                <!-- Empty State -->
                <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-400">
                    <div class="text-6xl mb-4">üëà</div>
                    <p class="text-lg">Select a prospect to get started</p>
                </div>

                <!-- Prospect Details (hidden by default) -->
                <div id="prospectDetails" class="hidden">
                    <div class="mb-6">
                        <h2 id="detailName" class="text-2xl font-bold text-gray-900">Business Name</h2>
                        <p id="detailCategory" class="text-gray-500">Category</p>
                        <div id="detailAddress" class="text-sm text-gray-400 mt-1"></div>
                    </div>

                    <!-- Contact Info -->
                    <div id="contactInfo" class="grid grid-cols-2 gap-3 mb-6">
                        <!-- Filled dynamically -->
                    </div>

                    <!-- Contact Status -->
                    <div id="contactStatus" class="mb-6 p-3 bg-white rounded-xl border border-gray-200">
                        <div class="text-sm font-semibold text-gray-700 mb-2">Contact Status</div>
                        <div id="statusIcons" class="flex flex-wrap gap-2">
                            <!-- Status icons rendered here -->
                        </div>
                    </div>

                    <!-- Template Preview -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Message Template</span>
                            <span class="text-xs text-gray-400">Edit in main app</span>
                        </div>
                        <div class="bg-white rounded-xl border border-gray-200 p-4">
                            <pre id="templatePreview" class="template-preview text-gray-700 text-sm">Select a prospect to see the template...</pre>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <button id="btnCopyOpen" onclick="copyAndOpen()" class="action-btn w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span id="btnCopyOpenIcon">üì±</span>
                            <span id="btnCopyOpenText">Copy & Open SMS</span>
                        </button>
                        <button id="btnMarkContacted" onclick="markContacted()" class="action-btn w-full bg-white border-2 border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                            <span>‚úì</span>
                            <span>Mark as Contacted</span>
                        </button>
                    </div>

                    <!-- Nearby-specific buttons (hidden by default) -->
                    <div id="nearbyActions" class="hidden space-y-3 mt-3">
                        <button onclick="getDirections()" class="action-btn w-full bg-blue-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span>üó∫Ô∏è</span>
                            <span>Get Directions</span>
                        </button>
                        <button onclick="showVisitModal()" class="action-btn w-full bg-orange-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                            <span>üö∂</span>
                            <span>Mark as Visited</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Stats -->
    <div class="bg-white border-t border-gray-200 px-4 py-3 flex items-center justify-between text-sm safe-bottom flex-shrink-0">
        <div class="flex items-center gap-6">
            <div>
                <span class="text-gray-500">Today:</span>
                <span id="statToday" class="font-bold text-purple-600">0</span>
                <span class="text-gray-400">contacted</span>
            </div>
            <div>
                <span class="text-gray-500">Session:</span>
                <span id="statSession" class="font-bold text-green-600">0</span>
            </div>
            <div>
                <span class="text-gray-500">Remaining:</span>
                <span id="statRemaining" class="font-bold text-gray-700">0</span>
            </div>
        </div>
        <div id="locationStatus" class="text-xs text-gray-400">
            üìç Location: --
        </div>
    </div>

    <!-- Visit Modal -->
    <div id="visitModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Mark Visit</h3>
            <p id="visitModalBusiness" class="text-gray-600 mb-4">Business Name</p>

            <div class="space-y-2 mb-4">
                <p class="text-sm font-semibold text-gray-700">Outcome:</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectOutcome('spoke')" class="outcome-btn p-3 rounded-xl border-2 border-gray-200 text-sm font-medium hover:border-green-500 hover:bg-green-50 transition-all" data-outcome="spoke">
                        üó£Ô∏è Spoke to owner
                    </button>
                    <button onclick="selectOutcome('card')" class="outcome-btn p-3 rounded-xl border-2 border-gray-200 text-sm font-medium hover:border-blue-500 hover:bg-blue-50 transition-all" data-outcome="card">
                        üí≥ Left card
                    </button>
                    <button onclick="selectOutcome('unavailable')" class="outcome-btn p-3 rounded-xl border-2 border-gray-200 text-sm font-medium hover:border-orange-500 hover:bg-orange-50 transition-all" data-outcome="unavailable">
                        üö´ Not available
                    </button>
                    <button onclick="selectOutcome('closed')" class="outcome-btn p-3 rounded-xl border-2 border-gray-200 text-sm font-medium hover:border-red-500 hover:bg-red-50 transition-all" data-outcome="closed">
                        üîí Closed
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="text-sm font-semibold text-gray-700">Notes (optional):</label>
                <textarea id="visitNotes" rows="2" class="w-full mt-1 p-3 border border-gray-300 rounded-xl text-sm" placeholder="Any notes about the visit..."></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="closeVisitModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold">Cancel</button>
                <button onclick="saveVisit()" class="flex-1 py-3 bg-green-500 text-white rounded-xl font-semibold">Save Visit</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 bg-gray-900 text-white rounded-xl shadow-lg z-50">
        <span id="toastMessage">Message</span>
    </div>

    <!-- Rapid Fire Modal -->
    <div id="rapidFireModal" class="fixed inset-0 bg-black/90 hidden flex-col z-50">
        <div class="bg-gradient-to-r from-sky-600 to-cyan-500 text-white p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="closeRapidFire()" class="p-2 hover:bg-white/20 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div>
                    <h2 class="font-bold text-lg">‚ö° Rapid Fire Mode</h2>
                    <p id="rapidFireZip" class="text-xs text-purple-200">ZIP: 00000</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold" id="rapidFireProgress">1/10</div>
                <div class="text-xs text-purple-200">Progress</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-gray-900">
            <div class="max-w-2xl mx-auto">
                <!-- Business Info -->
                <div class="bg-white rounded-xl p-4 mb-4">
                    <h3 id="rapidFireBusinessName" class="text-xl font-bold text-gray-900">Business Name</h3>
                    <p id="rapidFireCategory" class="text-gray-500 text-sm">Category</p>
                    <div id="rapidFireContact" class="mt-2 grid grid-cols-2 gap-2 text-sm">
                        <!-- Contact info filled dynamically -->
                    </div>
                </div>

                <!-- Template Preview -->
                <div class="bg-white rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-gray-700">Message</span>
                        <span id="rapidFireChannel" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">üì± SMS</span>
                    </div>
                    <pre id="rapidFireTemplate" class="template-preview text-gray-700 text-sm bg-gray-50 p-3 rounded-lg"></pre>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button onclick="rapidFireCopyAndOpen()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-bold text-lg shadow-lg">
                        üìã Copy & Open
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="rapidFireMarkSent()" class="py-3 bg-blue-500 text-white rounded-xl font-semibold">
                            ‚úì Mark Sent
                        </button>
                        <button onclick="rapidFireGotResponse()" class="py-3 bg-purple-500 text-white rounded-xl font-semibold">
                            üí¨ Got Response!
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="rapidFirePrevious()" class="py-3 bg-gray-600 text-white rounded-xl font-semibold">
                            ‚Üê Previous
                        </button>
                        <button onclick="rapidFireNext()" class="py-3 bg-gray-600 text-white rounded-xl font-semibold">
                            Next ‚Üí
                        </button>
                    </div>
                    <button onclick="rapidFireSkip()" class="w-full py-2 bg-gray-700 text-gray-300 rounded-xl text-sm">
                        Skip this business
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Capture Modal -->
    <div id="responseCaptureModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 mx-4 max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-2">üí¨ Response Received!</h3>
            <p id="responseCaptureBusiness" class="text-gray-600 mb-4">Business Name</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Response Channel (locked for follow-up)</label>
                    <div id="responseChannel" class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg font-medium text-sm">üì± SMS</div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Did they provide an email?</label>
                    <input type="email" id="capturedEmail" placeholder="email@example.com (optional)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Response Notes</label>
                    <textarea id="responseNotes" rows="3" placeholder="What did they say? Interest level? Next steps?"
                              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Interest Level</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setInterestLevel('hot')" class="interest-btn py-2 px-3 border-2 border-gray-200 rounded-lg text-sm font-medium hover:border-red-500 hover:bg-red-50" data-level="hot">
                            üî• Hot
                        </button>
                        <button onclick="setInterestLevel('warm')" class="interest-btn py-2 px-3 border-2 border-gray-200 rounded-lg text-sm font-medium hover:border-yellow-500 hover:bg-yellow-50" data-level="warm">
                            ‚òÄÔ∏è Warm
                        </button>
                        <button onclick="setInterestLevel('cold')" class="interest-btn py-2 px-3 border-2 border-gray-200 rounded-lg text-sm font-medium hover:border-blue-500 hover:bg-blue-50" data-level="cold">
                            ‚ùÑÔ∏è Cold
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeResponseCapture()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold">Cancel</button>
                <button onclick="saveResponse()" class="flex-1 py-3 bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-xl font-semibold">
                    Save & Move to Negotiating
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        const state = {
            currentChannel: 'sms',
            prospects: [],
            filteredProspects: [],
            selectedProspect: null,
            currentPosition: null,
            watchId: null,
            templates: {},
            settings: {},
            campaigns: [],
            pricingData: {},
            _settingsWarningShown: false,  // Track if settings warning has been shown
            campaignBoardData: null,  // Campaign board data
            currentMailerId: null,    // Current campaign/mailer ID
            zipFilter: '',            // ZIP filter for Outreach Hub
            categoryFilter: '',       // Category filter for Outreach Hub
            sessionStats: {
                contacted: 0,
                startTime: Date.now()
            },
            todayStats: {
                contacted: 0,
                date: new Date().toDateString()
            },
            visitOutcome: null,
            // ZIP Queue state
            viewMode: 'channel',  // 'channel' or 'zipQueue'
            zipQueue: {
                groups: {},       // { "85001": [businesses], ... }
                activeZip: null,
                rapidFireIndex: 0,
                rapidFireActive: false,
                selectedChannel: 'email'  // Default to email for ZIP Queue outreach
            },
            // Offline sync queue
            offlineSyncQueue: []
        };

        let supabaseClient = null;
        let currentUserEmail = null;

        // Load offline queue from localStorage on startup
        function loadOfflineQueue() {
            try {
                const saved = localStorage.getItem('outreach-offline-queue');
                if (saved) {
                    state.offlineSyncQueue = JSON.parse(saved);
                    console.log(`üì• Loaded ${state.offlineSyncQueue.length} items from offline queue`);
                }
            } catch (e) {
                console.warn('Failed to load offline queue:', e);
            }
        }

        // Save offline queue to localStorage
        function saveOfflineQueue() {
            try {
                localStorage.setItem('outreach-offline-queue', JSON.stringify(state.offlineSyncQueue));
            } catch (e) {
                console.warn('Failed to save offline queue:', e);
            }
        }

        // Add item to offline queue
        function queueForOfflineSync(prospectData, oldColumn, newColumn) {
            state.offlineSyncQueue.push({
                prospect: prospectData,
                oldColumn: oldColumn,
                newColumn: newColumn,
                mailerId: state.currentMailerId,
                timestamp: Date.now()
            });
            saveOfflineQueue();
            console.log(`üìù Queued sync for offline: ${prospectData.businessName}`);
        }

        // Process offline queue when back online
        async function processOfflineQueue() {
            if (state.offlineSyncQueue.length === 0) return;

            console.log(`üîÑ Processing ${state.offlineSyncQueue.length} queued sync items...`);
            const queue = [...state.offlineSyncQueue];
            state.offlineSyncQueue = [];
            saveOfflineQueue();

            for (const item of queue) {
                try {
                    // Temporarily set state for sync
                    const originalMailerId = state.currentMailerId;
                    const originalProspect = state.selectedProspect;

                    state.currentMailerId = item.mailerId;
                    state.selectedProspect = item.prospect;
                    state.selectedProspect._column = item.newColumn;

                    await syncToCloud(item.oldColumn);

                    // Restore state
                    state.currentMailerId = originalMailerId;
                    state.selectedProspect = originalProspect;

                    console.log(`‚úÖ Synced queued item: ${item.prospect.businessName}`);
                } catch (err) {
                    console.error(`‚ùå Failed to sync queued item: ${item.prospect.businessName}`, err);
                    // Re-queue if still failing
                    state.offlineSyncQueue.push(item);
                }
            }
            saveOfflineQueue();

            if (state.offlineSyncQueue.length === 0) {
                showToast('‚úì All offline changes synced!');
            } else {
                showToast(`‚ö†Ô∏è ${state.offlineSyncQueue.length} items still pending`);
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', () => {
            console.log('üåê Back online - processing offline queue');
            document.getElementById('syncStatus').textContent = '‚úì Online';
            document.getElementById('syncStatus').classList.remove('bg-yellow-500/30');
            document.getElementById('syncStatus').classList.add('bg-green-500/30');
            processOfflineQueue();
        });

        window.addEventListener('offline', () => {
            console.log('üì¥ Gone offline');
            document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Offline';
            document.getElementById('syncStatus').classList.remove('bg-green-500/30');
            document.getElementById('syncStatus').classList.add('bg-yellow-500/30');
        });

        // ============ DEBUG HELPER ============
        function showDebug(message, append = true) {
            const banner = document.getElementById('debugBanner');
            const text = document.getElementById('debugText');
            if (banner && text) {
                banner.classList.remove('hidden');
                if (append && text.textContent !== 'Debug info will appear here') {
                    text.innerHTML += '<br>' + message;
                } else {
                    text.innerHTML = message;
                }
                // Keep only last 8 lines
                const lines = text.innerHTML.split('<br>');
                if (lines.length > 8) {
                    text.innerHTML = lines.slice(-8).join('<br>');
                }
            }
            console.log('DEBUG:', message);
        }

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Outreach Hub loaded');
            showDebug('üöÄ Outreach Hub initializing...', false);

            // Load offline queue first
            loadOfflineQueue();

            // Display version in header
            if (window.APP_CONFIG?.app?.version) {
                const versionEl = document.getElementById('hubVersionDisplay');
                if (versionEl) versionEl.textContent = window.APP_CONFIG.app.version;
            }

            // Initialize Supabase
            if (window.supabase && window.APP_CONFIG) {
                supabaseClient = window.supabase.createClient(
                    window.APP_CONFIG.supabase.url,
                    window.APP_CONFIG.supabase.anonKey
                );
            }

            // Check auth first (needed for cloud loading)
            await checkAuth();

            // Process any pending offline sync items
            if (navigator.onLine && state.offlineSyncQueue.length > 0) {
                console.log('üîÑ Processing offline queue on startup...');
                setTimeout(processOfflineQueue, 2000); // Delay to let other loading complete
            }

            // Load data from cloud
            await loadCampaigns();
            await loadPricingData();
            await loadSettings();
            await loadTemplates();
            await loadProspects();
            loadTodayStats();

            // Populate campaign dropdown
            populateCampaignDropdown();

            // Start location tracking
            startLocationTracking();

            // Render initial view
            renderProspectList();
            updateStats();
        });

        // ============ AUTH ============
        async function checkAuth() {
            if (!supabaseClient) {
                document.getElementById('syncStatus').textContent = 'No DB';
                return;
            }
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session?.user) {
                    currentUserEmail = session.user.email;
                    document.getElementById('syncStatus').textContent = '‚úì Online';
                    document.getElementById('syncStatus').classList.add('bg-green-500/30');
                    // Show abbreviated email
                    const userEl = document.getElementById('userStatus');
                    userEl.textContent = currentUserEmail.split('@')[0];
                    userEl.classList.remove('hidden');
                    console.log('‚úÖ Logged in as:', currentUserEmail);
                } else {
                    document.getElementById('syncStatus').textContent = 'Not logged in';
                    document.getElementById('syncStatus').classList.add('bg-red-500/30');
                    console.warn('‚ö†Ô∏è No active session');
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                document.getElementById('syncStatus').textContent = 'Auth error';
            }
        }

        // Manual reload from cloud
        async function reloadFromCloud() {
            document.getElementById('syncStatus').textContent = 'Reloading...';
            try {
                await loadProspects();
                document.getElementById('syncStatus').textContent = '‚úì Reloaded';
                showToast('Reloaded from cloud');
            } catch (err) {
                console.error('Reload failed:', err);
                document.getElementById('syncStatus').textContent = 'Reload failed';
                showToast('Reload failed');
            }
        }

        // ============ CAMPAIGNS ============
        async function loadCampaigns() {
            console.log('üì• Loading campaigns...');
            console.log('üîç DEBUG currentUserEmail:', currentUserEmail);
            console.log('üîç DEBUG supabaseClient exists:', !!supabaseClient);

            if (!currentUserEmail || !supabaseClient) {
                console.warn('‚ö†Ô∏è Cannot load campaigns - no user or supabase client');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('postcards')
                    .select('*')
                    .eq('user_email', currentUserEmail)
                    .order('mail_date', { ascending: false });

                if (error) {
                    console.error('Failed to load campaigns:', error);
                    return;
                }

                state.campaigns = data || [];
                console.log('‚úÖ Loaded', state.campaigns.length, 'campaigns');
                console.log('üîç DEBUG campaigns:', state.campaigns.map(c => c.town));
            } catch (err) {
                console.error('Failed to load campaigns:', err);
            }
        }

        async function loadPricingData() {
            if (!currentUserEmail || !supabaseClient) return;
            console.log('üí∞ Loading pricing data...');
            try {
                const { data, error } = await supabaseClient
                    .from('app_data')
                    .select('data')
                    .eq('user_email', currentUserEmail)
                    .eq('data_type', 'pricing')
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Pricing load error:', error);
                    return;
                }

                if (data?.data) {
                    state.pricingData = data.data;
                    console.log('‚úÖ Pricing data loaded');
                }
            } catch (err) {
                console.error('Failed to load pricing:', err);
            }
        }

        function populateCampaignDropdown() {
            console.log('üîç DEBUG populateCampaignDropdown called');
            console.log('üîç DEBUG state.campaigns.length:', state.campaigns.length);

            const dropdown = document.getElementById('campaignDropdown');
            dropdown.innerHTML = '<option value="">-- Select Campaign --</option>';

            if (state.campaigns.length === 0) {
                console.warn('‚ö†Ô∏è No campaigns to populate dropdown');
                return;
            }

            state.campaigns.forEach((campaign, index) => {
                const option = document.createElement('option');
                option.value = index;
                const size = campaign.postcard_size || '9x12';
                const date = campaign.mail_date ? ` (${campaign.mail_date})` : '';
                option.textContent = `${campaign.town} ${size}${date}`;
                dropdown.appendChild(option);
            });

            console.log('‚úÖ Populated dropdown with', state.campaigns.length, 'campaigns');

            // Auto-select campaign in order of priority:
            // 1. Settings have a matching campaign
            // 2. Most recent campaign by mail_date
            // 3. First campaign if nothing else matches
            let selectedIndex = -1;

            // Try to match settings first
            if (state.settings.postcardName) {
                selectedIndex = state.campaigns.findIndex(c =>
                    c.town && state.settings.postcardName.includes(c.town)
                );
            }

            // If no settings match, find most recent campaign by date
            if (selectedIndex < 0 && state.campaigns.length > 0) {
                let mostRecentIndex = 0;
                let mostRecentDate = null;

                state.campaigns.forEach((campaign, index) => {
                    if (campaign.mail_date) {
                        const campaignDate = new Date(campaign.mail_date);
                        if (!mostRecentDate || campaignDate > mostRecentDate) {
                            mostRecentDate = campaignDate;
                            mostRecentIndex = index;
                        }
                    }
                });

                selectedIndex = mostRecentIndex;
                console.log('üìÖ Auto-selecting most recent campaign:', state.campaigns[selectedIndex]?.town);
            }

            // Apply selection and trigger onCampaignSelect to load data
            if (selectedIndex >= 0) {
                dropdown.value = selectedIndex;
                console.log('‚úÖ Auto-selected campaign index:', selectedIndex);
                // Trigger campaign selection to load prospects
                setTimeout(() => {
                    onCampaignSelect();
                }, 100);
            }
        }

        function extractTownName(fullName) {
            // Remove common prefixes and suffixes to get just the geographic area
            let town = fullName
                .replace(/^The\s+/gi, '')
                .replace(/^Where\s+/gi, '')
                .replace(/^Taste\s+of\s+/gi, '')
                .replace(/^Dining\s+Out\s+In\s+/gi, '')
                .replace(/\s+Eats$/gi, '')
                .replace(/\s+Food\s+Guide$/gi, '')
                .replace(/\s*Small Business Spotlight\s*/gi, '')
                .replace(/\s*Business Spotlight\s*/gi, '')
                .replace(/\s*Community Savings Card\s*/gi, '')
                .replace(/\s*Savings Card\s*/gi, '')
                .replace(/\s*Spotlight\s*/gi, '')
                .replace(/\s*Postcard\s*/gi, '')
                .replace(/\s*Mailer\s*/gi, '')
                .trim();
            return town || fullName;
        }

        function onCampaignSelect() {
            const dropdown = document.getElementById('campaignDropdown');
            const infoDiv = document.getElementById('campaignInfo');
            const infoText = document.getElementById('campaignInfoText');
            const selectedIndex = dropdown.value;

            if (selectedIndex === '' || selectedIndex === null) {
                infoDiv.classList.add('hidden');
                return;
            }

            const campaign = state.campaigns[parseInt(selectedIndex)];
            if (!campaign) return;

            // Extract area name
            const areaOnly = extractTownName(campaign.town);
            state.settings.areaName = areaOnly;

            // Set postcard name
            const townLower = campaign.town.toLowerCase();
            const isCompleteName = townLower.startsWith('the ') ||
                                   townLower.startsWith('where ') ||
                                   townLower.startsWith('taste of ') ||
                                   townLower.startsWith('dining out') ||
                                   townLower.includes('spotlight') ||
                                   townLower.includes('postcard') ||
                                   townLower.includes('savings') ||
                                   townLower.includes('card') ||
                                   townLower.includes('eats') ||
                                   townLower.includes('guide');

            state.settings.postcardName = isCompleteName ? campaign.town : `The ${campaign.town} Spotlight`;

            // Get home count - check postcards.address_count FIRST (most likely to be set),
            // then fall back to pricing data, then use default
            const mailerId = campaign.mailer_id;
            const campaignPricing = state.pricingData[mailerId];
            if (campaign.address_count && campaign.address_count > 0) {
                // Primary source: postcards.address_count (set via Edit Details or Set Ad Price)
                state.settings.homeCount = campaign.address_count.toLocaleString();
                console.log('‚úÖ Home count from campaign:', state.settings.homeCount);
            } else if (campaignPricing?.homeCount && campaignPricing.homeCount > 0) {
                // Fallback: pricing data (legacy)
                state.settings.homeCount = typeof campaignPricing.homeCount === 'number'
                    ? campaignPricing.homeCount.toLocaleString()
                    : campaignPricing.homeCount;
                console.log('‚úÖ Home count from pricing:', state.settings.homeCount);
            } else if (!state.settings.homeCount) {
                // Use default if nothing else available
                state.settings.homeCount = '5,000';
                console.log('‚ö†Ô∏è Using default home count (set in Edit Details):', state.settings.homeCount);
            }

            // Get ZIP code from campaign
            if (campaign.zip_code) {
                state.settings.zipCode = campaign.zip_code;
                console.log('‚úÖ ZIP code from campaign:', state.settings.zipCode);
            }

            // Show info
            const size = campaign.postcard_size || '9x12';
            const homeDisplay = state.settings.homeCount || '5,000';
            const zipDisplay = campaign.zip_code ? ` - ZIP ${campaign.zip_code}` : '';
            infoText.textContent = `üì¨ ${state.settings.postcardName} (${size}) - ${homeDisplay} homes${zipDisplay}`;
            infoDiv.classList.remove('hidden');

            // Save settings to cloud
            saveSettingsToCloud();

            // Re-render template preview if a prospect is selected
            if (state.selectedProspect) {
                updateTemplatePreview();
            }

            // Reset ZIP filter when campaign changes
            state.zipFilter = '';
            document.getElementById('zipFilterDropdown').value = '';

            // Load data for this campaign
            const campaignMailerId = campaign.mailer_id || campaign.Mailer_ID || campaign.id;
            console.log(`üîç Campaign selected: "${campaign.town}", mailer_id: "${campaignMailerId}"`);
            console.log(`üîç Campaign object keys:`, Object.keys(campaign));

            if (campaignMailerId) {
                state.currentMailerId = campaignMailerId;

                // Reload data for the selected campaign
                if (state.campaignBoardData) {
                    console.log(`üîç Using cached board data, keys: ${Object.keys(state.campaignBoardData).join(', ')}`);
                    processCampaignBoardData(state.campaignBoardData, campaignMailerId);
                } else {
                    // Data not loaded yet, fetch it
                    console.log('üì• No cached board data, fetching...');
                    loadProspects();
                }
            } else {
                console.warn('‚ö†Ô∏è No mailer ID found for campaign:', campaign);
            }

            showToast(`Campaign: ${campaign.town}`);
        }

        function onZipFilterSelect() {
            const dropdown = document.getElementById('zipFilterDropdown');
            state.zipFilter = dropdown.value;
            console.log(`üìç ZIP filter changed to: "${state.zipFilter || 'All'}"`);

            // Re-process data with new filter
            if (state.campaignBoardData && state.currentMailerId) {
                processCampaignBoardData(state.campaignBoardData, state.currentMailerId);
            }

            // Update ZIP Queue if active
            if (state.viewMode === 'zipQueue') {
                buildZipQueue();
                renderZipQueue();
            }
        }

        // Helper function to check if a prospect has the required contact info for a channel
        function prospectHasChannelInfo(p, channel) {
            switch (channel) {
                case 'sms':
                case 'call':
                    return !!p.phone;
                case 'email':
                    return !!p.email;
                case 'facebook':
                    return !!p.facebook;
                case 'instagram':
                    return !!p.instagram;
                case 'linkedin':
                    return !!p.linkedin;
                case 'nearby':
                    return !!(p.lat && p.lng);
                default:
                    return true;
            }
        }

        function populateZipDropdown() {
            const dropdown = document.getElementById('zipFilterDropdown');
            const currentValue = state.zipFilter || '';
            const channel = state.currentChannel;

            // Filter prospects by current channel first
            const channelProspects = state.prospects.filter(p => prospectHasChannelInfo(p, channel));

            // Collect all unique ZIPs from channel-filtered prospects
            const zips = new Set();
            channelProspects.forEach(p => {
                const zip = p.actualZip || p.zipCode || p.zip;
                if (zip) zips.add(String(zip).substring(0, 5)); // Normalize to 5 digits
            });

            const sortedZips = Array.from(zips).sort();

            // Build options
            let options = '<option value="">All ZIPs (' + channelProspects.length + ')</option>';
            sortedZips.forEach(zip => {
                const count = channelProspects.filter(p => {
                    const pZip = String(p.actualZip || p.zipCode || p.zip || '').substring(0, 5);
                    return pZip === zip;
                }).length;
                options += `<option value="${zip}" ${currentValue === zip ? 'selected' : ''}>${zip} (${count})</option>`;
            });

            dropdown.innerHTML = options;
            console.log(`üìç ZIP dropdown populated: ${sortedZips.length} ZIPs for ${channel} channel`);
        }

        function onCategoryFilterSelect() {
            const dropdown = document.getElementById('categoryFilterDropdown');
            state.categoryFilter = dropdown.value;
            console.log(`üè∑Ô∏è Category filter changed to: "${state.categoryFilter || 'All'}"`);

            // Re-render the prospect list with filter
            renderProspectList();
            updateStats();
        }

        function populateCategoryDropdown() {
            const dropdown = document.getElementById('categoryFilterDropdown');
            if (!dropdown) return;

            const currentValue = state.categoryFilter || '';
            const channel = state.currentChannel;

            // Filter prospects by current channel first
            const channelProspects = state.prospects.filter(p => prospectHasChannelInfo(p, channel));

            // Collect all unique categories from channel-filtered prospects
            const categories = new Set();
            channelProspects.forEach(p => {
                const category = p.category || p.businessType || p.type;
                if (category) categories.add(String(category));
            });

            const sortedCategories = Array.from(categories).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

            // Build options
            let options = `<option value="">All Categories (${channelProspects.length})</option>`;
            sortedCategories.forEach(category => {
                const count = channelProspects.filter(p => {
                    const pCat = p.category || p.businessType || p.type;
                    return String(pCat) === category;
                }).length;
                options += `<option value="${category}" ${currentValue === category ? 'selected' : ''}>${category} (${count})</option>`;
            });

            dropdown.innerHTML = options;
            console.log(`üè∑Ô∏è Category dropdown populated: ${sortedCategories.length} categories for ${channel} channel`);
        }

        async function saveSettingsToCloud() {
            if (!currentUserEmail || !supabaseClient) return;
            try {
                // Save to localStorage
                localStorage.setItem('outreach-scripts-settings', JSON.stringify(state.settings));

                // Save to cloud
                const { error } = await supabaseClient
                    .from('app_data')
                    .upsert({
                        user_email: currentUserEmail,
                        data_type: 'outreach-settings',
                        data: state.settings
                    }, {
                        onConflict: 'user_email,data_type'
                    });

                if (error) {
                    console.error('Cloud settings save error:', error);
                } else {
                    console.log('‚òÅÔ∏è Settings saved to cloud');
                }
            } catch (err) {
                console.error('Failed to save settings to cloud:', err);
            }
        }

        // ============ DATA LOADING ============
        async function loadProspects() {
            console.log('üì• Loading prospects from Campaign Board...');
            showDebug('üì• Loading prospects...');

            // ALWAYS load from Supabase first if logged in (for cross-device sync)
            if (supabaseClient && currentUserEmail) {
                try {
                    showDebug(`‚òÅÔ∏è User: ${currentUserEmail}`);

                    // First, get the current mailer/campaign
                    console.log('‚òÅÔ∏è Loading current mailer...');
                    const mailersResult = await supabaseClient
                        .from('app_data')
                        .select('data')
                        .eq('user_email', currentUserEmail)
                        .eq('data_type', 'mailers')
                        .single();

                    let currentMailerId = null;

                    // First check localStorage for the selected campaign (same key main app uses)
                    const savedMailerId = localStorage.getItem('mailslot-selectedMailerId');
                    if (savedMailerId) {
                        currentMailerId = savedMailerId;
                        state.currentMailerId = currentMailerId;
                        console.log('‚úÖ Current mailer from localStorage:', currentMailerId);
                        showDebug(`üìã Mailer from localStorage: ${currentMailerId}`);
                    } else if (!mailersResult.error && mailersResult.data?.data) {
                        // Fall back to finding current/active mailer or first one
                        const mailers = mailersResult.data.data;
                        const mailersList = Array.isArray(mailers) ? mailers : Object.values(mailers);
                        const currentMailer = mailersList.find(m => m.current || m.status === 'current') || mailersList[0];
                        if (currentMailer) {
                            currentMailerId = currentMailer.Mailer_ID || currentMailer.id;
                            state.currentMailerId = currentMailerId;
                            console.log('‚úÖ Current mailer from mailers list:', currentMailerId);
                            showDebug(`üìã Mailer from list: ${currentMailerId}`);
                        }
                    } else {
                        showDebug('‚ö†Ô∏è No mailer ID found yet');
                    }

                    // Now load campaign boards
                    console.log('‚òÅÔ∏è Loading campaign boards from Supabase...');
                    const { data, error } = await supabaseClient
                        .from('app_data')
                        .select('data')
                        .eq('user_email', currentUserEmail)
                        .eq('data_type', 'campaign-boards')
                        .single();

                    if (!error && data?.data) {
                        const boardKeys = Object.keys(data.data || {});
                        console.log('‚úÖ Loaded campaign boards from cloud');
                        console.log('üîç DEBUG cloud data keys:', boardKeys);
                        showDebug(`‚úÖ Boards loaded: ${boardKeys.length} boards`);
                        showDebug(`üìã Board keys: ${boardKeys.join(', ') || '(none)'}`);
                        processCampaignBoardData(data.data, currentMailerId);
                        // Also cache locally
                        localStorage.setItem('campaign-boards', JSON.stringify(data.data));
                        return;
                    } else {
                        console.log('‚ö†Ô∏è No campaign board data or error:', error?.message);
                        showDebug(`‚ùå No boards: ${error?.message || 'empty'}`);
                    }
                } catch (err) {
                    console.error('Cloud load failed:', err);
                    showDebug(`‚ùå Load error: ${err.message}`);
                }
            } else {
                showDebug('‚ö†Ô∏è No supabase or user');
            }

            // Fall back to local data if cloud fails
            loadFromLocalStorage();
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('campaign-boards');
                const mailerId = state.currentMailerId || localStorage.getItem('mailslot-selectedMailerId');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    console.log('üì¶ localStorage campaign board data:', parsed);
                    console.log('üì¶ Using mailerId:', mailerId);
                    processCampaignBoardData(parsed, mailerId);
                } else {
                    console.log('‚ùå No campaign board data in localStorage either');
                    document.getElementById('syncStatus').textContent = 'No data';
                }
            } catch (err) {
                console.error('localStorage load failed:', err);
            }
        }

        function processCampaignBoardData(boardsData, mailerId) {
            // Store raw campaign board data for syncing later
            state.campaignBoardData = boardsData;
            if (mailerId) state.currentMailerId = mailerId;

            // Use ZIP filter from dropdown
            const zipFilter = state.zipFilter || '';

            const allProspects = [];

            // Get the board for the selected campaign (with flexible key matching)
            let board = null;
            if (mailerId && boardsData) {
                // Try exact match first
                board = boardsData[mailerId];

                // If not found, try case-insensitive match
                if (!board) {
                    const mailerIdLower = mailerId.toLowerCase();
                    const matchingKey = Object.keys(boardsData).find(key =>
                        key.toLowerCase() === mailerIdLower
                    );
                    if (matchingKey) {
                        board = boardsData[matchingKey];
                        console.log(`üîÑ Found board with different case: ${matchingKey} (searched for: ${mailerId})`);
                        // Update state to use the actual key
                        state.currentMailerId = matchingKey;
                    }
                }

                // If still not found, try partial match (mailer ID might be subset)
                if (!board) {
                    const matchingKey = Object.keys(boardsData).find(key =>
                        key.includes(mailerId) || mailerId.includes(key)
                    );
                    if (matchingKey) {
                        board = boardsData[matchingKey];
                        console.log(`üîÑ Found board with partial match: ${matchingKey} (searched for: ${mailerId})`);
                        state.currentMailerId = matchingKey;
                    }
                }
            }

            console.log(`üîç Board lookup: mailerId="${mailerId}", found=${!!board}, availableKeys=${Object.keys(boardsData || {}).join(', ')}`);
            showDebug(`üîç Looking for: "${mailerId}"`);
            showDebug(`üìã Available: ${Object.keys(boardsData || {}).join(', ') || '(none)'}`);
            showDebug(`${board ? '‚úÖ Board FOUND' : '‚ùå Board NOT found'}`);

            if (!board) {
                console.log('‚ö†Ô∏è No board found for mailer:', mailerId);
                console.log('Available boards:', Object.keys(boardsData || {}));

                // Auto-create an empty board structure for this campaign
                if (mailerId && boardsData) {
                    console.log('üîß Auto-creating empty board for:', mailerId);
                    showDebug('üîß Auto-creating empty board...');
                    const newBoard = {
                        mailerId: mailerId,
                        name: mailerId,
                        config: {
                            channelPriority: ['sms', 'email', 'facebook', 'call'],
                            maxAttempts: 4,
                            daysBetweenAttempts: 3
                        },
                        columns: {
                            'queued': [],
                            'attempting': [],
                            'negotiating': [],
                            'invoice-sent': [],
                            'proof-approved': [],
                            'paid-in-full': []
                        },
                        createdAt: new Date().toISOString()
                    };
                    boardsData[mailerId] = newBoard;
                    state.campaignBoardData = boardsData;

                    // Save the new board to cloud
                    if (currentUserEmail && supabaseClient) {
                        supabaseClient.from('app_data').upsert({
                            user_email: currentUserEmail,
                            data_type: 'campaign-boards',
                            data: boardsData
                        }, { onConflict: 'user_email,data_type' }).then(({ error }) => {
                            if (error) {
                                console.error('Failed to save auto-created board:', error);
                            } else {
                                console.log('‚úÖ Auto-created board saved to cloud');
                            }
                        });
                    }

                    // Continue with empty board (will show empty list)
                    state.prospects = [];
                    renderProspectList();
                    updateStats();
                    populateZipDropdown();
            populateCategoryDropdown();
                    return;
                }

                state.prospects = [];
                renderProspectList();
                updateStats();
                populateZipDropdown();
            populateCategoryDropdown();
                return;
            }

            console.log('üìä Loading from board:', mailerId);

            // Show column counts in debug
            const colCounts = Object.entries(board.columns || {}).map(([k, v]) => `${k}:${(v || []).length}`).join(', ');
            showDebug(`üìä Columns: ${colCounts || '(no columns)'}`);

            // Load from 'queued' column
            let queuedItems = board.columns?.['queued'] || [];

            // Apply ZIP filter if set (normalize to 5 digits for comparison)
            if (zipFilter) {
                queuedItems = queuedItems.filter(item => {
                    const itemZip = String(item.actualZip || item.zipCode || item.zip || '').substring(0, 5);
                    return itemZip === zipFilter;
                });
            }

            queuedItems.forEach(item => {
                if (item && typeof item === 'object' && (item.businessName || item.name)) {
                    allProspects.push({
                        ...item,
                        _column: 'queued',
                        _boardId: mailerId,
                        pipelineStage: 'Queued'
                    });
                }
            });

            // Load from 'attempting' column
            let attemptingItems = board.columns?.['attempting'] || [];

            // Apply ZIP filter if set (normalize to 5 digits for comparison)
            if (zipFilter) {
                attemptingItems = attemptingItems.filter(item => {
                    const itemZip = String(item.actualZip || item.zipCode || item.zip || '').substring(0, 5);
                    return itemZip === zipFilter;
                });
            }

            attemptingItems.forEach(item => {
                if (item && typeof item === 'object' && (item.businessName || item.name)) {
                    allProspects.push({
                        ...item,
                        _column: 'attempting',
                        _boardId: mailerId,
                        pipelineStage: 'Attempting'
                    });
                }
            });

            state.prospects = allProspects;
            console.log('‚úÖ Loaded', allProspects.length, 'prospects from board:', mailerId);
            showDebug(`‚úÖ Loaded ${allProspects.length} prospects`);
            renderProspectList();
            updateStats();
            populateZipDropdown();
            populateCategoryDropdown();
        }

        async function loadSettings() {
            try {
                // Try cloud first if logged in
                if (currentUserEmail && supabaseClient) {
                    console.log('‚òÅÔ∏è Loading settings from cloud...');
                    const { data, error } = await supabaseClient
                        .from('app_data')
                        .select('data')
                        .eq('user_email', currentUserEmail)
                        .eq('data_type', 'outreach-settings')
                        .single();

                    if (!error && data?.data) {
                        state.settings = data.data;
                        // Also update localStorage
                        localStorage.setItem('outreach-scripts-settings', JSON.stringify(state.settings));
                        console.log('‚úÖ Loaded settings from cloud:', state.settings);
                    } else if (error && error.code !== 'PGRST116') {
                        console.error('Cloud settings load error:', error);
                    }
                }

                // Fallback to localStorage if no cloud settings
                if (!state.settings.yourName && !state.settings.postcardName) {
                    const stored = localStorage.getItem('outreach-scripts-settings');
                    if (stored) {
                        state.settings = JSON.parse(stored);
                        console.log('‚úÖ Loaded settings from localStorage:', state.settings);
                    } else {
                        console.log('‚ö†Ô∏è No settings found');
                    }
                }

                // Ensure critical values have defaults (cloud/localStorage may have stored empty strings)
                if (!state.settings.homeCount) state.settings.homeCount = '5,000';
                if (!state.settings.spotPrice) state.settings.spotPrice = '$400';
                console.log('üìã Settings after defaults:', { homeCount: state.settings.homeCount, spotPrice: state.settings.spotPrice });

            } catch (err) {
                console.error('Failed to load settings:', err);
            }
        }

        async function loadTemplates() {
            try {
                // Try cloud first if logged in
                if (currentUserEmail && supabaseClient) {
                    console.log('‚òÅÔ∏è Loading templates from cloud...');
                    const { data, error } = await supabaseClient
                        .from('app_data')
                        .select('data')
                        .eq('user_email', currentUserEmail)
                        .eq('data_type', 'outreach-templates')
                        .single();

                    if (!error && data?.data) {
                        state.templates = data.data;
                        console.log('‚úÖ Loaded templates from cloud:', Object.keys(state.templates));
                        return;
                    } else if (error && error.code !== 'PGRST116') {
                        console.error('Cloud template load error:', error);
                    }
                }

                // Fallback to localStorage
                const stored = localStorage.getItem('outreach-scripts-templates');
                if (stored) {
                    state.templates = JSON.parse(stored);
                    console.log('‚úÖ Loaded templates from localStorage:', Object.keys(state.templates));
                } else {
                    console.log('‚ö†Ô∏è No templates found - using defaults');
                }
            } catch (err) {
                console.error('Failed to load templates:', err);
            }
        }

        function loadTodayStats() {
            try {
                const stored = localStorage.getItem('outreach-today-stats');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (parsed.date === new Date().toDateString()) {
                        state.todayStats = parsed;
                    }
                }
            } catch (err) {
                console.error('Failed to load today stats:', err);
            }
        }

        function saveTodayStats() {
            state.todayStats.date = new Date().toDateString();
            localStorage.setItem('outreach-today-stats', JSON.stringify(state.todayStats));
        }

        // ============ CHANNEL SWITCHING ============
        function switchChannel(channel) {
            state.currentChannel = channel;
            state.selectedProspect = null;

            // Update tab styles
            document.querySelectorAll('.channel-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-green-500', 'bg-blue-500', 'bg-sky-500', 'bg-pink-500', 'bg-orange-500', 'text-white');
                tab.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeTab = document.getElementById('tab-' + channel);
            activeTab.classList.add('active', 'text-white');
            activeTab.classList.remove('bg-gray-100', 'text-gray-700');

            // Set tab color
            const colors = {
                sms: 'bg-green-500',
                email: 'bg-blue-500',
                facebook: 'bg-blue-600',
                instagram: 'bg-pink-500',
                linkedin: 'bg-sky-600',
                call: 'bg-orange-500',
                nearby: 'bg-emerald-500'
            };
            activeTab.classList.add(colors[channel] || 'bg-purple-500');

            // Update list title
            const titles = {
                sms: 'SMS Prospects',
                email: 'Email Prospects',
                facebook: 'Facebook Prospects',
                instagram: 'Instagram Prospects',
                linkedin: 'LinkedIn Prospects',
                call: 'Call Prospects',
                nearby: 'Nearby Businesses'
            };
            document.getElementById('listTitle').textContent = titles[channel];

            // Repopulate dropdowns to show only businesses with this channel's contact info
            populateZipDropdown();
            populateCategoryDropdown();

            renderProspectList();
            showEmptyState();
        }

        // ============ FILTERING ============
        function filterProspects() {
            const channel = state.currentChannel;

            if (channel === 'nearby') {
                return filterNearby();
            }

            let filtered = state.prospects.filter(p => {
                switch (channel) {
                    case 'sms':
                    case 'call':
                        return !!p.phone;
                    case 'email':
                        return !!p.email;
                    case 'facebook':
                        return !!p.facebook;
                    case 'instagram':
                        return !!p.instagram;
                    case 'linkedin':
                        return !!p.linkedin;
                    default:
                        return true;
                }
            });

            // Apply category filter if set
            if (state.categoryFilter) {
                filtered = filtered.filter(p => {
                    const pCat = p.category || p.businessType || p.type;
                    return String(pCat) === state.categoryFilter;
                });
            }

            return filtered;
        }

        function filterNearby() {
            if (!state.currentPosition) return [];

            return state.prospects
                .filter(p => p.lat && p.lng)
                .map(p => ({
                    ...p,
                    distance: calculateDistance(
                        state.currentPosition.lat,
                        state.currentPosition.lng,
                        p.lat,
                        p.lng
                    )
                }))
                .filter(p => p.distance <= 1) // Within 1 mile
                .sort((a, b) => a.distance - b.distance);
        }

        // ============ RENDERING ============
        function renderProspectList() {
            const container = document.getElementById('prospectList');
            const filtered = filterProspects();
            state.filteredProspects = filtered;

            document.getElementById('listCount').textContent = `${filtered.length} available`;

            if (filtered.length === 0) {
                const emptyMessages = {
                    sms: 'No prospects with phone numbers',
                    email: 'No prospects with email addresses',
                    facebook: 'No prospects with Facebook URLs',
                    instagram: 'No prospects with Instagram URLs',
                    linkedin: 'No prospects with LinkedIn URLs',
                    call: 'No prospects with phone numbers',
                    nearby: state.currentPosition ? 'No businesses within 1 mile' : 'Enable location to see nearby businesses'
                };

                container.innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <div class="text-4xl mb-2">${state.currentChannel === 'nearby' ? 'üìç' : 'üìã'}</div>
                        <p>${emptyMessages[state.currentChannel]}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map((p, idx) => {
                const ct = p.contactTracking || {};
                const isContacted = getContactedStatus(p);
                const distanceText = p.distance !== undefined ? `<span class="text-xs text-emerald-600 font-medium">üìç ${p.distance.toFixed(1)} mi</span>` : '';

                // Build contact icons
                const icons = [];
                if (p.phone) icons.push(ct.texted ? 'üì±‚úì' : 'üì±');
                if (p.email) icons.push(ct.emailed ? 'üìß‚úì' : 'üìß');
                if (p.facebook) icons.push(ct.facebookMessaged ? 'üìò‚úì' : 'üìò');
                if (p.instagram) icons.push(ct.dmed ? 'üì∑‚úì' : 'üì∑');
                if (p.linkedin) icons.push(ct.linkedinMessaged ? 'üíº‚úì' : 'üíº');

                // Build "Contacted via" badge showing which methods were used
                const usedMethods = [];
                if (ct.texted) usedMethods.push('üì±');
                if (ct.emailed) usedMethods.push('üìß');
                if (ct.called) usedMethods.push('üìû');
                if (ct.facebookMessaged) usedMethods.push('üìò');
                if (ct.dmed) usedMethods.push('üì∑');
                if (ct.linkedinMessaged) usedMethods.push('üíº');

                const contactedBadge = usedMethods.length > 0
                    ? `<div class="mt-1 inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 border border-green-300 rounded-full text-xs">
                         <span class="text-green-700 font-medium">Contacted:</span>
                         <span class="text-green-800 font-bold">${usedMethods.join(' ')}</span>
                       </div>`
                    : '';

                return `
                    <div class="prospect-item p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${isContacted ? 'contacted' : ''}"
                         onclick="selectProspect(${idx})">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    ${isContacted ? '<span class="text-green-500">‚úì</span>' : ''}
                                    <span class="font-medium text-gray-900 truncate">${p.businessName}</span>
                                </div>
                                <div class="text-xs text-gray-500 truncate">${p.category || 'No category'} ‚Ä¢ ZIP: ${p.actualZip || p.zipCode || p.zip || '?'}</div>
                                ${contactedBadge}
                                ${distanceText}
                            </div>
                            <div class="text-xs text-gray-400 ml-2 flex-shrink-0">${icons.join(' ')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProspect(index) {
            const prospect = state.filteredProspects[index];
            state.selectedProspect = prospect;

            // Update list selection
            document.querySelectorAll('.prospect-item').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            // Show details
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('prospectDetails').classList.remove('hidden');

            // Fill details
            document.getElementById('detailName').textContent = prospect.businessName;
            document.getElementById('detailCategory').textContent = prospect.category || 'No category';

            const address = prospect.address || prospect.fullAddress || '';
            document.getElementById('detailAddress').textContent = address;

            // Contact info with edit capability
            const contactHtml = `
                <div id="contactDisplay">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-500 font-medium">Contact Info</span>
                        <button onclick="toggleHubEditMode()" class="text-xs text-sky-600 hover:text-sky-800 font-medium">‚úèÔ∏è Edit</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white rounded-lg p-2 border">
                            <span class="text-gray-500 text-xs">Phone:</span><br>
                            <span class="font-medium">${prospect.phone || '<span class="text-gray-400">Not set</span>'}</span>
                        </div>
                        <div class="bg-white rounded-lg p-2 border">
                            <span class="text-gray-500 text-xs">Email:</span><br>
                            <span class="font-medium text-sm truncate">${prospect.email || '<span class="text-gray-400">Not set</span>'}</span>
                        </div>
                    </div>
                    <div class="mt-2 bg-white rounded-lg p-2 border">
                        <span class="text-gray-500 text-xs">Category:</span><br>
                        <span class="font-medium">${prospect.category || '<span class="text-gray-400">Not set</span>'}</span>
                    </div>
                </div>
                <div id="contactEdit" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-500 font-medium">Edit Contact Info</span>
                        <button onclick="toggleHubEditMode()" class="text-xs text-red-600 hover:text-red-800 font-medium">‚ùå Cancel</button>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs text-gray-500">Phone</label>
                            <input type="tel" id="hubEditPhone" value="${prospect.phone || ''}" class="w-full px-2 py-1.5 border rounded text-sm" placeholder="Phone number">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Email</label>
                            <input type="email" id="hubEditEmail" value="${prospect.email || ''}" class="w-full px-2 py-1.5 border rounded text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Category</label>
                            <input type="text" id="hubEditCategory" value="${prospect.category || ''}" class="w-full px-2 py-1.5 border rounded text-sm" placeholder="Business category">
                        </div>
                        <div class="flex gap-2 pt-1">
                            <button onclick="saveHubContactEdit()" class="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 font-medium">
                                üíæ Save
                            </button>
                            <button onclick="deleteFromHub()" class="px-3 py-2 bg-red-100 text-red-700 text-sm rounded-lg hover:bg-red-200 font-medium">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('contactInfo').innerHTML = contactHtml;

            // Contact status icons
            const ct = prospect.contactTracking || {};
            const statusHtml = [
                { key: 'emailed', icon: 'üìß', label: 'Email' },
                { key: 'texted', icon: 'üì±', label: 'Text' },
                { key: 'called', icon: 'üìû', label: 'Call' },
                { key: 'facebookMessaged', icon: 'üìò', label: 'FB' },
                { key: 'dmed', icon: 'üì∑', label: 'IG' },
                { key: 'linkedinMessaged', icon: 'üíº', label: 'LI' },
                { key: 'visitedInPerson', icon: 'üö∂', label: 'Visit' }
            ].map(s => `
                <span class="px-2 py-1 rounded-full text-xs ${ct[s.key] ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}">
                    ${s.icon} ${s.label} ${ct[s.key] ? '‚úì' : ''}
                </span>
            `).join('');
            document.getElementById('statusIcons').innerHTML = statusHtml;

            // Template preview
            updateTemplatePreview();

            // Update action button
            updateActionButton();

            // Show/hide nearby actions
            const isNearby = state.currentChannel === 'nearby';
            document.getElementById('nearbyActions').classList.toggle('hidden', !isNearby);
            document.getElementById('btnCopyOpen').classList.toggle('hidden', isNearby);
            document.getElementById('btnMarkContacted').classList.toggle('hidden', isNearby);
        }

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('prospectDetails').classList.add('hidden');
        }

        function updateTemplatePreview() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            let template = '';
            const channel = state.currentChannel;

            // Get appropriate template
            if (channel === 'nearby') {
                template = state.templates.walkin1?.body || 'Hi! I\'m [YOUR_NAME]. I do a community postcard that goes out to [HOME_COUNT] homes in [AREA].';
            } else if (channel === 'sms') {
                template = state.templates.sms1?.body || 'Hey! This is [YOUR_NAME]. We do a community postcard that hits [HOME_COUNT] homes in [AREA] and have the [CATEGORY] spot open. Interested?';
            } else if (channel === 'email') {
                const subject = state.templates.email1?.subject || 'Quick question about [BUSINESS_NAME]';
                const body = state.templates.email1?.body || 'Hi, we send out a community postcard...';
                template = `Subject: ${subject}\n\n${body}`;
            } else if (channel === 'facebook') {
                template = state.templates.fb?.body || 'Hey! I came across [BUSINESS_NAME] and love what you\'re doing...';
            } else if (channel === 'instagram') {
                template = state.templates.ig?.body || 'Hey! Love your page. I help local businesses reach more customers...';
            } else if (channel === 'linkedin') {
                template = state.templates.linkedin2?.body || 'Thanks for connecting! I run a community postcard...';
            } else if (channel === 'call') {
                template = state.templates.call1?.body || '=== OPENER ===\nHi, is this [BUSINESS_NAME]?...';
            }

            // Fill variables
            const filled = fillVariables(template, prospect);
            document.getElementById('templatePreview').textContent = filled;

            // Debug logging
            console.log('üìù Template preview updated:', {
                channel,
                businessName: prospect.businessName,
                category: prospect.category,
                settings: { yourName: state.settings.yourName, areaName: state.settings.areaName, homeCount: state.settings.homeCount },
                rawTemplate: template.substring(0, 50) + '...',
                filled: filled.substring(0, 50) + '...'
            });
        }

        // Unified template variable replacement - supports both [BRACKET] and {curlyBrace} syntax
        function fillVariables(text, prospect, warnOnMissing = false) {
            if (!text) return '';

            const settings = state.settings || {};
            const missingVars = [];

            // Strip "$" from spotPrice so templates can use "$[SPOT_PRICE]" without getting "$$"
            const priceValue = (settings.spotPrice || '400').replace(/^\$/, '');

            // Variable mappings: [BRACKET] -> {curlyBrace} -> value -> fallback
            const variables = {
                businessName: { value: prospect?.businessName, fallback: 'there' },
                category: { value: prospect?.category, fallback: 'business' },
                yourName: { value: settings.yourName, fallback: 'Your Name' },
                yourCompany: { value: settings.yourCompany, fallback: '' },
                yourPhone: { value: settings.yourPhone, fallback: '' },
                areaName: { value: settings.areaName, fallback: 'the area' },
                homeCount: { value: settings.homeCount, fallback: '5,000' },
                postcardName: { value: settings.postcardName, fallback: 'The Postcard' },
                spotPrice: { value: priceValue, fallback: '400' },
                zipCode: { value: settings.zipCode, fallback: '' }
            };

            // Map bracket names to camelCase names
            const bracketMap = {
                'BUSINESS_NAME': 'businessName',
                'CATEGORY': 'category',
                'YOUR_NAME': 'yourName',
                'YOUR_COMPANY': 'yourCompany',
                'YOUR_PHONE': 'yourPhone',
                'AREA': 'areaName',
                'HOME_COUNT': 'homeCount',
                'POSTCARD_NAME': 'postcardName',
                'SPOT_PRICE': 'spotPrice',
                'ZIP': 'zipCode'
            };

            let result = text;

            // Replace {curlyBrace} syntax
            Object.entries(variables).forEach(([key, { value, fallback }]) => {
                const pattern = new RegExp(`\\{${key}\\}`, 'g');
                const finalValue = value || fallback;
                if (!value && warnOnMissing) missingVars.push(key);
                result = result.replace(pattern, finalValue);
            });

            // Replace [BRACKET] syntax for backward compatibility
            Object.entries(bracketMap).forEach(([bracket, camel]) => {
                const { value, fallback } = variables[camel];
                const pattern = new RegExp(`\\[${bracket}\\]`, 'g');
                const finalValue = value || fallback || `[${bracket}]`;
                result = result.replace(pattern, finalValue);
            });

            // Warn if missing variables
            if (warnOnMissing && missingVars.length > 0 && !state._settingsWarningShown) {
                const settingsVars = missingVars.filter(v => ['yourName', 'areaName', 'homeCount', 'postcardName', 'spotPrice'].includes(v));
                if (settingsVars.length > 0) {
                    state._settingsWarningShown = true;
                    showToast(`‚ö†Ô∏è Update Settings: ${settingsVars.join(', ')}`);
                }
            }

            return result;
        }

        function updateActionButton() {
            const channel = state.currentChannel;
            const btn = document.getElementById('btnCopyOpen');
            const icon = document.getElementById('btnCopyOpenIcon');
            const text = document.getElementById('btnCopyOpenText');

            const config = {
                sms: { icon: 'üì±', text: 'Copy & Open Google Voice', color: 'from-green-500 to-emerald-600' },
                email: { icon: 'üìß', text: 'Copy & Open Email', color: 'from-sky-500 to-sky-600' },
                facebook: { icon: 'üìò', text: 'Copy & Open FB Page', color: 'from-blue-600 to-blue-700' },
                instagram: { icon: 'üì∑', text: 'Copy & Open IG Profile', color: 'from-pink-500 to-purple-600' },
                linkedin: { icon: 'üíº', text: 'Copy & Open LinkedIn', color: 'from-sky-500 to-sky-600' },
                call: { icon: 'üìû', text: 'Copy Script & Call', color: 'from-orange-500 to-orange-600' }
            };

            const c = config[channel] || config.sms;
            icon.textContent = c.icon;
            text.textContent = c.text;
            btn.className = `action-btn w-full bg-gradient-to-r ${c.color} text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2`;
        }

        // ============ ACTIONS ============
        async function copyAndOpen() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const channel = state.currentChannel;

            // Regenerate filled template fresh (don't rely on preview which might be stale)
            let rawTemplate = '';
            if (channel === 'sms') {
                rawTemplate = state.templates.sms1?.body || 'Hey! This is [YOUR_NAME]. We do a community postcard that hits [HOME_COUNT] homes in [AREA] and have the [CATEGORY] spot open. Interested?';
            } else if (channel === 'email') {
                rawTemplate = state.templates.email1?.body || 'Hi, we send out a community postcard...';
            } else if (channel === 'facebook') {
                rawTemplate = state.templates.fb?.body || 'Hey! I came across [BUSINESS_NAME] and love what you\'re doing...';
            } else if (channel === 'instagram') {
                rawTemplate = state.templates.ig?.body || 'Hey! Love your page. I help local businesses reach more customers...';
            } else if (channel === 'linkedin') {
                rawTemplate = state.templates.linkedin2?.body || 'Thanks for connecting! I run a community postcard...';
            } else if (channel === 'call') {
                rawTemplate = state.templates.call1?.body || '=== OPENER ===\nHi, is this [BUSINESS_NAME]?...';
            }

            const template = fillVariables(rawTemplate, prospect);

            // Also update the preview to match
            document.getElementById('templatePreview').textContent = template;

            console.log('üìã Copying template:', { channel, rawTemplate: rawTemplate.substring(0, 50), filled: template.substring(0, 50), settings: state.settings });

            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(template);
            } catch (err) {
                console.error('Clipboard failed:', err);
            }

            // Open appropriate app/URL
            let url = '';
            switch (channel) {
                case 'sms':
                    // Use Google Voice for consistent experience across devices
                    const formattedPhone = prospect.phone.replace(/\D/g, '');
                    url = `https://voice.google.com/u/0/messages?itemId=t.+1${formattedPhone}`;
                    break;
                case 'email':
                    const emailTemplate = state.templates.email1 || {};
                    const subject = encodeURIComponent(fillVariables(emailTemplate.subject || '', prospect));
                    const body = encodeURIComponent(fillVariables(emailTemplate.body || '', prospect));
                    url = `mailto:${prospect.email}?subject=${subject}&body=${body}`;
                    break;
                case 'facebook':
                    // Open Facebook page - user clicks Message button there
                    url = prospect.facebook;
                    break;
                case 'instagram':
                    // Open Instagram profile - user clicks Message button there
                    url = prospect.instagram;
                    break;
                case 'linkedin':
                    url = prospect.linkedin;
                    break;
                case 'call':
                    url = `tel:${prospect.phone}`;
                    break;
            }

            if (url) {
                if (!url.startsWith('http') && !url.startsWith('tel:') && !url.startsWith('mailto:')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            }

            showToast('üìã Copied! Opening...');
        }

        // Toggle edit mode for contact info in Outreach Hub
        function toggleHubEditMode() {
            const displayEl = document.getElementById('contactDisplay');
            const editEl = document.getElementById('contactEdit');
            if (displayEl && editEl) {
                displayEl.classList.toggle('hidden');
                editEl.classList.toggle('hidden');
            }
        }

        // Save contact info edits from Outreach Hub
        async function saveHubContactEdit() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const newPhone = document.getElementById('hubEditPhone')?.value.trim() || '';
            const newEmail = document.getElementById('hubEditEmail')?.value.trim() || '';
            const newCategory = document.getElementById('hubEditCategory')?.value.trim() || '';

            // Update prospect in local state
            prospect.phone = newPhone;
            prospect.email = newEmail;
            if (newCategory) prospect.category = newCategory;

            // Update in Campaign Board data
            if (state.campaignBoardData && state.currentMailerId) {
                const board = state.campaignBoardData[state.currentMailerId];
                if (board?.columns) {
                    for (const colKey of ['queued', 'attempting']) {
                        const items = board.columns[colKey] || [];
                        const item = items.find(i =>
                            (i.businessName || i.name) === (prospect.businessName || prospect.name) ||
                            i.id === prospect.id
                        );
                        if (item) {
                            item.phone = newPhone;
                            item.email = newEmail;
                            if (newCategory) item.category = newCategory;
                            console.log('‚úÖ Updated in Campaign Board:', item.businessName);
                        }
                    }
                }

                // Save to cloud
                await saveCampaignBoardsFromHub();
            }

            // Re-render
            toggleHubEditMode();
            renderProspectList();

            // Re-select to refresh the display
            const idx = state.filteredProspects.findIndex(p => p === prospect);
            if (idx >= 0) selectProspect(idx);

            showToast('‚úÖ Contact info saved');
        }

        // Delete business from Hub (removes from Campaign Board)
        async function deleteFromHub() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            if (!confirm(`Delete "${prospect.businessName}" from the Campaign Board?`)) return;

            // Remove from Campaign Board data
            if (state.campaignBoardData && state.currentMailerId) {
                const board = state.campaignBoardData[state.currentMailerId];
                if (board?.columns) {
                    for (const colKey of ['queued', 'attempting']) {
                        const items = board.columns[colKey] || [];
                        const idx = items.findIndex(i =>
                            (i.businessName || i.name) === (prospect.businessName || prospect.name) ||
                            i.id === prospect.id
                        );
                        if (idx >= 0) {
                            items.splice(idx, 1);
                            console.log('üóëÔ∏è Deleted from Campaign Board:', prospect.businessName);
                        }
                    }
                }

                // Save to cloud
                await saveCampaignBoardsFromHub();
            }

            // Remove from local prospects
            state.prospects = state.prospects.filter(p => p !== prospect);
            state.selectedProspect = null;

            // Re-render
            renderProspectList();
            showEmptyState();

            showToast('üóëÔ∏è Business deleted');
        }

        // Save campaign boards from Outreach Hub
        async function saveCampaignBoardsFromHub() {
            if (!currentUserEmail || !supabaseClient || !state.campaignBoardData) return;

            try {
                const { error } = await supabaseClient
                    .from('app_data')
                    .upsert({
                        user_email: currentUserEmail,
                        data_type: 'campaign-boards',
                        data: state.campaignBoardData
                    }, {
                        onConflict: 'user_email,data_type'
                    });

                if (error) {
                    console.error('Failed to save campaign boards:', error);
                } else {
                    console.log('‚òÅÔ∏è Campaign boards saved from Hub');
                    // Also update localStorage
                    localStorage.setItem('campaign-boards', JSON.stringify(state.campaignBoardData));
                }
            } catch (err) {
                console.error('Save error:', err);
            }
        }

        async function markContacted() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const channel = state.currentChannel;
            const trackingKey = {
                sms: 'texted',
                email: 'emailed',
                facebook: 'facebookMessaged',
                instagram: 'dmed',
                linkedin: 'linkedinMessaged',
                call: 'called'
            }[channel];

            if (!trackingKey) return;

            // Show syncing status
            document.getElementById('syncStatus').textContent = 'Saving...';

            // Update local state
            if (!prospect.contactTracking) prospect.contactTracking = {};
            prospect.contactTracking[trackingKey] = true;
            prospect.contactTracking[trackingKey + 'Date'] = new Date().toISOString();

            // Auto-move from 'queued' to 'attempting' when contacted
            const oldColumn = prospect._column;
            if (oldColumn === 'queued') {
                prospect._column = 'attempting';
                prospect.pipelineStage = 'Attempting';
            }

            // Update stats
            state.sessionStats.contacted++;
            state.todayStats.contacted++;
            saveTodayStats();

            // Update UI immediately
            renderProspectList();
            selectProspect(state.filteredProspects.indexOf(prospect));
            updateStats();

            // Sync to cloud and wait for completion
            try {
                await syncToCloud(oldColumn);

                // Also increment the daily goal counter if moving from queued
                if (oldColumn === 'queued') {
                    await incrementDailyGoalInCloud(prospect.businessName);
                }

                document.getElementById('syncStatus').textContent = '‚úì Saved';
                const movedMsg = oldColumn === 'queued' ? ' ‚Üí Attempting' : '';
                showToast('‚úì Marked & synced!' + movedMsg);
            } catch (err) {
                document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Sync failed';
                showToast('‚ö†Ô∏è Sync failed: ' + (err?.message || 'Unknown error').substring(0, 40));
                console.error('Sync error:', err);
            }
        }

        // Increment daily goal counter in cloud
        async function incrementDailyGoalInCloud(businessName = '') {
            if (!supabaseClient || !currentUserEmail) return;

            try {
                // Load current daily goal state from cloud
                const { data, error } = await supabaseClient
                    .from('app_data')
                    .select('data')
                    .eq('user_email', currentUserEmail)
                    .eq('data_type', 'dailyGoal')
                    .single();

                let goalState = {
                    dailyGoal: 10,
                    todayCount: 0,
                    lastResetDate: new Date().toDateString(),
                    history: []
                };

                if (!error && data?.data) {
                    goalState = data.data;
                }

                // Check if we need to reset for new day
                const today = new Date().toDateString();
                if (goalState.lastResetDate !== today) {
                    goalState.todayCount = 0;
                    goalState.lastResetDate = today;
                }

                // Increment count
                goalState.todayCount++;

                // Update history
                let todayRecord = goalState.history?.find(h => h.date === today);
                if (!todayRecord) {
                    todayRecord = { date: today, goal: goalState.dailyGoal, actual: 0, businesses: [] };
                    if (!goalState.history) goalState.history = [];
                    goalState.history.push(todayRecord);
                }
                todayRecord.actual = goalState.todayCount;
                if (businessName) {
                    todayRecord.businesses.push({ name: businessName, timestamp: new Date().toISOString() });
                }

                // Save back to cloud
                await supabaseClient.from('app_data').upsert({
                    user_email: currentUserEmail,
                    data_type: 'dailyGoal',
                    data: goalState
                }, { onConflict: 'user_email,data_type' });

                console.log('‚úÖ Daily goal incremented to', goalState.todayCount);
            } catch (err) {
                console.error('Failed to increment daily goal:', err);
            }
        }

        // ============ LOCATION ============
        function startLocationTracking() {
            if (!navigator.geolocation) {
                document.getElementById('locationStatus').textContent = 'üìç Location: Not available';
                return;
            }

            state.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    state.currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    document.getElementById('locationStatus').textContent =
                        `üìç Location: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;

                    // Update nearby count
                    const nearby = filterNearby();
                    const countEl = document.getElementById('nearbyCount');
                    if (nearby.length > 0) {
                        countEl.textContent = nearby.length;
                        countEl.classList.remove('hidden');
                    } else {
                        countEl.classList.add('hidden');
                    }

                    // Re-render if on nearby tab
                    if (state.currentChannel === 'nearby') {
                        renderProspectList();
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    document.getElementById('locationStatus').textContent = 'üìç Location: Error';
                },
                { enableHighAccuracy: true, maximumAge: 30000, timeout: 10000 }
            );
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getDirections() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const address = prospect.address || prospect.fullAddress || '';
            if (prospect.lat && prospect.lng) {
                // Use coordinates
                window.open(`https://maps.apple.com/?daddr=${prospect.lat},${prospect.lng}`, '_blank');
            } else if (address) {
                // Use address
                window.open(`https://maps.apple.com/?daddr=${encodeURIComponent(address)}`, '_blank');
            } else {
                showToast('No address available');
            }
        }

        // ============ VISIT MODAL ============
        function showVisitModal() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            document.getElementById('visitModalBusiness').textContent = prospect.businessName;
            document.getElementById('visitNotes').value = '';
            state.visitOutcome = null;

            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50', 'border-blue-500', 'bg-blue-50',
                                    'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
                btn.classList.add('border-gray-200');
            });

            document.getElementById('visitModal').classList.remove('hidden');
            document.getElementById('visitModal').classList.add('flex');
        }

        function closeVisitModal() {
            document.getElementById('visitModal').classList.add('hidden');
            document.getElementById('visitModal').classList.remove('flex');
        }

        function selectOutcome(outcome) {
            state.visitOutcome = outcome;

            const colors = {
                spoke: ['border-green-500', 'bg-green-50'],
                card: ['border-blue-500', 'bg-blue-50'],
                unavailable: ['border-orange-500', 'bg-orange-50'],
                closed: ['border-red-500', 'bg-red-50']
            };

            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50', 'border-blue-500', 'bg-blue-50',
                                    'border-orange-500', 'bg-orange-50', 'border-red-500', 'bg-red-50');
                btn.classList.add('border-gray-200');

                if (btn.dataset.outcome === outcome) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add(...colors[outcome]);
                }
            });
        }

        async function saveVisit() {
            const prospect = state.selectedProspect;
            if (!prospect || !state.visitOutcome) {
                showToast('Please select an outcome');
                return;
            }

            // Update tracking
            if (!prospect.contactTracking) prospect.contactTracking = {};
            prospect.contactTracking.visitedInPerson = true;
            prospect.contactTracking.visitedInPersonDate = new Date().toISOString();
            prospect.contactTracking.visitOutcome = state.visitOutcome;
            prospect.contactTracking.visitNotes = document.getElementById('visitNotes').value;

            // Update stats
            state.sessionStats.contacted++;
            state.todayStats.contacted++;
            saveTodayStats();

            // Sync
            await syncToCloud();

            // Update UI
            closeVisitModal();
            renderProspectList();
            updateStats();

            showToast('‚úì Visit recorded!');
        }

        // ============ SYNC ============
        async function syncToCloud(oldColumn = null) {
            if (!supabaseClient || !currentUserEmail) {
                console.warn('‚ö†Ô∏è Cannot sync: no supabase client or user email');
                return;
            }

            try {
                // Use campaign board data from state (loaded from cloud)
                if (!state.currentMailerId) {
                    console.warn('‚ö†Ô∏è No campaign board data to sync');
                    return;
                }

                // MERGE FIX: Fetch latest data from cloud to avoid overwriting other device's changes
                let boardsData = state.campaignBoardData || {};
                try {
                    const { data: cloudData, error: fetchError } = await supabaseClient
                        .from('app_data')
                        .select('data')
                        .eq('user_email', currentUserEmail)
                        .eq('data_type', 'campaign-boards')
                        .single();

                    if (!fetchError && cloudData?.data) {
                        // Merge: Start with cloud data, then apply local changes
                        const cloudBoards = cloudData.data;
                        // Copy any boards we don't have locally
                        Object.keys(cloudBoards).forEach(boardId => {
                            if (!boardsData[boardId]) {
                                boardsData[boardId] = cloudBoards[boardId];
                            }
                        });
                        // Update state with merged data
                        state.campaignBoardData = boardsData;
                        console.log('üì• Fetched fresh cloud data for merge');
                    }
                } catch (fetchErr) {
                    console.warn('‚ö†Ô∏è Could not fetch latest cloud data, proceeding with local:', fetchErr);
                }
                const board = boardsData[state.currentMailerId];
                const prospect = state.selectedProspect;

                if (!prospect) {
                    console.warn('‚ö†Ô∏è No prospect selected');
                    return;
                }

                if (!board) {
                    console.warn('‚ö†Ô∏è Board not found for mailer:', state.currentMailerId);
                    return;
                }

                const newColumn = prospect._column;

                // Helper function for robust prospect matching
                function matchProspect(item, prospect) {
                    // Try multiple matching strategies
                    const itemId = item.id || item._id || item.place_id;
                    const prospectId = prospect.id || prospect._id || prospect.place_id;

                    // Match by ID if both have one
                    if (itemId && prospectId && String(itemId) === String(prospectId)) {
                        return true;
                    }

                    // Match by business name (normalized)
                    const itemName = (item.businessName || item.name || '').toLowerCase().trim();
                    const prospectName = (prospect.businessName || prospect.name || '').toLowerCase().trim();
                    if (itemName && prospectName && itemName === prospectName) {
                        // Also check address or phone to avoid false matches
                        const itemAddr = (item.address || item.fullAddress || '').toLowerCase();
                        const prospectAddr = (prospect.address || prospect.fullAddress || '').toLowerCase();
                        if (itemAddr && prospectAddr && itemAddr.includes(prospectAddr.slice(0, 20))) {
                            return true;
                        }
                        // Or match by phone
                        if (item.phone && prospect.phone && item.phone === prospect.phone) {
                            return true;
                        }
                        // If no address/phone available, require exact name match with place_id
                        if (!itemAddr && !prospectAddr) {
                            // Only match if we have matching place_id as additional confirmation
                            const itemPlaceId = item.place_id || item.placeId;
                            const prospectPlaceId = prospect.place_id || prospect.placeId;
                            if (itemPlaceId && prospectPlaceId && itemPlaceId === prospectPlaceId) {
                                return true;
                            }
                            // Without address AND without place_id, don't match by name alone - too risky
                            console.warn(`‚ö†Ô∏è Skipping name-only match for "${itemName}" - no address/phone/place_id to confirm`);
                            return false;
                        }
                        // Name matched but address/phone didn't - NOT a match
                        return false;
                    }

                    return false;
                }

                // Handle column move if oldColumn provided and different from new
                if (oldColumn && oldColumn !== newColumn) {
                    console.log(`üîÑ Moving prospect from ${oldColumn} to ${newColumn}`);
                    console.log(`üìã Prospect: ${prospect.businessName} (id: ${prospect.id || prospect._id || prospect.place_id || 'none'})`);

                    // Remove from old column
                    const oldItems = board.columns[oldColumn] || [];
                    console.log(`üìã Old column ${oldColumn} has ${oldItems.length} items`);

                    const oldIdx = oldItems.findIndex(item => matchProspect(item, prospect));
                    if (oldIdx !== -1) {
                        oldItems.splice(oldIdx, 1);
                        console.log(`‚úÖ Removed from ${oldColumn}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Could not find prospect in ${oldColumn} to remove`);
                        // Log first few items for debugging
                        oldItems.slice(0, 3).forEach((item, i) => {
                            console.log(`   Item ${i}: ${item.businessName} (id: ${item.id || item._id || item.place_id || 'none'})`);
                        });
                    }

                    // Add to new column (with duplicate check)
                    if (!board.columns[newColumn]) board.columns[newColumn] = [];

                    // Check if item already exists in destination column
                    const newColItems = board.columns[newColumn];
                    const existsInDest = newColItems.some(item => matchProspect(item, prospect));

                    if (existsInDest) {
                        console.warn(`‚ö†Ô∏è Item "${prospect.businessName}" already exists in ${newColumn}, skipping add`);
                    } else {
                        // Create clean copy without internal _column property
                        const prospectCopy = { ...prospect };
                        delete prospectCopy._column;
                        delete prospectCopy.pipelineStage;
                        newColItems.push(prospectCopy);
                        console.log(`‚úÖ Added to ${newColumn} (now has ${newColItems.length} items)`);
                    }
                } else {
                    // Just update in current column
                    const items = board.columns[newColumn] || [];
                    console.log(`üîç Looking for prospect "${prospect.businessName}" in ${newColumn} (${items.length} items)`);

                    const idx = items.findIndex(item => matchProspect(item, prospect));

                    if (idx !== -1) {
                        items[idx].contactTracking = { ...prospect.contactTracking };
                        items[idx].lastContacted = new Date().toISOString();
                        console.log(`‚úÖ Updated contact tracking for ${prospect.businessName}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Prospect "${prospect.businessName}" not found in ${newColumn}`);
                        // Log first few items for debugging
                        items.slice(0, 3).forEach((item, i) => {
                            console.log(`   Item ${i}: ${item.businessName}`);
                        });
                    }
                }

                // Save to Supabase with retry logic for network errors
                let lastError = null;
                for (let attempt = 1; attempt <= 3; attempt++) {
                    try {
                        console.log(`‚òÅÔ∏è Sync attempt ${attempt}/3...`);
                        const { error } = await supabaseClient.from('app_data').upsert({
                            user_email: currentUserEmail,
                            data_type: 'campaign-boards',
                            data: boardsData
                        }, { onConflict: 'user_email,data_type' });

                        if (error) {
                            lastError = error;
                            console.error(`‚ùå Supabase error (attempt ${attempt}):`, error);
                            if (attempt < 3) {
                                await new Promise(r => setTimeout(r, 1000 * attempt)); // Wait 1s, 2s, 3s
                                continue;
                            }
                        } else {
                            console.log('‚úÖ Synced campaign board to Supabase cloud');
                            lastError = null;
                            break; // Success!
                        }
                    } catch (networkErr) {
                        lastError = networkErr;
                        console.error(`‚ùå Network error (attempt ${attempt}):`, networkErr.message);
                        if (attempt < 3) {
                            await new Promise(r => setTimeout(r, 1000 * attempt));
                            continue;
                        }
                    }
                }

                if (lastError) {
                    // Queue for offline sync instead of throwing
                    console.warn('‚ö†Ô∏è Sync failed after 3 attempts, queuing for later');
                    queueForOfflineSync({ ...prospect }, oldColumn, newColumn);
                    showToast('üì¥ Saved offline - will sync when online');
                    // Don't throw - data is queued
                    return;
                }

                // Try localStorage as backup (may fail on iPad due to quota)
                try {
                    localStorage.setItem('campaign-boards', JSON.stringify(boardsData));
                    console.log('üíæ Saved to localStorage');
                } catch (lsErr) {
                    console.warn('‚ö†Ô∏è localStorage save failed (quota exceeded), using cloud only');
                }
            } catch (err) {
                console.error('‚ùå Sync failed:', err);
                // Queue for offline sync instead of throwing
                const prospect = state.selectedProspect;
                if (prospect) {
                    queueForOfflineSync({ ...prospect }, oldColumn, prospect._column);
                    showToast('üì¥ Saved offline - will sync when online');
                }
            }
        }

        // ============ UTILITIES ============

        // Convert Facebook page URL to Messenger URL (m.me)
        function convertToMessengerUrl(fbUrl) {
            if (!fbUrl) return null;
            try {
                // Extract page name/ID from various Facebook URL formats
                // Examples: facebook.com/pagename, facebook.com/profile.php?id=123, fb.com/pagename
                let pageName = fbUrl;

                // Remove protocol and www
                pageName = pageName.replace(/^https?:\/\/(www\.)?/i, '');

                // Remove facebook.com or fb.com prefix
                pageName = pageName.replace(/^(facebook\.com|fb\.com)\//i, '');

                // Remove trailing slashes and query params for simple names
                pageName = pageName.split('?')[0].split('/')[0].replace(/\/$/, '');

                // If it's a profile.php URL, we can't easily convert it
                if (pageName.includes('profile.php') || !pageName) {
                    return fbUrl; // Return original URL as fallback
                }

                // Return Messenger URL
                return `https://m.me/${pageName}`;
            } catch (e) {
                console.warn('Could not convert FB URL to Messenger:', e);
                return fbUrl;
            }
        }

        // Convert Instagram URL to DM-friendly URL
        function convertToInstagramDM(igUrl) {
            if (!igUrl) return null;
            try {
                // Extract username from Instagram URL
                let username = igUrl;

                // Remove protocol and www
                username = username.replace(/^https?:\/\/(www\.)?/i, '');

                // Remove instagram.com prefix
                username = username.replace(/^instagram\.com\//i, '');

                // Remove trailing slashes and clean up
                username = username.split('?')[0].split('/')[0].replace(/\/$/, '').replace('@', '');

                if (!username) return igUrl;

                // Instagram DM deep link (works on mobile)
                // Note: instagram://user?username=X opens profile, user can tap Message from there
                return `https://instagram.com/${username}`;
            } catch (e) {
                console.warn('Could not convert IG URL:', e);
                return igUrl;
            }
        }

        function getContactedStatus(prospect) {
            const ct = prospect.contactTracking || {};
            const channel = state.currentChannel;

            switch (channel) {
                case 'sms': return ct.texted;
                case 'email': return ct.emailed;
                case 'facebook': return ct.facebookMessaged;
                case 'instagram': return ct.dmed;
                case 'linkedin': return ct.linkedinMessaged;
                case 'call': return ct.called;
                case 'nearby': return ct.visitedInPerson;
                default: return false;
            }
        }

        function updateStats() {
            const total = state.prospects.length;
            const contacted = state.prospects.filter(p => {
                const ct = p.contactTracking || {};
                return ct.emailed || ct.texted || ct.called || ct.facebookMessaged || ct.dmed || ct.linkedinMessaged || ct.visitedInPerson;
            }).length;

            document.getElementById('statToday').textContent = state.todayStats.contacted;
            document.getElementById('statSession').textContent = state.sessionStats.contacted;
            document.getElementById('statRemaining').textContent = total - contacted;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ============ VIEW MODE TOGGLE ============
        function switchViewMode(mode) {
            state.viewMode = mode;

            // Update toggle buttons
            document.getElementById('viewMode-channel').classList.toggle('bg-purple-600', mode === 'channel');
            document.getElementById('viewMode-channel').classList.toggle('text-white', mode === 'channel');
            document.getElementById('viewMode-channel').classList.toggle('bg-gray-200', mode !== 'channel');
            document.getElementById('viewMode-channel').classList.toggle('text-gray-700', mode !== 'channel');

            document.getElementById('viewMode-zipQueue').classList.toggle('bg-purple-600', mode === 'zipQueue');
            document.getElementById('viewMode-zipQueue').classList.toggle('text-white', mode === 'zipQueue');
            document.getElementById('viewMode-zipQueue').classList.toggle('bg-gray-200', mode !== 'zipQueue');
            document.getElementById('viewMode-zipQueue').classList.toggle('text-gray-700', mode !== 'zipQueue');

            // Show/hide appropriate content
            document.getElementById('channelTabs').classList.toggle('hidden', mode === 'zipQueue');
            document.getElementById('zipQueueStats').classList.toggle('hidden', mode !== 'zipQueue');
            document.getElementById('zipQueueChannelSelector').classList.toggle('hidden', mode !== 'zipQueue');

            if (mode === 'zipQueue') {
                buildZipQueue();
                renderZipQueue();
            } else {
                renderProspectList();
            }
        }

        function setZipQueueChannel(channel) {
            state.zipQueue.selectedChannel = channel;
            console.log('üìß ZIP Queue channel set to:', channel);
            // Rebuild ZIP queue to filter by channel availability
            buildZipQueue();
            renderZipQueue();
        }

        // ============ ZIP QUEUE ============
        function buildZipQueue() {
            const groups = {};
            const channel = state.zipQueue.selectedChannel || 'email';

            // Filter prospects that have the selected channel available and not yet contacted
            const filteredProspects = state.prospects.filter(p => {
                const ct = p.contactTracking || {};
                switch (channel) {
                    case 'email': return p.email && !ct.emailed;
                    case 'sms': return p.phone && !ct.texted;
                    case 'facebook': return p.facebook && !ct.facebookMessaged;
                    case 'instagram': return p.instagram && !ct.dmed;
                    case 'linkedin': return p.linkedin && !ct.linkedinMessaged;
                    case 'call': return p.phone && !ct.called;
                    default: return true;
                }
            });

            filteredProspects.forEach(p => {
                const zip = p.zipCode || p.actualZip || p.zip || 'Unknown';
                if (!groups[zip]) {
                    groups[zip] = [];
                }
                groups[zip].push(p);
            });

            state.zipQueue.groups = groups;

            // Update stats
            const zipCount = Object.keys(groups).length;
            const totalCount = filteredProspects.length;
            document.getElementById('zipGroupCount').textContent = zipCount;
            document.getElementById('zipTotalCount').textContent = totalCount;
        }

        function renderZipQueue() {
            const container = document.getElementById('prospectList');
            const groups = state.zipQueue.groups;
            const zipCodes = Object.keys(groups).sort();
            const channel = state.zipQueue.selectedChannel || 'email';

            const channelLabels = {
                email: 'üìß Email',
                sms: 'üì± SMS',
                facebook: 'üìò Facebook',
                instagram: 'üì∑ Instagram',
                linkedin: 'üíº LinkedIn',
                call: 'üìû Call'
            };

            document.getElementById('listTitle').textContent = `ZIP Queue - ${channelLabels[channel]}`;
            document.getElementById('listCount').textContent = `${zipCodes.length} ZIP codes`;

            if (zipCodes.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-400">
                        <div class="text-4xl mb-2">üìç</div>
                        <p>No prospects available for ${channelLabels[channel]}</p>
                        <p class="text-sm mt-2">Try selecting a different channel</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = zipCodes.map(zip => {
                const prospects = groups[zip];

                return `
                    <div class="p-4 border-b border-gray-200 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <span class="text-lg font-bold text-gray-900">üìç ${zip}</span>
                                <span class="ml-2 text-sm text-gray-500">${prospects.length} businesses</span>
                            </div>
                            <span class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full">
                                ${channelLabels[channel]}
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startRapidFire('${zip}')" class="flex-1 py-2 bg-gradient-to-r from-sky-500 to-cyan-500 text-white rounded-lg font-semibold text-sm hover:shadow-lg transition-shadow">
                                ‚ö° Work This ZIP
                            </button>
                            <button onclick="expandZipGroup('${zip}')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium text-sm hover:bg-gray-300">
                                View List
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function expandZipGroup(zip) {
            const prospects = state.zipQueue.groups[zip] || [];
            state.filteredProspects = prospects;
            state.zipQueue.activeZip = zip;

            const container = document.getElementById('prospectList');
            document.getElementById('listTitle').textContent = `ZIP ${zip}`;
            document.getElementById('listCount').textContent = `${prospects.length} businesses`;

            container.innerHTML = `
                <div class="p-2 bg-purple-50 border-b border-purple-200">
                    <button onclick="renderZipQueue()" class="text-sm text-purple-600 font-medium">‚Üê Back to ZIP Queue</button>
                </div>
            ` + prospects.map((p, idx) => {
                const ct = p.contactTracking || {};
                const isContacted = ct.emailed || ct.texted || ct.called || ct.facebookMessaged || ct.dmed;

                const icons = [];
                if (p.phone) icons.push(ct.texted ? 'üì±‚úì' : 'üì±');
                if (p.email) icons.push(ct.emailed ? 'üìß‚úì' : 'üìß');
                if (p.facebook) icons.push(ct.facebookMessaged ? 'üìò‚úì' : 'üìò');

                return `
                    <div class="prospect-item p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${isContacted ? 'contacted' : ''}"
                         onclick="selectProspectFromZip(${idx}, '${zip}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    ${isContacted ? '<span class="text-green-500">‚úì</span>' : ''}
                                    <span class="font-medium text-gray-900 truncate">${p.businessName}</span>
                                </div>
                                <div class="text-xs text-gray-500 truncate">${p.category || 'No category'}</div>
                            </div>
                            <div class="text-xs text-gray-400 ml-2 flex-shrink-0">${icons.join(' ')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectProspectFromZip(index, zip) {
            const prospects = state.zipQueue.groups[zip] || [];
            state.selectedProspect = prospects[index];
            state.filteredProspects = prospects;

            // Update list selection
            document.querySelectorAll('.prospect-item').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            // Show details (reuse existing function)
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('prospectDetails').classList.remove('hidden');

            const prospect = prospects[index];
            document.getElementById('detailName').textContent = prospect.businessName;
            document.getElementById('detailCategory').textContent = prospect.category || 'No category';
            document.getElementById('detailAddress').textContent = prospect.address || prospect.fullAddress || '';

            // Contact info
            const contactHtml = [];
            if (prospect.phone) contactHtml.push(`<div class="bg-white rounded-lg p-2 border"><span class="text-gray-500 text-xs">Phone:</span><br><span class="font-medium">${prospect.phone}</span></div>`);
            if (prospect.email) contactHtml.push(`<div class="bg-white rounded-lg p-2 border"><span class="text-gray-500 text-xs">Email:</span><br><span class="font-medium text-sm truncate">${prospect.email}</span></div>`);
            document.getElementById('contactInfo').innerHTML = contactHtml.join('');

            // Contact status
            const ct = prospect.contactTracking || {};
            const statusHtml = [
                { key: 'emailed', icon: 'üìß', label: 'Email' },
                { key: 'texted', icon: 'üì±', label: 'Text' },
                { key: 'called', icon: 'üìû', label: 'Call' },
                { key: 'facebookMessaged', icon: 'üìò', label: 'FB' },
                { key: 'dmed', icon: 'üì∑', label: 'IG' },
                { key: 'linkedinMessaged', icon: 'üíº', label: 'LI' }
            ].map(s => `
                <span class="px-2 py-1 rounded-full text-xs ${ct[s.key] ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-400'}">
                    ${s.icon} ${s.label} ${ct[s.key] ? '‚úì' : ''}
                </span>
            `).join('');
            document.getElementById('statusIcons').innerHTML = statusHtml;

            updateTemplatePreview();
            updateActionButton();

            // Show standard actions
            document.getElementById('nearbyActions').classList.add('hidden');
            document.getElementById('btnCopyOpen').classList.remove('hidden');
            document.getElementById('btnMarkContacted').classList.remove('hidden');
        }

        // ============ RAPID FIRE MODE ============
        function startRapidFire(zip) {
            const prospects = state.zipQueue.groups[zip] || [];
            if (prospects.length === 0) {
                showToast('No prospects in this ZIP');
                return;
            }

            state.zipQueue.activeZip = zip;
            state.zipQueue.rapidFireIndex = 0;
            state.zipQueue.rapidFireActive = true;

            document.getElementById('rapidFireModal').classList.remove('hidden');
            document.getElementById('rapidFireModal').classList.add('flex');
            document.getElementById('rapidFireZip').textContent = `ZIP: ${zip}`;

            updateRapidFireDisplay();
        }

        function closeRapidFire() {
            state.zipQueue.rapidFireActive = false;
            document.getElementById('rapidFireModal').classList.add('hidden');
            document.getElementById('rapidFireModal').classList.remove('flex');

            // Refresh the ZIP queue display
            if (state.viewMode === 'zipQueue') {
                buildZipQueue();
                renderZipQueue();
            }
        }

        function updateRapidFireDisplay() {
            const zip = state.zipQueue.activeZip;
            const prospects = state.zipQueue.groups[zip] || [];
            const idx = state.zipQueue.rapidFireIndex;

            if (idx < 0 || idx >= prospects.length) {
                closeRapidFire();
                showToast('üéâ ZIP complete!');
                return;
            }

            const prospect = prospects[idx];
            state.selectedProspect = prospect;

            // Update progress
            document.getElementById('rapidFireProgress').textContent = `${idx + 1}/${prospects.length}`;

            // Update business info
            document.getElementById('rapidFireBusinessName').textContent = prospect.businessName;
            document.getElementById('rapidFireCategory').textContent = prospect.category || 'No category';

            // Contact info
            const contactHtml = [];
            if (prospect.phone) contactHtml.push(`<div class="bg-gray-50 rounded px-2 py-1"><span class="text-gray-500 text-xs">üì±</span> ${prospect.phone}</div>`);
            if (prospect.email) contactHtml.push(`<div class="bg-gray-50 rounded px-2 py-1"><span class="text-gray-500 text-xs">üìß</span> ${prospect.email}</div>`);
            if (prospect.facebook) contactHtml.push(`<div class="bg-gray-50 rounded px-2 py-1"><span class="text-gray-500 text-xs">üìò</span> Facebook</div>`);
            document.getElementById('rapidFireContact').innerHTML = contactHtml.join('');

            // Use the selected channel from ZIP Queue settings
            const channelMap = {
                email: { icon: 'üìß', name: 'Email' },
                sms: { icon: 'üì±', name: 'SMS' },
                facebook: { icon: 'üìò', name: 'Facebook' },
                instagram: { icon: 'üì∑', name: 'Instagram' },
                linkedin: { icon: 'üíº', name: 'LinkedIn' },
                call: { icon: 'üìû', name: 'Call' }
            };
            const channel = state.zipQueue.selectedChannel || 'email';
            const { icon: channelIcon, name: channelName } = channelMap[channel];

            state.currentChannel = channel;
            document.getElementById('rapidFireChannel').innerHTML = `${channelIcon} ${channelName}`;

            // Template
            const template = getTemplateForChannel(channel);
            const filledTemplate = fillTemplate(template, prospect);
            document.getElementById('rapidFireTemplate').textContent = filledTemplate;
        }

        function rapidFireCopyAndOpen() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const channel = state.currentChannel;
            const template = getTemplateForChannel(channel);
            // Enable warning on missing variables when copying
            const filledMessage = fillTemplate(template, prospect, true);

            // Copy to clipboard
            navigator.clipboard.writeText(filledMessage).then(() => {
                showToast('üìã Copied!');
            }).catch(() => {
                showToast('Copy failed');
            });

            // Open appropriate app
            setTimeout(() => {
                openChannelApp(prospect, channel);
            }, 300);
        }

        function rapidFireMarkSent() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const channel = state.currentChannel;
            if (!prospect.contactTracking) prospect.contactTracking = {};

            switch (channel) {
                case 'sms': prospect.contactTracking.texted = true; break;
                case 'email': prospect.contactTracking.emailed = true; break;
                case 'facebook': prospect.contactTracking.facebookMessaged = true; break;
                case 'call': prospect.contactTracking.called = true; break;
                case 'instagram': prospect.contactTracking.dmed = true; break;
                case 'linkedin': prospect.contactTracking.linkedinMessaged = true; break;
            }

            // Auto-move from 'queued' to 'attempting' when contacted
            const oldColumn = prospect._column;
            if (oldColumn === 'queued') {
                prospect._column = 'attempting';
                prospect.pipelineStage = 'Attempting';
                console.log('üì§ Moving from queued to attempting');
            }

            // Update stats
            state.sessionStats.contacted++;
            state.todayStats.contacted++;
            saveTodayStats();

            // Sync with column move info and move to next
            syncToCloud(oldColumn).then(() => {
                showToast('‚úì Marked & synced');
                rapidFireNext();
            }).catch(err => {
                console.error('‚ùå Sync failed:', err);
                // Still move to next but warn user
                showToast('‚ö†Ô∏è Marked locally - sync pending');
                rapidFireNext();
                // Queue for retry on next action
                state.pendingSync = true;
            });
        }

        function rapidFireGotResponse() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            // Open response capture modal
            document.getElementById('responseCaptureBusiness').textContent = prospect.businessName;

            const channelIcons = { sms: 'üì± SMS', email: 'üìß Email', facebook: 'üìò Facebook', call: 'üìû Call' };
            document.getElementById('responseChannel').textContent = channelIcons[state.currentChannel] || state.currentChannel;

            document.getElementById('capturedEmail').value = '';
            document.getElementById('responseNotes').value = '';

            // Reset interest level
            document.querySelectorAll('.interest-btn').forEach(btn => {
                btn.classList.remove('border-red-500', 'bg-red-50', 'border-yellow-500', 'bg-yellow-50', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');
            });
            state.responseInterestLevel = null;

            document.getElementById('responseCaptureModal').classList.remove('hidden');
            document.getElementById('responseCaptureModal').classList.add('flex');
        }

        function rapidFirePrevious() {
            if (state.zipQueue.rapidFireIndex > 0) {
                state.zipQueue.rapidFireIndex--;
                updateRapidFireDisplay();
            }
        }

        function rapidFireNext() {
            const zip = state.zipQueue.activeZip;
            const prospects = state.zipQueue.groups[zip] || [];

            if (state.zipQueue.rapidFireIndex < prospects.length - 1) {
                state.zipQueue.rapidFireIndex++;
                updateRapidFireDisplay();
            } else {
                closeRapidFire();
                showToast('üéâ ZIP complete!');
            }
        }

        function rapidFireSkip() {
            rapidFireNext();
        }

        // ============ RESPONSE CAPTURE ============
        function setInterestLevel(level) {
            state.responseInterestLevel = level;

            const colors = {
                hot: ['border-red-500', 'bg-red-50'],
                warm: ['border-yellow-500', 'bg-yellow-50'],
                cold: ['border-blue-500', 'bg-blue-50']
            };

            document.querySelectorAll('.interest-btn').forEach(btn => {
                btn.classList.remove('border-red-500', 'bg-red-50', 'border-yellow-500', 'bg-yellow-50', 'border-blue-500', 'bg-blue-50');
                btn.classList.add('border-gray-200');

                if (btn.dataset.level === level) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add(...colors[level]);
                }
            });
        }

        function closeResponseCapture() {
            document.getElementById('responseCaptureModal').classList.add('hidden');
            document.getElementById('responseCaptureModal').classList.remove('flex');
        }

        async function saveResponse() {
            const prospect = state.selectedProspect;
            if (!prospect) return;

            const capturedEmail = document.getElementById('capturedEmail').value.trim();
            const responseNotes = document.getElementById('responseNotes').value.trim();
            const interestLevel = state.responseInterestLevel;

            // Update prospect data
            if (!prospect.contactTracking) prospect.contactTracking = {};

            // Mark channel as responded
            const channel = state.currentChannel;
            switch (channel) {
                case 'sms': prospect.contactTracking.texted = true; prospect.contactTracking.smsResponded = true; break;
                case 'email': prospect.contactTracking.emailed = true; prospect.contactTracking.emailResponded = true; break;
                case 'facebook': prospect.contactTracking.facebookMessaged = true; prospect.contactTracking.facebookResponded = true; break;
                case 'call': prospect.contactTracking.called = true; prospect.contactTracking.callResponded = true; break;
            }

            // Lock channel for follow-up
            prospect.lockedChannel = {
                channel: channel,
                capturedEmail: capturedEmail || null,
                lockedAt: new Date().toISOString()
            };

            // Save captured email if provided
            if (capturedEmail && !prospect.email) {
                prospect.email = capturedEmail;
            }

            // Save response notes and interest level
            prospect.lastContactResponse = responseNotes;
            prospect.interestLevel = interestLevel;
            prospect.respondedAt = new Date().toISOString();

            // Move to in-progress (negotiating in new system)
            const oldColumn = prospect._column;
            prospect._column = 'in-progress';
            prospect.pipelineStage = 'In Progress';

            // Update stats
            state.sessionStats.contacted++;
            state.todayStats.contacted++;
            saveTodayStats();

            // Sync to cloud
            await syncToCloud(oldColumn);

            closeResponseCapture();
            showToast('üéâ Moved to In Progress!');

            // Continue rapid fire if active
            if (state.zipQueue.rapidFireActive) {
                rapidFireNext();
            } else {
                // Refresh displays
                if (state.viewMode === 'zipQueue') {
                    buildZipQueue();
                    renderZipQueue();
                } else {
                    renderProspectList();
                }
            }
        }

        // Helper function to get template for channel
        function getTemplateForChannel(channel) {
            const templates = state.templates || {};
            const templateMap = {
                sms: templates.sms || templates.text || 'Hi {businessName}!',
                email: templates.email || 'Hello {businessName},',
                facebook: templates.facebook || 'Hi {businessName}!',
                instagram: templates.instagram || templates.dm || 'Hi {businessName}!',
                linkedin: templates.linkedin || 'Hello {businessName},',
                call: templates.call || 'Call script for {businessName}'
            };
            return templateMap[channel] || 'Hi {businessName}!';
        }

        // fillTemplate is now unified into fillVariables() above - keeping alias for compatibility
        const fillTemplate = fillVariables;

        // Helper function to open channel app
        function openChannelApp(prospect, channel) {
            switch (channel) {
                case 'sms':
                    if (prospect.phone) {
                        window.open(`sms:${prospect.phone}`, '_blank');
                    }
                    break;
                case 'email':
                    if (prospect.email) {
                        window.open(`mailto:${prospect.email}`, '_blank');
                    }
                    break;
                case 'facebook':
                    if (prospect.facebook) {
                        const messengerUrl = convertToMessengerUrl(prospect.facebook);
                        window.open(messengerUrl, '_blank');
                    }
                    break;
                case 'instagram':
                    if (prospect.instagram) {
                        const igUrl = convertToInstagramDM(prospect.instagram);
                        window.open(igUrl, '_blank');
                    }
                    break;
                case 'linkedin':
                    if (prospect.linkedin) {
                        window.open(prospect.linkedin, '_blank');
                    }
                    break;
                case 'call':
                    if (prospect.phone) {
                        window.open(`tel:${prospect.phone}`, '_blank');
                    }
                    break;
            }
        }
    </script>
</body>
</html>
