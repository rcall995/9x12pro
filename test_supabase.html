<!DOCTYPE html>
<html>
<head>
  <title>Supabase Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Supabase Connection Test</h1>
  <div id="results"></div>

  <script>
    const SUPABASE_URL = "https://kurhsdvxsgkgnfimfqdo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1cmhzZHZ4c2drZ25maW1mcWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDk3NDYsImV4cCI6MjA3ODM4NTc0Nn0.nB_GsE89WJ3eAQrgmNKb-fbCktHTHf-987D-G6lscZA";
    const ACTIVE_USER = "lastcall.me@hotmail.com";

    const { createClient } = window.supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const results = document.getElementById('results');

    async function runTests() {
      results.innerHTML = '<h2>Running tests...</h2>';

      // Test 1: Check if app_data table exists
      results.innerHTML += '<h3>Test 1: Query app_data table</h3>';
      try {
        const { data, error } = await supabaseClient
          .from('app_data')
          .select('data_type, created_at')
          .limit(5);

        if (error) {
          results.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
          results.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
        } else {
          results.innerHTML += `<p style="color: green;">✅ Success! Found ${data.length} records</p>`;
          results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (e) {
        results.innerHTML += `<p style="color: red;">❌ Exception: ${e.message}</p>`;
      }

      // Test 2: Try to insert test data
      results.innerHTML += '<h3>Test 2: Insert test task</h3>';
      try {
        const testData = {
          user_email: ACTIVE_USER,
          data_type: 'tasks',
          data: [
            { id: 999, text: 'TEST TASK - Delete this', dueDate: '2025-11-30', completed: false }
          ]
        };

        const { data, error } = await supabaseClient
          .from('app_data')
          .upsert(testData, { onConflict: 'user_email,data_type' })
          .select();

        if (error) {
          results.innerHTML += `<p style="color: red;">❌ Insert Error: ${error.message}</p>`;
          results.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
        } else {
          results.innerHTML += `<p style="color: green;">✅ Insert Success!</p>`;
          results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (e) {
        results.innerHTML += `<p style="color: red;">❌ Insert Exception: ${e.message}</p>`;
      }

      // Test 3: Read back the data
      results.innerHTML += '<h3>Test 3: Read back tasks</h3>';
      try {
        const { data, error } = await supabaseClient
          .from('app_data')
          .select('data')
          .eq('user_email', ACTIVE_USER)
          .eq('data_type', 'tasks')
          .single();

        if (error) {
          results.innerHTML += `<p style="color: red;">❌ Read Error: ${error.message}</p>`;
          results.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
        } else {
          results.innerHTML += `<p style="color: green;">✅ Read Success!</p>`;
          results.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (e) {
        results.innerHTML += `<p style="color: red;">❌ Read Exception: ${e.message}</p>`;
      }
    }

    runTests();
  </script>
</body>
</html>
